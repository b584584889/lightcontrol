var LOAD_PAGE_NUM=20,PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glCurrentPage=1,glReloadCount=0,gl_users=[],gl_rfiddevices=[],gl_nfclocators=[],gl_cardrollcall={},gl_cardrollcallevent={},gl_cardrollcallrecord=[];check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_user());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_rfiddevice());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+
PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_nfclocator());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcall(rollcallid));break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallevent(eventid));
break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallrecord(rollcallid,eventid));break;case 6:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,draw_cardrollcallevent_table(),CurrentLoadIndex+=1);break;case 7:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,draw_cardrollcallrecord_table(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):(0<glReloadCount&&(--glReloadCount,setTimeout(reload_device_info,5E3)),console.log("check_loading_status() Stop."))}function reload_device_info(){PreLoadIndex=3;CurrentLoadIndex=4;check_loading_status()}
function load_user(){gl_users=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loaduser=1&&project_id="+project_id,function(b){var a=0;$.each(b,function(c,b){gl_users.push(b);a++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_rfiddevice(){gl_rfiddevices=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loaddevice=1&project_id="+project_id,function(b){var a=0;$.each(b,function(b,e){gl_rfiddevices.push(e);a++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_nfclocator(){gl_nfclocators=[];$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&project_id="+project_id,function(b){var a=0;$.each(b,function(b,e){gl_nfclocators.push(e);a++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcall(b){gl_cardrollcall={};$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcall=1&project_id="+project_id+"&rollcallid="+b,function(a){gl_cardrollcall=a}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallevent(b){gl_cardrollcallevent={};$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallevent=1&project_id="+project_id+"&eventid="+b,function(a){gl_cardrollcallevent=a}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallrecord(b,a){gl_cardrollcallrecord=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallrecord=1&&project_id="+project_id+"&rollcallid="+b+"&eventid="+a,function(a){$.each(a,function(a,b){gl_cardrollcallrecord.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function draw_cardrollcallevent_table(){for(var b=document.getElementById("RFID_ROLLCALLRESULT_TABLE");1<=b.rows.length;)b.deleteRow(0);console.log("draw_table() gl_cardrollcallevent.rollcallname:"+gl_cardrollcallevent.rollcallname);var a=create_event_table_item(0,gl_cardrollcallevent);null!=a&&b.appendChild(a)}
function create_event_table_item(b,a){if(null==a)return null;var c=document.createElement("tr");1==b%2&&c.setAttribute("bgcolor","#ebebe0");var e=0;c.appendChild(document.createElement("td"));c.cells[e].appendChild(document.createTextNode(""+(b+1)));e++;var d=document.createElement("td");d.setAttribute("id","uiid_name_"+a.eventid);c.appendChild(d);var f=document.createElement("span");f.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");f.textContent=a.rollcallname;d.appendChild(f);
e++;d=document.createElement("td");d.setAttribute("id","uiid_cardid_"+a.eventid);c.appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-info");d.textContent=convertPrettyDateOnly(a.StartDateTime);c.cells[e].appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-warning");d.textContent=convertPrettyTimeOnly(a.StartDateTime);c.cells[e].appendChild(d);e++;d=document.createElement("td");d.setAttribute("id","uiid_userid_"+a.recordid);c.appendChild(d);
d=document.createElement("span");d.setAttribute("class","label label-info");d.textContent=convertPrettyDateOnly(a.EndDateTime);c.cells[e].appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-warning");d.textContent=convertPrettyTimeOnly(a.EndDateTime);c.cells[e].appendChild(d);e++;d=document.createElement("td");d.setAttribute("id","uiid_nodeid_"+a.recordid);c.appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-primary");d.textContent=
a.totalcount;c.cells[e].appendChild(d);e++;d=document.createElement("td");d.setAttribute("id","uiid_present_"+a.recordid);c.appendChild(d);f=document.createElement("span");0==a.presentcount?f.setAttribute("class","label label-danger"):f.setAttribute("class","label label-primary");f.textContent=a.presentcount;c.cells[e].appendChild(f);e++;d=a.totalcount-a.presentcount;f=document.createElement("td");f.setAttribute("id","uiid_present_"+a.recordid);c.appendChild(f);f=document.createElement("span");0==
d?f.setAttribute("class","label label-primary"):f.setAttribute("class","label label-danger");f.textContent=d;c.cells[e].appendChild(f);return c}function draw_cardrollcallrecord_table(){for(var b=document.getElementById("RFID_ROLLCALLRECORD_TABLE");1<=b.rows.length;)b.deleteRow(0);console.log("draw_table() gl_cardrollcallrecord.length:"+gl_cardrollcallrecord.length);for(var a=0;a<gl_cardrollcallrecord.length;++a){var c=create_record_table_item(a,gl_cardrollcallrecord[a]);b.appendChild(c)}}
function create_record_table_item(b,a){if(null==a)return null;var c=document.createElement("tr");1==b%2&&c.setAttribute("bgcolor","#ebebe0");var e="",d=0,f=gl_cardrollcall;0<a.userid&&(e=getUseName(parseInt(a.userid)));c.appendChild(document.createElement("td"));c.cells[d].appendChild(document.createTextNode(""+(b+1)));d++;var g=document.createElement("td");c.appendChild(g);g=document.createElement("span");0<a.cardid.length&&g.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");
g.textContent=a.cardid;c.cells[d].appendChild(g);d++;c.appendChild(document.createElement("td"));g=createRollCallDeviceList(a);c.cells[d].appendChild(g);d++;g=document.createElement("td");c.appendChild(g);g=document.createElement("span");0<a.userid&&(g.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;"),g.textContent=e);c.cells[d].appendChild(g);d++;g=document.createElement("td");c.appendChild(g);g=document.createElement("span");0==a.present?(g.setAttribute("class","label label-danger"),
null!=f&&(g.textContent=f.absentcomment)):(g.setAttribute("class","label label-primary"),null!=f&&(g.textContent=f.presentcomment));c.cells[d].appendChild(g);d++;f=document.createElement("td");c.appendChild(f);f=document.createElement("span");f.setAttribute("class","label label-info");0!=a.present&&(f.textContent=convertPrettyDateOnly(a.updatetime));c.cells[d].appendChild(f);f=document.createElement("span");f.setAttribute("class","label label-warning");0!=a.present&&(f.textContent=convertPrettyTimeOnly(a.updatetime));
c.cells[d].appendChild(f);d++;c.appendChild(document.createElement("td"));0==a.present&&check_rollcall_intime()&&(f=document.createElement("button"),f.setAttribute("title","\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230"),f.setAttribute("href","javascript:;"),f.setAttribute("onclick",'confirm_set_present("'+a.userid+'","'+a.cardid+'", "'+e+'");return false;'),e=document.createElement("i"),e.setAttribute("class","fa fa-user-plus"),f.appendChild(e),c.cells[d].appendChild(f));return c}
function createRollCallDeviceList(b){var a=document.createElement("span");a.setAttribute("id","uiid_devicelist_"+b.rollcallid);if(0<b.rfiddeviceids.length){var c=create_rfid_devicelist_ui(b.rollcallid,b.rfiddeviceids);a.appendChild(c)}0<b.nfclocators.length&&(b=create_nfc_devicelist_ui(b.rollcallid,b.nfclocators),a.appendChild(b));return a}
function create_rfid_devicelist_ui(b,a){var c=a.split(","),e=document.createElement("span");e.setAttribute("id","uiid_uhfreader_"+b);for(var d=0;d<c.length;d++){var f=document.createElement("div"),g=create_rfiddevice_label(getRFIDDeviceName(c[d]));f.appendChild(g);e.appendChild(f)}return e}
function create_nfc_devicelist_ui(b,a){var c=a.split(","),e=document.createElement("span");e.setAttribute("id","uiid_nfclocator_"+b);for(var d=0;d<c.length;d++){var f=document.createElement("div"),g=create_nfclocator_label(getNFCLocatorDeviceName(c[d]));f.appendChild(g);e.appendChild(f)}return e}
function create_rfiddevice_label(b){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a7d0;");a.textContent=b;return a}
function create_nfclocator_label(b){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#f39c12;");a.textContent=b;return a}function clearChildView(b){b=document.getElementById(b);if(null!=b)for(;b.firstChild;)b.removeChild(b.firstChild);return b}
function check_rollcall_intime(){var b=!1,a=moment(gl_cardrollcallevent.StartDateTime,"YYYY-MM-DD HH:mm:ss"),c=moment(gl_cardrollcallevent.EndDateTime,"YYYY-MM-DD HH:mm:ss"),e=moment();e>=a&&e<=c&&(b=!0);return b}
function update_device(b,a,c,e){console.log("update_device() deviceid:"+b);if(0==a.length)alert("\u8acb\u8f38\u5165\u540d\u7a31");else if(0==e.length)alert("\u8acb\u8f38\u5165IP\u4f4d\u5740");else{var d={};d.project_id=""+project_id;d.update_device=1;d.deviceid=b;d.name=a;d.type=c;d.ip=e;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:d,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,
b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}
function set_present(b,a){var c={};c.project_id=""+project_id;c.update_rollcall_record=1;c.rollcallid=rollcallid;c.eventid=eventid;c.cardid=a;c.userid=b;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:c,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));glReloadCount=5;setTimeout(reload_device_info,5E3)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}
function confirm_set_present(b,a,c){confirm("\u662f\u5426\u8981\u8a2d\u5b9a"+c+"\u9ede\u540d\u5df2\u5230?")&&set_present(b,a)}function getUseName(b){for(var a=b,c=0;c<gl_users.length;++c){var e=gl_users[c];if(parseInt(e.userid)==b){a=e.name;break}}return a}function getRFIDDeviceName(b){for(var a=b,c=0;c<gl_rfiddevices.length;++c){var e=gl_rfiddevices[c];if(e.deviceid===b){a=e.name;break}}return a}
function getNFCLocatorDeviceName(b){for(var a=b,c=0;c<gl_nfclocators.length;++c){var e=gl_nfclocators[c];if(e.macaddress===b){a=e.name;break}}return a}function convertPrettyDateOnly(b){var a=moment(b,"YYYY-MM-DD HH:mm:ss");b=a.format("YYYY");var c=a.format("M"),a=a.format("D");return b+"\u5e74"+c+"\u6708"+a+"\u65e5 "}
function convertPrettyTimeOnly(b){var a=moment(b,"YYYY-MM-DD HH:mm:ss");b=a.hour();var c=a.minutes(),a=a.seconds(),e="";0<=b&&(e+=b+"\u9ede");0<=c&&(e+=c+"\u5206");0<=a&&(e+=a+"\u79d2");return e}function open_cardrollcallevent_page(){window.open("/index.php/vilscardrollcallevent/"+project_id,"_blank").focus()};
