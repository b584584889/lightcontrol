var LOAD_PAGE_NUM=20,PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glCurrentPage=1,gl_user_info=[],gl_rfiddevices=[],gl_nfclocators=[],gl_cardrollcall=[],gl_cardrollcallrecord=[],gl_userrollcallrecord=[],LOAD_USER_NUM=500,gl_user_load_index=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_rfiddevice());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_nfclocator());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+
PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcall());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallrecord());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_user_info());
break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,draw_userrollcallrecord_table(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_rfiddevice(){gl_rfiddevices=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loaddevice=1&project_id="+project_id,function(a){var b=0;$.each(a,function(a,d){gl_rfiddevices.push(d);b++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_nfclocator(){gl_nfclocators=[];$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&project_id="+project_id,function(a){var b=0;$.each(a,function(a,d){gl_nfclocators.push(d);b++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcall(){gl_cardrollcall=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcall=1&project_id="+project_id,function(a){var b=0;$.each(a,function(a,d){gl_cardrollcall.push(d);b++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallrecord(){var a=(glCurrentPage-1)*LOAD_PAGE_NUM,b=LOAD_PAGE_NUM;gl_cardrollcallrecord=[];gl_userrollcallrecord=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallrecord=1&s="+a+"&count="+b+"&project_id="+project_id,function(a){var b=0;$.each(a,function(a,c){gl_cardrollcallrecord.push(c);put_to_user_rollcall_record(c);b++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_user_info(){for(var a="",b=0,c=0;c<gl_cardrollcallrecord.length;++c){for(var d=gl_cardrollcallrecord[c],f=!1,e=0;e<gl_user_info.length;++e)if(gl_user_info[e].userid==parseInt(d.userid)){f=!0;break}0==f&&(0<b&&(a+=","),a+=d.userid,b+=1)}0!=a.length&&$.getJSON(gl_target_server+"/php/vilsnodes.php","queryusers=1&userid="+a+"&project_id="+project_id,function(a){$.each(a,function(a,b){b.userid=parseInt(b.userid);gl_user_info.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=
1}).complete(function(){})}
function put_to_user_rollcall_record(a){for(var b=[],c=!1,d=0;d<gl_userrollcallrecord.length;++d){var f=gl_userrollcallrecord[d];if(f.rollcalleventid==a.rollcalleventid){b=f;c=!0;break}}c||(b=[],b.rollcalleventid=a.rollcalleventid,b.rollcallid=a.rollcallid,b.userrecord=[],gl_userrollcallrecord.push(b));f=[];c=!1;for(d=0;d<b.userrecord.length;++d){var e=b.userrecord[d];if(e.userid==a.userid){f=e;c=!0;break}}c||(f=[],f.userid=a.userid,f.card=[],b.userrecord.push(f));f.card.push(a)}
function create_empty_record_table_item(a){if(null==document.getElementById("empty_record_table_item")){var b=document.getElementById("RFID_ROLLCALLRECORD_TABLE"),c=document.createElement("tr");c.setAttribute("id","empty_record_table_item");var d=0;c.appendChild(document.createElement("td"));c.cells[d].appendChild(document.createTextNode(""+a));d++;c.appendChild(document.createElement("td"));c.cells[d].appendChild(create_input_text("input_name"));d++;c.appendChild(document.createElement("td"));c.cells[d].appendChild(create_input_text("input_type"));
d++;c.appendChild(document.createElement("td"));c.cells[d].appendChild(create_input_text("input_ip"));d++;c.appendChild(document.createElement("td"));a=document.createElement("button");a.setAttribute("class","btn btn-block btn-primary btn-lg");a.setAttribute("onclick","save_new_device();");a.textContent="\u5132\u5b58";c.cells[d].appendChild(a);b.appendChild(c)}}
function create_input_text(a,b){var c=document.createElement("textarea");c.setAttribute("rows","1");c.setAttribute("id",a);c.textContent=b;return c}function draw_cardrollcallrecord_table(){for(var a=document.getElementById("RFID_ROLLCALLRECORD_TABLE");1<=a.rows.length;)a.deleteRow(0);console.log("draw_table() gl_cardrollcallrecord.length:"+gl_cardrollcallrecord.length);for(var b=0;b<gl_cardrollcallrecord.length;++b){var c=create_record_table_item(b,gl_cardrollcallrecord[b]);a.appendChild(c)}}
function draw_userrollcallrecord_table(){for(var a=document.getElementById("RFID_ROLLCALLRECORD_TABLE");1<=a.rows.length;)a.deleteRow(0);console.log("draw_table() gl_userrollcallrecord.length:"+gl_userrollcallrecord.length);for(var b=0,c=0;c<gl_userrollcallrecord.length;++c){var d=gl_userrollcallrecord[c];console.log("draw_table() rollcalleventid:"+d.rollcalleventid+" rollcallid:"+d.rollcallid+" userrecord.length:"+d.userrecord.length);for(var f=0;f<d.userrecord.length;++f){var e=create_user_record_table_item(b,
d,d.userrecord[f]);a.appendChild(e);b++}}}
function create_record_table_item(a,b){if(null==b)return null;var c=document.createElement("tr");1==a%2&&c.setAttribute("bgcolor","#ebebe0");var d=0,f=getRollCall(parseInt(b.rollcallid));c.appendChild(document.createElement("td"));c.cells[d].appendChild(document.createTextNode(""+(a+1)));d++;var e=document.createElement("td");e.setAttribute("id","uiid_name_"+b.recordid);c.appendChild(e);var g=document.createElement("span");g.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");null!=
f&&(g.textContent=f.rollcallname);e.appendChild(g);d++;e=document.createElement("td");e.setAttribute("id","uiid_userid_"+b.recordid);c.appendChild(e);e=document.createElement("span");0<b.userid&&(e.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;"),e.textContent=getUseName(parseInt(b.userid)));c.cells[d].appendChild(e);d++;e=document.createElement("td");e.setAttribute("id","uiid_cardid_"+b.recordid);c.appendChild(e);e=document.createElement("span");0<b.cardid.length&&e.setAttribute("style",
"font-size:14px; font-weight:bold; color:#330033;");e.textContent=b.cardid;c.cells[d].appendChild(e);d++;c.appendChild(document.createElement("td"));e=createRollCallDeviceList(b);c.cells[d].appendChild(e);d++;e=document.createElement("td");e.setAttribute("id","uiid_present_"+b.recordid);c.appendChild(e);e=document.createElement("span");0==b.present?(e.setAttribute("class","label label-danger"),null!=f&&(e.textContent=f.absentcomment)):(e.setAttribute("class","label label-primary"),null!=f&&(e.textContent=
f.presentcomment));c.cells[d].appendChild(e);d++;f=document.createElement("td");f.setAttribute("id","uiid_present_"+b.recordid);c.appendChild(f);f=document.createElement("span");f.setAttribute("class","label label-primary");0!=b.present&&(f.textContent=b.updatetime);c.cells[d].appendChild(f);return c}
function create_user_record_table_item(a,b,c){if(null==b)return null;var d=document.createElement("tr");1==a%2&&d.setAttribute("bgcolor","#ebebe0");var f=0;b=getRollCall(parseInt(b.rollcallid));d.appendChild(document.createElement("td"));d.cells[f].appendChild(document.createTextNode(""+(a+1)));f++;a=document.createElement("td");d.appendChild(a);var e=document.createElement("span");e.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");null!=b&&(e.textContent=b.rollcallname);a.appendChild(e);
f++;a=document.createElement("td");d.appendChild(a);a=document.createElement("span");e=parseInt(c.userid);0<e&&(a.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;"),a.textContent=getUseName(e));d.cells[f].appendChild(a);f++;d.appendChild(document.createElement("td"));for(a=0;a<c.card.length;++a){var e=c.card[a],g=document.createElement("div");d.cells[f].appendChild(g);var h=document.createElement("span");0<e.cardid.length&&h.setAttribute("style","font-size:14px; font-weight:bold;line-height:2; color:#330033;");
h.textContent=e.cardid;g.appendChild(h)}f++;d.appendChild(document.createElement("td"));for(a=0;a<c.card.length;++a)e=c.card[a],g=document.createElement("div"),d.cells[f].appendChild(g),e=createRollCallDeviceList(e),g.appendChild(e);f++;d.appendChild(document.createElement("td"));for(a=0;a<c.card.length;++a)e=c.card[a],g=document.createElement("div"),d.cells[f].appendChild(g),"0"==e.present?g.appendChild(create_absent_label(b.absentcomment)):g.appendChild(create_present_label(b.presentcomment));f++;
d.appendChild(document.createElement("td"));for(a=0;a<c.card.length;++a)e=c.card[a],b=document.createElement("div"),d.cells[f].appendChild(b),0==e.present?b.appendChild(create_absent_label("\u7121")):b.appendChild(create_present_label(e.updatetime));return d}
function createRollCallDeviceList(a){var b=document.createElement("span");b.setAttribute("id","uiid_devicelist_"+a.rollcallid);if(0<a.rfiddeviceids.length){var c=create_rfid_devicelist_ui(a.rollcallid,a.rfiddeviceids);b.appendChild(c)}0<a.nfclocators.length&&(c=create_nfc_devicelist_ui(a.rollcallid,a.nfclocators),b.appendChild(c));0==a.rfiddeviceids.length&&0==a.nfclocators.length&&(a=create_no_device_label("\u7121"),b.appendChild(a));return b}
function create_rfid_devicelist_ui(a,b){var c=b.split(","),d=document.createElement("span");d.setAttribute("id","uiid_uhfreader_"+a);for(var f=0;f<c.length;f++){var e=document.createElement("div"),g=create_rfiddevice_label(getRFIDDeviceName(c[f]));e.appendChild(g);d.appendChild(e)}return d}
function create_nfc_devicelist_ui(a,b){var c=b.split(","),d=document.createElement("span");d.setAttribute("id","uiid_nfclocator_"+a);for(var f=0;f<c.length;f++){var e=document.createElement("div"),g=create_nfclocator_label(getNFCLocatorDeviceName(c[f]));e.appendChild(g);d.appendChild(e)}return d}
function create_rfiddevice_label(a){var b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a7d0;");b.textContent=a;return b}
function create_nfclocator_label(a){var b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#f39c12;");b.textContent=a;return b}
function create_no_device_label(a){var b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#a12409;");b.textContent=a;return b}
function create_present_label(a){var b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#3c8dbc;");b.textContent=a;return b}
function create_absent_label(a){var b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#dd4b39;");b.textContent=a;return b}
function edit_device(a){console.log("edit_device() deviceid:"+a);var b=getDevice(a);null!=b&&(create_edit_ui("uiid_name",a,b.name),create_edit_ui("uiid_type",a,b.type),create_edit_ui("uiid_ip",a,b.ip),b=document.getElementById("uiid_editbtn_"+a),b.setAttribute("title","Save this Device"),b.setAttribute("onclick",'save_device("'+a+'");return false;'),document.getElementById("uiid_editimg_"+a).setAttribute("class","fa fa-save"),document.getElementById("uiid_deletebtn_"+a).setAttribute("style","display:block"))}
function create_edit_ui(a,b,c){var d=clearChildView(a+"_"+b);a=create_input_text(a+"_"+b+"_edit",c);d.appendChild(a)}function clearChildView(a){a=document.getElementById(a);if(null!=a)for(;a.firstChild;)a.removeChild(a.firstChild);return a}function save_device(a){var b=document.getElementById("uiid_name_"+a+"_edit").value,c=document.getElementById("uiid_type_"+a+"_edit").value,d=document.getElementById("uiid_ip_"+a+"_edit").value;update_device(a,b,c,d)}
function update_device(a,b,c,d){console.log("update_device() deviceid:"+a);if(0==b.length)alert("\u8acb\u8f38\u5165\u540d\u7a31");else if(0==d.length)alert("\u8acb\u8f38\u5165IP\u4f4d\u5740");else{var f={};f.project_id=""+project_id;f.update_device=1;f.deviceid=a;f.name=b;f.type=c;f.ip=d;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:f,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,
b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}
function save_new_device(){var a=document.getElementById("input_name").value,b=document.getElementById("input_type").value,c=document.getElementById("input_ip").value;if(0==a.length)alert("\u8acb\u8f38\u5165\u540d\u7a31");else if(0==c.length)alert("\u8acb\u8f38\u5165IP\u4f4d\u5740");else{var d={};d.project_id=""+project_id;d.create_new_rfiddevice=1;d.name=a;d.type=b;d.ip=c;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:d,success:function(a){400==a.status&&alert("update Error! response = "+
JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}function confirm_delete_device(a,b,c){confirm("Are you sure you want to delete this device:"+b+" "+c+"   ?")&&delete_device(a)}
function delete_device(a){var b={};b.project_id=""+project_id;b.delete_device=1;b.deviceid=a;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:b,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,b,f){alert("error = "+f);alert("xhr.responseText = "+a.responseText)}})}$("#createnewrfiddevicebutton").click(function(){create_empty_record_table_item(gl_rfiddevices.length+1);return!1});
function reload_device_info(){PreLoadIndex=-1;CurrentLoadIndex=0;check_loading_status()}function getDevice(a){for(var b=null,c=0;c<gl_rfiddevices.length;++c){var d=gl_rfiddevices[c];if(d.deviceid===a){b=d;break}}return b}function getRollCall(a){for(var b=null,c=0;c<gl_cardrollcall.length;++c){var d=gl_cardrollcall[c];if(parseInt(d.rollcallid)==a){b=d;break}}return b}
function getUseName(a){for(var b=a,c=0;c<gl_user_info.length;++c){var d=gl_user_info[c];if(parseInt(d.userid)==a){b=d.name;break}}return b}function getRFIDDeviceName(a){for(var b=a,c=0;c<gl_rfiddevices.length;++c){var d=gl_rfiddevices[c];if(d.deviceid===a){b=d.name;break}}return b}function getNFCLocatorDeviceName(a){for(var b=a,c=0;c<gl_nfclocators.length;++c){var d=gl_nfclocators[c];if(d.macaddress===a){b=d.name;break}}return b}
function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,reload_device_info())}function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;reload_device_info()}function open_userrollcallrecord_page(){window.open("/index.php/vilsuserrollcallrecord/"+project_id,"_blank").focus()};
