var allDevicePoints={},allDeviceAliveTime={},glAnchor_List=[],glTag_List=[],glCoord_List=[],glLocator_List=[],gl_anchor_num=0,gl_tag_num=0,gl_coord_num=0,gl_locator_num=0,gl_anchor_load_index=0,gl_tag_load_index=0,gl_coord_load_index=0,gl_locator_load_index=0,LOAD_DEVICE_NUM=20,UPDATE_INTERVAL=1E3;
function create_table_item(a,c,d,b,f){if(null==b||void 0==b)return null;var e=b[2],g=get_node_type(e),h=b[0],n=b[6],l=allDeviceAliveTime[n];null==l&&(l="");b=allDevicePoints[n];null==b&&(b=[]);var m="row_"+a+"_"+n,p="row_updatetime_"+a+"_"+n;a="row_activity_"+a+"_"+n;var k=document.getElementById(m);if(null!=k)return document.getElementById(p).textContent=l,document.getElementById(a),$("#"+a).sparkline(b,{width:4*b.length,tooltipSuffix:""}),null;k=document.createElement("tr");k.setAttribute("id",
m);m=0;k.appendChild(document.createElement("td"));k.cells[m].appendChild(document.createTextNode(""+d));m++;k.appendChild(document.createElement("td"));d=document.createElement("span");"0"==e&&d.setAttribute("class","badge bg-green");"1"==e&&d.setAttribute("class","badge bg-blue");"2"==e&&d.setAttribute("class","badge bg-red");"3"==e&&d.setAttribute("class","badge bg-yellow");d.textContent=g;k.cells[m].appendChild(d);e=document.createElement("span");e.setAttribute("class","badge bg-purple-active");
f?("-1"==h&&e.setAttribute("class","badge bg-maroon-active"),e.textContent=h):e.textContent=c;k.cells[m].appendChild(e);m++;k.appendChild(document.createElement("td"));c=document.createElement("span");c.setAttribute("class","badge bg-light-yellow");c.textContent=n;k.cells[m].appendChild(c);m++;k.appendChild(document.createElement("td"));c=document.createElement("span");c.setAttribute("id",p);c.setAttribute("class","badge bg-light-yellow");c.textContent=l;k.cells[m].appendChild(c);m++;k.appendChild(document.createElement("td"));
l=document.createElement("span");l.setAttribute("id",a);k.cells[m].appendChild(l);$("#"+a).sparkline(b,{width:4*b.length,tooltipSuffix:""});return k}
function add_node_to_activity_table(a,c,d,b){for(var f=0,e=0;e<d.length;e++,b++){var g=d[e],h=g[6],n=g[1],l=allDevicePoints[h];null==l&&(l=[]);l.push(n);100<l.length&&l.splice(0,1);"0"!=n&&(devicealivetime=moment.utc().local().format("YYYY-MM-DD HH:mm:ss"),allDeviceAliveTime[h]=devicealivetime);allDevicePoints[h]=l;g=create_table_item(c,e,b,g,!0);null!=g&&a.appendChild(g);f++}return f}
function drawActivity(){null!=document.getElementById("TAG_NODE_ACTIVITY_TABLE_BODY")&&$.getJSON(gl_target_server+"/php/vilsnodes.php","devicescount=1&project_id="+project_id,function(a){gl_anchor_num=parseInt(a.LOC_ANCHOR_NUM);gl_tag_num=parseInt(a.LOC_TAG_NUM);gl_coord_num=parseInt(a.LOC_COORD_NUM);gl_locator_num=parseInt(a.LOC_LOCATOR_NUM);gl_locator_load_index=gl_coord_load_index=gl_tag_load_index=gl_anchor_load_index=0}).success(function(){setTimeout(load_anchor,10)}).error(function(){setTimeout(drawActivity,
1E3)}).complete(function(){})}
function load_anchor(){0==gl_anchor_load_index&&(glAnchor_List=[]);$.getJSON(gl_target_server+"/php/vilsnodes.php","loadanchor=1&s="+gl_anchor_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var c=parseInt(a.LOC_ANCHOR_NUM),d=gl_anchor_load_index;d<gl_anchor_load_index+c;++d){var b="LOC_ANCHOR_INDEX_"+d;void 0!=a[b]&&null!=a[b]&&(b=a[b].split(","),glAnchor_List.push(b))}gl_anchor_load_index+=c}).success(function(){if(gl_anchor_load_index>=gl_anchor_num){gl_anchor_load_index=
0;var a=document.getElementById("ANCHOR_NODE_ACTIVITY_TABLE_BODY");add_node_to_activity_table(a,"LOC",glAnchor_List,0);setTimeout(load_tag,1)}else setTimeout(load_anchor,1)}).error(function(){gl_anchor_load_index=0;setTimeout(load_anchor,UPDATE_INTERVAL)}).complete(function(){})}
function load_tag(){0==gl_tag_load_index&&(glTag_List=[]);$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtag=1&s="+gl_tag_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var c=parseInt(a.LOC_TAG_NUM),d=gl_tag_load_index;d<gl_tag_load_index+c;++d){var b="LOC_TAG_INDEX_"+d;void 0!=a[b]&&null!=a[b]&&(b=a[b].split(","),glTag_List.push(b))}gl_tag_load_index+=c}).success(function(){if(gl_tag_load_index>=gl_tag_num){gl_tag_load_index=0;var a=document.getElementById("TAG_NODE_ACTIVITY_TABLE_BODY");
add_node_to_activity_table(a,"LOC",glTag_List,0);setTimeout(load_coord,1)}else setTimeout(load_tag,1)}).error(function(){gl_tag_load_index=0;setTimeout(load_tag,UPDATE_INTERVAL)}).complete(function(){})}
function load_coord(){0==gl_coord_load_index&&(glCoord_List=[]);$.getJSON(gl_target_server+"/php/vilsnodes.php","loadcoord=1&s="+gl_coord_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var c=parseInt(a.LOC_COORD_NUM),d=gl_coord_load_index;d<gl_coord_load_index+c;++d){var b="LOC_COORD_INDEX_"+d;void 0!=a[b]&&null!=a[b]&&(b=a[b].split(","),glCoord_List.push(b))}gl_coord_load_index+=c}).success(function(){if(gl_coord_load_index>=gl_coord_num){gl_coord_load_index=0;var a=
document.getElementById("COORD_NODE_ACTIVITY_TABLE_BODY");add_node_to_activity_table(a,"LOC",glCoord_List,0);setTimeout(load_locator,1)}else setTimeout(load_coord,1)}).error(function(){gl_coord_load_index=0;setTimeout(load_coord,UPDATE_INTERVAL)}).complete(function(){})}
function load_locator(){0==gl_locator_load_index&&(glLocator_List=[]);$.getJSON(gl_target_server+"/php/vilsnodes.php","loadlocator=1&s="+gl_locator_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var c=parseInt(a.LOC_LOCATOR_NUM),d=gl_locator_load_index;d<gl_locator_load_index+c;++d){var b="LOC_LOCATOR_INDEX_"+d;void 0!=a[b]&&null!=a[b]&&(b=a[b].split(","),glLocator_List.push(b))}gl_locator_load_index+=c}).success(function(){if(gl_locator_load_index>=gl_locator_num){gl_locator_load_index=
0;var a=document.getElementById("LOCATOR_NODE_ACTIVITY_TABLE_BODY");add_node_to_activity_table(a,"LOC",glLocator_List,0);setTimeout(load_anchor,UPDATE_INTERVAL)}else setTimeout(load_locator,1)}).error(function(){gl_locator_load_index=0;setTimeout(load_anchor,UPDATE_INTERVAL)}).complete(function(){})}drawActivity();function get_node_type(a){var c="";"0"==a?c="ANCHOR":"1"==a?c="TAG":"2"==a?c="COORD":"3"==a&&(c="LOCATOR");return c}
function open_activity_page(){window.open("/index.php/vilsactivity/"+project_id,"_blank").focus()};var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glShowCount=0,glSensorInfo_List=[],glBeaconInfo_List=[],gl_SensorData_load_index=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_sensor());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_SensorData());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,show_SensorData(),show_BeaconData(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):(0==glShowCount?setTimeout(reload_page,3E3):setTimeout(reload_page,
1E4),glShowCount++)}function reload_page(){PreLoadIndex=-1;CurrentLoadIndex=0;check_loading_status()}
function load_sensor(){glSensorInfo_List=[];glBeaconInfo_List=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadsensordevice=1&project_id="+project_id,function(a){$.each(a,function(a,d){var b={};b.id=d.id;b.name=d.name;b.value=[];b.day=[];b.jsonvalue=[];b.Longitude=[];b.Latitude=[];b.datetime=[];glSensorInfo_List.push(b);"beacon"==d.type&&(b={},b.id=d.id,b.name=d.name,b.value="",b.jsonvalue=d.jsonvalue,b.datetime=moment(d.datetime,"YYYY-MM-DD HH:mm:ss"),glBeaconInfo_List.push(b))})}).success(function(){gl_SensorData_load_index=
0;CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_SensorData(){if(gl_SensorData_load_index>=glSensorInfo_List.length)CurrentLoadIndex+=1;else{for(var a=0,c="",d=gl_SensorData_load_index;d<glSensorInfo_List.length&&3>a;d++,a++){var b=glSensorInfo_List[d];0<a&&(c+=",");c+=b.id}$.getJSON(gl_target_server+"/php/vilsnodes.php","loadsensordata=1&project_id="+project_id+"&names="+c,function(b){var a=null;$.each(b,function(b,c){if(null==a||a.id!==c.name)a=get_SensorData(c.name);null!=a&&(a.value.push(c.value),a.day.push(c.day),a.jsonvalue.push(c.jsonvalue),
a.Longitude.push(c.Longitude),a.Latitude.push(c.Latitude),a.datetime.push(c.datetime));if(a.id===c.name){var d=get_BeaconData(c.name);if(null!=d){var f=moment(c.datetime,"YYYY-MM-DD HH:mm:ss");f>d.datetime&&(d.value=c.value,d.datetime=f)}}})}).success(function(){gl_SensorData_load_index+=3;gl_SensorData_load_index>=glSensorInfo_List.length?CurrentLoadIndex+=1:setTimeout(load_SensorData,1)}).error(function(){}).complete(function(){})}}
function show_SensorData(){for(var a=document.getElementById("SENSOR_NODE_ACTIVITY_TABLE_BODY"),c=0;c<glSensorInfo_List.length;c++){var d=create_SensorData_item(c,glSensorInfo_List[c]);null!=d&&a.appendChild(d)}}
function create_SensorData_item(a,c){if(null==c)return null;var d=c.datetime[0],b="row_SensorData_"+a,f="row_updatetime_SensorData_"+a,e="row_activity_SensorData_"+a,g=document.getElementById(b);if(null!=g)return document.getElementById(f).textContent=d,$("#"+e).sparkline(c.value,{width:4*c.value.length,tooltipSuffix:""}),null;g=document.createElement("tr");g.setAttribute("id",b);b=0;g.appendChild(document.createElement("td"));g.cells[b].appendChild(document.createTextNode(""+a));b++;g.appendChild(document.createElement("td"));
var h=document.createElement("span");h.setAttribute("class","badge bg-green");h.textContent=c.name;g.cells[b].appendChild(h);b++;g.appendChild(document.createElement("td"));h=document.createElement("span");h.setAttribute("id",f);h.setAttribute("class","badge bg-light-yellow");h.textContent=d;g.cells[b].appendChild(h);b++;g.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("id",e);g.cells[b].appendChild(d);return g}
function show_BeaconData(){for(var a=document.getElementById("BEACON_NODE_ACTIVITY_TABLE_BODY");a.firstChild;)a.removeChild(a.firstChild);glBeaconInfo_List=glBeaconInfo_List.sort(function(a,c){return c.datetime-a.datetime});for(var c=0;c<glBeaconInfo_List.length;c++){var d=create_BeaconData_item(c,glBeaconInfo_List[c]);null!=d&&a.appendChild(d)}}
function create_BeaconData_item(a,c){if(null==c||void 0==c.datetime)return null;var d=c.datetime.format("YYYY-MM-DD HH:mm:ss"),b=moment().diff(c.datetime),f=document.createElement("tr");15E3<=b&&f.setAttribute("style","background-color:rgb(125, 120, 120);");b=0;f.appendChild(document.createElement("td"));f.cells[b].appendChild(document.createTextNode(""+a));b++;f.appendChild(document.createElement("td"));var e=document.createElement("span");e.setAttribute("class","badge bg-green");e.textContent=c.name;
f.cells[b].appendChild(e);b++;f.appendChild(document.createElement("td"));e=document.createElement("span");e.setAttribute("class","badge bg-light-yellow");e.textContent=d;f.cells[b].appendChild(e);b++;f.appendChild(document.createElement("td"));d=document.createElement("span");d.textContent=c.value+"  "+c.jsonvalue;f.cells[b].appendChild(d);return f}function get_SensorData(a){for(var c=0;c<glSensorInfo_List.length;c++){var d=glSensorInfo_List[c];if(d.id===a)return d}return null}
function get_BeaconData(a){for(var c=0;c<glBeaconInfo_List.length;c++){var d=glBeaconInfo_List[c];if(d.id===a)return d}return null};
