var LOAD_PAGE_NUM=20,rfidcards_PreLoadIndex=-1,rfidcards_CurrentLoadIndex=0,LOAD_STATE_END=9999,rfidcards_glCurrentPage=1,gl_notOnLinelist_rfidcards=[],gl_OnLinelist_rfidcards=[];check_rfidcards_loading_status();
function check_rfidcards_loading_status(){switch(rfidcards_CurrentLoadIndex){case 0:rfidcards_PreLoadIndex!=rfidcards_CurrentLoadIndex&&(rfidcards_PreLoadIndex=rfidcards_CurrentLoadIndex,load_rfidcard());break;case 1:rfidcards_PreLoadIndex!=rfidcards_CurrentLoadIndex&&(rfidcards_PreLoadIndex=rfidcards_CurrentLoadIndex,draw_rfidcard_table(),rfidcards_CurrentLoadIndex+=1);break;case 2:rfidcards_PreLoadIndex!=rfidcards_CurrentLoadIndex&&(rfidcards_PreLoadIndex=rfidcards_CurrentLoadIndex,rfidcards_CurrentLoadIndex=
LOAD_STATE_END)}rfidcards_CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_rfidcards_loading_status,100):setTimeout(reload_rficcard_info,1E4)}
function load_rfidcard(){if("activetab_uhfcards"===gl_activetab){var c=(rfidcards_glCurrentPage-1)*LOAD_PAGE_NUM,a=LOAD_PAGE_NUM,b=gl_showfilter_showonline?1:0,d=gl_showfilter_showoffline?1:0;gl_notOnLinelist_rfidcards=[];gl_OnLinelist_rfidcards=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcard=1&s="+c+"&count="+a+"&project_id="+project_id+"&showonline="+b+"&showoffline="+d,function(a){$.each(a,function(a,b){"0"===b.alive?gl_notOnLinelist_rfidcards.push(b):gl_OnLinelist_rfidcards.push(b)})}).success(function(){rfidcards_CurrentLoadIndex+=
1}).error(function(){}).complete(function(){})}else setTimeout(load_rfidcard,1E3)}function create_input_text(c,a){var b=document.createElement("textarea");b.setAttribute("rows","1");b.setAttribute("id",c);b.textContent=a;return b}
function draw_rfidcard_table(){for(var c=document.getElementById("RFID_CARD_TABLE");1<=c.rows.length;)c.deleteRow(0);if(gl_showfilter_showonline)for(var a=0;a<gl_OnLinelist_rfidcards.length;++a){var b=gl_OnLinelist_rfidcards[a],d=(rfidcards_glCurrentPage-1)*LOAD_PAGE_NUM,b=rfidcards_create_record_table_item(d+a,b);c.appendChild(b)}if(gl_showfilter_showoffline)for(a=0;a<gl_notOnLinelist_rfidcards.length;++a)b=gl_notOnLinelist_rfidcards[a],d=(rfidcards_glCurrentPage-1)*LOAD_PAGE_NUM,b=rfidcards_create_record_table_item(d+
a,b),c.appendChild(b)}
function rfidcards_create_record_table_item(c,a){if(null==a)return null;var b=document.createElement("tr");"0"===a.alive?b.setAttribute("bgcolor","#a3c2c2"):b.setAttribute("bgcolor","#FFFFFF");var d=a.cardid;"0"!==a.userid&&(d=findUserName(a.userid));var f=0;b.appendChild(document.createElement("td"));b.cells[f].appendChild(document.createTextNode(""+c));f++;b.appendChild(document.createElement("td"));if("0"!=a.alive){var e=document.createElement("span");e.setAttribute("class","badge bg-fuchsia");
e.textContent=a.alive;b.cells[f].appendChild(e)}f++;b.appendChild(document.createElement("td"));e=document.createElement("span");e.setAttribute("id","uiid_name_"+a.cardid);e.setAttribute("class","badge bg-yellow-active");e.textContent=0<a.name.length?a.name:d;b.cells[f].appendChild(e);if(edit_node_info){e=document.createElement("a");e.setAttribute("id","uiid_name_"+a.cardid+"_NODNAME_EDIT");e.setAttribute("href","javascript:;");e.setAttribute("onclick",'edit_rfidcard_name("'+a.cardid+'","'+d+'");return false;');
var g=document.createElement("i");g.setAttribute("class","fa fa-edit");e.appendChild(g);b.cells[f].appendChild(e)}f++;e=document.createElement("td");e.setAttribute("id","uiid_type_"+a.cardid);b.appendChild(e);g=document.createElement("span");g.setAttribute("class","badge bg-green-active");g.textContent="0"===a.userid?"\u5361\u7247":"\u4eba\u54e1\u914d\u6234";e.appendChild(g);f++;e=document.createElement("td");e.setAttribute("id","uiid_id_"+a.cardid);b.appendChild(e);g=document.createElement("span");
g.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");g.textContent=a.cardid;e.appendChild(g);f++;e=document.createElement("td");e.setAttribute("id","uiid_id_"+a.cardid);b.appendChild(e);"0"!==a.userid&&(g=document.createElement("span"),g.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:1;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:rgb(54, 127, 169);"),g.textContent=d,e.appendChild(g));
f++;b.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("id","uiid_maplayer_"+a.cardid);d.setAttribute("class","label label-primary");d.textContent=get_maplayer_name(a.maplayer);b.cells[f].appendChild(d);f++;d=document.createElement("td");b.appendChild(d);d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("class","btn btn-default");d.setAttribute("data-toggle","modal");d.setAttribute("data-target","#modal-qrcode");d.setAttribute("onclick",
'device_card_qrcode_show("'+a.cardid+'");return false;');e=document.createElement("i");e.setAttribute("class","fa fa-qrcode");d.appendChild(e);b.cells[f].appendChild(d);edit_node_info&&(d=document.createElement("button"),d.setAttribute("id","uiid_deletebtn_"+a.cardid),d.setAttribute("title","Delete This Card"),d.setAttribute("href","javascript:;"),d.setAttribute("onclick",'confirm_delete_card("'+a.cardid+'");return false;'),e=document.createElement("i"),e.setAttribute("class","fa fa-user-times"),
d.appendChild(e),b.cells[f].appendChild(d));return b}function edit_rfidcard_name(c,a){console.log("edit_rfidcard_name() cardid:"+c+" cardname:"+a);var b=prompt("\u7de8\u8f2fUHF\u5361\u7247\u540d\u7a31:",a);b&&(document.getElementById("uiid_name_"+c).innerText=b,update_rfidcard_name(c,b))}
function device_card_qrcode_show(c){console.log("device_card_qrcode_show() cardid:"+c);document.getElementById("device_qrcode_type").textContent="Type: CARD";document.getElementById("device_qrcode_name").textContent="";document.getElementById("device_qrcode_macaddress").textContent="\u5361\u7247ID: "+c;jQuery.ajax({url:gl_target_server+"/php/configvils.php",type:"POST",data:"loadqrcode=1&type=CARD&accountid="+c+"&id="+c+"&project_id="+project_id,dataType:"text",success:function(a){a=JSON.parse(a);
document.getElementById("device_qrcode_ui").setAttribute("src",a.qrcode);document.getElementById("device_qrcode_target").textContent="target: "+a.target;document.getElementById("device_qrcode_topic").textContent="topic: "+a.topic;document.getElementById("device_qrcode_datetime").textContent="\u66f4\u65b0\u6642\u9593: "+a.datetime}})}
function update_rfidcard_name(c,a){if(0==a.length)alert("\u8acb\u8f38\u5165\u540d\u7a31");else{var b={};b.project_id=""+project_id;b.update_rfidcard_name=1;b.cardid=c;b.cardname=a;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:b,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a))},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}
function confirm_delete_card(c){confirm("Are you sure you want to delete this card:"+c+"   ?")&&delete_card(c)}function delete_card(c){var a={};a.project_id=""+project_id;a.delete_card=1;a.cardid=c;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:a,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a))},error:function(a,c,f){alert("error = "+f);alert("xhr.responseText = "+a.responseText)}})}
$("#scannewrfidcardbutton").click(function(){var c={};c.project_id=""+project_id;c.scan_rfidcard=1;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:c,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a))},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}});return!1});function reload_rficcard_info(){rfidcards_PreLoadIndex=-1;rfidcards_CurrentLoadIndex=0;check_rfidcards_loading_status()}
function rfidcards_move_page_backward(){var c=document.getElementById("rfidcards_id_current_page_num");1>=rfidcards_glCurrentPage||(rfidcards_glCurrentPage--,c.textContent=rfidcards_glCurrentPage)}function rfidcards_move_page_forward(){var c=document.getElementById("rfidcards_id_current_page_num");rfidcards_glCurrentPage++;c.textContent=rfidcards_glCurrentPage}function open_rfidcards_page(){window.open("/index.php/vilsrfidcards/"+project_id,"_blank").focus()};
