var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glCurrentPage=1,LOAD_PAGE_NUM=20,gl_usersubgroups=[],gl_billboard_List=[],pre_input_title_value="",pre_input_date_value="";check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usersubgroup());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_billboard_records());break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_billboard_records(),CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_usersubgroup(){gl_usersubgroups=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,b){b.subgroupid=parseInt(b.subgroupid);gl_usersubgroups.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_billboard_records(){var a=document.getElementById("search_billboard_title_text").value,d=document.getElementById("search_billboard_date_text").value;pre_input_title_value=a;pre_input_date_value=d;var b=gl_target_server+"/php/pushnotify.php",c=(glCurrentPage-1)*LOAD_PAGE_NUM,e=LOAD_PAGE_NUM;gl_billboard_List=[];c="loadbillboardrecords=1&project_id="+project_id+"&offset="+c+"&count="+e;0<a.length&&(c=c+"&searchtitle="+a);0<d.length&&(c=c+"&searchdate="+d);$.getJSON(b,c,function(a){$.each(a,
function(a,b){gl_billboard_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}function show_billboard_records(){for(var a=document.getElementById("table_content");a.firstChild;)a.removeChild(a.firstChild);for(var d=0;d<gl_billboard_List.length;d++)show_billboard(a,(glCurrentPage-1)*LOAD_PAGE_NUM+d+1,gl_billboard_List[d])}
function show_billboard(a,d,b){var c=0,e=document.createElement("tr");e.setAttribute("id",b.id+"_TABLE_ROW");0==d%2&&e.setAttribute("bgcolor","#ebebe0");a.appendChild(e);var f=document.createElement("tr");f.setAttribute("id",b.id+"_TABLE_ROW_EXTRA");a.appendChild(f);e.appendChild(document.createElement("td"));e.cells[c].appendChild(document.createTextNode(""+d));0<b.imageids.length&&(a=document.createElement("a"),a.setAttribute("id",b.id+"_billboard_detail_button"),a.setAttribute("title","\u986f\u793a\u8a73\u7d30\u8cc7\u8a0a"),
a.setAttribute("onclick",'open_billboard_detail("'+b.id+'", "'+b.imageids+'");'),a.setAttribute("class","btn btn-default btn-xs pull-right"),d=document.createElement("i"),d.setAttribute("id",b.id+"_billboard_detail_icon"),d.setAttribute("class","fa fa-plus text-green"),a.appendChild(d),e.cells[c].appendChild(a));c++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","title_"+b.id);a.appendChild(document.createTextNode(b.title));e.cells[c].appendChild(a);
c++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","description_"+b.id);a.appendChild(document.createTextNode(b.content));e.cells[c].appendChild(a);c++;a=create_subgroup(b.subgroupids);a.setAttribute("id","uiid_subgroup_"+b.id);e.appendChild(a);c++;e.appendChild(document.createElement("td"));a=document.createElement("span");a.setAttribute("class","label label-info");a.textContent=b.datetime;e.cells[c].appendChild(a);c++;3!=gl_groupid&&(e.appendChild(document.createElement("td")),
a=document.createElement("button"),a.setAttribute("id","uiid_deletebtn_"+b.id),a.setAttribute("title","Delete This Record"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick",'confirm_delete_record("'+b.title+'", "'+b.id+'");return false;'),b=document.createElement("i"),b.setAttribute("class","fa fa-trash"),a.appendChild(b),e.cells[c].appendChild(a))}
function open_billboard_detail(a,d){var b=document.getElementById(a+"_billboard_detail_button");b.setAttribute("title","\u95dc\u9589\u8a73\u7d30\u8cc7\u8a0a");b.setAttribute("onclick",'close_billboard_detail("'+a+'", "'+d+'");');document.getElementById(a+"_billboard_detail_icon").setAttribute("class","fa fa-minus text-red");var c=document.getElementById(a+"_TABLE_ROW_EXTRA");c.setAttribute("bgcolor","#ebebe0");c.appendChild(document.createElement("td"));b=document.createElement("td");b.setAttribute("colspan",
"4");c.appendChild(b);c=document.createElement("div");c.setAttribute("class","row");c.setAttribute("id","notify_image_"+a);b.appendChild(c);load_billboard_images(a,d)}
function close_billboard_detail(a,d){var b=document.getElementById(a+"_billboard_detail_button");b.setAttribute("title","\u986f\u793a\u8a73\u7d30\u8cc7\u8a0a");b.setAttribute("onclick",'open_billboard_detail("'+a+'", "'+d+'");');document.getElementById(a+"_billboard_detail_icon").setAttribute("class","fa fa-plus text-green");clearChildView(a+"_TABLE_ROW_EXTRA")}function load_billboard_images(a,d){for(var b=d.split(","),c=0;c<b.length;c++)load_billboard_image(a,b[c])}
function load_billboard_image(a,d){$.getJSON(gl_target_server+"/php/storage.php","loadsingleimage=1&project_id="+project_id+"&imageuid="+d,function(b){var c="show_img_area_"+d;if(void 0==document.getElementById(c)){var e=document.getElementById("notify_image_"+a);b=create_data_image("\u516c\u544a\u7167\u7247",a,b);b.setAttribute("id",c);e.appendChild(b)}}).success(function(){}).error(function(){}).complete(function(){})}
function create_data_image(a,d,b){d=document.createElement("div");d.setAttribute("class","col-xs-12 col-md-6 col-lg-4");var c=document.createElement("ul");c.setAttribute("class","mailbox-attachments clearfix");d.appendChild(c);var e=document.createElement("li");e.setAttribute("style","background-color:white;");c.appendChild(e);c=document.createElement("span");c.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");c.textContent=a;e.appendChild(c);a=document.createElement("div");
e.appendChild(a);c=document.createElement("span");c.setAttribute("class","label label-info");c.textContent=convertPrettyDateOnly(b.updatetime,"+00:00");a.appendChild(c);c=document.createElement("span");c.setAttribute("class","label label-warning");c.textContent=convertPrettyTimeOnly(b.updatetime,"+00:00");a.appendChild(c);a=document.createElement("span");a.setAttribute("class","mailbox-attachment-icon has-img");e.appendChild(a);c=document.createElement("img");c.setAttribute("src","/php/downloadfile.php?loadthumb=1&project_id="+
project_id+"&imageid="+b.id);c.setAttribute("alt","Attachment");a.appendChild(c);a=document.createElement("div");a.setAttribute("class","mailbox-attachment-info");e.appendChild(a);e=document.createElement("a");e.setAttribute("href","/php/downloadfile.php?project_id="+project_id+"&imageid="+b.id);e.setAttribute("class","mailbox-attachment-name");a.appendChild(e);e.appendChild(document.createTextNode("  "+b.description));a=document.createElement("span");a.setAttribute("class","mailbox-attachment-size");
a.textContent=convertFileSize(parseInt(b.imagesize));e.appendChild(a);e=document.createElement("a");e.setAttribute("href","/php/downloadfile.php?project_id="+project_id+"&imageid="+b.id);e.setAttribute("class","btn btn-default btn-xs pull-right");a.appendChild(e);b=document.createElement("i");b.setAttribute("class","fa fa-cloud-download");e.appendChild(b);return d}
function convertFileSize(a){return 1048576<a?(Math.round(100*a/1048576)/100).toString()+"MB":(Math.round(100*a/1024)/100).toString()+"KB"}
function create_subgroup(a){var d=document.createElement("td");a=a.split(",");if(0<=a.indexOf("99999")){var b=document.createElement("div");b.appendChild(create_subgroup_label("\u5168\u90e8"));d.appendChild(b)}else for(var c=0,b=void 0,e=0;e<a.length;e++){var f=parseInt(a[e]),f=getSubgroupName(f);0<f.length&&(0==c&&(b=document.createElement("div"),d.appendChild(b)),b.appendChild(create_subgroup_label(f)),b.appendChild(create_empty_spcae()),c++,5<=c&&(c=0))}return d}
function create_subgroup_label(a){var d=document.createElement("span");d.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a65a;");d.textContent=a;return d}
function create_empty_spcae(){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;");a.textContent="  ";return a}var gl_search_title_start=0;
function search_billboard_title_text_change(){var a=document.getElementById("search_billboard_title_text").value;if(a===pre_input_title_value)console.log("search_billboard_title_text_change() input_value === pre_input_title_value, input_value:"+a);else return gl_search_title_start=0,glCurrentPage=1,reload_page(),!1}
function check_search_billboard_title_text(a){0==gl_search_title_start&&(gl_search_title_start=new Date);a=((new Date).getTime()-gl_search_title_start.getTime())/1E3;CurrentLoadIndex!=LOAD_STATE_END?(console.log("check_search_billboard_title_text() CurrentLoadIndex != LOAD_STATE_END"),setTimeout(search_billboard_title_text_change,500)):1<=a?(gl_search_title_start=0,search_billboard_title_text_change()):setTimeout(search_billboard_title_text_change,500)}var gl_search_date_start=0;
function search_billboard_date_text_change(){var a=document.getElementById("search_billboard_date_text").value;if(a===pre_input_title_value)console.log("search_billboard_date_text_change() input_value === pre_input_title_value, input_value:"+a);else return gl_search_date_start=0,glCurrentPage=1,reload_page(),!1}
function check_search_billboard_date_text(a){0==gl_search_date_start&&(gl_search_date_start=new Date);a=((new Date).getTime()-gl_search_date_start.getTime())/1E3;CurrentLoadIndex!=LOAD_STATE_END?(console.log("check_search_billboard_date_text() CurrentLoadIndex != LOAD_STATE_END"),setTimeout(search_billboard_date_text_change,500)):1<=a?(gl_search_date_start=0,search_billboard_date_text_change()):setTimeout(search_billboard_date_text_change,500)}
function confirm_delete_record(a,d){confirm("\u78ba\u5b9a\u522a\u9664\u516c\u544a\u4e8b\u9805:"+a+"   ?")&&delete_record(d)}
function delete_record(a){var d={};d.project_id=""+project_id;d.delete_billboard=1;d.recordid=a;jQuery.ajax({url:gl_target_server+"/php/pushnotify.php",type:"POST",data:d,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));glCurrentPage=1;reload_page()},error:function(a,c,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}})}var $source=document.querySelector("#search_billboard_title_text");$source.addEventListener("input",check_search_billboard_title_text);
var $source_date=document.querySelector("#search_billboard_date_text");$source_date.addEventListener("input",check_search_billboard_date_text);function getSubgroupName(a){var d="";if("99999"==a)return"\u5168\u90e8";for(var b=0;b<gl_usersubgroups.length;++b){var c=gl_usersubgroups[b];if(c.subgroupid==a){d=c.subgroupname;break}}return d}function clearChildView(a){a=document.getElementById(a);if(null!=a)for(;a.firstChild;)a.removeChild(a.firstChild);return a}
function reload_page(){PreLoadIndex=0;CurrentLoadIndex=1;check_loading_status()}function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,reload_page())}function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;reload_page()}
function convertPrettyDateOnly(a,d){var b=moment.utc(a,"YYYY-MM-DD HH:mm:ss").utcOffset(d),c=b.format("YYYY"),e=b.format("M"),b=b.format("D");return c+"\u5e74"+e+"\u6708"+b+"\u65e5 "}function convertPrettyTimeOnly(a,d){var b=moment.utc(a,"YYYY-MM-DD HH:mm:ss").utcOffset(d),c=b.hour(),e=b.minutes(),b=b.seconds(),f="";0<=c&&(f+=c+"\u9ede");0<=e&&(f+=e+"\u5206");0<=b&&(f+=b+"\u79d2");return f}
function open_billboardrecords_page(){window.open("/index.php/vilsbillboardrecords/"+project_id,"_blank").focus()};
