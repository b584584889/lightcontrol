var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=b.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,e={next:function(){if(b<a.length){var g=b++;return{value:d(g,a[g]),done:!1}}e.next=function(){return{done:!0,value:void 0}};return e.next()}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill=function(a,d,b,e){if(d){b=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var g=a[e];g in b||(b[g]={});b=b[g]}a=a[a.length-1];e=b[a];d=d(e);d!=e&&null!=d&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
L.ImageOverlay.Rotated=L.ImageOverlay.extend({initialize:function(a,d,b,e,g){"string"===typeof a?this._url=a:this._rawImage=a;this._topLeft=L.latLng(d);this._topRight=L.latLng(b);this._bottomLeft=L.latLng(e);L.setOptions(this,g)},onAdd:function(a){this._image||(this._initImage(),1>this.options.opacity&&this._updateOpacity());this.options.interactive&&(L.DomUtil.addClass(this._rawImage,"leaflet-interactive"),this.addInteractiveTarget(this._rawImage));a.on("zoomend resetview",this._reset,this);this.getPane().appendChild(this._image);
this._reset()},onRemove:function(a){a.off("zoomend resetview",this._reset,this);L.ImageOverlay.prototype.onRemove.call(this,a)},_initImage:function(){var a=this._rawImage;this._url&&(a=L.DomUtil.create("img"),a.style.display="none",this.options.crossOrigin&&(a.crossOrigin=""),a.src=this._url,this._rawImage=a);L.DomUtil.addClass(a,"leaflet-image-layer");var d=this._image=L.DomUtil.create("div","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));this._updateZIndex();d.appendChild(a);
d.onselectstart=L.Util.falseFn;d.onmousemove=L.Util.falseFn;a.onload=function(){this._reset();a.style.display="block";this.fire("load")}.bind(this);a.alt=this.options.alt},_reset:function(){var a=this._image;if(void 0!=this._map){var d=this._map.latLngToLayerPoint(this._topLeft),b=this._map.latLngToLayerPoint(this._topRight),e=this._map.latLngToLayerPoint(this._bottomLeft),g=b.subtract(d).add(e),h=L.bounds([d,b,e,g]),l=h.getSize(),g=d.subtract(h.min),q=b.subtract(d),t=e.subtract(d),q=Math.atan2(q.y,
q.x),t=Math.atan2(t.x,t.y);this._bounds=L.latLngBounds(this._map.layerPointToLatLng(h.min),this._map.layerPointToLatLng(h.max));L.DomUtil.setPosition(a,h.min);a.style.width=l.x+"px";a.style.height=l.y+"px";h=this._rawImage.width;a=this._rawImage.height;h&&a&&(b=d.distanceTo(b)/h*Math.cos(q),d=d.distanceTo(e)/a*Math.cos(t),this._rawImage.style.transformOrigin="0 0",this._rawImage.style.transform="translate("+g.x+"px, "+g.y+"px)skew("+t+"rad, "+q+"rad) scale("+b+", "+d+") ")}},reposition:function(a,
d,b){this._topLeft=L.latLng(a);this._topRight=L.latLng(d);this._bottomLeft=L.latLng(b);this._reset()},setUrl:function(a){this._url=a;this._rawImage&&(this._rawImage.src=a);return this}});L.imageOverlay.rotated=function(a,d,b,e,g){return new L.ImageOverlay.Rotated(a,d,b,e,g)};var Indoor2DMap=function(a){function d(f,k){return FloatDiv(k,11132E3*Math.cos(f*Math.PI/180))}function b(f,k){return FloatMul(k,11132E3*Math.cos(f*Math.PI/180))}this.mEnableUISmoothing=!0;this.SHOW_LOCATOR_DEFAULT=this.SHOW_AREA_DEFAULT=!1;var e=function(f,k){return L.Util.isArray(f)?L.latLng(f[1],f[0]):L.latLng(k,f)},g=L.icon({iconUrl:"/images/orig-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),
h=L.icon({iconUrl:"/images/coord-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),l=L.icon({iconUrl:"/images/marker-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),q=L.icon({iconUrl:"/images/tag-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,
47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),t=L.icon({iconUrl:"/images/marker-sleep-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),p=L.icon({iconUrl:"/images/marker-sleep-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),u=L.icon({iconUrl:"/images/anchor-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),w=L.icon({iconUrl:"/images/locator-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),E=L.icon({iconUrl:"/images/locator-notalive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),F=L.icon({iconUrl:"/images/locator-poweroff-icon-2x.png",
shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),G=L.icon({iconUrl:"/images/gray-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),H=L.icon({iconUrl:"/images/gray-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,
-35]}),I=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]});L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[50,74],shadowSize:[41,41],iconAnchor:[25,74],shadowAnchor:[14,41],popupAnchor:[0,-35]});var J=L.icon({iconUrl:"/images/inactive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,
37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),K=L.icon({iconUrl:"/images/inactive-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),M=L.icon({iconUrl:"/images/norollcall-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),N=L.icon({iconUrl:"/images/norollcall-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),y=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),z=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),A=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),x=L.icon({iconUrl:"/images/pin_lidar.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),B=L.icon({iconUrl:"/images/pin_user.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),C="#FF6347 #FFA500 #FFD700 #32CD32 #87CEEB #7B68EE #8A2BE2 #4245f4 #F08080 #f441d9".split(" ");
this.mMapLayer_nodes=[];this.mMapLayerId=1;this.OriginMarker=null;this.Anchors=[];this.Tags=[];this.Coords=[];this.Locators=[];this.Sensors=[];this.Users=[];this.TagDrawList=[];this.TagGPSDrawList=[];this.MapAreas=[];this.AddressList=[];this.AlertIconScaleIndexList=[];this.AlertIconScaleUpDownList=[];this.StreetMaps=[[]];this.NodeAlertFunction=[];this.areaborder_color="#8b95aa";this.areaborder_opacity="0.8";this.FadeOutPolylines=[[]];this.FadeOutNodes=[[]];this.mRotateMap=this.mShowTrack=!1;this.mTargetDragCallback=
this.mEditModeCallback=this.mNodeClickCallback=this.mUpdateMapInfoCallback=this.mOrigNodeDragCallback=this.mNodeDragCallback=null;this.mEdit_delete_mode=this.mEdit_mode=!1;this.mEdit_maparea_index=-1;this.mLayerControl=this.mUsermapScaleDown=this.mUsermapScaleUp=this.mUsermapEdit=null;this.mMap_OrigY=this.mMap_OrigX=this.mMap_coeff=this.mMap_scale=this.mUsermap_height=this.mUsermap_width=this.mMAP_North=this.mWGS48OriginY=this.mWGS48OriginX=0;this.mBounds=[e(0,0),e(1E3,1E3)];this.mUserProject_Name=
this.mUserMap_url=this.mUserMaplayer=null;this.smoothing_time=400;this.move_step_size=6;this.move_loop_count=0;this.GPS_smoothing_time=400;this.GPS_move_step_size=10;this.GPS_move_loop_count=0;this.popupZoom=20;this.mDrawControl=null;this.baseLayers={};this.layer_areas=new L.FeatureGroup;this.overlays={};L.Map=L.Map.extend({openPopup:function(f,k,c){f instanceof L.Popup||(f=(new L.Popup(c)).setContent(f));k&&f.setLatLng(k);if(this.hasLayer(f))return this;this._popup=f;return this.addLayer(f)}});this.mMap=
L.map(a,{maxZoom:26,zoomSnap:0,zoomDelta:.25,doubleClickZoom:!1});this.mLayerControl=L.control.layers().addTo(this.mMap);this.mMap.attributionControl.setPrefix('<a href="http://smims.com">SMIMS</a>');this.mMap.orig_this=this;a=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:26,attribution:'&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'});var D=L.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,
subdomains:["mt0","mt1","mt2","mt3"]}),O=L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,subdomains:["mt0","mt1","mt2","mt3"]});this.mLayerControl.addOverlay(a,"OpenStreetMap");this.mLayerControl.addOverlay(D,"Google Streets");this.mLayerControl.addOverlay(O,"Google Satellite");this.StreetMaps.OpenStreetMap=0;this.StreetMaps["Google Streets"]=0;this.StreetMaps["Google Satellite"]=0;Indoor2DMap.prototype.create_alert_scale_icon=function(){var f;for(f=
0;10>f;f++){var k=25*(1+.1*f),c=37*(1+.1*f),k=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[k,c],shadowSize:[41,41],iconAnchor:[k/2,c],shadowAnchor:[14,41],popupAnchor:[0,-35]});this.AlertIconScaleUpDownList[f]=k}};Indoor2DMap.prototype.onOverlayAdd=function(f){f.name in this.orig_this.StreetMaps&&(this.orig_this.StreetMaps[f.name]=1,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.onOverlayRemove=function(f){f.name in this.orig_this.StreetMaps&&
(this.orig_this.StreetMaps[f.name]=0,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.updateMapRotate=function(f){var k=!1;for(map in f.StreetMaps)if(1==f.StreetMaps[map]){k=!0;break}f.mRotateMap=k;f.update_2d_map(f);f.update_node_pos(f,f.Anchors);f.update_node_pos(f,f.Coords);f.load_allmaparea(f)};Indoor2DMap.prototype.update_2d_map=function(f){null!=f.mUserMaplayer&&f.mMap.removeLayer(f.mUserMaplayer);var k=FloatDiv(f.mUsermap_width,f.mMap_scale*f.mMap_coeff),c=FloatDiv(f.mUsermap_height,
f.mMap_scale*f.mMap_coeff),a=f.mWGS48OriginY+FloatDiv(FloatMul(f.mMap_OrigY,-1),11057400),b=f.mWGS48OriginX+d(a,FloatMul(f.mMap_OrigX,-1)),a=e(b,a),b=FloatDiv(1E4,11057400),g=d(f.mWGS48OriginY+b,1E4),k=e(a.lng+k,a.lat+b/g*c);f.mBounds=[a,k];b=new L.latLng(f.mBounds[1].lat,f.mBounds[0].lng);g=new L.latLng(f.mBounds[1].lat,f.mBounds[1].lng);k=new L.latLng(f.mBounds[0].lat,f.mBounds[0].lng);c=new L.latLng(f.mWGS48OriginY,this.mWGS48OriginX);a=0;f.mRotateMap&&(a=f.mMAP_North);b=rotatePoint(b,a,c);g=rotatePoint(g,
a,c);k=rotatePoint(k,a,c);f.mUserMaplayer=L.imageOverlay.rotated(f.mUserMap_url,b,g,k,{opacity:.5,interactive:!0,attribution:f.mUserProject_Name});f.mMap.addLayer(f.mUserMaplayer,f.mUserProject_Name)};Indoor2DMap.prototype.update_node_pos=function(f,k){for(var c=0;c<k.length;c++){var a=k[c];if(null!=a){var b=f.convertToLatLng(f,a.posX,a.posY);a.setLatLng(b)}}};Indoor2DMap.prototype.setMapCoeff=function(f,k,c,a,b,g,h,P,l){null==f&&(f=0);null==k&&(k=0);this.mWGS48OriginX=parseFloat(h);this.mWGS48OriginY=
parseFloat(P);this.mMAP_North=parseFloat(l);this.mUsermap_width=parseInt(c);this.mUsermap_height=parseInt(a);this.mMap_scale=parseFloat(b);this.mMap_coeff=parseFloat(g);this.mMap_OrigX=parseFloat(f);this.mMap_OrigY=parseFloat(k);f=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);k=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);c=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);a=this.mWGS48OriginX+d(c,FloatMul(this.mMap_OrigX,-1));c=e(a,c);a=FloatDiv(1E4,
11057400);b=d(this.mWGS48OriginY+a,1E4);f=e(c.lng+f,c.lat+a/b*k);this.mBounds=[c,f]};Indoor2DMap.prototype.setMapImage=function(f,k){this.mUserMap_url=f;this.mUserProject_Name=k;this.update_2d_map(this);this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]});this.mMap.zoomControl.setPosition("topright");L.control.scale({imperial:!1,maxWidth:300}).addTo(this.mMap);this.mLayerControl.addOverlay(this.layer_areas,"Areas");1==this.SHOW_AREA_DEFAULT&&this.mMap.addLayer(this.layer_areas,"Areas");this.create_map_action(this.mMap)};
Indoor2DMap.prototype.setMapLayerInfo=function(f){this.mMapLayerId=f};Indoor2DMap.prototype.changeUserMap=function(f,k,c){this.mUserMap_url=f;this.mMap.removeLayer(this.mUserMaplayer);this.mUsermap_width=k;this.mUsermap_height=c;f=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);k=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);c=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);var a=this.mWGS48OriginX+d(c,FloatMul(this.mMap_OrigX,-1));c=e(a,c);var a=
FloatDiv(1E4,11057400),b=d(this.mWGS48OriginY+a,1E4);f=e(c.lng+f,c.lat+a/b*k);this.mBounds=[c,f];this.mUserMaplayer=L.imageOverlay(this.mUserMap_url,this.mBounds,{attribution:this.mUserProject_Name,opacity:.5});this.mMap.addLayer(this.mUserMaplayer,this.mUserProject_Name)};Indoor2DMap.prototype.editmode=function(){return this.mEdit_mode};Indoor2DMap.prototype.setShowTrack=function(f){this.mShowTrack=f};Indoor2DMap.prototype.refresh=function(){var f=this.mMap.getZoom();this.mMap._onResize();0==f&&
setTimeout(this.fitBounds,100,this)};Indoor2DMap.prototype.fitBounds=function(f){f.mMap.fitBounds(f.mBounds,{paddingTopLeft:[0,0]})};Indoor2DMap.prototype.setBounds=function(f,k,c,a){c=e(a,c);f=e(k,f);this.mBounds=[c,f];this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]})};Indoor2DMap.prototype.clearAddressTarget=function(){for(var f=this.getCurrentLayer("Origin",this.mMapLayerId),k=0;k<this.AddressList.length;k++)f.removeLayer(this.AddressList[k]);this.AddressList=[]};Indoor2DMap.prototype.setTargetLocation=
function(f,k,c){for(var a,b=!1,d=0;d<this.AddressList.length;d++){var h=this.AddressList[d];if(h.name===f){b=!0;a=h;break}}0==b&&(a=f+"&nbsp;&nbsp;&nbsp;&nbsp;<br>",a=L.popup({closeOnClick:!1,autoClose:!1}).setContent(a),b=e(c,k),a=L.marker(b,{title:f,draggable:!1}).bindPopup(a),a.name=f,a.orig_this=this,a.setIcon(g),this.AddressList.push(a),a.on("click",this.markerOnClick),a.on("dragend",function(f){f=f.target;var c=f.orig_this,k=f.getLatLng();"function"===typeof c.mTargetDragCallback&&c.mTargetDragCallback(c.mMapLayerId,
f.name,k.lat,k.lng)}),f=this.getCurrentLayer("Origin",this.mMapLayerId),a.addTo(f));k=e(c,k);a.setLatLng(k)};Indoor2DMap.prototype.setUISmoothing=function(f){f&&!this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,100,this),setTimeout(this.draw_tag_GPS_smooth_move,100,this));this.mEnableUISmoothing=f};Indoor2DMap.prototype.markerOnClick=function(f){this.orig_this.markclick(f.target.type,f.target.index);"function"===typeof this.orig_this.mNodeClickCallback&&this.orig_this.mNodeClickCallback(f.target)};
Indoor2DMap.prototype.mapAreaOnClick=function(f){var k=f.target.orig_this;if(k.mEdit_mode&&!k.mEdit_delete_mode){var c=k.MapAreas[f.target.index],c=c.toGeoJSON();k.toggle_map_area_editor(c,f.target.index)}else c=k.MapAreas[f.target.index],c=c.toGeoJSON(),999!=c.properties.areatype&&fetch_rollcall(c.properties.areaid,c.properties.areaname)};Indoor2DMap.prototype.createVILSMarker=function(f,k,c,a,d,e,g,h,l){var v=c+"&nbsp;&nbsp;&nbsp;&nbsp;<br>";0==c.length&&(v=k+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");var v=
L.popup({closeOnClick:!1,autoClose:!1}).setContent(v),n=this.convertToLatLng(this,a,d),m=L.marker(n,{title:k,draggable:h}).bindPopup(v);m.nodeid=k;m.macaddress=f;m.nodename=c;m.posX=a;m.posY=d;m.posZ=e;m.date=g;m.orig_this=this;m.maplayer=l;m.on("click",this.markerOnClick);m.on("dragend",function(f){f=f.target;var c=f.orig_this,k=f.getLatLng();f.posY=FloatMul(k.lat,11057400)-FloatMul(c.mWGS48OriginY,11057400);posX1=b(k.lat,k.lng);posX2=b(k.lat,c.mWGS48OriginX);f.posX=posX1-posX2;"function"===typeof c.mNodeDragCallback&&
c.mNodeDragCallback(c.mMapLayerId,f.type,m.macaddress,f.nodeid,f.posX,f.posY,f.posZ,k.lat,k.lng)});return m};Indoor2DMap.prototype.fadeout_tag_footprint=function(f,k){var c=[],a=[],b=this.FadeOutPolylines[f],d=this.FadeOutNodes[f],e=this.getCurrentLayer("Tags",k);null!=b&&e.removeLayer(b);if(null!=d&&void 0!=d){for(var b="rgb(244, 131, 66)",g=0;g<d.length;g++){var h=d[g],l=h.options.radius,b=h.options.color;.5>=l||0==mShowTrack?e.removeLayer(h):(h.setStyle({radius:l-.5}),l=h.getLatLng(),c.push([l.lat,
l.lng]),a[a.length]=h)}this.FadeOutNodes[f]=a;b=new L.Polyline(c,{color:b,weight:4,opacity:.4,smoothFactor:1});e.addLayer(b);this.FadeOutPolylines[f]=b}};Indoor2DMap.prototype.fadeout_loop=function(f){for(var k=0;k<f.Tags.length;k++){var c=f.Tags[k];f.fadeout_tag_footprint(c.nodeid,c.maplayer)}setTimeout(f.fadeout_loop,1E3,f)};Indoor2DMap.prototype.showGoolgeMap=function(){this.mMap.addLayer(D,"Google Streets")};Indoor2DMap.prototype.showOriginLayer=function(){var f=this.getCurrentLayer("Origin",
this.mMapLayerId);this.mMap.addLayer(f,"Origin")};Indoor2DMap.prototype.createMapEditor=function(f){this.mUsermapScaleDown=new this.UserMapScaleDownControl;this.mUsermapScaleUp=new this.UserMapScaleUpControl;this.mUsermapEdit=new this.UserMapEditControl;this.mMap.addControl(this.mUsermapEdit);this.fadeout_loop(this);this.mEditModeCallback=f};Indoor2DMap.prototype.setNodeDragCallback=function(f){this.mNodeDragCallback=f};Indoor2DMap.prototype.setOrigNodeDragCallback=function(f){this.mOrigNodeDragCallback=
f};Indoor2DMap.prototype.setUpdateMapInfoCallback=function(f){this.mUpdateMapInfoCallback=f};Indoor2DMap.prototype.setNodeClickCallback=function(f){this.mNodeClickCallback=f};Indoor2DMap.prototype.addOriginMarker=function(f,k,c){f=this.createVILSMarker("0000","OriginXYZID","Origin",f,k,c,null,!1,this.mMapLayerId);f.setIcon(g);k=this.getCurrentLayer("Origin",this.mMapLayerId);f.addTo(k);this.OriginMarker=f;f.type="Origin";f.index=0;f.on("dragend",function(f){f=f.target;var c=f.getLatLng(),k=this.orig_this,
a=FloatMul(c.lat,11057400)-FloatMul(k.mWGS48OriginY,11057400);posX1=b(c.lat,c.lng);posX2=b(c.lat,k.mWGS48OriginX);c=posX1-posX2;k.mMap_OrigY+=a;k.mMap_OrigX+=c;k.update_2d_map(k);f.setLatLng(new L.LatLng(k.mWGS48OriginY,k.mWGS48OriginX));k.mMap.panTo(f.getLatLng());"function"===typeof k.mOrigNodeDragCallback&&k.mOrigNodeDragCallback(k.mMapLayerId,k.mMap_OrigX,k.mMap_OrigY)})};Indoor2DMap.prototype.createDummyTag=function(f,k,c,a,b,d,e,g,h){this.updateMarker(this.Tags,f,k,c,a,b,d,e,g,h,!1)||this.addTag(this.Tags.length,
f,k,c,a,b,d,e,g,h)};Indoor2DMap.prototype.addAnchor=function(f,k,c,a,b,d,e,g,h,l,n){k=this.createVILSMarker(k,c,a,b,d,e,l,!1,n);n=this.getCurrentLayer("Anchors",n);k.setIcon(u);k.addTo(n);this.Anchors[f]=k;k.type="anchor";k.index=f};Indoor2DMap.prototype.addTag=function(f,k,c,a,b,d,e,g,h,v,n){k=this.createVILSMarker(k,c,a,b,d,e,v,!1,n);n=this.getCurrentLayer("Tags",n);k.setIcon(l);n.addLayer(k);this.Tags[f]=k;k.type="tag";k.index=f};Indoor2DMap.prototype.addCoordinator=function(f,k,c,a,b,d,e,g,l,
v,n){k=this.createVILSMarker(k,c,a,b,d,e,v,!1,n);n=this.getCurrentLayer("Coordinators",n);k.setIcon(h);k.addTo(n);this.Coords[f]=k;k.type="coord";k.index=f};Indoor2DMap.prototype.addLocator=function(f,k,c,a,b,d,e,g,h,l,n){k=this.createVILSMarker(k,c,a,b,d,e,l,!1,n,n);n=this.getCurrentLayer("Locators",n);k.setIcon(w);k.addTo(n);this.Locators[f]=k;k.type="locator";k.index=f};Indoor2DMap.prototype.getCurrentLayer=function(f,k){var c=this.mMapLayer_nodes[f];void 0==c&&(c=new L.LayerGroup,this.mMapLayer_nodes[f]=
c,"Tags"==f&&this.mMap.addLayer(c,f),"Locators"==f&&1==this.SHOW_LOCATOR_DEFAULT&&this.mMap.addLayer(c,f),"Sensors"==f&&this.mMap.addLayer(c,f),"Users"==f&&this.mMap.addLayer(c,f),this.mLayerControl.addOverlay(c,f));return c};Indoor2DMap.prototype.updateAnchorMarker=function(f,k,c,a,b,d,e,g,h,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return!0;this.updateMarker(this.Anchors,f,k,c,a,b,d,e,g,h,!1,!0,l)||this.addAnchor(this.Anchors.length,f,k,c,a,b,d,e,g,h,l)};Indoor2DMap.prototype.updateTagMarker=
function(f,k,c,a,b,d,e,g,h,l,n){if(0!=this.mMapLayerId&&0!=n&&this.mMapLayerId!=n)return this.setMarkerVisible(this.Tags,k,!1),this.updateMarker(this.Tags,f,k,c,a,b,d,e,g,h,!0,!1,n),this.push_to_drawlist(f,k,c,a,b,d,e,g,h,n),!0;0!=this.check_visible_state(this.Tags,k)||l||(this.reset_node(k,a,b,d,e,g,n),this.updateMarker(this.Tags,f,k,c,a,b,d,e,g,h,!0,!0,n),this.setMarkerVisible(this.Tags,k,!0));l?this.hide_2d_drawlist(k):(this.hide_2d_drawGPSlist(k),this.push_to_drawlist(f,k,c,a,b,d,e,g,h,n));(l=
this.updateMarker(this.Tags,f,k,c,a,b,d,e,g,h,!0,!this.mEnableUISmoothing&&!l,n))||this.addTag(this.Tags.length,f,k,c,a,b,d,e,g,h,n);return l};Indoor2DMap.prototype.updateCoordinatorMarker=function(f,k,c,a,b,d,e,g,h,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return this.setMarkerVisible(this.Coords,k,!1),this.updateMarker(this.Coords,f,k,c,a,b,d,e,g,h,!0,!1,l),!0;this.updateMarker(this.Coords,f,k,c,a,b,d,e,g,h,!1,!0,l)||this.addCoordinator(this.Coords.length,f,k,c,a,b,d,e,g,h,l)};Indoor2DMap.prototype.updateLocatorMarker=
function(f,k,c,a,b,d,e,g,h,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return this.setMarkerVisible(this.Locators,k,!1),this.updateMarker(this.Locators,f,k,c,a,b,d,e,g,h,!0,!1,l),!0;var n=this.updateMarker(this.Locators,f,k,c,a,b,d,e,g,h,!1,!0,l);n||this.addLocator(this.Locators.length,f,k,c,a,b,d,e,g,h,l);return n};Indoor2DMap.prototype.updateMarker=function(f,k,c,a,b,d,e,g,h,l,n,m,q){var t=!1,p,u;for(u=0;u<f.length;u++)if(p=f[u],p.nodeid===c){p.nodename=0==a.length?c:a;p.posX=b;p.posY=
d;p.posZ=e;p.buildingid=g;p.floor=h;p.maplayer=q;p.date=l;p.macaddress=k;if(m&&(f=this.convertToLatLng(this,b,d),p.setLatLng(f),n&&this.mShowTrack)){void 0!=p._icon&&"hidden"==p._icon.style.visibility&&this.showMarker(p);n=u;10<=n&&(n-=10);n=L.circleMarker(f,{color:C[n],opacity:.3,fillColor:C[n],fillOpacity:.2,className:"geoData",radius:5});q=this.getCurrentLayer("Tags",q);n.buildingid=g;n.floor=h;n.addTo(q);g=this.FadeOutNodes[p.nodeid];if(null==g||void 0==g)g=[];g[g.length]=n;this.FadeOutNodes[p.nodeid]=
g}t=!0;break}return t};Indoor2DMap.prototype.updateSensorMarker=function(f,k,c,a,b,d,g,h){var l=this.getCurrentLayer("Sensors",d);if(0!=this.mMapLayerId&&0!=d&&this.mMapLayerId!=d)return!0;for(var p=!1,n=0;n<this.Sensors.length;n++){var m=this.Sensors[n];if(m.id===f){p=!0;m.setLatLng(e(a,b));break}}0==p?(p=new moment,k=this.createVILSMarker(f,f,k,0,0,0,p,!1,d),"LiDAR"===c?k.setIcon(x):0==g.length||0==g?k.setIcon(z):1==h?k.setIcon(A):k.setIcon(y),k.setLatLng(e(a,b)),l.addLayer(k),c=this.Sensors.length,
this.Sensors[c]=k,k.id=f,k.type="sensor",k.index=c):"LiDAR"===c?m.setIcon(x):0==g.length||0==g?m.setIcon(z):1==h?m.setIcon(A):m.setIcon(y)};Indoor2DMap.prototype.updateUserMarker=function(f,k,c,a,b,d,g,h){d=this.getCurrentLayer("Users",c);if(0!=this.mMapLayerId&&0!=c&&this.mMapLayerId!=c)return!0;var l=e(g,h);g=parseInt(g);h=parseInt(h);if(0==g||0==h)l=this.convertToLatLng(this,a,b);a=!1;for(b=0;b<this.Users.length;b++)if(h=this.Users[b],h.id===f){a=!0;h.setLatLng(l);break}0==a&&(a=new moment,k=this.createVILSMarker(f,
f,k,0,0,0,a,!1,c),k.setIcon(B),k.setLatLng(l),d.addLayer(k),c=this.Users.length,this.Users[c]=k,k.id=f,k.type="user",k.index=c)};Indoor2DMap.prototype.getTagList=function(){return this.Tags};Indoor2DMap.prototype.getLocatorList=function(){return this.Locators};Indoor2DMap.prototype.setTagPopup=function(f,k){var c;for(c=0;c<this.Tags.length;c++){var a=this.Tags[c];if(a.nodeid===f){k?(a.openPopup(),this.mMap.setView(a.getLatLng())):a.closePopup();break}}};Indoor2DMap.prototype.setLocatorPopup=function(f,
k){var c;for(c=0;c<this.Locators.length;c++){var a=this.Locators[c];if(a.nodeid===f){k?(a.openPopup(),this.mMap.setView(a.getLatLng())):a.closePopup();break}}};Indoor2DMap.prototype.setSensorPopup=function(f,k){var c;for(c=0;c<this.Sensors.length;c++){var a=this.Sensors[c];console.log("setSensorPopup() index:"+c+" id:"+f+" exist_sensor.id:"+a.id);if(a.id===f){k?(a.openPopup(),this.mMap.setView(a.getLatLng())):a.closePopup();break}}};Indoor2DMap.prototype.setUserPopup=function(f,k){var c;for(c=0;c<
this.Users.length;c++){var a=this.Users[c];if(a.id==f){k?(a.setIcon(B),a.openPopup(),this.mMap.setView(a.getLatLng())):(a.setIcon(x),a.closePopup());break}}};Indoor2DMap.prototype.setTagAlert=function(f,a){this.set_TagDraw_Alert(f,a);this.set_TagGPSDraw_Alert(f,a)};Indoor2DMap.prototype.setStartAlert=function(f){void 0==this.NodeAlertFunction[f]&&(this.NodeAlertFunction[f]={});this.NodeAlertFunction[f]=1;console.log("setStartAlert() "+f)};Indoor2DMap.prototype.setStopAlert=function(f){void 0==this.NodeAlertFunction[f]&&
(this.NodeAlertFunction[f]={});this.NodeAlertFunction[f]=0;this.getTargetNode(f).setIcon(this.AlertIconScaleUpDownList[0]);console.log("setStopAlert() "+f)};Indoor2DMap.prototype.check_tag_layer_alertcircle=function(){var f=this.getCurrentLayer("Tags",this.mMapLayerId),a=f.getLayers(),c;for(c=0;c<a.length;c++){var b=a[c];"circleMarker"===b.type&&(console.log("check_tag_layer_alertcircle() Found!"),f.removeLayer(b))}};Indoor2DMap.prototype.check_locator_layer_alertcircle=function(){for(var f=this.getCurrentLayer("Locators",
this.mMapLayerId),a=f.getLayers(),c=0;c<a.length;c++){var b=a[c];"circleMarker"===b.type&&(console.log("check_locator_layer_alertcircle() Found!"),f.removeLayer(b))}};Indoor2DMap.prototype.set_TagDraw_Alert=function(f,a){for(var c=0;c<this.TagDrawList.length;c++){var b=this.TagDrawList[c];if(b.nodeid===f){c=this.getTargetNode(f);if(null==c)break;if(c.maplayer!=this.mMapLayerId)break;0<b.alertcount&&b.alertcount--;void 0==this.NodeAlertFunction[f]&&(this.NodeAlertFunction[f]={},this.NodeAlertFunction[f]=
1);if(0==a||0==this.NodeAlertFunction[f]){b.alertcount=0;var d=this.getCurrentLayer("Tags",this.mMapLayerId),e=b.alertcircle;void 0!=e&&null!=e&&(d.removeLayer(e),b.alertcircle=null,c.closePopup());c.setPopupContent(c.nodename);break}var d=this.convertToLatLng(this,b.curposX,b.curposY),g="rgb(244, 20, 20)",h="rgb(244, 20, 20)";2==a&&(h=g="rgb(244, 20, 20)");e=b.alertcircle;if(void 0==e||null==e)e=L.circleMarker(d,{color:g,opacity:.2,fillColor:h,fillOpacity:.2,className:"geoData",radius:25}),e.type=
"circleMarker",d=this.getCurrentLayer("Tags",this.mMapLayerId),e.addTo(d),b.alertcircle=e,b.alertcount=50,c.setPopupContent(c.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),c.openPopup(),this.mMap.setView(c.getLatLng());break}}};Indoor2DMap.prototype.set_TagGPSDraw_Alert=function(f,a){for(var c=0;c<this.TagGPSDrawList.length;c++){var b=this.TagGPSDrawList[c];if(b.nodeid===f){c=this.getTargetNode(f);if(null==c){console.log("set_TagGPSDraw_Alert() nodeid:"+f+" TargetNode == null");break}if(c.maplayer!=
this.mMapLayerId){console.log("set_TagGPSDraw_Alert() "+f+" not in this map");break}0<b.alertcount&&b.alertcount--;void 0==this.NodeAlertFunction[f]&&(this.NodeAlertFunction[f]={},this.NodeAlertFunction[f]=1);if(0==a||0==this.NodeAlertFunction[f]){b.alertcount=0;var d=this.getCurrentLayer("Tags",this.mMapLayerId),g=b.alertcircle;void 0!=g&&null!=g&&(d.removeLayer(g),b.alertcircle=null,c.closePopup());c.setPopupContent(c.nodename);break}var d=e(b.curposLng,b.curposLat),h="rgb(244, 20, 20)",l="rgb(244, 20, 20)";
2==a&&(l=h="rgb(244, 20, 20)");g=b.alertcircle;if(void 0==g||null==g)g=L.circleMarker(d,{color:h,opacity:.2,fillColor:l,fillOpacity:.2,className:"geoData",radius:25}),g.type="circleMarker",d=this.getCurrentLayer("Tags",this.mMapLayerId),g.addTo(d),b.alertcircle=g,b.alertcount=50,console.log("set_TagGPSDraw_Alert()"+b.nodeid+" circle:"+g+" alertcount:"+b.alertcount+" alertType:"+a),c.bindPopup(f+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),c.openPopup(),this.mMap.setView(c.getLatLng());break}}};Indoor2DMap.prototype.getTargetNode=
function(f){for(var a=null,c=0;c<this.Tags.length&&(a=this.Tags[c],a.nodeid!==f);c++);return a};Indoor2DMap.prototype.getTargetLocatorNode=function(f){for(var a=null,c=0;c<this.Locators.length&&(a=this.Locators[c],a.nodeid!==f);c++);return a};Indoor2DMap.prototype.setTagLocation=function(f,a,c,b,d,e,g,h,u,v,n){for(b=0;b<this.Tags.length;b++){var m=this.Tags[b];if(m.nodeid===f){0!=a?0==m.alertcount&&(1==v?m.setIcon(q):m.setIcon(l)):(0<c.length&&(0==d?1==v?m.setIcon(q):m.setIcon(l):1==d?1==v?m.setIcon(H):
m.setIcon(G):2==d&&m.setIcon(I)),1==n?1==v?m.setIcon(p):m.setIcon(t):0==e||1==h?1==v?m.setIcon(K):m.setIcon(J):0<g.length&&!u?1==v?m.setIcon(N):m.setIcon(M):1==v?m.setIcon(q):m.setIcon(l));break}}};Indoor2DMap.prototype.setTagLngLat=function(f,a,c,b,d){this.setMarkerVisible(this.Tags,f,!0);if(!(0>=a&&0>=c))for(var g=0;g<this.Tags.length;g++){var h=this.Tags[g];h.nodeid===f&&(h.setIcon(l),this.mEnableUISmoothing?this.push_to_GPSdrawlist(f,a,c,b,d):h.setLatLng(e(a,c)))}};Indoor2DMap.prototype.updateTagGPS=
function(f,a,c){for(var b=0;b<this.Tags.length;b++){var d=this.Tags[b];d.nodeid===f&&d.setLatLng(e(a,c))}};Indoor2DMap.prototype.setLocatorAlert=function(f,a,c,b){if(0<=a)for(var d=0;d<this.Locators.length;d++){var e=this.Locators[d];if(e.nodeid===f){if(e.maplayer!=this.mMapLayerId)break;0<e.alertcount&&e.alertcount--;void 0==this.NodeAlertFunction[f]&&(this.NodeAlertFunction[f]={},this.NodeAlertFunction[f]=1);if(0==a||0==this.NodeAlertFunction[f]){e.alertcount=0;1==b?e.setIcon(F):0<c?e.setIcon(w):
e.setIcon(E);f=this.getCurrentLayer("Locators",this.mMapLayerId);a=e.alertcircle;void 0!=a&&null!=a&&(f.removeLayer(a),e.alertcircle=null,e.closePopup());e.setPopupContent(e.nodename);break}f=this.convertToLatLng(this,e.posX,e.posY);b=c="rgb(244, 20, 20)";2==a&&(b=c="rgb(244, 20, 20)");a=e.alertcircle;if(void 0==a||null==a)a=L.circleMarker(f,{color:c,opacity:.2,fillColor:b,fillOpacity:.2,className:"geoData",radius:25}),a.type="circleMarker",f=this.getCurrentLayer("Locators",this.mMapLayerId),a.addTo(f),
e.alertcircle=a,e.alertcount=50,e.setPopupContent(e.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),e.openPopup(),this.mMap.setView(e.getLatLng());break}}};Indoor2DMap.prototype.setMarkerVisible=function(f,a,c){for(var b=!1,d=0;d<f.length;d++){var e=f[d];if(e.nodeid===a){b=c?this.showMarker(e):this.hideMarker(e);break}}return b};Indoor2DMap.prototype.hideMarker=function(f){var a=!1;null!=f._icon&&("hidden"!=f._icon.style.visibility&&(a=!0),f._icon.style.visibility="hidden");null!=f._shadow&&(f._shadow.style.visibility=
"hidden");f.closePopup();return a};Indoor2DMap.prototype.showMarker=function(f){var a=!1;null!=f._icon&&("visible"!=f._icon.style.visibility&&(a=!0),f._icon.style.visibility="visible");null!=f._shadow&&(f._shadow.style.visibility="visible");return a};Indoor2DMap.prototype.check_visible_state=function(f,a){for(var c=!1,b=0;b<f.length;b++){var d=f[b];if(d.nodeid===a){c=this.check_node_visible_state(d);break}}return c};Indoor2DMap.prototype.check_node_visible_state=function(f){var a=!1;null!=f._icon&&
"visible"==f._icon.style.visibility&&(a=!0);return a};Indoor2DMap.prototype.markclick=function(f,a){"anchor"===f?(this.Anchors[a].openPopup(),this.mMap.setView(this.Anchors[a].getLatLng()),$("#ProfileMarkerName").text(this.Anchors[a].nodename),$("#ProfileMarkerPosition").text("("+this.Anchors[a].posX+","+this.Anchors[a].posY+","+this.Anchors[a].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Anchors[a].date).local().format("MMM Do, hh:mm A"))):"tag"===f?(this.Tags[a].openPopup(),this.mMap.setView(this.Tags[a].getLatLng()),
$("#ProfileMarkerName").text(this.Tags[a].nodename),$("#ProfileMarkerPosition").text("("+this.Tags[a].posX+","+this.Tags[a].posY+","+this.Tags[a].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Tags[a].date).local().format("MMM Do, hh:mm A"))):"Origin"===f?null!=this.OriginMarker&&(this.OriginMarker.openPopup(),this.mMap.setView(this.OriginMarker.getLatLng()),$("#ProfileMarkerName").text(this.OriginMarker.nodename),$("#ProfileMarkerPosition").text("("+this.OriginMarker.posX+","+this.OriginMarker.posY+
","+this.OriginMarker.posZ+")"),$("#ProfileMarkerLocation").text(""),$("#ProfileMarkerUpdateTime").text("")):"coord"===f?(this.Coords[a].openPopup(),this.mMap.setView(this.Coords[a].getLatLng()),$("#ProfileMarkerName").text(this.Coords[a].nodename),$("#ProfileMarkerPosition").text("("+this.Coords[a].posX+","+this.Coords[a].posY+","+this.Coords[a].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Coords[a].date).local().format("MMM Do, hh:mm A"))):"locator"===f&&(this.Locators[a].openPopup(),
this.mMap.setView(this.Locators[a].getLatLng()),$("#ProfileMarkerName").text(this.Locators[a].nodename),$("#ProfileMarkerPosition").text("("+this.Locators[a].posX+","+this.Locators[a].posY+","+this.Locators[a].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Locators[a].date).local().format("MMM Do, hh:mm A")))};Indoor2DMap.prototype.UserMapEditControl=L.Control.extend({options:{position:"topleft"},onAdd:function(f){var a=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");
a.style.backgroundColor="white";a.style.backgroundImage="url(/images/edit-icon.png)";a.style.backgroundSize="28px 28px";a.style.width="32px";a.style.height="32px";a.onclick=function(){f.orig_this.mEdit_mode?(f.removeControl(f.orig_this.mUsermapScaleUp),f.removeControl(f.orig_this.mUsermapScaleDown),f.removeControl(f.orig_this.mDrawControl),f.orig_this.mEdit_mode=!1,$("#areaname_edit").css("display","none"),f.orig_this.setMakerDragable(f.orig_this.mEdit_mode),"function"===typeof f.orig_this.mEditModeCallback&&
f.orig_this.mEditModeCallback(!1)):(f.addControl(f.orig_this.mUsermapScaleUp),f.addControl(f.orig_this.mUsermapScaleDown),f.orig_this.mDrawControl=f.orig_this.creat_drawControl(f.orig_this),f.addControl(f.orig_this.mDrawControl),f.orig_this.mEdit_mode=!0,f.orig_this.setMakerDragable(f.orig_this.mEdit_mode),"function"===typeof f.orig_this.mEditModeCallback&&f.orig_this.mEditModeCallback(!0))};return a}});Indoor2DMap.prototype.UserMapScaleUpControl=L.Control.extend({options:{position:"topleft"},onAdd:function(f){var a=
L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");a.style.backgroundColor="white";a.style.backgroundImage="url(/images/maximize-25.png)";a.style.backgroundSize="28px 28px";a.style.width="32px";a.style.height="32px";a.style.backgroundRepeat="no-repeat";a.onclick=function(){f.orig_this.mMap_scale-=.01*f.orig_this.mMap_scale;f.orig_this.update_2d_map(f.orig_this);"function"===typeof f.orig_this.mUpdateMapInfoCallback&&f.orig_this.mUpdateMapInfoCallback(f.orig_this.mMapLayerId,
f.orig_this.mMap_scale,f.orig_this.mMap_coeff)};return a}});Indoor2DMap.prototype.UserMapScaleDownControl=L.Control.extend({options:{position:"topleft"},onAdd:function(f){var a=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");a.style.backgroundColor="white";a.style.backgroundImage="url(/images/minimize-25.png)";a.style.backgroundSize="28px 28px";a.style.width="32px";a.style.height="32px";a.style.backgroundRepeat="no-repeat";a.onclick=function(){f.orig_this.mMap_scale+=
.01*f.orig_this.mMap_scale;f.orig_this.update_2d_map(f.orig_this);"function"===typeof f.orig_this.mUpdateMapInfoCallback&&f.orig_this.mUpdateMapInfoCallback(f.orig_this.mMapLayerId,f.orig_this.mMap_scale,f.orig_this.mMap_coeff)};return a}});Indoor2DMap.prototype.drawControl=new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,
weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:this.layer_areas}});Indoor2DMap.prototype.creat_drawControl=function(f){return new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:f.layer_areas}})};Indoor2DMap.prototype.setMakerDragable=
function(f){var a=this.getCurrentLayer("Origin",this.mMapLayerId);this.mMap.hasLayer(a)&&null!=this.OriginMarker&&null!=this.OriginMarker.dragging&&(f?this.OriginMarker.dragging.enable():this.OriginMarker.dragging.disable());a=this.getCurrentLayer("Anchors",this.mMapLayerId);if(this.mMap.hasLayer(a))for(a=0;a<this.Anchors.length;a++){var c=this.Anchors[a];null!=c&&null!=c.dragging&&(f?c.dragging.enable():c.dragging.disable())}a=this.getCurrentLayer("Tags",this.mMapLayerId);if(this.mMap.hasLayer(a))for(a=
0;a<this.Tags.length;a++)c=this.Tags[a],null!=c&&null!=c.dragging&&(f?c.dragging.enable():c.dragging.disable());a=this.getCurrentLayer("Coordinators",this.mMapLayerId);if(this.mMap.hasLayer(a))for(a=0;a<this.Coords.length;a++)coord_node=this.Coords[a],null!=coord_node&&null!=coord_node.dragging&&(f?coord_node.dragging.enable():coord_node.dragging.disable());a=this.getCurrentLayer("Locators",this.mMapLayerId);if(this.mMap.hasLayer(a))for(a=0;a<this.Locators.length;a++)locator_node=this.Locators[a],
null!=locator_node&&null!=locator_node.dragging&&(f?locator_node.dragging.enable():locator_node.dragging.disable());a=this.getCurrentLayer("Sensors",this.mMapLayerId);if(this.mMap.hasLayer(a))for(a=0;a<this.Sensors.length;a++)sensor_node=this.Sensors[a],null!=sensor_node&&null!=sensor_node.dragging&&(f?sensor_node.dragging.enable():sensor_node.dragging.disable());a=this.getCurrentLayer("Users",this.mMapLayerId);if(this.mMap.hasLayer(a))for(a=0;a<this.Users.length;a++)user_node=this.Users[a],null!=
user_node&&null!=user_node.dragging&&(f?user_node.dragging.enable():user_node.dragging.disable())};Indoor2DMap.prototype.create_maparea_from_geoJSON=function(a,b,c){L.geoJson(c,{pointToLayer:function(a,f){},style:function(a){return a.properties.style},onEachFeature:function(a,f){var c='<label id="maparea_popup_'+a.properties.areaid+'">\u5340\u57df:'+a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;</label>",c=(new L.popup({minWidth:"16",closeButton:!0,closeOnClick:!0,maxWidth:"190"})).setContent(c);
f.bindPopup(c)}}).eachLayer(function(c){c.index=b;c.orig_this=a;c.on("click",a.mapAreaOnClick);a.MapAreas[b]=c;a.layer_areas.addLayer(c)})};Indoor2DMap.prototype.load_allmaparea=function(a){a.layer_areas.eachLayer(function(c){a.layer_areas.removeLayer(c)});var b=[];"function"===typeof get_maplayerarea&&get_maplayerarea(this.mMapLayerId,function(c){$.each(c,function(a,f){var c=JSON.parse(f);b[a]=c});c=0;for(var d in b){var e=b[d];"6"!==e.properties.areatype&&(a.create_maparea_from_geoJSON(a,c,e),c++)}for(d in b)e=
b[d],"6"===e.properties.areatype&&(a.create_maparea_from_geoJSON(a,c,e),c++)})};Indoor2DMap.prototype.load_maparea=function(){this.load_allmaparea(this)};Indoor2DMap.prototype.create_map_success=function(a,b,c){a.layer_areas.removeLayer(a.MapAreas[c]);a.create_map_area(a,b.geojson,c)};Indoor2DMap.prototype.create_map_action=function(a){a.on("draw:created",function(b){b=b.layer;b.options.fillColor=b.options.color;b.options.fillOpacity=b.options.opacity;b.options.color=a.orig_this.areaborder_color;
b.options.opacity=a.orig_this.areaborder_opacity;b.index=Object.keys(a.orig_this.MapAreas).length;b.orig_this=a.orig_this;b.on("click",a.orig_this.mapAreaOnClick);a.orig_this.layer_areas.addLayer(b);var c=b.toGeoJSON();c.properties.style={};c.properties.style.color=b.options.color;c.properties.style.opacity=b.options.opacity;c.properties.style.weight=b.options.weight;for(var d=c.properties.style,e="#",g=0;6>g;g++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];d.fillColor=e;c.properties.style.fillOpacity=
b.options.fillOpacity;c.properties.areaid="area"+getRandomInt(1E3,9999);c.properties.areaname="Area "+Object.keys(a.orig_this.MapAreas).length;a.orig_this.MapAreas[b.index]=b;d=JSON.stringify(c);create_maplayerarea(a.orig_this,a.orig_this.mMapLayerId,d,c.properties.areaid,c.properties.areaname,0,b.index,a.orig_this.create_map_success)});a.on("draw:edited",function(b){b.layers.eachLayer(function(c){c=c.toGeoJSON();var b=c.properties.areaid,d=JSON.stringify(c);update_maplayerarea_shape(a.orig_this.mMapLayerId,
b,d,c.properties.areaname)})});a.on("draw:deletestart",function(b){a.orig_this.mEdit_delete_mode=!0});a.on("draw:deletestop",function(b){a.orig_this.mEdit_delete_mode=!1});a.on("draw:deleted",function(b){b.layers.eachLayer(function(c){c=c.toGeoJSON().properties.areaid;a.orig_this.delete_map_area(a.orig_this,c)});a.orig_this.mEdit_delete_mode=!1});a.on("moveend",function(){})};Indoor2DMap.prototype.delete_map_area=function(a,b){delete_maplayerarea(a.mMapLayerId,b)};Indoor2DMap.prototype.create_map_area=
function(a,b,c){return L.geoJson(JSON.parse(b),{pointToLayer:function(a,f){},style:function(a){return a.properties.style},onEachFeature:function(a,f){f.bindPopup(a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;")}}).eachLayer(function(b){b.index=c;b.orig_this=a;b.on("click",a.mapAreaOnClick);a.MapAreas[c]=b;a.layer_areas.addLayer(b)})};Indoor2DMap.prototype.areacolorOnInput=function(){var a=$("#areacolor_input").val();if("#"!=a.charAt(0))console.log("areacolorOnInput() not valid color!");
else if(9!=a.length)console.log("areacolorOnInput() not valid color string length! need 9, get "+a.length);else{var b=a.substring(0,7),a="0x"+a.substring(7,9),a=parseInt(a),a=parseFloat(a)/255;$("#areaname_color").minicolors("value",b);$("#areaname_color").minicolors("opacity",a)}};Indoor2DMap.prototype.toggle_map_area_editor=function(a,b){this.mEdit_maparea_index=b;$("#areaname_input").val(a.properties.areaname);$("#area_type_show").html(convert_area_type_name(a.properties.areatype));$("#area_type_show").attr("data-id",
a.properties.areatype);$("#areaname_color").minicolors("value",a.properties.style.fillColor);$("#areaname_color").minicolors("opacity",a.properties.style.fillOpacity);var c=parseInt(255*a.properties.style.fillOpacity).toString(16);$("#areacolor_input").val(a.properties.style.fillColor+c);document.getElementById("areacolor_input").addEventListener("input",this.areacolorOnInput);$("#areaname_edit").css("display","block")};Indoor2DMap.prototype.areaname_save=function(a){var b=$("#areaname_color").minicolors("value"),
c=$("#areaname_color").minicolors("opacity"),d=$("#areaname_input").val(),e=$("#area_type_show").attr("data-id"),g=a.MapAreas[a.mEdit_maparea_index];g.setStyle({color:a.areaborder_color,opacity:a.areaborder_opacity,fillColor:b,fillOpacity:c});g.bindPopup(d+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");$("#areaname_edit").css("display","none");g=g.toGeoJSON();g.properties.areaname=d;g.properties.areatype=e;g.properties.style.color=a.areaborder_color;g.properties.style.opacity=a.areaborder_opacity;g.properties.style.fillColor=
b;g.properties.style.fillOpacity=c;b=g.properties.areaid;c=JSON.stringify(g);update_maplayerarea(a.mMapLayerId,b,c,d,e)};Indoor2DMap.prototype.push_to_drawlist=function(a,b,c,d,e,g,h,l,p){for(var q=!1,n=0;n<this.TagDrawList.length;n++){var m=this.TagDrawList[n];m.nodeid===b&&(0==m.preposX&&0==m.preposY&&0==m.preposZ?(m.totalposX=parseInt(d),m.totalposY=parseInt(e),m.totalposZ=parseInt(g),m.count=1):(m.totalposX+=parseInt(d),m.totalposY+=parseInt(e),m.totalposZ+=parseInt(g),m.count++),m.buildingid=
h,m.floor=l,m.date=p,m.hide=!1,q=!0)}0==q&&(q={},q.nodeid=b,q.macaddress=a,q.nodename=c,q.date=p,this.reset_draw_node(q,d,e,g,h,l),this.TagDrawList.push(q))};Indoor2DMap.prototype.hide_2d_drawlist=function(a){for(var b=0;b<this.TagDrawList.length;b++){var c=this.TagDrawList[b];if(c.nodeid===a){c.hide=!0;break}}};Indoor2DMap.prototype.hide_2d_drawGPSlist=function(a){for(var b=0;b<this.TagGPSDrawList.length;b++){var c=this.TagGPSDrawList[b];if(c.nodeid===a){c.hide=!0;break}}};Indoor2DMap.prototype.reset_node=
function(a,b,c,d,e,g){for(var h=0;h<this.TagDrawList.length;h++){var l=this.TagDrawList[h];if(l.nodeid===a){this.reset_draw_node(l,b,c,d,e,g);break}}};Indoor2DMap.prototype.reset_draw_node=function(a,b,c,d,e,g){a.buildingid=e;a.floor=g;a.count=0;a.totalposX=0;a.totalposY=0;a.totalposZ=0;a.preAveragePosX=parseInt(b);a.preAveragePosY=parseInt(c);a.preAveragePosZ=parseInt(d);a.preposX=parseInt(b);a.preposY=parseInt(c);a.preposZ=parseInt(d);a.curposX=parseInt(b);a.curposY=parseInt(c);a.curposZ=parseInt(d);
a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_X=parseInt(b);a.move_no_block_old_X=parseInt(b);a.move_moving_X=parseInt(b);a.move_moving_old_X=parseInt(b);a.move_no_block_Y=parseInt(c);a.move_no_block_old_Y=parseInt(c);a.move_moving_Y=parseInt(c);a.move_moving_old_Y=parseInt(c);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1;a.hide=!1};Indoor2DMap.prototype.push_to_GPSdrawlist=function(a,b,c,d,e){for(var g=!1,h=0;h<this.TagGPSDrawList.length;h++){var l=this.TagGPSDrawList[h];
l.nodeid===a&&(0==l.preposLng&&0==l.preposLat?(l.totalposLng=parseFloat(b),l.totalposLat=parseFloat(c),l.count=1):(l.totalposLng+=parseFloat(b),l.totalposLat+=parseFloat(c),l.count++),l.hide=!1,g=!0)}0==g&&(g={},g.nodeid=a,this.reset_GPSdraw_node(g,b,c,d,e),this.TagGPSDrawList.push(g))};Indoor2DMap.prototype.reset_GPSdraw_node=function(a,b,c,d,e){a.buildingid=d;a.floor=e;a.count=0;a.totalposLng=0;a.totalposLat=0;a.preAveragePosLng=parseFloat(b);a.preAveragePosLat=parseFloat(c);a.preposLng=parseFloat(b);
a.preposLat=parseFloat(c);a.curposLng=parseFloat(b);a.curposLat=parseFloat(c);a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_Lng=parseFloat(b);a.move_no_block_old_Lng=parseFloat(b);a.move_moving_Lng=parseFloat(b);a.move_moving_old_Lng=parseFloat(b);a.move_no_block_Lat=parseFloat(c);a.move_no_block_old_Lat=parseFloat(c);a.move_moving_Lat=parseFloat(c);a.move_moving_old_Lat=parseFloat(c);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1};Indoor2DMap.prototype.draw_tag_smooth_move=
function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_smooth_move,1E3,a);else{for(var b=0;b<a.TagDrawList.length;b++){var c=a.TagDrawList[b];if(1!=c.hide){var d=c.curposX-c.preposX,e=c.curposY-c.preposY,g=c.curposZ-c.preposZ,h;5<=Math.sqrt(d*d+e*e+g*g)||10<c.not_move_count?(h=c.draw_loop_index+1,d/=a.move_step_size,e/=a.move_step_size,g/=a.move_step_size,h>=a.move_step_size&&(h=a.move_step_size),d=parseInt(d*h),e=parseInt(e*h),g=parseInt(g*h),c.not_move_count=0,10>a.move_loop_count||(h=c.preposX+d,d=
c.preposY+e,g=c.preposZ+g,a.updateMarker(a.Tags,c.macaddress,c.nodeid,c.nodename,h,d,g,c.buildingid,c.floor,c.date,!0,!0))):c.not_move_count++;c.draw_loop_index++;if(c.draw_loop_index>=a.move_step_size){if(0<c.count){h=parseInt(c.totalposX/c.count);g=parseInt(c.totalposY/c.count);d=parseInt(c.totalposZ/c.count);r=1;c.move_moving_X=parseInt(r*(h-c.move_no_block_old_X));c.move_no_block_X=c.move_moving_X+c.move_no_block_old_X;c.move_moving_old_X=c.move_moving_X;c.move_moving_Y=parseInt(r*(g-c.move_no_block_old_Y));
c.move_no_block_Y=c.move_moving_Y+c.move_no_block_old_Y;c.move_moving_old_Y=c.move_moving_Y;c.move_status+=1;if(6<c.move_status||0>c.move_moving_X*c.move_moving_old_X)c.move_status=1;c.move_no_block_old_X=c.move_no_block_X;c.move_no_block_old_Y=c.move_no_block_Y;c.preposX=c.curposX;c.preposY=c.curposY;c.preposZ=c.curposZ;c.curposX=c.move_no_block_X;c.curposY=c.move_no_block_Y;c.curposZ=d;c.preAveragePosX=parseInt(c.totalposX/c.count);c.preAveragePosY=parseInt(c.totalposY/c.count);c.preAveragePosZ=
parseInt(c.totalposZ/c.count);c.totalposX=0;c.totalposY=0;c.totalposZ=0;c.count=0;c.draw_loop_index=0}c.draw_loop_index>2*a.move_step_size&&(c.preposX=c.curposX,c.preposY=c.curposY,c.preposZ=c.curposZ,c.draw_loop_index=0)}}}a.move_loop_count++;1E4<=a.move_loop_count&&(a.move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_smooth_move,a.smoothing_time/a.move_step_size,a)}};Indoor2DMap.prototype.draw_tag_GPS_smooth_move=function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_GPS_smooth_move,1E3,
a);else{for(var b=0;b<a.TagGPSDrawList.length;b++){var c=a.TagGPSDrawList[b];if(1!=c.hide){var d=c.curposLng-c.preposLng,e=c.curposLat-c.preposLat,g;10<c.not_move_count?(g=c.draw_loop_index+1,d/=a.GPS_move_step_size,e/=a.GPS_move_step_size,g>=a.GPS_move_step_size&&(g=a.GPS_move_step_size),d=parseFloat(d*g),e=parseFloat(e*g),c.not_move_count=0,10>a.GPS_move_loop_count||(g=c.preposLng+d,e=c.preposLat+e,a.updateTagGPS(c.nodeid,g,e))):c.not_move_count++;c.draw_loop_index++;if(c.draw_loop_index>=a.GPS_move_step_size){if(0<
c.count){g=parseFloat(c.totalposLng/c.count);e=parseFloat(c.totalposLat/c.count);d=.1;switch(c.move_status){case 1:case 2:d=.1;break;case 3:case 4:case 5:case 6:d=.8}a.GPS_smoothing_time=.1==d?200:.4==d?400:800;c.move_moving_Lng=parseFloat(d*(g-c.move_no_block_old_Lng));c.move_no_block_Lng=c.move_moving_Lng+c.move_no_block_old_Lng;c.move_moving_old_Lng=c.move_moving_Lng;c.move_moving_Lat=parseFloat(d*(e-c.move_no_block_old_Lat));c.move_no_block_Lat=c.move_moving_Lat+c.move_no_block_old_Lat;c.move_moving_old_Lat=
c.move_moving_Lat;c.move_status+=1;if(6<c.move_status||0>c.move_moving_Lng*c.move_moving_old_Lng)c.move_status=1;c.move_no_block_old_Lng=c.move_no_block_Lng;c.move_no_block_old_Lat=c.move_no_block_Lat;c.preposLng=c.curposLng;c.preposLat=c.curposLat;c.curposLng=c.move_no_block_Lng;c.curposLat=c.move_no_block_Lat;c.preAveragePosX=parseFloat(c.totalposLng/c.count);c.preAveragePosY=parseFloat(c.totalposLat/c.count);c.totalposLng=0;c.totalposLat=0;c.count=0;c.draw_loop_index=0}c.draw_loop_index>2*a.GPS_move_step_size&&
(c.preposLng=c.curposLng,c.preposLat=c.curposLat,c.draw_loop_index=0)}}}a.GPS_move_loop_count++;1E4<=a.GPS_move_loop_count&&(a.GPS_move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_GPS_smooth_move,a.GPS_smoothing_time/a.GPS_move_step_size,a)}};Indoor2DMap.prototype.update_alert_circle=function(a){a.update_tag_alert_circle();a.update_tag_GPS_alert_circle();a.update_locator_alert_circle();setTimeout(a.update_alert_circle,100,a)};Indoor2DMap.prototype.update_tag_alert_circle=function(){for(var a=
0;a<this.TagDrawList.length;a++){var b=this.TagDrawList[a];if(1!=b.hide){var c=b.alertcircle;if(void 0!=c&&null!=c){var d=c.options.opacity,e=d,g=c.options.radius,h=g;.2==d?5<g?h=g-5:e=.3:20<g?e=.2:h=g+5;d=this.getTargetNode(b.nodeid);c.setStyle({radius:h,opacity:e});c.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[b.nodeid]&&(this.AlertIconScaleIndexList[b.nodeid]=0);c=this.AlertIconScaleIndexList[b.nodeid];0==this.NodeAlertFunction[b.nodeid]?d.setIcon(this.AlertIconScaleUpDownList[0]):
d.setIcon(this.AlertIconScaleUpDownList[c]);c++;10<=c&&(c=0);this.AlertIconScaleIndexList[b.nodeid]=c}}}};Indoor2DMap.prototype.update_tag_GPS_alert_circle=function(){for(var a=0;a<this.TagGPSDrawList.length;a++){var b=this.TagGPSDrawList[a];if(1!=b.hide){var c=b.alertcircle;if(void 0!=c&&null!=c){var d=c.options.opacity,e=d,g=c.options.radius,h=g;.2==d?5<g?h=g-5:e=.3:20<g?e=.2:h=g+5;d=this.getTargetNode(b.nodeid);c.setStyle({radius:h,opacity:e});c.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[b.nodeid]&&
(this.AlertIconScaleIndexList[b.nodeid]=0);c=this.AlertIconScaleIndexList[b.nodeid];d.setIcon(this.AlertIconScaleUpDownList[c]);c++;10<=c&&(c=0);this.AlertIconScaleIndexList[b.nodeid]=c}}}};Indoor2DMap.prototype.update_locator_alert_circle=function(){for(var a=0;a<this.Locators.length;a++){var b=this.Locators[a],c=b.alertcircle;if(void 0!=c&&null!=c){var d=c.options.opacity,e=d,g=c.options.radius,h=g;.2==d?5<g?h=g-5:e=.3:20<g?e=.2:h=g+5;d=this.getTargetLocatorNode(b.nodeid);c.setStyle({radius:h,opacity:e});
c.setLatLng(b.getLatLng());void 0==this.AlertIconScaleIndexList[b.nodeid]&&(this.AlertIconScaleIndexList[b.nodeid]=0);c=this.AlertIconScaleIndexList[b.nodeid];d.setIcon(this.AlertIconScaleUpDownList[c]);c++;10<=c&&(c=0);this.AlertIconScaleIndexList[b.nodeid]=c}}};Indoor2DMap.prototype.convertToLatLng=function(a,b,c){var g=FloatDiv(parseFloat(c),11057400);FloatMul(g,11057400);c=a.mWGS48OriginY+FloatDiv(parseFloat(c),11057400);b=a.mWGS48OriginX+d(c,parseFloat(b));return a.mRotateMap?a.rotateLatLng(c,
b):e(b,c)};Indoor2DMap.prototype.rotateLatLng=function(a,b){var c=new L.latLng(a,b),d=new L.latLng(this.mWGS48OriginY,this.mWGS48OriginX);return rotatePoint(c,this.mMAP_North,d)};this.mMap.on("overlayadd",this.onOverlayAdd);this.mMap.on("overlayremove ",this.onOverlayRemove);this.create_alert_scale_icon();this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,2E3,this),setTimeout(this.draw_tag_GPS_smooth_move,2E3,this));setTimeout(this.update_alert_circle,2E3,this)};
$(document).ready(function(){$(".colorpicker").each(function(){$(this).minicolors({changeDelay:200,format:"hex",position:"bottom left",theme:"bootstrap",opacity:$(this).attr("data-opacity"),change:function(a,d){console.log("change() fillColorhex:"+a+", opacity:"+d);var b=parseInt(255*d).toString(16);$("#areacolor_input").val(a+b)},theme:"default"})})});var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glLiveMap,glFireFightingList=[],glCurrentFireFightingCaseIndex=0,glNFCdevices=[],glAoAdevices=[],glNFCdeviceSelected={},glStandbydeviceSelected={},glAreaUser={},glUserAirUsing={},glCaseUsers={},glAllUsers=[],glUserBodyRecords={},gl_bodyinfo_load_index=0,glResetUserAreaTable=!1;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,create_map(),CurrentLoadIndex+=1);break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_user_info());break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cases());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_NFCdevices());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),
PreLoadIndex=CurrentLoadIndex,load_AoAdevices());break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,runLive_user_area(),runLive_bodyinfo_records(),runLive_field_user(),CurrentLoadIndex+=1);break;case 6:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,
load_websocket_firefighting_event(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}function create_map(){glLiveMap=new Indoor2DMap("mapid");glLiveMap.setMapCoeff(0,0,10240,10240,5,1E5,121.51,25.04,0);glLiveMap.setMapImage("/images/empty.png","Indoor 2D Map");glLiveMap.setMapLayerInfo(1);glLiveMap.showGoolgeMap();glLiveMap.showOriginLayer()}
function load_cases(){glFireFightingList=[];$.getJSON(gl_target_server+"/php/firefighting.php","loadfirefightingcases=1&closed=0&project_id="+project_id,function(a){$.each(a,function(a,b){glFireFightingList.push(b);glNFCdeviceSelected[b.casenumber]=[];glStandbydeviceSelected[b.casenumber]=[];glAreaUser[b.casenumber]=[];updateNFCdeviceSelected(b.casenumber,b.NFCDeviceIds);updateStandbydeviceSelected(b.casenumber,b.StandbyDeviceIds)})}).complete(function(){show_addresses();load_cases_users()})}
function load_cases_users(){for(var a=[],d=0;d<glFireFightingList.length;d++)a.push(glFireFightingList[d].casenumber);$.getJSON(gl_target_server+"/php/firefighting.php","loadfirefightingusers=1&casenumber="+a.toString()+"&project_id="+project_id,function(a){$.each(a,function(a,b){glAreaUser[b.casenumber].push(b)})}).complete(function(){for(var a=0;a<glFireFightingList.length;a++){var d=glFireFightingList[a],g=glAreaUser[d.casenumber],g=g.sort(function(a,b){return b.enterTime<a.enterTime});glAreaUser[d.casenumber]=
g}show_user_area();CurrentLoadIndex+=1})}function getUserAirUsing(a){$.getJSON(gl_target_server+"/php/firefighting.php","loaduserairusing=1&userid="+a+"&project_id="+project_id,function(d){glUserAirUsing[a]=parseFloat(d.airusing)}).success(function(){})}
function load_NFCdevices(){$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&s=0&count=100&project_id="+project_id+"&showonline=1&showoffline=1",function(a){$.each(a,function(a,b){glNFCdevices.push(b)})}).success(function(){}).error(function(){}).complete(function(){show_nfcdevice_to_UI();show_nfcdeviceSelected_to_UI();CurrentLoadIndex+=1})}
function load_AoAdevices(){glAoAdevices=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadaoa=1&project_id="+project_id,function(a){for(var d=parseInt(a.LOC_AOA_NUM),b=0;b<d;++b){var e="LOC_AOA_INDEX_"+b;if(void 0!=a[e]&&null!=a[e]){var e=a[e].split(","),g=e[1],h=e[5],l=e[6],q=e[7],t={};t.id=e[0];t.name=g;t.posX=h;t.posY=l;t.posZ=q;t.type="aoadevice";glAoAdevices.push(t)}}}).success(function(){}).error(function(){}).complete(function(){show_standbydevice_to_UI();show_standbydeviceSelected_to_UI();
CurrentLoadIndex+=1})}function load_user_info(){glAllUsers=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loaduserbaseinfo=1&project_id="+project_id,function(a){$.each(a,function(a,b){glAllUsers.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function runLive_user_area(){1==glResetUserAreaTable&&(show_user_area(),glResetUserAreaTable=!1);for(var a=glAreaUser[glFireFightingList[glCurrentFireFightingCaseIndex].casenumber],d=0;d<a.length;d++){var b=a[d],e=document.getElementById("fieldentertime_"+b.userid);if(void 0!=e){var g=getDiffTime(b.enterTime);e.textContent=convertPrettyTime(g);var e=document.getElementById("fieldrow_"+b.userid),h=document.getElementById("status_"+b.userid);checkExceedTime(g)?(h.textContent="\u5efa\u8b70\u589e\u63f4/\u64a4\u96e2",
e.setAttribute("style","background-color:rgb(225, 20, 20);")):(h.textContent="\u6b63\u5e38",e.setAttribute("style","background-color:rgb(250, 250, 250);"))}g=getAirRamin(b.userid,b.enterTime,b.airremain);e=document.getElementById("fieldairremain_"+b.userid);void 0!=e&&(e.textContent=g,"\u7121"===g&&(e=document.getElementById("fieldrow_"+b.userid),e.setAttribute("style","background-color:rgb(225, 20, 20);"),h=document.getElementById("status_"+b.userid),h.textContent="\u5efa\u8b70\u589e\u63f4/\u64a4\u96e2"));
g=document.getElementById("fieldactivity_"+b.userid);void 0!=g&&(g.textContent=b.activity);g=document.getElementById("fieldSPO2_"+b.userid);void 0!=g&&(g.textContent=b.SPO2);g=document.getElementById("fieldHR_"+b.userid);void 0!=g&&(g.textContent=b.HR);e=document.getElementById("fielduserairusing_"+b.userid);void 0!=e&&(g=glUserAirUsing[b.userid],void 0!=g&&(e.setAttribute("title","\u6bcf\u5206\u9418\u6d88\u8017bar\u6578:"+g),e.textContent=" "+g));g=document.getElementById("standbyairremain_"+b.userid);
void 0!=g&&(g.textContent=b.airremain);g=document.getElementById("standbyactivity_"+b.userid);void 0!=g&&(g.textContent=b.activity);g=document.getElementById("standbySPO2_"+b.userid);void 0!=g&&(g.textContent=b.SPO2);g=document.getElementById("standbyHR_"+b.userid);void 0!=g&&(g.textContent=b.HR);e=document.getElementById("standbyuserairusing_"+b.userid);void 0!=e&&(g=glUserAirUsing[b.userid],void 0!=g&&(e.setAttribute("title","\u6bcf\u5206\u9418\u6d88\u8017bar\u6578:"+g),e.textContent=" "+g))}setTimeout(runLive_user_area,
1E3)}
function runLive_bodyinfo_records(){var a=moment().subtract(1,"days"),d=moment(),a=a.format("YYYY-MM-DD HH:mm:ss"),d=d.format("YYYY-MM-DD HH:mm:ss");if(gl_bodyinfo_load_index>=glAllUsers.length)gl_bodyinfo_load_index=0,setTimeout(runLive_bodyinfo_records,5E3);else{var b=glAllUsers[gl_bodyinfo_load_index];$.getJSON(gl_target_server+"/php/vilsnodes.php","project_id="+project_id+"&loaduserbodybaseinforecords=1&accountid="+b.userid+"&StartDate="+a+"&EndDate="+d,function(a){var d={},h=b.userid;$.each(a,function(a,
b){d[a]=b});glUserBodyRecords[h]=d}).success(function(){});gl_bodyinfo_load_index++;setTimeout(runLive_bodyinfo_records,100)}}
function runLive_field_user(){var a=glFireFightingList[glCurrentFireFightingCaseIndex],d={};glCaseUsers[a.casenumber]=[];$.getJSON(gl_target_server+"/php/firefighting.php","loadfirefightingevent=1&casenumber="+a.casenumber+"&eventtype=FireFightingUser&project_id="+project_id,function(a){$.each(a,function(a,b){var h=b.json;void 0==d[h.userid]&&(d[h.userid]=[]);d[h.userid].push(h)})}).complete(function(){glCaseUsers[a.casenumber]=d;update_field_user(d)});setTimeout(runLive_field_user,2E3)}
function update_field_user(a){var d={},b;for(b in a)if(a.hasOwnProperty(b)){var e=getUserName(b);d[b]={};for(var g="",h="",l="",q="",t=0,p=a[b],u=0;u<p.length;u++){var w=p[u];"0"==w.areaType?(0==g.length&&(g=w.enterTime),l=w.enterTime):"0"==q&&(h=w.enterTime,q=getEnterLeaveDiffTime(l,h),t+=q);q=w.areaType}l=moment.utc(t).format("HH:mm:ss");d[b].userName=e;d[b].enterTime=g;d[b].leaveTime=h;d[b].totalTime=convertPrettyTime(l)}for(a=document.getElementById("field_users");a.hasChildNodes();)a.removeChild(a.firstChild);
e=create_field_user_table();a.appendChild(e);a=document.getElementById("record_table_field_user_body");e=1;for(b in d)g=create_field_user_row(e,d[b]),a.appendChild(g),e+=1}
function create_field_user_table(){var a=document.getElementById("record_box_table_area");if(void 0!=a)return a;a=document.createElement("div");a.setAttribute("id","record_box_table_area");var d=document.createElement("div");d.setAttribute("class","box");a.appendChild(d);var b=document.createElement("div");b.setAttribute("class","box-body no-padding");d.appendChild(b);d=document.createElement("table");d.setAttribute("class","table table-bordered");b.appendChild(d);var e=document.createElement("thead");
d.appendChild(e);b=document.createElement("tr");b.setAttribute("bgcolor","#cce6ff");b.setAttribute("id","record_table_head");e.appendChild(b);e=document.createElement("th");e.setAttribute("style","width: 10px");e.textContent="#";b.appendChild(e);e=document.createElement("th");e.textContent="\u4eba\u54e1\u540d\u7a31";b.appendChild(e);e=document.createElement("th");e.setAttribute("style","text-align:center");e.textContent="\u6700\u65e9\u9032\u5165\u6642\u9593";b.appendChild(e);e=document.createElement("th");
e.setAttribute("style","text-align:center");e.textContent="\u6700\u665a\u96e2\u958b\u6642\u9593";b.appendChild(e);e=document.createElement("th");e.textContent="\u505c\u7559\u7e3d\u6642\u9593";b.appendChild(e);b=document.createElement("tbody");b.setAttribute("id","record_table_field_user_body");d.appendChild(b);return a}
function create_field_user_row(a,d){var b=0,e=document.createElement("tr");0==a%2&&e.setAttribute("bgcolor","#ebebe0");e.appendChild(document.createElement("td"));e.cells[b].appendChild(document.createTextNode(""+a));b++;e.appendChild(document.createElement("td"));var g=document.createElement("span");g.setAttribute("class","badge bg-green");g.textContent=d.userName;e.cells[b].appendChild(g);b++;g=document.createElement("td");e.appendChild(g);var h=document.createElement("span");h.setAttribute("class",
"label label-warning");h.textContent=d.enterTime;g.appendChild(h);b++;g=document.createElement("td");e.appendChild(g);h=document.createElement("span");h.setAttribute("class","label label-info");h.textContent=d.leaveTime;g.appendChild(h);b++;e.appendChild(document.createElement("td"));e.cells[b].appendChild(document.createTextNode(d.totalTime));return e}
function update_device_info(){var a=gl_target_server+"/php/firefighting.php",d=glFireFightingList[glCurrentFireFightingCaseIndex],b=glNFCdeviceSelected[d.casenumber],e=glStandbydeviceSelected[d.casenumber],g={};g.project_id=project_id;g.updatedeviceinfo=1;g.casenumber=d.casenumber;g.NFCDeviceIds=b.toString();g.StandbyDeviceIds=e.toString();jQuery.ajax({url:a,type:"POST",data:g,success:function(a){},error:function(a,b,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}});return!1}
function update_user_airremain(a,d,b){var e=gl_target_server+"/php/firefighting.php",g={};g.project_id=project_id;g.updateuserairremain=1;g.casenumber=a;g.userid=d;g.airremain=b;jQuery.ajax({url:e,type:"POST",data:g,success:function(a){},error:function(a,b,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}});return!1}
function update_user_area(a,d,b){var e=gl_target_server+"/php/firefighting.php",g={};g.project_id=project_id;g.updateuserarea=1;g.casenumber=a;g.userid=d;g.areaType=b;jQuery.ajax({url:e,type:"POST",data:g,success:function(a){},error:function(a,b,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}});return!1}
function finish_case(a){var d=glFireFightingList[glCurrentFireFightingCaseIndex],b=gl_target_server+"/php/firefighting.php",e={};e.project_id=project_id;e.finishcase=1;e.casenumber=d.casenumber;e.calcairusing=a;jQuery.ajax({url:b,type:"POST",data:e,success:function(a){PreLoadIndex=1;CurrentLoadIndex=2;setTimeout(check_loading_status,100)},error:function(a,b,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}});return!1}
function reset_air_remain(a,d){var b=prompt("\u8a2d\u5b9a\u4eba\u54e1("+d+")\u6c23\u74f6\u58d3\u529b(\u55ae\u4f4d:bar)","");if(null!=b){console.log("reset_air_remain() userid:"+a+" username:"+d+" newValue:"+b);for(var e=glFireFightingList[glCurrentFireFightingCaseIndex],g=glAreaUser[e.casenumber],h=0;h<g.length;h++){var l=g[h];if(l.userid==a){l.airremain=b;update_user_airremain(e.casenumber,a,b);break}}}}
function confirm_change_user_area(a,d,b,e){b="\u5f85\u547d\u71b1\u5340";"0"==e?b="\u7ba1\u5236\u5340":"1"==e&&(b="\u5f85\u547d\u71b1\u5340");confirm("\u66f4\u6539\u4f7f\u7528\u8005("+d+")\u5340\u57df, \u79fb\u81f3"+b+"?")&&change_user_area(a,e)}
function change_user_area(a,d){console.log("change_user_area() userid:"+a+" toType:"+d);for(var b=glFireFightingList[glCurrentFireFightingCaseIndex],e=glAreaUser[b.casenumber],g=!1,h=0;h<e.length;h++){var l=e[h];if(l.userid==a){update_user_area(b.casenumber,a,d);g=!0;break}}if(0==g)for(h=0;h<glAllUsers.length;h++)if(l=glAllUsers[h],l.userid==a){update_user_area(b.casenumber,a,d);g=!0;break}e=e.sort(function(a,b){return b.enterTime<a.enterTime});glAreaUser[b.casenumber]=e}
function show_nfcdevice_to_UI(){for(var a=document.getElementById("nfcdevice_dropdown_menu");a.hasChildNodes();)a.removeChild(a.firstChild);var d=glFireFightingList[glCurrentFireFightingCaseIndex],b=glNFCdeviceSelected[d.casenumber];if(1!=d.caseclosed){var d=document.createElement("li"),e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_selectall("device_nfclocator");return true;');d.appendChild(e);e.appendChild(document.createTextNode("\u5168\u9078"));
a.appendChild(d);for(d=0;d<glNFCdevices.length;++d){for(var e=glNFCdevices[d],g=!1,h=0;h<b.length;++h)if(b[h]==e.deviceid){g=!0;break}e=create_dropdown_device_item("nfclocator",e.deviceid,parseInt(e.macaddress),e.name,g);a.appendChild(e)}}}
function show_standbydevice_to_UI(){for(var a=document.getElementById("standbydevice_dropdown_menu");a.hasChildNodes();)a.removeChild(a.firstChild);var d=glFireFightingList[glCurrentFireFightingCaseIndex],b=glStandbydeviceSelected[d.casenumber];if(1!=d.caseclosed){var d=document.createElement("li"),e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_selectall("device_standbydevice");return true;');d.appendChild(e);
e.appendChild(document.createTextNode("\u5168\u9078"));a.appendChild(d);for(d=0;d<glAoAdevices.length;++d){for(var g=glAoAdevices[d],e=!1,h=0;h<b.length;++h){var l=b[h];if(l===g.id){e=!0;break}}e=create_dropdown_device_item("standbydevice",g.id,g.id,g.name,e);a.appendChild(e)}for(d=0;d<glNFCdevices.length;++d){g=glNFCdevices[d];e=!1;for(h=0;h<b.length;++h)if(l=b[h],l===g.deviceid){e=!0;break}e=create_dropdown_device_item("standbydevice",g.deviceid,parseInt(g.macaddress),g.name,e);a.appendChild(e)}}}
function show_nfcdeviceSelected_to_UI(){for(var a=document.getElementById("nfclocator_selection");a.hasChildNodes();)a.removeChild(a.firstChild);for(var d=glNFCdeviceSelected[glFireFightingList[glCurrentFireFightingCaseIndex].casenumber],b=0;b<d.length;++b)for(var e=d[b],g=0;g<glNFCdevices.length;++g){var h=glNFCdevices[g];if(e==h.deviceid){e=document.createElement("span");e.textContent=h.name;e.setAttribute("class","badge bg-yellow");a.appendChild(e);break}}}
function show_standbydeviceSelected_to_UI(){for(var a=document.getElementById("standbydevice_selection");a.hasChildNodes();)a.removeChild(a.firstChild);for(var d=glStandbydeviceSelected[glFireFightingList[glCurrentFireFightingCaseIndex].casenumber],b=0;b<d.length;++b){for(var e=d[b],g=!1,h=0;h<glAoAdevices.length;++h){var l=glAoAdevices[h];if(e==l.id){h=document.createElement("span");h.textContent=l.name;h.setAttribute("class","badge bg-green");a.appendChild(h);g=!0;break}}if(!g)for(h=0;h<glNFCdevices.length;++h)if(l=
glNFCdevices[h],e==l.deviceid){e=document.createElement("span");e.textContent=l.name;e.setAttribute("class","badge bg-yellow");a.appendChild(e);break}}}
function dropdown_selectall(a){var d=glFireFightingList[glCurrentFireFightingCaseIndex];if("device_standbydevice"===a){for(var b=0;b<glAoAdevices.length;++b){var e=glAoAdevices[b],g=document.getElementById("dropdown_checkbox_"+a+"_"+e.id);if(void 0==g)break;g.checked=!0;putToStandbydeviceSelected(d.casenumber,e.id);show_standbydeviceSelected_to_UI()}for(b=0;b<glNFCdevices.length;++b){e=glNFCdevices[b];g=document.getElementById("dropdown_checkbox_"+a+"_"+e.deviceid);if(void 0==g)break;g.checked=!0;
putToStandbydeviceSelected(d.casenumber,e.deviceid);show_standbydeviceSelected_to_UI()}}else if("device_nfclocator"===a)for(b=0;b<glNFCdevices.length;++b){e=glNFCdevices[b];g=document.getElementById("dropdown_checkbox_"+a+"_"+e.deviceid);if(void 0==g)break;g.checked=!0;putToNFCdeviceSelected(d.casenumber,e.deviceid);show_nfcdeviceSelected_to_UI()}update_device_info()}function dropdown_checkbox_device_click(a){glDropdown_checkbox_device_click=!0}var glDropdown_checkbox_device_click=!1;
function dropdown_device_click(a,d){var b=glFireFightingList[glCurrentFireFightingCaseIndex];1==glDropdown_checkbox_device_click?1==document.getElementById("dropdown_checkbox_device_"+a+"_"+d).checked?putToDeviceSelected(b.casenumber,a,d):removeFromDeviceSelected(b.casenumber,a,d):1==document.getElementById("dropdown_checkbox_device_"+a+"_"+d).checked?(document.getElementById("dropdown_checkbox_device_"+a+"_"+d).checked=!1,removeFromDeviceSelected(b.casenumber,a,d)):(document.getElementById("dropdown_checkbox_device_"+
a+"_"+d).checked=!0,putToDeviceSelected(b.casenumber,a,d));show_DeviceSelected_to_UI(a);update_device_info();glDropdown_checkbox_device_click=!1}
function create_dropdown_device_item(a,d,b,e,g){var h=document.createElement("li"),l=document.createElement("a");l.setAttribute("class","small");l.setAttribute("tabIndex","-1");l.setAttribute("data-value",b);l.setAttribute("href","javascript:;");l.setAttribute("onclick",'dropdown_device_click("'+a+'","'+d+'");return true;');b=document.createElement("input");b.setAttribute("type","checkbox");b.setAttribute("id","dropdown_checkbox_device_"+a+"_"+d);b.setAttribute("onclick","dropdown_checkbox_device_click();return true;");
b.checked=g;l.appendChild(b);l.appendChild(document.createTextNode(" "+e));h.appendChild(l);return h}function show_DeviceSelected_to_UI(a){"nfclocator"===a?show_nfcdeviceSelected_to_UI():"standbydevice"===a&&show_standbydeviceSelected_to_UI()}function putToDeviceSelected(a,d,b){"nfclocator"===d?putToNFCdeviceSelected(a,b):"standbydevice"===d&&putToStandbydeviceSelected(a,b)}
function removeFromDeviceSelected(a,d,b){"nfclocator"===d?removeFromNFCdeviceSelected(a,b):"standbydevice"===d&&removeFromStandbydeviceSelected(a,b)}function updateNFCdeviceSelected(a,d){for(var b=d.split(","),e=0;e<b.length;++e){var g=b[e];0<g.length&&putToNFCdeviceSelected(a,parseInt(g))}}function updateStandbydeviceSelected(a,d){for(var b=d.split(","),e=0;e<b.length;++e){var g=b[e];0<g.length&&putToStandbydeviceSelected(a,g)}}
function putToNFCdeviceSelected(a,d){for(var b=glNFCdeviceSelected[a],e=!1,g=0;g<b.length;++g)if(b[g]==d){e=!0;break}0==e&&b.push(d);glNFCdeviceSelected[a]=b}function removeFromNFCdeviceSelected(a,d){for(var b=glNFCdeviceSelected[a],e=0;e<b.length;++e)if(b[e]==d){b.splice(e,1);break}glNFCdeviceSelected[a]=b}function putToStandbydeviceSelected(a,d){for(var b=glStandbydeviceSelected[a],e=!1,g=0;g<b.length;++g)if(b[g]==d){e=!0;break}0==e&&b.push(d);glStandbydeviceSelected[a]=b}
function removeFromStandbydeviceSelected(a,d){for(var b=glStandbydeviceSelected[a],e=0;e<b.length;++e)if(b[e]==d){b.splice(e,1);break}glStandbydeviceSelected[a]=b}
function show_addresses(){document.getElementById("Address_longitude").innerHTML="\u7d93\u5ea6:";document.getElementById("Address_latitude").innerHTML="\u7def\u5ea6:";glCurrentFireFightingCaseIndex=0;glLiveMap.clearAddressTarget();for(var a=document.getElementById("dropdown_addresses");a.hasChildNodes();)a.removeChild(a.firstChild);for(var d=0;d<glFireFightingList.length;d++){var b=glFireFightingList[d],e=!1;if(0==d){e=!0;document.getElementById("cur_address").innerHTML=b.address+'<span class="caret"></span>';
document.getElementById("Address_longitude").innerHTML="\u7d93\u5ea6:"+b.lng;document.getElementById("Address_latitude").innerHTML="\u7def\u5ea6:"+b.lat;document.getElementById("record_starttime").innerHTML="\u6848\u865f:"+b.casenumber+" \u8a18\u9304\u958b\u59cb\u6642\u9593:"+b.starttime;var g=document.getElementById("closecasebutton");0==b.caseclosed?g.setAttribute("style","display:block;"):g.setAttribute("style","display:none;");glCurrentFireFightingCaseIndex=d;focus_map(b)}b=create_dropdown_address_item(d,
b.address,e);a.appendChild(b)}}function create_dropdown_address_item(a,d,b){b=document.createElement("li");var e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("tabIndex","-1");e.setAttribute("data-value",a);e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_address_click("'+a+'");return true;');e.appendChild(document.createTextNode(" "+d));b.appendChild(e);return b}
function dropdown_address_click(a){var d=glFireFightingList[a];glCurrentFireFightingCaseIndex=a;focus_map(d);document.getElementById("cur_address").innerHTML=d.address+'<span class="caret"></span>';document.getElementById("Address_longitude").innerHTML="\u7d93\u5ea6:"+d.lng;document.getElementById("Address_latitude").innerHTML="\u7def\u5ea6:"+d.lat;document.getElementById("record_starttime").innerHTML="\u6848\u865f:"+d.casenumber+" \u8a18\u9304\u958b\u59cb\u6642\u9593:"+d.starttime;a=document.getElementById("closecasebutton");
0==d.caseclosed?a.setAttribute("style","display:block;"):a.setAttribute("style","display:none;");show_user_area();show_nfcdevice_to_UI();show_nfcdeviceSelected_to_UI();show_standbydeviceSelected_to_UI()}
function show_user_area(){for(var a=document.getElementById("FIRE_AREA_TABLE_BODY");a.hasChildNodes();)a.removeChild(a.firstChild);for(var d=document.getElementById("STANDBY_AREA_TABLE_BODY");d.hasChildNodes();)d.removeChild(d.firstChild);for(var b=document.getElementById("STANDBY2_AREA_TABLE_BODY");b.hasChildNodes();)b.removeChild(b.firstChild);for(var e=document.getElementById("STANDBY3_AREA_TABLE_BODY");e.hasChildNodes();)e.removeChild(e.firstChild);for(var g=glAreaUser[glFireFightingList[glCurrentFireFightingCaseIndex].casenumber],
h=0,l=0,q=0,t=0;t<g.length;t++){var p=g[t],u=parseInt(p.areaType);0==u?(h++,p=create_field_table_item(h,p),a.appendChild(p)):1==u?(l++,p=create_standby_table_item(l,p),d.appendChild(p)):2==u&&(q++,p=create_standby_table_item(q,p),b.appendChild(p))}for(t=a=0;t<glAllUsers.length;t++){p=glAllUsers[t];d=parseInt(p.userid);b=!1;for(u=0;u<g.length;u++)if(d==parseInt(g[u].userid)){b=!0;break}0==b&&(a++,p=create_standby_table_item(a,p),e.appendChild(p))}document.getElementById("infield_count").textContent=
h;document.getElementById("standby1_count").textContent=l;document.getElementById("standby2_count").textContent=q;document.getElementById("standby3_count").textContent=a}
function create_field_table_item(a,d){var b=getUserName(d.userid),e=document.createElement("tr");e.setAttribute("id","fieldrow_"+d.userid);e.setAttribute("style","background-color:rgb(250, 250, 250);");var g=0;e.appendChild(document.createElement("td"));e.cells[g].appendChild(document.createTextNode(""+a));g++;var h=document.createElement("td");h.setAttribute("style","height: 90px;");e.appendChild(h);h=document.createElement("span");h.setAttribute("style","font-size:24px; font-weight:bold; color:#330033;");
h.textContent=b;e.cells[g].appendChild(h);var l=document.createElement("div");e.cells[g].appendChild(l);h=document.createElement("button");h.setAttribute("type","button");h.setAttribute("onclick","confirm_change_user_area('"+d.userid+"','"+b+"','"+d.areaType+"','1');");h.setAttribute("class","btn btn-sm");h.textContent="\u66f4\u6539\u5340\u57df";l.appendChild(h);g++;e.appendChild(document.createElement("td"));h=document.createElement("span");h.setAttribute("id","fieldHR_"+d.userid);h.setAttribute("style",
"font-size:14px; font-weight:bold; color:#225533;");h.textContent=d.HR;e.cells[g].appendChild(h);g++;e.appendChild(document.createElement("td"));h=document.createElement("span");h.setAttribute("id","fieldSPO2_"+d.userid);h.setAttribute("style","font-size:14px; font-weight:bold; color:#225533;");h.textContent=d.SPO2;e.cells[g].appendChild(h);g++;h=document.createElement("td");h.setAttribute("style","height: 90px;");e.appendChild(h);h=document.createElement("span");h.setAttribute("id","fieldairremain_"+
d.userid);h.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");h.textContent=getAirRamin(d.userid,d.enterTime,d.airremain);e.cells[g].appendChild(h);h=document.createElement("span");h.setAttribute("id","fielduserairusing_"+d.userid);h.setAttribute("title","\u6bcf\u5206\u9418\u6d88\u8017bar\u6578:");h.setAttribute("style","font-size:10px; font-weight:light; color:#337733;");e.cells[g].appendChild(h);l=document.createElement("div");e.cells[g].appendChild(l);h=document.createElement("button");
h.setAttribute("type","button");h.setAttribute("onclick","reset_air_remain('"+d.userid+"','"+b+"');");h.setAttribute("class","btn btn-sm");h.textContent="\u8a2d\u5b9a\u6c23\u74f6\u91cf";l.appendChild(h);g++;b=document.createElement("td");b.setAttribute("style","height: 90px;");e.appendChild(b);b=document.createElement("span");b.setAttribute("id","fieldentertime_"+d.userid);b.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");h=getDiffTime(d.enterTime);b.textContent=convertPrettyTime(h);
e.cells[g].appendChild(b);g++;b=document.createElement("td");b.setAttribute("style","height: 90px;");e.appendChild(b);b=document.createElement("span");b.setAttribute("id","fieldactivity_"+d.userid);b.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");b.textContent=d.activity;e.cells[g].appendChild(b);g++;b=document.createElement("td");b.setAttribute("style","height: 90px;");e.appendChild(b);b=document.createElement("span");b.setAttribute("id","status_"+d.userid);b.setAttribute("style",
"font-size:14px; font-weight:bold; color:#330033;");b.textContent="\u6b63\u5e38";e.cells[g].appendChild(b);return e}
function create_standby_table_item(a,d){var b=getUserName(d.userid),e=document.createElement("tr");e.setAttribute("id","standbyrow_"+d.userid);e.setAttribute("style","background-color:rgb(250, 250, 250);");var g=0;e.appendChild(document.createElement("td"));e.cells[g].appendChild(document.createTextNode(""+a));g++;var h=document.createElement("td");h.setAttribute("style","height: 90px;");e.appendChild(h);h=document.createElement("span");h.setAttribute("style","font-size:24px; font-weight:bold; color:#330033;");
h.textContent=b;e.cells[g].appendChild(h);var l=document.createElement("div");e.cells[g].appendChild(l);h=document.createElement("button");h.setAttribute("type","button");h.setAttribute("onclick","confirm_change_user_area('"+d.userid+"','"+b+"','"+d.areaType+"','0');");h.setAttribute("class","btn btn-sm");h.textContent="\u66f4\u6539\u5340\u57df";l.appendChild(h);g++;e.appendChild(document.createElement("td"));h=document.createElement("span");h.setAttribute("id","standbyHR_"+d.userid);h.setAttribute("style",
"font-size:14px; font-weight:bold; color:#225533;");h.textContent=d.HR;e.cells[g].appendChild(h);g++;e.appendChild(document.createElement("td"));h=document.createElement("span");h.setAttribute("id","standbySPO2_"+d.userid);h.setAttribute("style","font-size:14px; font-weight:bold; color:#225533;");h.textContent=d.SPO2;e.cells[g].appendChild(h);g++;h=document.createElement("td");h.setAttribute("style","height: 90px;");e.appendChild(h);h=document.createElement("span");h.setAttribute("id","standbyairremain_"+
d.userid);h.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");h.textContent=d.airremain;e.cells[g].appendChild(h);h=document.createElement("span");h.setAttribute("id","standbyuserairusing_"+d.userid);h.setAttribute("title","\u6bcf\u5206\u9418\u6d88\u8017bar\u6578:");h.setAttribute("style","font-size:10px; font-weight:light; color:#337733;");e.cells[g].appendChild(h);l=document.createElement("div");e.cells[g].appendChild(l);h=document.createElement("button");h.setAttribute("type",
"button");h.setAttribute("onclick","reset_air_remain('"+d.userid+"','"+b+"');");h.setAttribute("class","btn btn-sm");h.textContent="\u8a2d\u5b9a\u6c23\u74f6\u91cf";l.appendChild(h);g++;b=document.createElement("td");b.setAttribute("style","height: 90px;");e.appendChild(b);b=document.createElement("span");b.setAttribute("id","standbyactivity_"+d.userid);b.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");b.textContent=d.activity;e.cells[g].appendChild(b);return e}
function focus_map(a){glLiveMap.setBounds(parseFloat(a.lat)-.001,parseFloat(a.lng)-.001,parseFloat(a.lat)+.001,parseFloat(a.lng)+.001);glLiveMap.setTargetLocation(a.address,a.lat,a.lng)}function load_websocket_firefighting_event(){$.getJSON(gl_target_server+"/php/configvils.php","loadsystemconfig=1&project_id="+project_id,function(a){glWebSocketPort=a.web_socket_port;load_FireFightingEvent_websocket()})}
function load_FireFightingEvent_websocket(){var a=gl_websocket_server+":"+glWebSocketPort+"/websocket/maingroups_"+gl_maingroups+"_2D1531973179180j8teuD5A4A_type|firefightingevent";console.log("load_FireFightingEvent_websocket() wsUri:"+a);websocket=new WebSocket(a);websocket.onmessage=function(a){onMessageFireFightingEvent(a)};websocket.onclose=function(a){onCloseFireFightingEvent(a)};websocket.onopen=function(a){onOpenFireFightingEvent(a)}}
function onMessageFireFightingEvent(a){a=JSON.parse(a.data);if("FireFightingInfo"===a.msgType){console.log("onMessageFireFightingEvent() casedata.casenumber:"+a.casenumber);for(var d in glFireFightingList)glFireFightingList[d].casenumber==a.casenumber&&(glFireFightingList[d]=a);glNFCdeviceSelected[a.casenumber]=[];glStandbydeviceSelected[a.casenumber]=[];updateNFCdeviceSelected(a.casenumber,a.NFCDeviceIds);updateStandbydeviceSelected(a.casenumber,a.StandbyDeviceIds);dropdown_address_click(glCurrentFireFightingCaseIndex)}else if("FireFightingUser"===
a.msgType){console.log("onMessageFireFightingEvent() casedata.userid:"+a.userid);console.log("onMessageFireFightingEvent() casedata.areaType:"+a.areaType);console.log("onMessageFireFightingEvent() casedata.casenumber:"+a.casenumber);console.log("onMessageFireFightingEvent() casedata.airremain:"+a.airremain);console.log("onMessageFireFightingEvent() casedata.enterTime:"+a.enterTime);console.log("onMessageFireFightingEvent() casedata.activity:"+a.activity);console.log("onMessageFireFightingEvent() casedata.HR:"+
a.HR);console.log("onMessageFireFightingEvent() casedata.SPO2:"+a.SPO2);var b=glAreaUser[a.casenumber],e=!1,g=0;for(d in b){if(b[d].userid==a.userid){b[d].areaType!=a.areaType&&(glResetUserAreaTable=!0);b[d]=a;e=!0;console.log("onMessageFireFightingEvent() existed casedata.userid:"+a.userid);break}g++}0==e&&(b.push(a),glResetUserAreaTable=!0,console.log("onMessageFireFightingEvent() new casedata.userid:"+a.userid));d=b.sort(function(a,b){return b.enterTime<a.enterTime});glAreaUser[a.casenumber]=d}}
function onOpenFireFightingEvent(a){console.log("onOpenFireFightingEvent() Connected to VILS Center!! ");$("#connection_status").html('<a><i class="fa fa-chain text-green"></i> \u7cfb\u7d71\u5df2\u9023\u7dda</a>')}function onCloseFireFightingEvent(a){console.log("onCloseFireFightingEvent() reconnect to VILS Center!! ");$("#connection_status").html('<a><i class="fa fa-chain-broken text-red"></i> \u7cfb\u7d71\u9023\u7dda\u4e2d...</a>');setTimeout(load_FireFightingEvent_websocket,2E3)}
function closeNewFireFightingbtn_click(){$("#modal-askcloseaction").modal("show")}function continue_case_click(){$("#modal-askcloseaction").modal("hide")}function end_case_and_save_airrecord_click(){$("#modal-askcloseaction").modal("hide");finish_case(1)}function end_case_click(){$("#modal-askcloseaction").modal("hide");finish_case(0)}function getUserName(a){parseInt(a);for(var d=0;d<glAllUsers.length;++d){var b=glAllUsers[d];if(parseInt(b.userid)==a)return b.name}return a}
function getAirRamin(a,d,b){d=moment().diff(d,"seconds");var e=glUserAirUsing[a];void 0==e?(setTimeout(getUserAirUsing,10,a),a=30):a=6*e;b=(6*(parseInt(b)-60)-a/60*d)/(a/60);return 0>=b?"\u7121":convertPrettyTime(convertFormatTime(b))}function checkExceedTime(a){var d=moment(a,"HH:mm:ss");a=d.hour();var b=d.minutes();d.seconds();d=!1;0<a?d=!0:20<=b&&(d=!0);return d}function getDiffTime(a){a=moment(a,"YYYY-MM-DD HH:mm:ss");var d=moment().utcOffset("+08:00");return moment(d-a).utc()}
function getEnterLeaveDiffTime(a,d){var b=moment(a,"YYYY-MM-DD HH:mm:ss"),e=moment(d,"YYYY-MM-DD HH:mm:ss");return moment(e-b).utc()}function convertToStayTime(a){a=moment(a,"YYYY-MM-DD HH:mm:ss");var d=moment();a=moment(d-a).utc();return convertPrettyTime(a)}function convertFormatTime(a){return moment.utc(1E3*a).format("HH:mm:ss")}
function convertPrettyTime(a){var d=moment(a,"HH:mm:ss");a=d.hour();var b=d.minutes(),d=d.seconds(),e="";0<a&&(e+=a+"\u5c0f\u6642");0<b&&(e+=b+"\u5206");0<d&&(e+=d+"\u79d2");return e}function convertPrettyRollCallTime(a){var d=moment(a,"HH:mm");a=d.hour();var b=d.minutes();d.seconds();d="";0<=a&&(d+=a+"\u9ede");0<=b&&(d+=b+"\u5206");return d}function getRandomInt(a,d){return Math.floor(Math.random()*(d-a+1))+a}
function FloatAdd(a,d){var b,e;try{b=a.toString().split(".")[1].length}catch(g){b=0}try{e=d.toString().split(".")[1].length}catch(g){e=0}b=Math.pow(10,Math.max(b,e));return(FloatMul(a,b)+FloatMul(d,b))/b}function FloatSubtraction(a,d){var b,e,g;try{b=a.toString().split(".")[1].length}catch(h){b=0}try{e=d.toString().split(".")[1].length}catch(h){e=0}g=Math.pow(10,Math.max(b,e));return((a*g-d*g)/g).toFixed(b>=e?b:e)}
function FloatMul(a,d){var b=0,e=a.toString(),g=d.toString();try{b+=e.split(".")[1].length}catch(h){}try{b+=g.split(".")[1].length}catch(h){}return Number(e.replace(".",""))*Number(g.replace(".",""))/Math.pow(10,b)}function FloatDiv(a,d){var b=0,e=0,g,h;try{b=a.toString().split(".")[1].length}catch(l){}try{e=d.toString().split(".")[1].length}catch(l){}g=Number(a.toString().replace(".",""));h=Number(d.toString().replace(".",""));return g/h*Math.pow(10,e-b)}
function rotatePoint(a,d,b){d=d*Math.PI/180;return new L.latLng(Math.sin(d)*(a.lng-b.lng)+Math.cos(d)*(a.lat-b.lat)+b.lat,Math.cos(d)*(a.lng-b.lng)-Math.sin(d)*(a.lat-b.lat)+b.lng)}function open_firefighting_record_page(){window.open("/index.php/vilsfirefightingrecord/"+project_id,"_blank").focus()};
