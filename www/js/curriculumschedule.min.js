var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,gl_curriculumrecord_List=[],gl_curriculumapply_List=[],gl_curriculumrecordapply_List=[],gl_curriculum_List=[],gl_curriculumtype_List=[],gl_user_info=[],gCurrentWeek=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_CurriculumRecords());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_CurriculumApply());break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_Curriculums());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_CurriculumType());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),
PreLoadIndex=CurrentLoadIndex,show_schedule());break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_user_info(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_CurriculumRecords(){var a=gl_target_server+"/php/curriculum.php";gl_curriculumrecord_List=[];$.getJSON(a,"loadcurriculumrecord=1&project_id="+project_id,function(a){$.each(a,function(a,b){b.id=parseInt(b.id);b.userid=parseInt(b.userid);b.curriculumid=parseInt(b.curriculumid);gl_curriculumrecord_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_CurriculumApply(){for(var a=gl_target_server+"/php/curriculum.php",b=[],c=0;c<gl_curriculumrecord_List.length;c++)b.push(gl_curriculumrecord_List[c].id);b=b.toString();gl_curriculumapply_List=[];$.getJSON(a,"loadcurriculumapply=1&project_id="+project_id+"&records="+b,function(a){$.each(a,function(a,b){b.id=parseInt(b.id);b.userid=parseInt(b.userid);b.curriculumrecordid=parseInt(b.curriculumrecordid);b.status=parseInt(b.status);gl_curriculumapply_List.push(b)})}).success(function(){CurrentLoadIndex+=
1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_Curriculums(){gl_curriculumrecordapply_List=[];for(var a=[],b=0;b<gl_curriculumrecord_List.length;b++){for(var c=gl_curriculumrecord_List[b],e=!1,d=0;d<gl_curriculumapply_List.length;d++){var f=gl_curriculumapply_List[d];if(c.id==f.curriculumrecordid&&1==f.status){gl_curriculumrecordapply_List.push(c);e=!0;break}}if(e){e=!1;for(d=0;d<a.length;d++)if(a[d]==c.curriculumid){e=!0;break}e||a.push(c.curriculumid)}}a=a.toString();b=gl_target_server+"/php/curriculum.php";gl_curriculum_List=
[];$.getJSON(b,"loadcurriculums=1&project_id="+project_id+"&curriculumid="+a,function(a){$.each(a,function(a,b){b.id=parseInt(b.id);b.userid=parseInt(b.userid);b.typeid=parseInt(b.typeid);b.recordid=parseInt(b.recordid);gl_curriculum_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_CurriculumType(){for(var a=[],b=0;b<gl_curriculum_List.length;b++){for(var c=gl_curriculum_List[b],e=!1,d=0;d<a.length;d++)if(a[d]==c.typeid){e=!0;break}e||a.push(c.typeid)}a=a.toString();b=gl_target_server+"/php/curriculum.php";gl_curriculumtype_List=[];$.getJSON(b,"loadcurriculumtype=1&project_id="+project_id+"&type="+a,function(a){$.each(a,function(a,b){b.id=parseInt(b.id);gl_curriculumtype_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=
1}).complete(function(){})}function show_schedule(){show_week_schedule();CurrentLoadIndex+=1}
function show_week_schedule(){var a=getCurrentWeek(gCurrentWeek),b=a.showDate[0]+" ~ "+a.showDate[4];document.getElementById("id_current_week").textContent=b;document.getElementById("monday_date").textContent=a.showDate[0];document.getElementById("tuesday_date").textContent=a.showDate[1];document.getElementById("wednesday_date").textContent=a.showDate[2];document.getElementById("thursday_date").textContent=a.showDate[3];document.getElementById("friday_date").textContent=a.showDate[4];var b=create_weekday_schedule(a.Date[0],
"1"),c=create_weekday_schedule(a.Date[1],"2"),e=create_weekday_schedule(a.Date[2],"3"),d=create_weekday_schedule(a.Date[3],"4"),a=create_weekday_schedule(a.Date[4],"5"),f=clearChildView("monday_class"),g=clearChildView("tuesday_class"),h=clearChildView("wednesday_class"),k=clearChildView("thursday_class"),l=clearChildView("friday_class");f.appendChild(b);g.appendChild(c);h.appendChild(e);k.appendChild(d);l.appendChild(a)}
function create_weekday_schedule(a,b){for(var c=document.createElement("div"),e=[],d=0;d<gl_curriculumrecordapply_List.length;d++){var f=gl_curriculumrecordapply_List[d];if(a>=f.startdate&&a<=f.enddate)for(var g=0;g<f.weekday.length;g++)if(b===f.weekday[g]){e.push(f);break}}for(g=[];0<e.length;){for(var d=void 0,f=-1,h=0;h<e.length;h++){var k=e[h];void 0==d?(d=k,f=h):0<compareFormatTiime(d.starttime,k.starttime)&&(d=k,f=h)}g.push(d);e.splice(f,1)}for(d=0;d<g.length;d++)f=g[d],e=create_curriculum_class(f),
c.appendChild(e);return c}function compareFormatTiime(a,b){var c=moment(a,"hh:mm A"),e=moment(b,"hh:mm A");return c>e}function create_curriculum_class(a){var b=document.createElement("div");b.setAttribute("class","row");b.setAttribute("style","text-align: center;");var c=document.createElement("div");c.setAttribute("class","col-sm-8");c.setAttribute("style","margin-left: auto;margin-right: auto;display: block;");b.appendChild(c);a=create_class_info(a);c.appendChild(a);return b}
function create_class_info(a){var b=document.createElement("ul");b.setAttribute("class","mailbox-attachments clearfix");var c=document.createElement("li");b.appendChild(c);var e=getBackgroundColor(a.curriculumid),d=getTextColor(a.curriculumid),f=getLocationTextColor(a.curriculumid),g=document.createElement("div");g.setAttribute("class","mailbox-attachment-info");g.setAttribute("style","background-color:"+e+";");c.appendChild(g);c=document.createElement("p");c.setAttribute("class","overflow-ellipsis");
c.setAttribute("style","white-space: nowrap;overflow: hidden;font-weight:bold;color:"+d+";");c.textContent=a.name;g.appendChild(c);c=document.createElement("span");c.setAttribute("class","mailbox-attachment-size");c.setAttribute("style","text-align: center;color:"+d+";");c.textContent=a.starttime;g.appendChild(c);c=document.createElement("span");c.setAttribute("class","mailbox-attachment-size");c.setAttribute("style","text-align: center;color:"+d+";");c.textContent=a.endtime;g.appendChild(c);d=document.createElement("span");
d.setAttribute("class","mailbox-attachment-size");d.setAttribute("style","text-align:center;font-weight:bold;color:"+f+";");d.textContent="\u5730\u9ede:"+a.location;g.appendChild(d);f=document.createElement("a");f.setAttribute("class","btn btn-default btn-xs pull-left");d.appendChild(f);g=document.createElement("i");g.setAttribute("title","\u67e5\u770b\u8a73\u7d30\u8cc7\u8a0a");g.setAttribute("onclick",'open_detail_record("'+a.id+'");return false;');g.setAttribute("class","fa fa-search-plus");f.appendChild(g);
0<a.files.length&&(f=document.createElement("a"),f.setAttribute("title","\u4e0b\u8f09\u6a94\u6848"),f.setAttribute("href","/php/downloadfile.php?project_id="+project_id+"&fileid="+a.files),f.setAttribute("class","btn btn-default btn-xs pull-right"),d.appendChild(f),a=document.createElement("i"),a.setAttribute("class","fa fa-cloud-download"),f.appendChild(a));return b}
function open_detail_record(a){$("#modal-record_detail").modal("toggle");a=get_curriculumrecord(a);var b=get_curriculum(a.curriculumid),b=getCurriculumTypeName(b.typeid);document.getElementById("record_detail_name").textContent="\u8ab2\u7a0b\u540d\u7a31: "+a.name;document.getElementById("record_detail_type").textContent="\u8ab2\u7a0b\u985e\u5225[\u8ab2\u7a0b\u865f\u78bc]: "+b+"["+a.number+"]";document.getElementById("record_detail_time").textContent="\u8ab2\u7a0b\u6642\u9593: "+a.starttime+" ~ "+
a.endtime;document.getElementById("record_detail_signintime").textContent="\u8ab2\u7a0b\u7c3d\u5230\u6642\u9593: "+a.signinstarttime+" ~ "+a.signinendtime;document.getElementById("record_detail_totalhours").textContent="\u7e3d\u6642\u6578(\u5c0f\u6642): "+a.totalhours;document.getElementById("record_detail_location").textContent="\u5730\u9ede: "+a.location;document.getElementById("record_detail_description").textContent="\u5167\u5bb9: "+a.description;b=document.getElementById("record_detail_teacher");
b.textContent="\u4efb\u8ab2\u8001\u5e2b: ";console.log("teacheruserid:"+a.teacheruserid);var c=document.createElement("span");c.setAttribute("class","badge bg-aqua-active");c.textContent=getUserName(a.teacheruserid);b.appendChild(c);document.getElementById("record_detail_cost").textContent="\u8cbb\u7528: "+a.cost;document.getElementById("record_detail_note").textContent="\u5099\u8a3b: "+a.note}
function getBackgroundColor(a){switch(get_curriculum(a).typeid%10){default:case 0:a="#fe8a71";break;case 1:a="#f6cd61";break;case 2:a="#2ab7ca";break;case 3:a="#fe9c8f";break;case 4:a="#851e3e";break;case 5:a="#f9caa7";break;case 6:a="#33ff56";break;case 7:a="#3da4ab";break;case 8:a="#0e9aa7";break;case 9:a="#4a4e4d"}return a}
function getTextColor(a){switch(get_curriculum(a).typeid%10){default:case 0:a="#336621";break;case 1:a="#336621";break;case 2:a="#336621";break;case 3:a="#336621";break;case 4:a="#aaccdd";break;case 5:a="#336621";break;case 6:a="#336621";break;case 7:a="#336621";break;case 8:a="#336621";break;case 9:a="#336621"}return a}
function getLocationTextColor(a){switch(get_curriculum(a).typeid%10){default:case 0:a="#443311";break;case 1:a="#443311";break;case 2:a="#443311";break;case 3:a="#443311";break;case 4:a="#aaccdd";break;case 5:a="#443311";break;case 6:a="#443311";break;case 7:a="#443311";break;case 8:a="#443311";break;case 9:a="#443311"}return a}
function load_user_info(){var a=[],b=check_userinfo_existed(parseInt(gl_userid));0==b&&a.push(gl_userid);for(var c=0;c<gl_curriculumrecordapply_List.length;c++){var e=gl_curriculumrecordapply_List[c],b=check_userinfo_existed(e.userid);if(0==b&&0<e.userid){for(var b=!1,d=0;d<a.length;d++)if(a[d]==e.userid){b=!0;break}b||a.push(e.userid)}b=check_userinfo_existed(e.teacheruserid);if(0==b&&0<e.teacheruserid){b=!1;for(d=0;d<a.length;d++)if(a[d]==e.teacheruserid){b=!0;break}b||a.push(e.teacheruserid)}}0==
a.length?update_user_name():$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusername=1&user="+a.toString()+"&project_id="+project_id,function(a){$.each(a,function(a,b){b.userid=parseInt(b.userid);gl_user_info.push(b)})}).success(function(){update_user_name()}).error(function(){}).complete(function(){})}function check_userinfo_existed(a){for(var b=!1,c=0;c<gl_user_info.length;++c)if(gl_user_info[c].userid==a){b=!0;break}return b}
function getUserName(a){for(var b="",c=0;c<gl_user_info.length;++c){var e=gl_user_info[c];if(e.userid==a){b=e.name;break}}return b}function get_curriculumrecord(a){for(var b=0;b<gl_curriculumrecord_List.length;b++){var c=gl_curriculumrecord_List[b];if(c.id==a)return c}}function get_curriculum(a){for(var b=0;b<gl_curriculum_List.length;b++){var c=gl_curriculum_List[b];if(0==a)break;else if(c.id==a)break}return c}
function getCurriculumTypeName(a){for(var b="",c=0;c<gl_curriculumtype_List.length;c++){var e=gl_curriculumtype_List[c];if(a==e.id){b=e.name;break}}return b}
function update_user_name(){for(var a=0;a<gl_curriculumrecordapply_List.length;a++){var b=gl_curriculumrecordapply_List[a],c=document.getElementById("user_name_"+b.id+"_"+b.userid);void 0!=c&&(c.textContent=getUserName(b.userid));c=document.getElementById("teacheruser_name_"+b.id+"_"+b.teacheruserid);void 0!=c&&(c.textContent=getUserName(b.teacheruserid))}}
function getCurrentWeek(a){a=moment().clone().add(a,"weeks").startOf("isoWeek");for(var b={showDate:[],Date:[]},c=0;6>=c;c++)b.showDate.push(moment(a).add(c,"days").format("MM/DD")),b.Date.push(moment(a).add(c,"days").format("YYYY-MM-DD"));return b}function clearChildView(a){a=document.getElementById(a);if(null!=a)for(;a.firstChild;)a.removeChild(a.firstChild);return a}function move_week_backward(){gCurrentWeek--;show_week_schedule()}
function move_week_forward(){gCurrentWeek++;show_week_schedule()}function open_weekschedule_page(){window.open("/index.php/vilsweekschedule/"+project_id,"_blank").focus()};
