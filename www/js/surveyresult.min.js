var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,LOAD_PAGE_NUM=20,LOAD_DEVICE_NUM=40,glTags=[],glLocators=[],gl_tag_num=0,gl_locator_num=0,gl_tag_load_index=0,gl_locator_load_index=0,glSurvey_List=[],glSurveyEvent_List=[],glPushNotifyMessageRecord_List=[],glSurveyResult_List=[],glStorageImage_List=[],glMessageStatus_List=[],glCurrentPage=1,glReloadTimes=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_survey());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_surveyevent());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+
PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_surveyevents(),CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_devices());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,
load_surveyresults());break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_surveyresults(),CurrentLoadIndex+=1);break;case 6:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_PushNotify_uploadimage(),load_user_uploadimage(),CurrentLoadIndex+=1);
break;case 7:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_message_status());break;case 8:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_message_status(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,
100):console.log("check_loading_status() Stop.")}function load_survey(){var a=gl_target_server+"/php/survey.php";glSurvey_List=[];$.getJSON(a,"loadsurvey=1&project_id="+project_id+"&surveyid="+show_surveyid+"&accountid="+accountid,function(a){$.each(a,function(a,b){glSurvey_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_surveyevent(){var a=gl_target_server+"/php/survey.php";glSurveyEvent_List=[];$.getJSON(a,"loadsurveyevent=1&project_id="+project_id+"&surveyid="+show_surveyid+"&hashkey="+show_hashkey+"&accountid="+accountid,function(a){$.each(a,function(a,b){glSurveyEvent_List.push(b)})}).success(function(){load_PushNotifyMessageRecord()}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_PushNotifyMessageRecord(){var a=gl_target_server+"/php/pushnotify.php";glPushNotifyMessageRecord_List=[];for(var b="",c=0;c<glSurveyEvent_List.length;c++){var f=glSurveyEvent_List[c];0!=c&&(b+=",");b+=f.PushNotifyMessageRecorddbId}$.getJSON(a,"loadmessagerecord=1&project_id="+project_id+"&dbids="+b,function(a){$.each(a,function(a,b){glPushNotifyMessageRecord_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_surveyresults(){var a=gl_target_server+"/php/survey.php";glSurveyResult_List=[];for(var b="",c=0;c<glSurveyEvent_List.length;c++){var f=glSurveyEvent_List[c];0!=c&&(b+=",");b+=f.hashkey}$.getJSON(a,"loadsurveyresults=1&project_id="+project_id+"&hashkeys="+b+"&loaduser=1&accountid="+accountid,function(a){$.each(a,function(a,b){var c={};c.hashkey=a;c.record=b;glSurveyResult_List.push(c)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function show_surveyevents(){for(var a=document.getElementById("SURVEY_EVENT_TABLE_BODY");a.firstChild;)a.removeChild(a.firstChild);console.log("show_surveyevent() glSurveyEvent_List.length:"+glSurveyEvent_List.length);for(var b=0,c=0;c<glSurveyEvent_List.length;c++)b+=show_surveyevent(a,(glCurrentPage-1)*LOAD_PAGE_NUM+b+1,glSurveyEvent_List[c]),show_surveyeventitem(glSurveyEvent_List[c])}
function show_surveyevent(a,b,c){var f=0;console.log("show_surveyevent() surveyid:"+c.surveyid);var d=find_survey(c.surveyid);if(null==d)return 0;console.log("show_surveyevent() survey.type:"+d.type+" survey.title:"+d.title);var e=document.createElement("tr");e.setAttribute("id",c.dbId+"_TABLE_ROW");a.appendChild(e);e.appendChild(document.createElement("td"));e.cells[f].appendChild(document.createTextNode(""+b));f++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.appendChild(document.createTextNode(c.eventid));
e.cells[f].appendChild(a);f++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.appendChild(document.createTextNode(d.title));e.cells[f].appendChild(a);f++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","description_"+d.surveyid);a.appendChild(document.createTextNode(d.description));e.cells[f].appendChild(a);f++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","type_"+d.surveyid);
e.cells[f].appendChild(a);"0"===d.type&&a.appendChild(document.createTextNode("\u55ae\u9078"));"1"===d.type&&a.appendChild(document.createTextNode("\u8907\u9078"));f++;e.appendChild(document.createElement("td"));void 0!=c.deadline&&0<c.deadline.length&&(d=document.createElement("span"),d.setAttribute("class","label label-info"),d.textContent=convertPrettyDateOnly(c.deadline,"+00:00"),e.cells[f].appendChild(d),d=document.createElement("span"),d.setAttribute("class","label label-warning"),d.textContent=
convertPrettyTimeOnly(c.deadline,"+00:00"),e.cells[f].appendChild(d));f++;e.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("class","label label-info");d.textContent=convertPrettyDateOnly(c.DateTime,"+00:00");e.cells[f].appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-warning");d.textContent=convertPrettyTimeOnly(c.DateTime,"+00:00");e.cells[f].appendChild(d);c=document.createElement("td");c.setAttribute("id","show_img_area");
e.appendChild(c);return 1}function load_devices(){$.getJSON(gl_target_server+"/php/vilsnodes.php","devicescount=1&project_id="+project_id,function(a){gl_tag_num=parseInt(a.LOC_TAG_NUM);gl_locator_num=parseInt(a.LOC_LOCATOR_NUM);gl_locator_load_index=gl_tag_load_index=0}).success(function(){setTimeout(load_tags,10)}).error(function(){setTimeout(load_devices,1E3)}).complete(function(){})}
function load_tags(){gl_tag_load_index>=gl_tag_num?(gl_tag_load_index=0,setTimeout(load_locators,10)):(0==gl_tag_load_index&&(glTags=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtag=1&s="+gl_tag_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){var b=parseInt(a.LOC_TAG_NUM);0==gl_tag_load_index&&0==b&&(gl_tag_load_index=gl_tag_num=0);for(var c=gl_tag_load_index;c<gl_tag_load_index+b;++c){var f=a["LOC_TAG_INDEX_"+c];void 0!=f&&(f=f.split(","),glTags.push(f))}gl_tag_load_index+=
b}).success(function(){gl_tag_load_index>=gl_tag_num?(gl_tag_load_index=0,setTimeout(load_locators,10)):setTimeout(load_tags,10)}).error(function(){gl_tag_load_index=0;setTimeout(load_tags,1E3)}).complete(function(){}))}
function load_locators(){console.log("load_locators(): gl_locator_num:"+gl_locator_num+" gl_locator_load_index:"+gl_locator_load_index);gl_locator_load_index>=gl_locator_num?(gl_locator_load_index=0,CurrentLoadIndex+=1):(0==gl_locator_load_index&&(glLocators=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadlocator=1&s="+gl_locator_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var b=parseInt(a.LOC_LOCATOR_NUM),c=gl_locator_load_index;c<gl_locator_load_index+
b;++c){var f="LOC_LOCATOR_INDEX_"+c;void 0!=a[f]&&null!=a[f]&&(f=a[f].split(","),glLocators.push(f))}gl_locator_load_index+=b}).success(function(){gl_locator_load_index>=gl_locator_num?(gl_locator_load_index=0,CurrentLoadIndex+=1):load_locators()}).error(function(){gl_locator_load_index=0;CurrentLoadIndex+=1;setTimeout(load_locators,1E3)}).complete(function(){}))}
function show_surveyeventitem(a){for(var b=document.getElementById("SURVEY_ITEM_TABLE_BODY");b.firstChild;)b.removeChild(b.firstChild);var c=find_survey(a.surveyid);if(null==c)return 0;for(var f=0;f<c.items.length;f++){var d=c.items[f],e=document.createElement("tr");b.appendChild(e);var h=document.createElement("td");h.appendChild(document.createTextNode(f+1));e.appendChild(h);h=document.createElement("td");h.appendChild(document.createTextNode(d.description));e.appendChild(h);d=document.createElement("td");
e.appendChild(d);h=document.createElement("span");h.setAttribute("class","label label-danger");h.setAttribute("id","survey_item_"+a.hashkey+"_"+f);h.textContent="0";d.appendChild(h);d=document.createElement("td");d.setAttribute("id","survey_item_user_"+a.hashkey+"_"+f);e.appendChild(d)}e=document.createElement("tr");b.appendChild(e);h=document.createElement("td");h.appendChild(document.createTextNode(c.items.length+1));e.appendChild(h);h=document.createElement("td");h.appendChild(document.createTextNode("\u8aaa\u660e"));
e.appendChild(h);b=document.createElement("td");b.setAttribute("id","survey_item_comment_"+a.hashkey);e.appendChild(b);b=document.createElement("td");b.setAttribute("id","survey_item_comment_user_"+a.hashkey);e.appendChild(b)}
function show_surveyresults(){for(var a=0;a<glSurveyResult_List.length;a++){var b=glSurveyResult_List[a],c=document.getElementById("survey_item_comment_user_"+b.hashkey);if(void 0!=c)for(;c.firstChild;)c.removeChild(c.firstChild);var f=document.getElementById("survey_item_comment_"+b.hashkey);if(void 0!=f)for(;f.firstChild;)f.removeChild(f.firstChild);for(var d=0;d<b.record.length;d++)for(var e=b.record[d],h=e.results.split(","),k=0;k<h.length;k++){var g=document.getElementById("survey_item_user_"+
b.hashkey+"_"+k);if(void 0!=g)for(;g.firstChild;)g.removeChild(g.firstChild)}for(var n=[],l=[],m=[],d=0;d<b.record.length;d++)if(e=b.record[d],h=e.results.split(","),c=document.getElementById("survey_item_comment_user_"+b.hashkey),void 0!=c&&0<e.comment.length&&(m.push(e.comment),k=document.createElement("div"),c.appendChild(k),c=document.createElement("span"),c.setAttribute("class","label label-primary"),c.textContent=e.comment,k.appendChild(c),g=document.createElement("span"),g.setAttribute("class",
"label label-success"),g.textContent=e.name,k.appendChild(g),g=document.createElement("span"),g.setAttribute("class","label label-info"),g.textContent=convertPrettyDateOnly(e.datetime,"+00:00"),k.appendChild(g),g=document.createElement("span"),g.setAttribute("class","label label-warning"),g.textContent=convertPrettyTimeOnly(e.datetime,"+00:00"),k.appendChild(g)),void 0==n[e.topic])for(n[e.topic]=1,k=0;k<h.length;k++)c=parseInt(h[k]),void 0==l[k]&&(l[k]=0),l[k]+=c,g=document.getElementById("survey_item_user_"+
b.hashkey+"_"+k),void 0!=g&&1==c&&(c=document.createElement("div"),g.appendChild(c),g=document.createElement("span"),g.setAttribute("class","label label-success"),g.textContent=e.name,c.appendChild(g),g=document.createElement("span"),g.setAttribute("class","label label-info"),g.textContent=convertPrettyDateOnly(e.datetime,"+00:00"),c.appendChild(g),g=document.createElement("span"),g.setAttribute("class","label label-warning"),g.textContent=convertPrettyTimeOnly(e.datetime,"+00:00"),c.appendChild(g));
for(d=0;d<l.length;d++)e=document.getElementById("survey_item_"+b.hashkey+"_"+d),void 0!=e&&(e.textContent=l[d],0==l[d]?e.setAttribute("class","label label-danger"):e.setAttribute("class","label label-info"));for(d=0;d<m.length;d++)void 0!=f&&(b=document.createElement("span"),b.setAttribute("class","label label-primary"),f.appendChild(b),b.textContent=m[d])}2>glReloadTimes&&(setTimeout(reload_surveyresults,1E4),glReloadTimes++)}
function load_PushNotify_uploadimage(){for(var a="";0<glPushNotifyMessageRecord_List.length;){a=glPushNotifyMessageRecord_List[0].messagehashkey;break}0!=a.length&&$.getJSON(gl_target_server+"/php/pushnotify.php","loadnotifyimage=1&project_id="+project_id+"&messagehashkey="+a,function(a){0<a.imageuid.length&&load_PushNotify_images(a.imageuid)}).success(function(){}).error(function(){}).complete(function(){})}
function load_PushNotify_images(a){console.log("load_PushNotify_images() imageuid:"+a);a=a.split(",");for(var b=0;b<a.length;b++)load_PushNotify_image(a[b])}
function load_PushNotify_image(a){console.log("load_PushNotify_image() imageuid:"+a);$.getJSON(gl_target_server+"/php/storage.php","loadsingleimage=1&project_id="+project_id+"&imageuid="+a,function(b){var c="show_img_area_"+a;if(void 0==document.getElementById(c)){var f=document.getElementById("show_img_area");b=create_data_image(b.id,b.description,b.thumbpath,b.imagetype,b.imagesize);b.setAttribute("id",c);f.appendChild(b)}}).success(function(){}).error(function(){}).complete(function(){})}
function load_user_uploadimage(){glStorageImage_List=[];for(var a="";0<glPushNotifyMessageRecord_List.length;){a=glPushNotifyMessageRecord_List[0].messagehashkey;break}0!=a.length&&$.getJSON(gl_target_server+"/php/storage.php","loadnotifyimage=1&project_id="+project_id+"&messagehashkey="+a,function(a){$.each(a,function(a,b){glStorageImage_List.push(b)})}).success(function(){show_user_uploadimage()}).error(function(){}).complete(function(){})}
function show_user_uploadimage(){for(var a=document.getElementById("UPLOAD_IMAGE_TABLE_BODY"),b=0;b<glStorageImage_List.length;b++){var c=glStorageImage_List[b];console.log("show_user_uploadimage() description:"+c.description);console.log("show_user_uploadimage() thumbimagelink:"+(gl_target_server+"/php/downloadfile.php?imageuid="+c.imageuid+"&loadthumb=1"));var f=document.getElementById("upload_img_"+c.topic);void 0==f&&(f=create_upload_img_row_item(b,c),a.appendChild(f));update_upload_img_item(c)}}
function create_upload_img_row_item(a,b){var c=document.createElement("tr");c.setAttribute("id","upload_img_"+b.topic);var f=document.createElement("td");f.appendChild(document.createTextNode(a+1));c.appendChild(f);f=document.createElement("td");f.setAttribute("id","upload_img_td_"+b.topic);c.appendChild(f);f=document.createElement("td");c.appendChild(f);var d=document.createElement("span");d.setAttribute("class","label label-success");d.textContent=getUserNameByTopic(b.topic);f.appendChild(d);d=
document.createElement("span");d.setAttribute("class","label label-info");d.textContent=convertPrettyDateOnly(b.updatetime,"+00:00");f.appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-warning");d.textContent=convertPrettyTimeOnly(b.updatetime,"+00:00");f.appendChild(d);return c}
function update_upload_img_item(a){var b="show_img_"+a.imageuid;if(void 0==document.getElementById(b)){var c=document.getElementById("upload_img_td_"+a.topic);a=create_data_image(a.id,a.description,a.thumbpath,a.imagetype,a.imagesize);a.setAttribute("id",b);c.appendChild(a)}}
function create_data_image(a,b,c,f,d){c=document.createElement("td");var e=document.createElement("ul");e.setAttribute("class","mailbox-attachments clearfix");c.appendChild(e);f=document.createElement("li");e.appendChild(f);e=document.createElement("span");e.setAttribute("class","mailbox-attachment-icon has-img");f.appendChild(e);var h=document.createElement("img");h.setAttribute("src","/php/downloadfile.php?loadthumb=1&project_id="+project_id+"&imageid="+a);h.setAttribute("alt","Attachment");e.appendChild(h);
e=document.createElement("div");e.setAttribute("class","mailbox-attachment-info");f.appendChild(e);f=document.createElement("a");f.setAttribute("href","/php/downloadfile.php?project_id="+project_id+"&imageid="+a);f.setAttribute("class","mailbox-attachment-name");e.appendChild(f);e=document.createElement("i");e.setAttribute("class","fa fa-camera");f.appendChild(e);f.appendChild(document.createTextNode("  "+b));b=document.createElement("span");b.setAttribute("class","mailbox-attachment-size");b.textContent=
convertFileSize(parseInt(d));f.appendChild(b);d=document.createElement("a");d.setAttribute("href","/php/downloadfile.php?project_id="+project_id+"&imageid="+a);d.setAttribute("class","btn btn-default btn-xs pull-right");b.appendChild(d);a=document.createElement("i");a.setAttribute("class","fa fa-cloud-download");d.appendChild(a);return c}function convertFileSize(a){return 1048576<a?(Math.round(100*a/1048576)/100).toString()+"MB":(Math.round(100*a/1024)/100).toString()+"KB"}
function reload_surveyresults(){console.log("reload_surveyresults() glReloadTimes:"+glReloadTimes);PreLoadIndex=4;CurrentLoadIndex=5;setTimeout(check_loading_status,1E4)}function find_survey(a){for(var b=0;b<glSurvey_List.length;b++){var c=glSurvey_List[b];if(parseInt(c.surveyid)==parseInt(a))return c}return null}
function load_message_status(){glMessageStatus_List=[];for(var a="";0<glPushNotifyMessageRecord_List.length;){a=glPushNotifyMessageRecord_List[0].messagehashkey;break}0!=a.length&&$.getJSON(gl_target_server+"/php/pushnotify.php","loadmessagestatus=1&project_id="+project_id+"&hashkeys="+a+"&loadaccountname=1",function(a){$.each(a,function(a,b){glMessageStatus_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function show_message_status(){for(var a=document.getElementById("message_read");a.firstChild;)a.removeChild(a.firstChild);var b=document.createElement("div");a.appendChild(b);for(var c=0,f=0;f<glMessageStatus_List.length;f++){var d=glMessageStatus_List[f];if("1"==d.readed){var e=document.createElement("span");e.setAttribute("class","label label-success");e.textContent=d.accountname;b.appendChild(e);e=document.createElement("span");e.setAttribute("class","label label-info");e.textContent=convertPrettyDateOnly(d.datetime,
"+00:00");b.appendChild(e);e=document.createElement("span");e.setAttribute("class","label label-warning");e.textContent=convertPrettyTimeOnly(d.datetime,"+00:00");b.appendChild(e);d=document.createElement("span");d.setAttribute("style","width:20px; display: inline-block;");b.appendChild(d);c++;5<=c&&(b=document.createElement("div"),a.appendChild(b),c=0)}}}
function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,PreLoadIndex=0,CurrentLoadIndex=1,check_loading_status())}function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;PreLoadIndex=0;CurrentLoadIndex=1;check_loading_status()}
function getUserNameByTopic(a){for(var b="",c=0;c<glSurveyResult_List.length;c++){for(var f=glSurveyResult_List[c],d=0;d<f.record.length;d++){var e=f.record[d];if(a===e.topic){b=e.name;break}}if(0<b.length)break}return b}function convertPrettyDateOnly(a,b){var c=moment.utc(a,"YYYY-MM-DD HH:mm:ss").utcOffset(b),f=c.format("YYYY"),d=c.format("M"),c=c.format("D");return f+"\u5e74"+d+"\u6708"+c+"\u65e5 "}
function convertPrettyTimeOnly(a,b){var c=moment.utc(a,"YYYY-MM-DD HH:mm:ss").utcOffset(b),f=c.hour(),d=c.minutes(),c=c.seconds(),e="";0<=f&&(e+=f+"\u9ede");0<=d&&(e+=d+"\u5206");0<=c&&(e+=c+"\u79d2");return e}function show_surveyresult(a,b){window.open("/index.php/vilssurveyresult/"+a+"/"+b,"_blank").focus()}function open_surveyrecords_page(){window.open("/index.php/vilssurveyrecords/"+project_id,"_blank").focus()};
