var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,LOAD_PAGE_NUM=20,gl_user_info=[],gl_searchusers=[],gl_usersubgroups=[],gl_assist_List=[],glCurrentPage=1,pre_input_value="",glNewAssistIndex=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usersubgroup());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_assists());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+
PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_assists(),CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_user_info(),CurrentLoadIndex+=1);break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=
CurrentLoadIndex,load_assist_config(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}function load_usersubgroup(){gl_usersubgroups=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,b){gl_usersubgroups.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_assists(){var a=gl_target_server+"/php/assist.php",c=(glCurrentPage-1)*LOAD_PAGE_NUM,b=LOAD_PAGE_NUM;gl_assist_List=[];$.getJSON(a,"loadassists=1&project_id="+project_id+"&offset="+c+"&count="+b,function(a){$.each(a,function(a,b){gl_assist_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function show_assists(){for(var a=document.getElementById("ASSIST_TABLE_BODY");a.firstChild;)a.removeChild(a.firstChild);for(var c=0;c<gl_assist_List.length;c++)show_assist(a,(glCurrentPage-1)*LOAD_PAGE_NUM+c+1,gl_assist_List[c])}
function show_assist(a,c,b){var d=0,e=document.createElement("tr");e.setAttribute("id",b.id+"_TABLE_ROW");0==c%2&&e.setAttribute("bgcolor","#ebebe0");a.appendChild(e);e.appendChild(document.createElement("td"));e.cells[d].appendChild(document.createTextNode(""+c));d++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","title_"+b.id);a.appendChild(document.createTextNode(b.title));e.cells[d].appendChild(a);d++;e.appendChild(document.createElement("td"));
a=document.createElement("div");a.setAttribute("id","description_"+b.id);a.appendChild(document.createTextNode(b.description));e.cells[d].appendChild(a);d++;a=create_subgroup(b.subgroups);a.setAttribute("id","uiid_subgroup_"+b.id);e.appendChild(a);d++;a=document.createElement("td");a.setAttribute("id","uiid_assignusers_"+b.id);e.appendChild(a);c=create_assignusers(b.id,b.assignusers);a.appendChild(c);d++;if(1==gl_groupid||2==gl_groupid)e.appendChild(document.createElement("td")),a=document.createElement("button"),
a.setAttribute("id","editbtn_"+b.id),a.setAttribute("title","Edit this Assist"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","edit_assist('"+b.id+"');return false;"),c=document.createElement("i"),c.setAttribute("id","editimg_"+b.id),c.setAttribute("class","fa fa-edit"),a.appendChild(c),e.cells[d].appendChild(a),a=document.createElement("button"),a.setAttribute("id","deletebtn_"+b.id),a.setAttribute("style","display:none"),a.setAttribute("title","Delete this Assist"),a.setAttribute("href",
"javascript:;"),a.setAttribute("onclick","confirm_delete_assist('"+b.id+"');return false;"),b=document.createElement("i"),b.setAttribute("class","fa fa-trash-o"),a.appendChild(b),e.cells[d].appendChild(a)}
function load_user_info(){for(var a="",c=0,b=0;b<gl_assist_List.length;b++)for(var d=gl_assist_List[b].assignusers.split(","),e=0;e<d.length;e++){for(var f=parseInt(d[e]),g=!1,h=0;h<gl_user_info.length;++h)if(gl_user_info[h].userid==f){g=!0;break}0==g&&0<f&&(0<c&&(a+=","),a+=f,c+=1)}0==a.length?update_user_name():$.getJSON(gl_target_server+"/php/vilsnodes.php","queryusers=1&userid="+a+"&project_id="+project_id,function(a){$.each(a,function(a,b){b.userid=parseInt(b.userid);gl_user_info.push(b)})}).success(function(){update_user_name()}).error(function(){}).complete(function(){})}
function update_user_name(){for(var a=0;a<gl_assist_List.length;a++)for(var c=gl_assist_List[a],b=c.assignusers.split(","),d=0;d<b.length;d++){var e=parseInt(b[d]);document.getElementById("assign_user_name_"+c.id+"_"+e).textContent=getUserName(e)}}
function load_assist_config(){$.getJSON(gl_target_server+"/php/assist.php","queryassistconfig=1&project_id="+project_id,function(a){document.getElementById("config_sendNotifyTime").textContent=a.sendNotifyTime}).success(function(){}).error(function(){}).complete(function(){})}
function edit_assist(a){for(var c=document.getElementById("title_"+a),b=document.getElementById("description_"+a),d=document.getElementById("uiid_subgroup_"+a),e=document.getElementById("uiid_assignusers_"+a);c.firstChild;)c.removeChild(c.firstChild);for(;b.firstChild;)b.removeChild(b.firstChild);for(;d.firstChild;)d.removeChild(d.firstChild);for(;e.firstChild;)e.removeChild(e.firstChild);var f=document.getElementById("editbtn_"+a),g=document.getElementById("editimg_"+a);f.setAttribute("title","Save this Assist");
f.setAttribute("onclick","save_assist('"+a+"');return false;");g.setAttribute("class","fa fa-save");document.getElementById("deletebtn_"+a).setAttribute("style","display:block");for(g=0;g<gl_assist_List.length;g++)if(f=gl_assist_List[g],f.id==a){c.appendChild(create_input_text("input_title_"+a,f.title));b.appendChild(create_input_text("input_description_"+a,f.description));c=create_edit_subgrouplist_ui(a,f.subgroups);d.appendChild(c);d=create_edit_assignuserlist_ui(a,f.assignusers);e.appendChild(d);
$source=document.querySelector("#search_user_text_"+a);$source.addEventListener("input",check_search_user_change);$source.recordid=a;break}}
function save_assist(a){var c=document.getElementById("input_title_"+a).value,b=document.getElementById("input_description_"+a).value;if(0==c.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u540d\u7a31");else if(0==b.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u8aaa\u660e");else{for(var d=void 0,e=0;e<gl_assist_List.length;e++){var f=gl_assist_List[e];if(f.id==a){d=f;break}}void 0==d?alert("\u7121\u6b64\u4e8b\u9805\u7d00\u9304!"):(d=getSelectedSubgroup(a),e=getSelectedUser(a),f={},f.project_id=""+project_id,
f.update_assist=1,f.id=a,f.title=c,f.description=b,f.subgroups=d,f.assignusers=e,jQuery.ajax({url:gl_target_server+"/php/assist.php",type:"POST",data:f,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}}))}}
function save_new_assist(){var a=document.getElementById("input_title").value,c=document.getElementById("input_description").value,b=getSelectedSubgroup("new"),d=getSelectedUser("new");console.log("save_new_assist() subgroups:"+b);if(0==a.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u540d\u7a31");else if(0==c.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u8aaa\u660e");else{var e={};e.project_id=""+project_id;e.create_new_assist=1;e.title=a;e.description=c;e.subgroups=b;e.assignusers=d;jQuery.ajax({url:gl_target_server+
"/php/assist.php",type:"POST",data:e,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}function confirm_delete_assist(a){confirm("Are you sure you want to delete this assist ?")&&delete_assist(a)}
function delete_assist(a){var c={};c.project_id=""+project_id;c.delete_assist=1;c.id=a;jQuery.ajax({url:gl_target_server+"/php/assist.php",type:"POST",data:c,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,c,e){alert("error = "+e);alert("xhr.responseText = "+a.responseText)}})}
function create_empty_assist_table_item(a){a=document.getElementById("ASSIST_TABLE_BODY");if(void 0==document.getElementById("input_title")){a=a.insertRow(0);var c=0;a.appendChild(document.createElement("td"));a.cells[c].appendChild(document.createTextNode(""));c++;a.appendChild(document.createElement("td"));a.cells[c].appendChild(create_input_text("input_title"));c++;a.appendChild(document.createElement("td"));a.cells[c].appendChild(create_input_text("input_description"));c++;a.appendChild(document.createElement("td"));
var b=create_edit_subgrouplist_ui("new","");a.cells[c].appendChild(b);c++;a.appendChild(document.createElement("td"));b=document.createElement("div");b.setAttribute("class","btn-group");a.cells[c].appendChild(b);var d=document.createElement("input");d.setAttribute("type","text");d.setAttribute("placeholder","\u5c0b\u627e\u4eba\u54e1");d.setAttribute("id","search_user_text_new");b.appendChild(d);d=document.createElement("ul");d.setAttribute("class","dropdown-menu");d.setAttribute("id","search_user_text_dropdown_new");
b.appendChild(d);b=document.createElement("div");b.setAttribute("id","assignusers_new");a.cells[c].appendChild(b);c++;a.appendChild(document.createElement("td"));b=document.createElement("button");b.setAttribute("class","btn btn-block btn-primary btn-lg");b.setAttribute("onclick","save_new_assist();");b.textContent="\u5132\u5b58";a.cells[c].appendChild(b)}}
function create_input_text(a,c){var b=document.createElement("textarea");b.setAttribute("rows","1");b.setAttribute("id",a);b.textContent=c;return b}function create_subgroup_label(a){var c=document.createElement("span");c.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a65a;");c.textContent=a;return c}
function create_empty_spcae(){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;");a.textContent="  ";return a}
function create_edit_subgrouplist_ui(a,c){var b=document.createElement("div");b.setAttribute("class","btn-group");var d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("class","btn btn-default btn-sm dropdown-toggle");d.setAttribute("data-toggle","dropdown");d.textContent="\u5b50\u96c6\u5408";b.appendChild(d);var e=document.createElement("span");e.setAttribute("class","caret");d.appendChild(e);d=document.createElement("ul");d.setAttribute("class","dropdown-menu");b.appendChild(d);
if(1==gl_groupid||2==gl_groupid||3==gl_groupid){var e=document.createElement("li"),f=document.createElement("a");f.setAttribute("class","small");f.setAttribute("href","javascript:;");f.setAttribute("onclick",'dropdown_selectall("subgroup","'+a+'");return true;');e.appendChild(f);f.appendChild(document.createTextNode("\u5168\u9078"));d.appendChild(e)}e=c.split(",");for(f=0;f<gl_usersubgroups.length;++f){var g=gl_usersubgroups[f],h=check_numer_in_list(parseInt(g.subgroupid),e);d.appendChild(create_dropdown_subgroup_item(a,
f,parseInt(g.subgroupid),g.subgroupname,h))}return b}
function create_edit_assignuserlist_ui(a,c){var b=document.createElement("div"),d=document.createElement("div");d.setAttribute("class","btn-group");b.appendChild(d);var e=document.createElement("input");e.setAttribute("type","text");e.setAttribute("placeholder","\u5c0b\u627e\u4eba\u54e1");e.setAttribute("id","search_user_text_"+a);d.appendChild(e);e=document.createElement("ul");e.setAttribute("class","dropdown-menu");e.setAttribute("id","search_user_text_dropdown_"+a);d.appendChild(e);d=document.createElement("div");
d.setAttribute("id","assignusers_"+a);b.appendChild(d);for(var e=c.split(","),f=0;f<e.length;f++){var g=parseInt(e[f]),h=getUserName(g),g=create_clickable_user(a,g,h);d.appendChild(g)}return b}
function create_dropdown_subgroup_item(a,c,b,d,e){var f=document.createElement("li"),g=document.createElement("a");g.setAttribute("class","small");g.setAttribute("tabIndex","-1");g.setAttribute("data-value",b);g.setAttribute("href","javascript:;");g.setAttribute("onclick",'dropdown_subgroup_click("'+a+'",'+c+");return true;");b=document.createElement("input");b.setAttribute("type","checkbox");b.setAttribute("id","dropdown_checkbox_subgroup_"+a+"_"+c);b.setAttribute("onclick",'dropdown_checkbox_subgroup_click("'+
a+'",'+c+");return true;");b.checked=e;g.appendChild(b);g.appendChild(document.createTextNode(" "+d));f.appendChild(g);return f}function dropdown_checkbox_subgroup_click(a,c){glDropdown_checkbox_subgroup_click=!0}var glDropdown_checkbox_subgroup_click=!1;
function dropdown_subgroup_click(a,c){1!=glDropdown_checkbox_subgroup_click&&(1==document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c).checked?document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c).checked=!1:document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c).checked=!0);glDropdown_checkbox_subgroup_click=!1}
function dropdown_selectall(a,c){console.log("dropdown_selectall() prefix:"+a+" fileid:"+c);for(var b=0;100>b;b++){var d=document.getElementById("dropdown_checkbox_"+a+"_"+c+"_"+b);if(void 0==d){console.log("dropdown_selectall() fileid:"+c+" i:"+b+" ele == undefined ");break}d.checked=!0}}
function create_subgroup(a){var c=document.createElement("td");a=a.split(",");if(0<=a.indexOf("99999")){var b=document.createElement("div");b.appendChild(create_subgroup_label("\u5168\u90e8"));c.appendChild(b)}else for(var d=0,b=void 0,e=0;e<a.length;e++){var f=getSubgroupName(a[e]);0<f.length&&(0==d&&(b=document.createElement("div"),c.appendChild(b)),b.appendChild(create_subgroup_label(f)),b.appendChild(create_empty_spcae()),d++,5<=d&&(d=0))}return c}
function create_assignusers(a,c){for(var b=document.createElement("div"),d=c.split(","),e=0;e<d.length;e++){var f=parseInt(d[e]),g=document.createElement("div");g.setAttribute("id","assign_user_"+a+"_"+f);b.appendChild(g);var h=document.createElement("span");h.setAttribute("class","badge bg-aqua-active");h.setAttribute("id","assign_user_name_"+a+"_"+f);h.textContent=getUserName(f);g.appendChild(h)}return b}
function getSelectedSubgroup(a){for(var c=[],b=0,d=0;d<gl_usersubgroups.length;++d){var e=gl_usersubgroups[d];document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+d).checked&&(e=parseInt(e.subgroupid),c.push(e),b++)}1!=gl_groupid&&2!=gl_groupid||b!=gl_usersubgroups.length||(c=[],c.push(99999));return c.toString()}
function getSelectedUser(a){for(var c=[],b=document.getElementById("assignusers_"+a).childNodes,d=0;d<b.length;d++){var e=b[d].id.replace("assign_user_"+a+"_","");c.push(e);console.log("getSelectedUser() userid:"+e)}return c.toString()}function check_numer_in_list(a,c){for(var b=!1,d=0;d<c.length;++d){var e=c[d];if(parseInt(e)==a||99999==parseInt(e)){b=!0;break}}return b}
function getSubgroupName(a){var c="";if("99999"==a)return"\u5168\u90e8";for(var b=0;b<gl_usersubgroups.length;++b){var d=gl_usersubgroups[b];if(parseInt(d.subgroupid)==a){c=d.subgroupname;break}}return c}function create_new_assist(){create_empty_assist_table_item(gl_assist_List.length+1);$source=document.querySelector("#search_user_text_new");$source.addEventListener("input",check_search_user_change);$source.recordid="new";return!1}var gl_search_start=0;
function search_user_change(a){console.log("search_user_change() recordid:"+a);var c=document.getElementById("search_user_text_"+a).value;if(c===pre_input_value)console.log("search_user_change() input_value === pre_input_value, input_value:"+c),""===c&&clearChildView("search_user_text_dropdown_"+a);else return console.log("search_user_change() input_value:"+c),search_text_change(a,c),!1}
function check_search_user_change(a){0==gl_search_start&&(gl_search_start=new Date);1<=((new Date).getTime()-gl_search_start.getTime())/1E3?(gl_search_start=0,search_user_change(a.currentTarget.recordid)):setTimeout(search_user_change,500,a.currentTarget.recordid)}
function search_text_change(a,c){gl_searchusers=[];jQuery.ajax({url:gl_target_server+"/php/vilsnodes.php",type:"POST",data:"searchuser=1&s=0&count=30&project_id="+project_id+"&text="+c,dataType:"text",success:function(b){b=JSON.parse(b);$.each(b,function(a,b){gl_searchusers.push(b)});update_search_user_table(a)}});return!1}
function update_search_user_table(a){clearChildView("search_user_text_dropdown_"+a);var c=document.getElementById("search_user_text_dropdown_"+a);if(void 0!=c){for(var b=0;b<gl_searchusers.length;++b)c.appendChild(create_user_item(b+1,a,gl_searchusers[b]));0<gl_searchusers.length&&$("#search_user_text_dropdown_"+a).is(":hidden")&&$("#search_user_text_dropdown_"+a).toggle()}}
function create_user_item(a,c,b){a=document.createElement("li");var d=document.createElement("a");d.setAttribute("class","small");d.setAttribute("tabIndex","-1");d.setAttribute("data-value",b.userid);d.setAttribute("href","javascript:;");d.setAttribute("onclick",'searchresult_user_click("'+c+'", "'+b.userid+'", "'+b.name+'");return true;');d.appendChild(document.createTextNode(" "+b.name));a.appendChild(d);return a}
function searchresult_user_click(a,c,b){console.log("searchresult_user_click() recordid:"+a+" userid:"+c);$("#search_user_text_dropdown_"+a).toggle();var d=document.getElementById("assignusers_"+a);void 0!=d&&(a=create_clickable_user(a,c,b),d.appendChild(a))}
function create_clickable_user(a,c,b){var d=document.createElement("div");d.setAttribute("id","assign_user_"+a+"_"+c);var e=document.createElement("span");e.setAttribute("class","badge bg-aqua-active");e.textContent=b;d.appendChild(e);b=document.createElement("span");b.setAttribute("class","badge bg-red");b.textContent="\u79fb\u9664";b.setAttribute("onclick",'remove_user_click("'+a+'", "'+c+'");return true;');d.appendChild(b);return d}
function remove_user_click(a,c){var b=document.getElementById("assign_user_"+a+"_"+c);null!=b&&b.parentElement.removeChild(b)}
function edit_assist_config(){var a=document.getElementById("config_sendNotifyTime"),c=document.getElementById("editconfigbtn"),b=document.getElementById("editconfigimg"),d=a.textContent;clearChildView("config_sendNotifyTime");c.setAttribute("title","Save this Assist Config");c.setAttribute("onclick","save_assis_config();return false;");b.setAttribute("class","fa fa-save");a.appendChild(create_input_text("input_sendNotifyTime",d))}
function save_assis_config(){var a=document.getElementById("input_sendNotifyTime").value;if(0==a.length)alert("\u5fc5\u9808\u8f38\u5165 \u63d0\u524d\u901a\u77e5\u6642\u9593");else if(console.log("save_assis_configt() sendNotifyTime:["+a+"]"),0==isNumeric(a))alert("\u63d0\u524d\u901a\u77e5\u6642\u9593, \u5fc5\u9808\u662f\u6578\u5b57");else{var c={};c.project_id=""+project_id;c.update_assistconfig=1;c.sendNotifyTime=a;jQuery.ajax({url:gl_target_server+"/php/assist.php",type:"POST",data:c,success:function(a){400==
a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,c,e){alert("error = "+e);alert("xhr.responseText = "+a.responseText)}})}}function isNumeric(a){return""!==a&&!isNaN(parseFloat(a))&&isFinite(a)}function clearChildView(a){a=document.getElementById(a);if(null!=a)for(;a.firstChild;)a.removeChild(a.firstChild);return a}
function getUserName(a){for(var c="",b=0;b<gl_user_info.length;++b){var d=gl_user_info[b];if(d.userid==a){c=d.name;break}}return c}function reload_page(){PreLoadIndex=-1;CurrentLoadIndex=0;check_loading_status()}function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,reload_page())}
function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;reload_page()}function open_assist_page(){window.open("/index.php/vilsassist/"+project_id,"_blank").focus()};
