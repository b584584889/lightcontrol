var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,gl_usersubgroups=[],gl_userdatasubgroups=[],gl_subgroup_schedule=[],gl_edit_mode=0,gl_current_groupid=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex+=1);break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usersubgroup());break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_subgroup_schedule());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_schedule())}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_usersubgroup(){$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(a){$.each(a,function(b,a){a.subgroupid=parseInt(a.subgroupid);gl_usersubgroups.push(a)})}).success(function(){load_userdatasubgroup()}).error(function(){}).complete(function(){})}
function load_userdatasubgroup(){$.getJSON(gl_target_server+"/php/vilsnodes.php","loaddatasubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,c){c.subgroupid=parseInt(c.subgroupid);gl_userdatasubgroups.push(c)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_subgroup_schedule(){gl_subgroup_schedule=[];for(var a="",b=0;b<gl_usersubgroups.length;++b){var c=gl_usersubgroups[b];0!=b&&(a+=",");a+=c.subgroupid}$.getJSON(gl_target_server+"/php/vilsnodes.php","loadweekschedule=1&subgroupids="+a+"&project_id="+project_id,function(a){$.each(a,function(a,b){gl_subgroup_schedule.push(b.jsonstring)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function create_class(a,b,c,d,e,g,h){var f={};f.starttime=a;f.endtime=b;f.monday=c;f.tuesday=d;f.wednesday=e;f.thursday=g;f.friday=h;return f}
function show_schedule(){var a,b;3==gl_groupid?(a=gl_usersubgroups[0],b=gl_usersubgroups.length):(a=gl_userdatasubgroups[0],b=gl_userdatasubgroups.length);1==b?document.getElementById("class_title").textContent=a.subgroupname:3==gl_groupid?create_dropdown_class(gl_usersubgroups):create_dropdown_class(gl_userdatasubgroups);update_schedule_view(a.subgroupid)}
function update_schedule_view(a){gl_current_groupid=a;a=get_schedule(a);schedule_title.textContent="";class_teacher.textContent="";for(var b=0;8>b;b++)show_class("time",b+1,""),show_class("monday",b+1,""),show_class("tuesday",b+1,""),show_class("wednesday",b+1,""),show_class("thursday",b+1,""),show_class("friday",b+1,"");if(null!=a)for(schedule_title.textContent=a.title,class_teacher.textContent=a.class_teacher,b=0;8>b;b++){var c=a.classinfo[b];show_class("time",b+1,c.starttime+"<br>|<br>"+c.endtime);
show_class("monday",b+1,c.monday);show_class("tuesday",b+1,c.tuesday);show_class("wednesday",b+1,c.wednesday);show_class("thursday",b+1,c.thursday);show_class("friday",b+1,c.friday)}1==gl_edit_mode&&edit_mode()}function show_class(a,b,c){document.getElementById(a+"_"+b+"_class").innerHTML=c}
function create_dropdown_class(a){var b=document.getElementById("class_title"),c=document.createElement("div");c.setAttribute("class","btn-group");b.appendChild(c);var d=a[0],b=document.createElement("button");b.setAttribute("type","button");b.setAttribute("class","btn btn-default btn-sm dropdown-toggle");b.setAttribute("data-toggle","dropdown");b.setAttribute("id","dropdown_current_class");b.textContent=d.subgroupname;c.appendChild(b);d=document.createElement("span");d.setAttribute("class","caret");
b.appendChild(d);b=document.createElement("ul");b.setAttribute("class","dropdown-menu");c.appendChild(b);for(c=0;c<a.length;++c)b.appendChild(create_dropdown_class_item(a[c]))}
function create_dropdown_class_item(a){var b=document.createElement("li"),c=document.createElement("a");c.setAttribute("class","small");c.setAttribute("tabIndex","-1");c.setAttribute("data-value",a.subgroupname);c.setAttribute("href","javascript:;");c.setAttribute("onclick",'dropdown_class_click("'+a.subgroupid+'");return true;');c.appendChild(document.createTextNode(a.subgroupname));b.appendChild(c);return b}
function dropdown_class_click(a){var b=document.getElementById("dropdown_current_class"),c=gl_userdatasubgroups;3==gl_groupid&&(c=gl_usersubgroups);for(var d=0;d<c.length;++d){var e=c[d];if(a==e.subgroupid){b.textContent=e.subgroupname;a=document.createElement("span");a.setAttribute("class","caret");b.appendChild(a);update_schedule_view(e.subgroupid);break}}}
function edit_mode(){if(1!=gl_edit_mode){gl_edit_mode=1;var a=document.getElementById("schedule_title");a.innerHTML="<a href='javascript:;' onclick='edit_schedule_title(\""+a.innerHTML+"\");'>"+a.innerHTML+" <i class='fa fa-edit'/></a>";a=document.getElementById("class_teacher");a.innerHTML="<a href='javascript:;' onclick='edit_class_teacher(\""+a.innerHTML+"\");'>"+a.innerHTML+" <i class='fa fa-edit'/></a>";for(a=1;8>=a;a++)update_time_edit_mode("time",a),update_edit_mode("monday",a),update_edit_mode("tuesday",
a),update_edit_mode("wednesday",a),update_edit_mode("thursday",a),update_edit_mode("friday",a)}}
function update_time_edit_mode(a,b){var c=document.getElementById(a+"_"+b+"_class"),d=get_schedule(gl_current_groupid);null==d&&(d=create_default_schedule(gl_current_groupid));var d=d.classinfo[b-1],e="<a href='javascript:;' onclick='edit_class_starttime(\""+a+'","'+b+'","'+d.starttime+"\");'>"+d.starttime+" <i class='fa fa-edit'></i></a>",e=e+"<br>|<br>"+("<a href='javascript:;' onclick='edit_class_endtime(\""+a+'","'+b+'","'+d.endtime+"\");'>"+d.endtime+" <i class='fa fa-edit'></i></a>");c.innerHTML=
e}function update_edit_mode(a,b){var c=document.getElementById(a+"_"+b+"_class");c.innerHTML="<a href='javascript:;' onclick='edit_class(\""+a+'","'+b+'","'+c.textContent+"\");'>"+c.textContent+" <i class='fa fa-edit'/></a>"}function edit_class_starttime(a,b,c){c=prompt("\u8f38\u5165\u8ab2\u7a0b\u958b\u59cb\u6642\u9593:",c);update_class_starttime(a,b,c);update_time_edit_mode(a,b)}
function edit_class_endtime(a,b,c){c=prompt("\u8f38\u5165\u8ab2\u7a0b\u7d50\u675f\u6642\u9593:",c);update_class_endtime(a,b,c);update_time_edit_mode(a,b)}function edit_class(a,b,c){c=prompt("\u8f38\u5165\u8ab2\u7a0b\u540d\u7a31:",c);document.getElementById(a+"_"+b+"_class").innerHTML="<a href='javascript:;' onclick='edit_class(\""+a+'","'+b+'","'+c+"\");'>"+c+" <i class='fa fa-edit'/></a>";update_class_info(a,b,c)}
function edit_schedule_title(a){a=prompt("\u8f38\u5165\u8ab2\u7a0b\u5e74\u5ea6\u540d\u7a31:",a);document.getElementById("schedule_title").innerHTML="<a href='javascript:;' onclick='edit_schedule_title(\""+a+"\");'>"+a+" <i class='fa fa-edit'/></a>";update_schedule_title(a)}
function edit_class_teacher(a){a=prompt("\u8f38\u5165\u73ed\u7d1a\u5c0e\u5e2b\u540d\u7a31:",a);document.getElementById("class_teacher").innerHTML="<a href='javascript:;' onclick='edit_class_teacher(\""+a+"\");'>"+a+" <i class='fa fa-edit'/></a>";update_class_teacher(a)}function get_schedule(a){for(var b=0;b<gl_subgroup_schedule.length;++b){var c=gl_subgroup_schedule[b];if(a===parseInt(c.subgroupid))return c}return null}
function update_class_info(a,b,c){var d=get_schedule(gl_current_groupid);null!=d&&(b=d.classinfo[b-1],"monday"===a?b.monday=c:"tuesday"===a?b.tuesday=c:"wednesday"===a?b.wednesday=c:"thursday"===a?b.thursday=c:"friday"===a&&(b.friday=c),update_schedule_info())}function update_schedule_title(a){var b=get_schedule(gl_current_groupid);null!=b&&(b.title=a,update_schedule_info())}
function update_class_teacher(a){var b=get_schedule(gl_current_groupid);null!=b&&(b.class_teacher=a,update_schedule_info())}function update_class_starttime(a,b,c){a=get_schedule(gl_current_groupid);null!=a&&(a.classinfo[b-1].starttime=c,update_schedule_info())}function update_class_endtime(a,b,c){a=get_schedule(gl_current_groupid);null!=a&&(a.classinfo[b-1].endtime=c,update_schedule_info())}
function update_schedule_info(){var a=get_schedule(gl_current_groupid);if(null!=a){var a=JSON.stringify(a),b={};b.project_id=""+project_id;b.update_weekschedule=1;b.subgroupid=gl_current_groupid;b.schedule=a;jQuery.ajax({url:gl_target_server+"/php/vilsnodes.php",type:"POST",data:b,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a))},error:function(a,b,e){}})}}
function create_default_schedule(a){var b={};b.subgroupid=a;b.title="";b.class_teacher="";b.classinfo=[];b.classinfo[0]=create_class("08:25","09:10","","","","","");b.classinfo[1]=create_class("09:20","10:05","","","","","");b.classinfo[2]=create_class("10:15","11:00","","","","","");b.classinfo[3]=create_class("11:10","11:55","","","","","");b.classinfo[4]=create_class("13:20","14:05","","","","","");b.classinfo[5]=create_class("14:15","15:00","","","","","");b.classinfo[6]=create_class("15:20",
"16:05","","","","","");b.classinfo[7]=create_class("16:15","17:00","","","","","");gl_subgroup_schedule.push(b);return b}function open_weekschedule_page(){window.open("/index.php/vilsweekschedule/"+project_id,"_blank").focus()};
