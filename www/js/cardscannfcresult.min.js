var glAllCardScanResult={},gl_nfclocators=[],gl_nfccards=[],gl_user_info=[],gl_cardscanresult=[],LOAD_CARD_NUM=300,gl_nfccard_load_index=0,LOAD_USER_NUM=500,gl_user_load_index=0,PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=999,MAX_SHOW_RESULT=20,LOAD_PAGE_NUM=20,gl_CurrentPage=1;loading_status();
function loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_nfclocator());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_cardscan_result());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,show_cardscan_result(),CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_nfccard());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=
CurrentLoadIndex,load_user_info())}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(loading_status,100):setTimeout(reload_cardscan_result,5E3)}function reload_cardscan_result(){PreLoadIndex=0;CurrentLoadIndex=1;loading_status()}
function load_nfclocator(){gl_nfclocators=[];$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&project_id="+project_id,function(c){$.each(c,function(b,a){gl_nfclocators.push(a)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_nfccard(){for(var c=[],b=0;b<gl_cardscanresult.length;++b){for(var a=gl_cardscanresult[b],d=!1,e=0;e<gl_nfccards.length;++e){var f=gl_nfccards[e];if(f.cardid===a.cardid){d=!0;break}}if(0==d)for(e=0;e<c.length;++e)if(f=c[e],f===a.cardid){d=!0;break}0==d&&c.push(a.cardid)}0==c.length?CurrentLoadIndex+=1:(querycard=c.toString(),$.getJSON(gl_target_server+"/php/nfclocator.php","querycards=1&cardid="+querycard+"&project_id="+project_id,function(a){$.each(a,function(a,b){gl_nfccards.push(b)})}).success(function(){CurrentLoadIndex+=
1}).error(function(){CurrentLoadIndex+=1}).complete(function(){}))}
function load_user_info(){for(var c="",b=0,a=0;a<gl_nfccards.length;++a){for(var d=gl_nfccards[a],e=parseInt(d.userid),f=!1,g=0;g<gl_user_info.length;++g)if(gl_user_info[g].userid==e){f=!0;break}0==f&&0!=e&&(0<b&&(c+=","),c+=d.userid,b+=1)}0==c.length?CurrentLoadIndex=LOAD_STATE_END:$.getJSON(gl_target_server+"/php/vilsnodes.php","queryusers=1&userid="+c+"&project_id="+project_id,function(a){$.each(a,function(a,b){b.userid=parseInt(b.userid);gl_user_info.push(b)})}).success(function(){PreLoadIndex=
0;CurrentLoadIndex=1}).error(function(){}).complete(function(){})}
function load_cardscan_result(){var c=(gl_CurrentPage-1)*LOAD_PAGE_NUM,b=LOAD_PAGE_NUM;gl_cardscanresult=[];var a=document.getElementById("search_nfccard_text").value,d="loadcardscan=1&s="+c+"&count="+b+"&project_id="+project_id;0<a.length&&(d="loadcardscan=1&s="+c+"&count="+b+"&project_id="+project_id+"&matchname="+a);$.getJSON(gl_target_server+"/php/nfclocator.php",d,function(a){$.each(a,function(a,b){gl_cardscanresult.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function show_cardscan_result(){document.getElementById("CARDSCAN_TABLE_MSG").innerText="";for(var c=document.getElementById("CARDSCAN_TABLE");1<=c.rows.length;)c.deleteRow(0);for(var b=0;b<gl_cardscanresult.length;++b){var a=nfccards_create_record_table_item((gl_CurrentPage-1)*LOAD_PAGE_NUM+b,gl_cardscanresult[b]);c.appendChild(a)}}
function nfccards_create_record_table_item(c,b){if(null==b)return null;var a=document.createElement("tr");1==c%2&&a.setAttribute("bgcolor","#ebebe0");var d=getNFCCard(b.cardid),e=b.cardid,f="";null!=d&&(e=d.name,0<d.userid&&(f=e=getUserName(d.userid)),0==e.length&&(e=b.cardid));d=0;a.appendChild(document.createElement("td"));a.cells[d].appendChild(document.createTextNode(""+c));d++;a.appendChild(document.createElement("td"));var g=document.createElement("span");g.setAttribute("class","badge bg-blue-active");
g.textContent=e;a.cells[d].appendChild(g);d++;a.appendChild(document.createElement("td"));e=document.createElement("span");e.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");e.textContent=b.cardid;a.cells[d].appendChild(e);d++;a.appendChild(document.createElement("td"));e=document.createElement("span");e.setAttribute("class","badge bg-blue");e.textContent=getNFCDeviceName(b.LoRAMacaddress);a.cells[d].appendChild(e);d++;a.appendChild(document.createElement("td"));e=document.createElement("span");
0<f.length&&(e.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:1;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:rgb(54, 127, 169);"),e.textContent=f);a.cells[d].appendChild(e);d++;a.appendChild(document.createElement("td"));f=document.createElement("span");f.setAttribute("class","badge bg-green-active");f.textContent=b.datetime;a.cells[d].appendChild(f);d++;a.appendChild(document.createElement("td"));
f=document.createElement("span");f.textContent=b.ssid;a.cells[d].appendChild(f);d++;a.appendChild(document.createElement("td"));f=document.createElement("span");f.textContent=b.wifimac;a.cells[d].appendChild(f);return a}function getNFCCard(c){for(var b=0;b<gl_nfccards.length;b++){var a=gl_nfccards[b];if(a.cardid===c)return a}return null}function getNFCCardName(c){for(var b=0;b<gl_nfccards.length;b++){var a=gl_nfccards[b];if(a.cardid===c)return 0==a.name.length?a.cardid:a.name}return c}
function getNFCDeviceName(c){for(var b=0;b<gl_nfclocators.length;b++){var a=gl_nfclocators[b];if(a.LoRAMacaddress===c)return a.name}return c}function getUserName(c){for(var b="",a=0;a<gl_user_info.length;a++)if(c==gl_user_info[a].userid){b=gl_user_info[a].name;break}return b}function move_page_backward(){var c=document.getElementById("id_current_page_num");1>=gl_CurrentPage||(gl_CurrentPage--,c.textContent=gl_CurrentPage,reload_cardscan_result())}
function move_page_forward(){var c=document.getElementById("id_current_page_num");gl_CurrentPage++;c.textContent=gl_CurrentPage;reload_cardscan_result()}function search_nfccard_text_change(c){glCurrentPage=1;reload_cardscan_result();return!1}var $source=document.querySelector("#search_nfccard_text");$source.addEventListener("input",search_nfccard_text_change);function open_cardscannfcresult_page(){window.open("/index.php/vilscardscannfcresult/"+project_id,"_blank").focus()};
