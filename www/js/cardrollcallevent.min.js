var LOAD_PAGE_NUM=20,PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glCurrentPage=1,gl_cardrollcall=[],gl_cardrollcallevent=[],gl_usersubgroups=[],gl_cardrollcallsubgroupevent={};check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcall());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallevent());break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usersubgroup());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallsubgroupevent());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+
CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,draw_cardrollcallevent_table(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_cardrollcall(){gl_cardrollcall=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcall=1&project_id="+project_id,function(a){var b=0;$.each(a,function(a,d){gl_cardrollcall.push(d);b++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallevent(){var a=(glCurrentPage-1)*LOAD_PAGE_NUM,b=LOAD_PAGE_NUM;gl_cardrollcallevent=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallevent=1&s="+a+"&count="+b+"&project_id="+project_id,function(a){$.each(a,function(a,b){gl_cardrollcallevent.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_usersubgroup(){$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,c){c.subgroupid=parseInt(c.subgroupid);gl_usersubgroups.push(c)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallsubgroupevent(){gl_cardrollcallsubgroupevent={};for(var a="",b=0,c=0;c<gl_cardrollcallevent.length;++c){var d=gl_cardrollcallevent[c];0<b&&(a+=",");a+=d.eventid;b+=1}$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallsubgroupevent=1&project_id="+project_id+"&eventids="+a,function(a){$.each(a,function(a,b){gl_cardrollcallsubgroupevent[a]=[];gl_cardrollcallsubgroupevent[a].push(b);for(var c=0;c<gl_cardrollcallevent.length;++c){var d=gl_cardrollcallevent[c];if(d.eventid===
a){for(var f=0,l=0,h=0;h<b.length;++h){var k=b[h];check_valid_subgroup(parseInt(k.subgroupid))&&(f+=parseInt(k.totalcount),l+=parseInt(k.presentcount))}d.totalcount=f;d.presentcount=l;gl_cardrollcallevent[c]=d;break}}})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}function check_valid_subgroup(a){for(var b=0;b<gl_usersubgroups.length;b++)if(gl_usersubgroups[b].subgroupid==a)return!0;return!1}
function create_empty_record_table_item(a){if(null==document.getElementById("empty_record_table_item")){var b=document.getElementById("RFID_ROLLCALLEVENT_TABLE"),c=document.createElement("tr");c.setAttribute("id","empty_record_table_item");var d=0;c.appendChild(document.createElement("td"));c.cells[d].appendChild(document.createTextNode(""+a));d++;c.appendChild(document.createElement("td"));c.cells[d].appendChild(create_input_text("input_name"));d++;c.appendChild(document.createElement("td"));c.cells[d].appendChild(create_input_text("input_type"));
d++;c.appendChild(document.createElement("td"));c.cells[d].appendChild(create_input_text("input_ip"));d++;c.appendChild(document.createElement("td"));a=document.createElement("button");a.setAttribute("class","btn btn-block btn-primary btn-lg");a.setAttribute("onclick","save_new_device();");a.textContent="\u5132\u5b58";c.cells[d].appendChild(a);b.appendChild(c)}}
function create_input_text(a,b){var c=document.createElement("textarea");c.setAttribute("rows","1");c.setAttribute("id",a);c.textContent=b;return c}function draw_cardrollcallevent_table(){for(var a=document.getElementById("RFID_ROLLCALLEVENT_TABLE");1<=a.rows.length;)a.deleteRow(0);for(var b=0,c=0;c<gl_cardrollcallevent.length;++c){var d=create_record_table_item(b,gl_cardrollcallevent[c]);null!=d&&(a.appendChild(d),b++)}}
function create_record_table_item(a,b){if(null==b)return null;var c=document.createElement("tr");1==a%2&&c.setAttribute("bgcolor","#ebebe0");var d=0,f=getRollCall(b.rollcallid);if(null==f)return null;c.appendChild(document.createElement("td"));c.cells[d].appendChild(document.createTextNode(""+(a+1)));d++;var e=document.createElement("td");e.setAttribute("id","uiid_name_"+b.eventid);c.appendChild(e);var g=document.createElement("span");g.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");
g.textContent=f.rollcallname;e.appendChild(g);d++;e=document.createElement("td");e.setAttribute("id","uiid_cardid_"+b.eventid);c.appendChild(e);e=document.createElement("span");e.setAttribute("class","label label-info");e.textContent=convertPrettyDateOnly(b.StartDateTime);c.cells[d].appendChild(e);e=document.createElement("span");e.setAttribute("class","label label-warning");e.textContent=convertPrettyTimeOnly(b.StartDateTime);c.cells[d].appendChild(e);d++;e=document.createElement("td");e.setAttribute("id",
"uiid_userid_"+b.eventid);c.appendChild(e);e=document.createElement("span");e.setAttribute("class","label label-info");e.textContent=convertPrettyDateOnly(b.EndDateTime);c.cells[d].appendChild(e);e=document.createElement("span");e.setAttribute("class","label label-warning");e.textContent=convertPrettyTimeOnly(b.EndDateTime);c.cells[d].appendChild(e);d++;e=document.createElement("td");e.setAttribute("id","uiid_nodeid_"+b.eventid);c.appendChild(e);e=document.createElement("span");e.setAttribute("class",
"label label-primary");e.textContent=b.totalcount;c.cells[d].appendChild(e);d++;e=document.createElement("td");e.setAttribute("id","uiid_present_"+b.eventid);c.appendChild(e);g=document.createElement("span");0==b.presentcount?g.setAttribute("class","label label-danger"):g.setAttribute("class","label label-primary");g.textContent=b.presentcount;c.cells[d].appendChild(g);d++;e=b.totalcount-b.presentcount;g=document.createElement("td");g.setAttribute("id","uiid_present_"+b.eventid);c.appendChild(g);
g=document.createElement("span");0==e?g.setAttribute("class","label label-primary"):g.setAttribute("class","label label-danger");g.textContent=e;c.cells[d].appendChild(g);d++;c.appendChild(document.createElement("td"));e=document.createElement("button");e.setAttribute("title","\u67e5\u770b\u8a73\u7d30\u8cc7\u8a0a");e.setAttribute("href","javascript:;");e.setAttribute("onclick",'show_rollcallresult("'+f.rollcallid+'","'+b.eventid+'");return false;');f=document.createElement("i");f.setAttribute("class",
"fa fa-calendar-check-o ");e.appendChild(f);c.cells[d].appendChild(e);return c}
function edit_device(a){console.log("edit_device() deviceid:"+a);var b=getDevice(a);null!=b&&(create_edit_ui("uiid_name",a,b.name),create_edit_ui("uiid_type",a,b.type),create_edit_ui("uiid_ip",a,b.ip),b=document.getElementById("uiid_editbtn_"+a),b.setAttribute("title","Save this Device"),b.setAttribute("onclick",'save_device("'+a+'");return false;'),document.getElementById("uiid_editimg_"+a).setAttribute("class","fa fa-save"),document.getElementById("uiid_deletebtn_"+a).setAttribute("style","display:block"))}
function create_edit_ui(a,b,c){var d=clearChildView(a+"_"+b);a=create_input_text(a+"_"+b+"_edit",c);d.appendChild(a)}function clearChildView(a){a=document.getElementById(a);if(null!=a)for(;a.firstChild;)a.removeChild(a.firstChild);return a}function save_device(a){var b=document.getElementById("uiid_name_"+a+"_edit").value,c=document.getElementById("uiid_type_"+a+"_edit").value,d=document.getElementById("uiid_ip_"+a+"_edit").value;update_device(a,b,c,d)}
function show_rollcallresult(a,b){window.open("/index.php/vilsuserrollcallresult/"+project_id+"?rollcallid="+a+"&eventid="+b,"_blank").focus()}
function update_device(a,b,c,d){console.log("update_device() deviceid:"+a);if(0==b.length)alert("\u8acb\u8f38\u5165\u540d\u7a31");else if(0==d.length)alert("\u8acb\u8f38\u5165IP\u4f4d\u5740");else{var f={};f.project_id=""+project_id;f.update_device=1;f.deviceid=a;f.name=b;f.type=c;f.ip=d;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:f,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,
b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}
function save_new_device(){var a=document.getElementById("input_name").value,b=document.getElementById("input_type").value,c=document.getElementById("input_ip").value;if(0==a.length)alert("\u8acb\u8f38\u5165\u540d\u7a31");else if(0==c.length)alert("\u8acb\u8f38\u5165IP\u4f4d\u5740");else{var d={};d.project_id=""+project_id;d.create_new_rfiddevice=1;d.name=a;d.type=b;d.ip=c;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:d,success:function(a){400==a.status&&alert("update Error! response = "+
JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}function confirm_delete_device(a,b,c){confirm("Are you sure you want to delete this device:"+b+" "+c+"   ?")&&delete_device(a)}
function delete_device(a){var b={};b.project_id=""+project_id;b.delete_device=1;b.deviceid=a;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:b,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_device_info,300)},error:function(a,b,f){alert("error = "+f);alert("xhr.responseText = "+a.responseText)}})}$("#createnewrfiddevicebutton").click(function(){create_empty_record_table_item(gl_rfiddevices.length+1);return!1});
function reload_device_info(){PreLoadIndex=-1;CurrentLoadIndex=0;check_loading_status()}function getDevice(a){for(var b=null,c=0;c<gl_rfiddevices.length;++c){var d=gl_rfiddevices[c];if(d.deviceid===a){b=d;break}}return b}function getRollCall(a){for(var b=null,c=0;c<gl_cardrollcall.length;++c){var d=gl_cardrollcall[c];if(d.rollcallid===a){b=d;break}}return b}
function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,reload_device_info())}function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;reload_device_info()}function convertPrettyDateOnly(a){var b=moment.utc(a,"YYYY-MM-DD HH:mm:ss");a=b.format("YYYY");var c=b.format("M"),b=b.format("D");return a+"\u5e74"+c+"\u6708"+b+"\u65e5 "}
function convertPrettyTimeOnly(a){var b=moment.utc(a,"YYYY-MM-DD HH:mm:ss");a=b.hour();var c=b.minutes(),b=b.seconds(),d="";0<=a&&(d+=a+"\u9ede");0<=c&&(d+=c+"\u5206");0<=b&&(d+=b+"\u79d2");return d}function open_cardrollcallevent_page(){window.open("/index.php/vilscardrollcallevent/"+project_id,"_blank").focus()};
