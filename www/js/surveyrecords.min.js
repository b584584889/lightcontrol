var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,LOAD_PAGE_NUM=20,glSurvey_List=[],glSurveyEvent_List=[],glSurveyResult_List=[],glCurrentPage=1,glReloadTimes=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_surveys());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_surveyevents());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+
PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_surveyevents(),CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_surveyresults());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,
show_surveyresults(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}function load_surveys(){var a=gl_target_server+"/php/survey.php";glSurvey_List=[];$.getJSON(a,"loadsurveys=1&project_id="+project_id+"&accountid="+accountid,function(a){$.each(a,function(a,c){glSurvey_List.push(c)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_surveyevents(){var a=gl_target_server+"/php/survey.php",e=(glCurrentPage-1)*LOAD_PAGE_NUM,f=LOAD_PAGE_NUM;glSurveyEvent_List=[];$.getJSON(a,"loadsurveyevents=1&project_id="+project_id+"&offset="+e+"&count="+f+"&accountid="+accountid,function(a){$.each(a,function(a,b){glSurveyEvent_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_surveyresults(){var a=gl_target_server+"/php/survey.php";glSurveyResult_List=[];for(var e="",f=0;f<glSurveyEvent_List.length;f++){var c=glSurveyEvent_List[f];0!=f&&(e+=",");e+=c.hashkey}$.getJSON(a,"loadsurveyresults=1&project_id="+project_id+"&hashkeys="+e,function(a){$.each(a,function(a,d){var c={};c.hashkey=a;c.record=d;glSurveyResult_List.push(c)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function show_surveyevents(){for(var a=document.getElementById("SURVEY_EVENT_TABLE_BODY");a.firstChild;)a.removeChild(a.firstChild);console.log("show_surveyevents() glSurveyEvent_List.length:"+glSurveyEvent_List.length);for(var e=0;e<glSurveyEvent_List.length;e++)show_surveyevent(a,(glCurrentPage-1)*LOAD_PAGE_NUM+e+1,glSurveyEvent_List[e])}
function show_surveyevent(a,e,f){var c=0;console.log("show_surveyevent() surveyid:"+f.surveyid);var d=find_survey(f.surveyid);if(null==d)return 0;console.log("show_surveyevent() survey.type:"+d.type+" survey.title:"+d.title);var b=document.createElement("tr");b.setAttribute("id",f.dbId+"_TABLE_ROW");a.appendChild(b);b.appendChild(document.createElement("td"));b.cells[c].appendChild(document.createTextNode(""+e));c++;b.appendChild(document.createElement("td"));a=document.createElement("div");a.appendChild(document.createTextNode(f.eventid));
b.cells[c].appendChild(a);c++;b.appendChild(document.createElement("td"));a=document.createElement("div");a.appendChild(document.createTextNode(d.title));b.cells[c].appendChild(a);c++;b.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","description_"+d.surveyid);a.appendChild(document.createTextNode(d.description));b.cells[c].appendChild(a);c++;b.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","type_"+d.surveyid);
b.cells[c].appendChild(a);"0"===d.type&&a.appendChild(document.createTextNode("\u55ae\u9078"));"1"===d.type&&a.appendChild(document.createTextNode("\u8907\u9078"));c++;b.appendChild(document.createElement("td"));d=show_survey_item(d.surveyid,d.items,f.hashkey);b.cells[c].appendChild(d);c++;b.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("class","label label-info");d.textContent=f.deadline;b.cells[c].appendChild(d);c++;b.appendChild(document.createElement("td"));
d=document.createElement("span");d.setAttribute("class","label label-success");d.textContent=f.DateTime;b.cells[c].appendChild(d);c++;b.appendChild(document.createElement("td"));b.cells[c].appendChild(document.createTextNode(""+f.PushNotifyMessageRecorddbId));c++;b.appendChild(document.createElement("td"));d=document.createElement("button");d.setAttribute("title","\u67e5\u770b\u8a73\u7d30\u8cc7\u8a0a");d.setAttribute("href","javascript:;");d.setAttribute("onclick","show_surveyresult("+project_id+
',"'+f.surveyid+'","'+f.hashkey+'");return false;');f=document.createElement("i");f.setAttribute("class","fa fa-calendar-check-o ");d.appendChild(f);b.cells[c].appendChild(d);return 1}
function show_survey_item(a,e,f){var c=document.createElement("div");c.setAttribute("id","survey_item_"+a);var d=document.createElement("table");c.appendChild(d);var b=document.createElement("thead");d.appendChild(b);var g=document.createElement("tr");b.appendChild(g);b=document.createElement("th");b.setAttribute("style","width: 40px");g.appendChild(b);b=document.createElement("th");g.appendChild(b);g=document.createElement("tbody");g.setAttribute("id","survey_table_body_"+a);d.appendChild(g);for(d=
0;d<e.length;d++){b=e[d];a=document.createElement("tr");g.appendChild(a);var h=document.createElement("td");a.appendChild(h);var k=document.createElement("span");k.setAttribute("class","label label-danger");k.setAttribute("id","survey_item_"+f+"_"+d);k.textContent="0";h.appendChild(k);h=document.createElement("td");a.appendChild(h);h.appendChild(document.createTextNode(b.description))}a=document.createElement("tr");g.appendChild(a);h=document.createElement("td");a.appendChild(h);h.appendChild(document.createTextNode("\u8aaa\u660e:"));
e=document.createElement("td");e.setAttribute("id","survey_item_comment_"+f);a.appendChild(e);return c}
function show_surveyresults(){for(var a=0;a<glSurveyResult_List.length;a++){for(var e=glSurveyResult_List[a],f=[],c=[],d=[],b=0;b<e.record.length;b++){var g=e.record[b],h=g.results.split(",");0<g.comment.length&&d.push(g.comment);if(void 0==f[g.topic])for(f[g.topic]=1,g=0;g<h.length;g++){var k=parseInt(h[g]);void 0==c[g]&&(c[g]=0);c[g]+=k}}for(b=0;b<c.length;b++)f=document.getElementById("survey_item_"+e.hashkey+"_"+b),void 0!=f&&(f.textContent=c[b],0==c[b]?f.setAttribute("class","label label-danger"):
f.setAttribute("class","label label-info"));e=document.getElementById("survey_item_comment_"+e.hashkey);if(null!=e){for(;e.firstChild;)e.removeChild(e.firstChild);for(b=0;b<d.length;b++)void 0!=e&&(c=document.createElement("span"),c.setAttribute("class","label label-primary"),e.appendChild(c),c.textContent=d[b])}}5>glReloadTimes&&(setTimeout(reload_surveyresults,1E4),glReloadTimes++)}
function reload_surveyresults(){console.log("reload_surveyresults() glReloadTimes:"+glReloadTimes);PreLoadIndex=2;CurrentLoadIndex=3;setTimeout(check_loading_status,1E4)}function find_survey(a){for(var e=0;e<glSurvey_List.length;e++){var f=glSurvey_List[e];if(0==a.localeCompare(f.surveyid))return f}return null}
function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,PreLoadIndex=0,CurrentLoadIndex=1,check_loading_status())}function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;PreLoadIndex=0;CurrentLoadIndex=1;check_loading_status()}
function show_surveyresult(a,e,f){window.open("/index.php/vilssurveyresult/"+a+"?surveyid="+e+"&hashkey="+f,"_blank").focus()}function open_surveyrecords_page(){window.open("/index.php/vilssurveyrecords/"+project_id,"_blank").focus()};
