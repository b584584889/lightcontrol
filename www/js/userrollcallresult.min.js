var LOAD_PAGE_NUM=20,PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glCurrentPage=1,glReloadCount=0,gl_user_info=[],gl_usersubgroups=[],gl_rfiddevices=[],gl_nfclocators=[],gl_cardrollcall={},gl_cardrollcallevent={},gl_cardrollcallrecord=[],gl_userrollcallrecord=[],gl_all_subgroup_totalcount=0,gl_all_subgroup_presentcount=0,gl_all_subgroup_absentcount=0,LOAD_USER_NUM=500,gl_user_load_index=0,gl_enable_batch_present=!1,gl_batch_present_user=[];check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,$("#modal-loading").modal("show"),gl_user_info=[],load_user_info());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usersubgroup());
break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_rfiddevice());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_nfclocator());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+
" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcall(rollcallid));break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallevent(eventid));break;case 6:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,draw_cardrollcallevent_table(),
CurrentLoadIndex+=1);break;case 7:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cardrollcallrecord(rollcallid,eventid));break;case 8:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,draw_user_subgroup_table(),$("#modal-loading").modal("hide"),CurrentLoadIndex=
LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):(gl_enable_batch_present?glReloadCount=0:0<glReloadCount?(--glReloadCount,setTimeout(reload_rollcall_info,5E3)):setTimeout(reload_rollcall_info,3E4),console.log("check_loading_status() Stop."))}function reload_rollcall_info(){gl_enable_batch_present||(PreLoadIndex=4,CurrentLoadIndex=5,check_loading_status())}function reload_rollcall_ui(){PreLoadIndex=7;CurrentLoadIndex=8;check_loading_status()}
function load_user_info(){var c=0;$.getJSON(gl_target_server+"/php/vilsnodes.php","loaduser=1&s="+gl_user_load_index+"&count="+LOAD_USER_NUM+"&project_id="+project_id,function(a){$.each(a,function(b,a){a.userid=parseInt(a.userid);gl_user_info.push(a);c+=1});gl_user_load_index+=c}).success(function(){c<LOAD_USER_NUM?CurrentLoadIndex+=1:setTimeout(load_user_info,20)}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function load_usersubgroup(){$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(c){$.each(c,function(a,b){b.subgroupid=parseInt(b.subgroupid);gl_usersubgroups.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_rfiddevice(){gl_rfiddevices=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loaddevice=1&project_id="+project_id,function(c){var a=0;$.each(c,function(b,c){gl_rfiddevices.push(c);a++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_nfclocator(){gl_nfclocators=[];$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&project_id="+project_id,function(c){var a=0;$.each(c,function(b,c){gl_nfclocators.push(c);a++})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcall(c){gl_cardrollcall={};$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcall=1&project_id="+project_id+"&rollcallid="+c,function(a){gl_cardrollcall=a}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallevent(c){gl_cardrollcallevent={};$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallevent=1&project_id="+project_id+"&eventid="+c,function(a){gl_cardrollcallevent=a}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_cardrollcallrecord(c,a){gl_cardrollcallrecord=[];gl_userrollcallrecord=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loadcardrollcallrecord=1&&project_id="+project_id+"&rollcallid="+c+"&eventid="+a,function(a){$.each(a,function(a,b){gl_cardrollcallrecord.push(b);put_to_user_rollcall_record(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function put_to_user_rollcall_record(c){for(var a=[],b=!1,e=0;e<gl_userrollcallrecord.length;++e){var d=gl_userrollcallrecord[e];if(d.rollcalleventid==c.rollcalleventid){a=d;b=!0;break}}b||(a=[],a.rollcalleventid=c.rollcalleventid,a.rollcallid=c.rollcallid,a.userrecord=[],gl_userrollcallrecord.push(a));d=[];b=!1;for(e=0;e<a.userrecord.length;++e){var f=a.userrecord[e];if(f.userid==c.userid){d=f;b=!0;break}}b||(d=[],d.userid=c.userid,d.card=[],d.present=0,a.userrecord.push(d));d.card.push(c);"1"==
c.present&&(d.present=1)}function draw_cardrollcallevent_table(){for(var c=document.getElementById("USER_ROLLCALLRESULT_TABLE");1<=c.rows.length;)c.deleteRow(0);var a=create_event_table_item(0,gl_cardrollcallevent);null!=a&&c.appendChild(a)}
function create_event_table_item(c,a){if(null==a)return null;var b=document.createElement("tr");1==c%2&&b.setAttribute("bgcolor","#ebebe0");var e=0;b.appendChild(document.createElement("td"));b.cells[e].appendChild(document.createTextNode(""+(c+1)));e++;var d=document.createElement("td");d.setAttribute("id","uiid_name_"+a.eventid);b.appendChild(d);var f=document.createElement("span");f.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");f.textContent=a.rollcallname;d.appendChild(f);
e++;d=document.createElement("td");d.setAttribute("id","uiid_cardid_"+a.eventid);b.appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-info");d.textContent=convertPrettyDateOnly(a.StartDateTime);b.cells[e].appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-warning");d.textContent=convertPrettyTimeOnly(a.StartDateTime);b.cells[e].appendChild(d);e++;d=document.createElement("td");d.setAttribute("id","uiid_userid_"+a.recordid);b.appendChild(d);
d=document.createElement("span");d.setAttribute("class","label label-info");d.textContent=convertPrettyDateOnly(a.EndDateTime);b.cells[e].appendChild(d);d=document.createElement("span");d.setAttribute("class","label label-warning");d.textContent=convertPrettyTimeOnly(a.EndDateTime);b.cells[e].appendChild(d);e++;b.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("id","uiid_total_"+a.recordid);d.setAttribute("class","label label-primary");d.textContent=gl_all_subgroup_totalcount;
b.cells[e].appendChild(d);e++;b.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("id","uiid_present_"+a.recordid);d.textContent=gl_all_subgroup_presentcount;0==gl_all_subgroup_presentcount?d.setAttribute("class","label label-danger"):d.setAttribute("class","label label-primary");b.cells[e].appendChild(d);e++;f=a.totalcount-a.presentcount;b.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("id","uiid_absent_"+a.recordid);
d.textContent=0;0==f?d.setAttribute("class","label label-primary"):d.setAttribute("class","label label-danger");b.cells[e].appendChild(d);return b}
function draw_user_subgroup_table(){if(null!=document.getElementById("USER_ROLLCALLRECORD_TABLE_TABS")){var c=document.getElementById("USER_ROLLCALLRECORD_TABLE_TABS"),a=document.getElementById("USER_ROLLCALLRECORD_TABLE_CONTENT");if(void 0!=gl_cardrollcall.subgroups){var b=gl_cardrollcall.subgroups.split(","),e=[];$.each(b,function(a,b){-1===$.inArray(b,e)&&e.push(b)});b=gl_all_subgroup_absentcount=gl_all_subgroup_presentcount=gl_all_subgroup_totalcount=0;create_rollcallrecord_tab(b,1,c,99999,"\u9ede\u540d\u672a\u5230");
create_rollcallrecord_tab_pane_not_preset(b,a,99999);b++;for(var d=0;d<e.length;d++)for(var f=parseInt(e[d]),g=0;g<gl_usersubgroups.length;g++){var h=gl_usersubgroups[g];f==h.subgroupid&&(create_rollcallrecord_tab(b,0,c,h.subgroupid,h.subgroupname),create_not_preset_item(b,h.subgroupid,h.subgroupname),create_rollcallrecord_tab_pane(b,a,h.subgroupid),b++)}c=document.getElementById("uiid_total_"+gl_cardrollcallevent.recordid);a=document.getElementById("uiid_present_"+gl_cardrollcallevent.recordid);
b=document.getElementById("uiid_absent_"+gl_cardrollcallevent.recordid);c.textContent=gl_all_subgroup_totalcount;a.textContent=gl_all_subgroup_presentcount;b.textContent=gl_all_subgroup_absentcount}}}
function create_rollcallrecord_tab(c,a,b,e,d){var f=document.getElementById("tab_"+e);if(null==f){var g=document.createElement("li");0==c&&g.setAttribute("class","active");g.setAttribute("id","tab_"+e);b.appendChild(g);c=document.createElement("a");c.setAttribute("href","#tab_subgroup_"+e);c.setAttribute("data-toggle","tab");g.appendChild(c);e=document.createElement("span");1==a?e.setAttribute("class","badge bg-red-active"):e.setAttribute("class","badge bg-blue-active");e.textContent=d;c.appendChild(e)}return f}
function create_rollcallrecord_tab_pane(c,a,b){var e=document.getElementById("tab_subgroup_"+b);null==e&&(e=document.createElement("div"),0==c?e.setAttribute("class","tab-pane active table-responsive"):e.setAttribute("class","tab-pane table-responsive"),e.setAttribute("id","tab_subgroup_"+b),a.appendChild(e));a=document.getElementById("tab_subgroup_table_"+b);if(null==a){a=document.createElement("table");a.setAttribute("id","tab_subgroup_table_"+b);a.setAttribute("class","table table-bordered");var d=
document.createElement("thead");a.appendChild(d);var f=document.createElement("tr");f.setAttribute("style","background-color:#cce6ff;");d.appendChild(f);d=create_th("#");d.setAttribute("style","width: 10px;");f.appendChild(d);f.appendChild(create_th("\u4f7f\u7528\u8005"));f.appendChild(create_th("\u5361\u7247ID"));f.appendChild(create_th("\u9ede\u540d\u88dd\u7f6e"));f.appendChild(create_th("\u9ede\u540d\u7d50\u679c"));f.appendChild(create_th("\u9ede\u540d\u6642\u9593"));f.appendChild(create_th("\u64cd\u4f5c"));
f=document.createElement("tbody");f.setAttribute("id","tab_subgroup_table_content"+b);a.appendChild(f);e.appendChild(a)}d=document.getElementById("tab_subgroup_table_content"+b);if(null!=d){clearChildView("tab_subgroup_table_content"+b);f=a=e=0;clearChildView("not_preset_item_user_"+b);for(var g=document.getElementById("not_preset_item_user_"+b),h=0,l=0;l<gl_userrollcallrecord.length;++l)for(var n=gl_userrollcallrecord[l],p=0;p<n.userrecord.length;++p){var k=n.userrecord[p];if(check_user_subgroup(k.userid,
b)){var m=create_user_record_table_item(h,n,k);d.appendChild(m);h++;1==k.present?(gl_all_subgroup_presentcount+=1,e+=1):(gl_all_subgroup_absentcount+=1,a+=1,m="",0<k.card.length&&(m=k.card[0].cardid),k=create_not_present_user(k.userid,m),g.appendChild(k),k=document.createElement("span"),k.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;"),k.textContent="  ",g.appendChild(k),
0<a&&0==a%5&&(k=document.createElement("div"),g.appendChild(k)));gl_all_subgroup_totalcount++;f++}}1==c&&check_rollcall_intime()&&(c=document.getElementById("not_preset_item_action_"+b),d=document.createElement("button"),d.setAttribute("title","\u6279\u6b21\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230"),d.setAttribute("href","javascript:;"),d.setAttribute("onclick","enable_batch_present();return false;"),d.setAttribute("id","enable_batch_present_btn"),g=document.createElement("i"),g.setAttribute("class","fa fa-user-plus"),
g.setAttribute("id","enable_batch_present_icon"),d.appendChild(g),c.appendChild(d),gl_enable_batch_present&&(d.setAttribute("title","\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230"),d.setAttribute("onclick","save_batch_present();return false;"),g.setAttribute("class","fa fa-save")));c=document.getElementById("not_preset_item_total_"+b);d=document.getElementById("not_preset_item_present_"+b);b=document.getElementById("not_preset_item_absent_"+b);void 0!=c&&(c.textContent=f);void 0!=d&&(0==e?d.setAttribute("class",
"label label-danger"):d.setAttribute("class","label label-primary"),d.textContent=e);void 0!=b&&(0==a?b.setAttribute("class","label label-primary"):b.setAttribute("class","label label-danger"),b.textContent=a)}}
function create_rollcallrecord_tab_pane_not_preset(c,a,b){var e=document.getElementById("tab_subgroup_"+b);null==e&&(e=document.createElement("div"),0==c?e.setAttribute("class","tab-pane active table-responsive"):e.setAttribute("class","tab-pane table-responsive"),e.setAttribute("id","tab_subgroup_"+b),a.appendChild(e));c=document.getElementById("tab_subgroup_table_"+b);if(null==c){c=document.createElement("table");c.setAttribute("id","tab_subgroup_table_"+b);c.setAttribute("class","table table-bordered");
var d=document.createElement("thead");c.appendChild(d);a=document.createElement("tr");a.setAttribute("style","background-color:#cce6ff;");d.appendChild(a);d=create_th("#");d.setAttribute("style","width: 10px;");a.appendChild(d);d=create_th("\u5b50\u96c6\u5408");d.setAttribute("style","width: 150px;");a.appendChild(d);d=create_th("\u61c9\u5230\u7e3d\u6578");d.setAttribute("style","width: 150px;");a.appendChild(d);d=create_th("\u5be6\u5230\u7e3d\u6578");d.setAttribute("style","width: 150px;");a.appendChild(d);
d=create_th("\u672a\u5230\u7e3d\u6578");d.setAttribute("style","width: 150px;");a.appendChild(d);a.appendChild(create_th("\u672a\u5230\u4eba\u54e1"));a.appendChild(create_th("\u64cd\u4f5c"));a=document.createElement("tbody");a.setAttribute("id","tab_subgroup_table_content"+b);c.appendChild(a);e.appendChild(c)}null!=document.getElementById("tab_subgroup_table_content"+b)&&clearChildView("tab_subgroup_table_content"+b)}
function create_not_preset_item(c,a,b){var e=document.getElementById("tab_subgroup_table_content99999");if(null==e)console.log("create_not_preset_item() tab_subgroup_table_content == null");else if(null!=document.getElementById("not_preset_item_"+a))console.log("create_not_preset_item() not_preset_item == null");else{var d=document.createElement("tr");1==c%2&&d.setAttribute("bgcolor","#ebebe0");d.setAttribute("id","not_preset_item_row_"+a);var f=0;d.appendChild(document.createElement("td"));d.cells[f].appendChild(document.createTextNode(""+
c));f++;c=document.createElement("td");d.appendChild(c);c=document.createElement("span");c.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");c.textContent=b;d.cells[f].appendChild(c);f++;d.appendChild(document.createElement("td"));b=document.createElement("span");b.setAttribute("id","not_preset_item_total_"+a);b.setAttribute("class","label label-primary");b.textContent=0;d.cells[f].appendChild(b);f++;d.appendChild(document.createElement("td"));b=document.createElement("span");
b.setAttribute("id","not_preset_item_present_"+a);b.setAttribute("class","label label-danger");b.textContent=0;d.cells[f].appendChild(b);f++;d.appendChild(document.createElement("td"));b=document.createElement("span");b.setAttribute("id","not_preset_item_absent_"+a);b.setAttribute("class","label label-primary");b.textContent=0;d.cells[f].appendChild(b);f++;c=document.createElement("td");d.appendChild(c);b=document.createElement("span");b.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");
b.setAttribute("id","not_preset_item_user_"+a);b.textContent="";d.cells[f].appendChild(b);f=document.createElement("td");f.setAttribute("id","not_preset_item_action_"+a);d.appendChild(f);e.appendChild(d)}}
function create_not_present_user(c,a){var b=getUseName(parseInt(c)),e=getUseAccount(c),d=document.createElement("span");d.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a65a;");d.textContent=b+" [ "+e+" ] ";gl_enable_batch_present&&(b=document.createElement("input"),b.setAttribute("id","id_row_checkbox_"+c),b.setAttribute("type","checkbox"),b.setAttribute("onclick",
"click_user();return true;"),d.appendChild(b),d.setAttribute("onclick",'click_user_name("'+c+'", "'+a+'");return true;'));return d}var gl_click_user=!1;function click_user(){gl_click_user=!0}function click_user_name(c,a){console.log("click_user_name() userid:"+c+" cardid:"+a);var b=document.getElementById("id_row_checkbox_"+c);gl_click_user||(b.checked=b.checked?!1:!0);b.checked?add_to_presentuser(c,a):remove_from_presentuser(c,a);gl_click_user=!1}
function create_th(c){var a=document.createElement("th");a.textContent=c;return a}function draw_userrollcallrecord_table(){for(var c=document.getElementById("USER_ROLLCALLRECORD_TABLE");1<=c.rows.length;)c.deleteRow(0);for(var a=0,b=0;b<gl_userrollcallrecord.length;++b)for(var e=gl_userrollcallrecord[b],d=0;d<e.userrecord.length;++d){var f=create_user_record_table_item(a,e,e.userrecord[d]);c.appendChild(f);a++}}
function create_record_table_item(c,a){if(null==a)return null;var b=document.createElement("tr");1==c%2&&b.setAttribute("bgcolor","#ebebe0");var e="",d="",f=0,g=gl_cardrollcall;0<a.userid&&(e=getUseName(parseInt(a.userid)),d=getUseAccount(a.userid));b.appendChild(document.createElement("td"));b.cells[f].appendChild(document.createTextNode(""+(c+1)));f++;var h=document.createElement("td");b.appendChild(h);h=document.createElement("span");0<a.cardid.length&&h.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");
h.textContent=a.cardid;b.cells[f].appendChild(h);f++;b.appendChild(document.createElement("td"));h=createRollCallDeviceList(a);b.cells[f].appendChild(h);f++;h=document.createElement("td");b.appendChild(h);h=document.createElement("span");0<a.userid&&(h.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;"),h.textContent=e+" [ "+d+" ]");b.cells[f].appendChild(h);f++;d=document.createElement("td");b.appendChild(d);d=document.createElement("span");0==a.present?(d.setAttribute("class",
"label label-danger"),null!=g&&(d.textContent=g.absentcomment)):(d.setAttribute("class","label label-primary"),null!=g&&(d.textContent=g.presentcomment));b.cells[f].appendChild(d);f++;g=document.createElement("td");b.appendChild(g);g=document.createElement("span");g.setAttribute("class","label label-info");0!=a.present&&(g.textContent=convertPrettyDateOnly(a.datetime));b.cells[f].appendChild(g);g=document.createElement("span");g.setAttribute("class","label label-warning");0!=a.present&&(g.textContent=
convertPrettyTimeOnly(a.datetime));b.cells[f].appendChild(g);f++;b.appendChild(document.createElement("td"));0==a.present&&check_rollcall_intime()&&(g=document.createElement("button"),g.setAttribute("title","\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230"),g.setAttribute("href","javascript:;"),g.setAttribute("onclick",'confirm_set_present("'+a.userid+'","'+a.cardid+'", "'+e+'");return false;'),e=document.createElement("i"),e.setAttribute("class","fa fa-user-plus"),g.appendChild(e),b.cells[f].appendChild(g));
return b}
function create_user_record_table_item(c,a,b){if(null==a)return null;a=document.createElement("tr");1==c%2&&a.setAttribute("bgcolor","#ebebe0");var e=0,d=gl_cardrollcall,f="",g="";0<b.userid&&(f=getUseName(parseInt(b.userid)),g=getUseAccount(b.userid));a.appendChild(document.createElement("td"));a.cells[e].appendChild(document.createTextNode(""+(c+1)));e++;c=document.createElement("td");a.appendChild(c);c=document.createElement("span");0<parseInt(b.userid)&&(c.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;"),c.textContent=
f+" [ "+g+" ] ");a.cells[e].appendChild(c);e++;a.appendChild(document.createElement("td"));for(g=0;g<b.card.length;++g){c=b.card[g];var h=document.createElement("div");a.cells[e].appendChild(h);var l=document.createElement("span");0<c.cardid.length&&l.setAttribute("style","font-size:14px; font-weight:bold;line-height:2; color:#330033;");l.textContent=c.cardid;h.appendChild(l)}e++;a.appendChild(document.createElement("td"));for(g=0;g<b.card.length;++g)c=b.card[g],h=document.createElement("div"),a.cells[e].appendChild(h),
c=createRollCallDeviceList(c),h.appendChild(c);e++;a.appendChild(document.createElement("td"));for(g=0;g<b.card.length;++g)c=b.card[g],h=document.createElement("div"),a.cells[e].appendChild(h),"0"==c.present?h.appendChild(create_absent_label(d.absentcomment)):h.appendChild(create_present_label(d.presentcomment));e++;a.appendChild(document.createElement("td"));for(g=0;g<b.card.length;++g)c=b.card[g],d=document.createElement("div"),a.cells[e].appendChild(d),0==c.present?d.appendChild(create_absent_label("\u7121")):
d.appendChild(create_present_label(c.datetime));e++;a.appendChild(document.createElement("td"));for(g=0;g<b.card.length;++g)c=b.card[g],d=document.createElement("div"),a.cells[e].appendChild(d),0==c.present&&check_rollcall_intime()&&(h=document.createElement("button"),h.setAttribute("title","\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230"),h.setAttribute("href","javascript:;"),h.setAttribute("onclick",'confirm_set_present("'+b.userid+'","'+c.cardid+'", "'+f+'");return false;'),c=document.createElement("i"),
c.setAttribute("class","fa fa-user-plus"),h.appendChild(c),d.appendChild(h));return a}
function createRollCallDeviceList(c){var a=document.createElement("span");a.setAttribute("id","uiid_devicelist_"+c.rollcallid);if(0<c.rfiddeviceids.length){var b=create_rfid_devicelist_ui(c.rollcallid,c.rfiddeviceids);a.appendChild(b)}0<c.nfclocators.length&&(b=create_nfc_devicelist_ui(c.rollcallid,c.nfclocators),a.appendChild(b));0==c.rfiddeviceids.length&&0==c.nfclocators.length&&(c=create_no_device_label("\u7121"),a.appendChild(c));return a}
function create_rfid_devicelist_ui(c,a){var b=a.split(","),e=document.createElement("span");e.setAttribute("id","uiid_uhfreader_"+c);for(var d=0;d<b.length;d++){var f=document.createElement("div"),g=create_rfiddevice_label(getRFIDDeviceName(b[d]));f.appendChild(g);e.appendChild(f)}return e}
function create_nfc_devicelist_ui(c,a){var b=a.split(","),e=document.createElement("span");e.setAttribute("id","uiid_nfclocator_"+c);for(var d=0;d<b.length;d++){var f=document.createElement("div"),g=create_nfclocator_label(getNFCLocatorDeviceName(b[d]));f.appendChild(g);e.appendChild(f)}return e}
function create_rfiddevice_label(c){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a7d0;");a.textContent=c;return a}
function create_nfclocator_label(c){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#f39c12;");a.textContent=c;return a}
function create_no_device_label(c){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#a12409;");a.textContent=c;return a}
function create_present_label(c){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#3c8dbc;");a.textContent=c;return a}
function create_absent_label(c){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#dd4b39;");a.textContent=c;return a}function clearChildView(c){c=document.getElementById(c);if(null!=c)for(;c.firstChild;)c.removeChild(c.firstChild);return c}
function check_rollcall_intime(){var c=!1,a=moment(gl_cardrollcallevent.StartDateTime,"YYYY-MM-DD HH:mm:ss"),b=moment(gl_cardrollcallevent.EndDateTime,"YYYY-MM-DD HH:mm:ss"),e=moment();e>=a&&e<=b&&(c=!0);return c}
function enable_batch_present(){console.log("enable_batch_present() ");gl_batch_present_user=[];gl_enable_batch_present=!0;var c=document.getElementById("enable_batch_present_btn"),a=document.getElementById("enable_batch_present_icon");c.setAttribute("title","\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230");c.setAttribute("onclick","save_batch_present();return false;");a.setAttribute("class","fa fa-save");reload_rollcall_ui()}
function add_to_presentuser(c,a){for(var b=!1,e=0;e<gl_batch_present_user.length;++e){var d=gl_batch_present_user[e];if(d.userid==c){b=!0;break}}b||(d={},d.userid=c,d.cardid=a,gl_batch_present_user.push(d));console.log("add_to_presentuser() gl_batch_present_user.length:"+gl_batch_present_user.length)}
function remove_from_presentuser(c,a){for(var b=0;b<gl_batch_present_user.length;++b)if(gl_batch_present_user[b].userid==c){gl_batch_present_user.splice(b,1);break}console.log("remove_from_presentuser() gl_batch_present_user.length:"+gl_batch_present_user.length)}function save_batch_present(){console.log("save_batch_present() ");confirm("\u662f\u5426\u8981\u6279\u6b21\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230?")&&batch_set_present()}
function batch_set_present(){gl_enable_batch_present=!1;for(var c=[],a=[],b=0;b<gl_batch_present_user.length;++b){var e=gl_batch_present_user[b];c.push(e.userid);a.push(e.cardid)}b={};b.project_id=""+project_id;b.update_rollcall_record_batch=1;b.rollcallid=rollcallid;b.eventid=eventid;b.userids=c.toString();b.cardids=a.toString();jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:b,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));a=document.getElementById("enable_batch_present_btn");
var b=document.getElementById("enable_batch_present_icon");a.setAttribute("title","\u6279\u6b21\u8a2d\u5b9a\u9ede\u540d\u5df2\u5230");a.setAttribute("onclick","enable_batch_present();return false;");b.setAttribute("class","fa fa-user-plus");gl_batch_present_user=[];glReloadCount=5;setTimeout(reload_rollcall_info,1E3)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}
function set_present(c,a){var b={};b.project_id=""+project_id;b.update_rollcall_record=1;b.rollcallid=rollcallid;b.eventid=eventid;b.cardid=a;b.userid=c;jQuery.ajax({url:gl_target_server+"/php/rfiddevice.php",type:"POST",data:b,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));glReloadCount=5;setTimeout(reload_rollcall_info,5E3)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}
function confirm_set_present(c,a,b){confirm("\u662f\u5426\u8981\u8a2d\u5b9a"+b+"\u9ede\u540d\u5df2\u5230?")&&set_present(c,a)}
function create_userrollcallresult_xlsx_report(){document.getElementById("xlsxreport_status").textContent="\u7522\u751f\u5831\u8868\u4e2d...";jQuery.ajax({url:gl_target_server+"/php/vilsnodes.php",type:"POST",data:"loaduserrollcallresultxlsxreport=1&project_id="+project_id+"&rollcallid="+rollcallid+"&eventid="+eventid,dataType:"text",success:function(c){var a=JSON.parse(c);console.log("create_userrollcallresult_xlsx_report() success:"+a.success+" xlsxreport:"+a.xlsxreport);for(var b=document.getElementById("xlsxreport_status");b.firstChild;)b.removeChild(b.firstChild);
"true"===a.success?(c=document.createElement("button"),c.setAttribute("type","button"),c.setAttribute("class","btn btn-app"),c.setAttribute("style","width:90px;height:100px"),c.setAttribute("onclick","open_new_page('"+a.xlsxreport+"');"),b.appendChild(c),a=document.createElement("img"),a.setAttribute("src","/images/xlsx-dl-icon-1.png"),a.setAttribute("alt","Download report"),a.setAttribute("title","Download report"),a.setAttribute("height","80"),a.setAttribute("width","80"),c.appendChild(a)):(b=document.getElementById("xlsxreport_status"),
b.textContent="\u7522\u751f\u5831\u8868\u5931\u6557!")}});return!1}function check_user_subgroup(c,a){var b=!1;parseInt(c);for(var e=parseInt(a)+"",d=0;d<gl_user_info.length;++d){var f=gl_user_info[d];if(parseInt(f.userid)==c){0<=f.subgroups.split(",").indexOf(e)&&(b=!0);break}}return b}function getUseName(c){for(var a=c,b=0;b<gl_user_info.length;++b){var e=gl_user_info[b];if(parseInt(e.userid)==c){a=e.name;break}}return a}
function getUseAccount(c){for(var a=c,b=0;b<gl_user_info.length;++b){var e=gl_user_info[b];if(parseInt(e.userid)==c){a=e.account;break}}return a}function getRFIDDeviceName(c){for(var a=c,b=0;b<gl_rfiddevices.length;++b){var e=gl_rfiddevices[b];if(e.deviceid===c){a=e.name;break}}return a}function getNFCLocatorDeviceName(c){for(var a=c,b=0;b<gl_nfclocators.length;++b){var e=gl_nfclocators[b];if(e.macaddress===c){a=e.name;break}}return a}
function convertPrettyDateOnly(c){var a=moment(c,"YYYY-MM-DD HH:mm:ss");c=a.format("YYYY");var b=a.format("M"),a=a.format("D");return c+"\u5e74"+b+"\u6708"+a+"\u65e5 "}function convertPrettyTimeOnly(c){var a=moment(c,"YYYY-MM-DD HH:mm:ss");c=a.hour();var b=a.minutes(),a=a.seconds(),e="";0<=c&&(e+=c+"\u9ede");0<=b&&(e+=b+"\u5206");0<=a&&(e+=a+"\u79d2");return e}function open_new_page(c){window.open(c,"_blank").focus()}
function open_cardrollcallevent_page(){window.open("/index.php/vilscardrollcallevent/"+project_id,"_blank").focus()};
