var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,e,f){if(f.get||f.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[e]=f.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var e=0;return $jscomp.iteratorPrototype(function(){return e<d.length?{done:!1,value:d[e++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(d,e){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var f=0,g={next:function(){if(f<d.length){var k=f++;return{value:e(k,d[k]),done:!1}}g.next=function(){return{done:!0,value:void 0}};return g.next()}};g[Symbol.iterator]=function(){return g};return g};
$jscomp.polyfill=function(d,e,f,g){if(e){f=$jscomp.global;d=d.split(".");for(g=0;g<d.length-1;g++){var k=d[g];k in f||(f[k]={});f=f[k]}d=d[d.length-1];g=f[d];e=e(g);e!=g&&null!=e&&$jscomp.defineProperty(f,d,{configurable:!0,writable:!0,value:e})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6-impl","es3");
L.ImageOverlay.Rotated=L.ImageOverlay.extend({initialize:function(d,e,f,g,k){"string"===typeof d?this._url=d:this._rawImage=d;this._topLeft=L.latLng(e);this._topRight=L.latLng(f);this._bottomLeft=L.latLng(g);L.setOptions(this,k)},onAdd:function(d){this._image||(this._initImage(),1>this.options.opacity&&this._updateOpacity());this.options.interactive&&(L.DomUtil.addClass(this._rawImage,"leaflet-interactive"),this.addInteractiveTarget(this._rawImage));d.on("zoomend resetview",this._reset,this);this.getPane().appendChild(this._image);
this._reset()},onRemove:function(d){d.off("zoomend resetview",this._reset,this);L.ImageOverlay.prototype.onRemove.call(this,d)},_initImage:function(){var d=this._rawImage;this._url&&(d=L.DomUtil.create("img"),d.style.display="none",this.options.crossOrigin&&(d.crossOrigin=""),d.src=this._url,this._rawImage=d);L.DomUtil.addClass(d,"leaflet-image-layer");var e=this._image=L.DomUtil.create("div","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));this._updateZIndex();e.appendChild(d);
e.onselectstart=L.Util.falseFn;e.onmousemove=L.Util.falseFn;d.onload=function(){this._reset();d.style.display="block";this.fire("load")}.bind(this);d.alt=this.options.alt},_reset:function(){var d=this._image;if(void 0!=this._map){var e=this._map.latLngToLayerPoint(this._topLeft),f=this._map.latLngToLayerPoint(this._topRight),g=this._map.latLngToLayerPoint(this._bottomLeft),k=f.subtract(e).add(g),l=L.bounds([e,f,g,k]),q=l.getSize(),k=e.subtract(l.min),t=f.subtract(e),u=g.subtract(e),t=Math.atan2(t.y,
t.x),u=Math.atan2(u.x,u.y);this._bounds=L.latLngBounds(this._map.layerPointToLatLng(l.min),this._map.layerPointToLatLng(l.max));L.DomUtil.setPosition(d,l.min);d.style.width=q.x+"px";d.style.height=q.y+"px";l=this._rawImage.width;d=this._rawImage.height;l&&d&&(f=e.distanceTo(f)/l*Math.cos(t),e=e.distanceTo(g)/d*Math.cos(u),this._rawImage.style.transformOrigin="0 0",this._rawImage.style.transform="translate("+k.x+"px, "+k.y+"px)skew("+u+"rad, "+t+"rad) scale("+f+", "+e+") ")}},reposition:function(d,
e,f){this._topLeft=L.latLng(d);this._topRight=L.latLng(e);this._bottomLeft=L.latLng(f);this._reset()},setUrl:function(d){this._url=d;this._rawImage&&(this._rawImage.src=d);return this}});L.imageOverlay.rotated=function(d,e,f,g,k){return new L.ImageOverlay.Rotated(d,e,f,g,k)};var Indoor2DMap=function(d){function e(a,c){return FloatDiv(c,11132E3*Math.cos(a*Math.PI/180))}function f(a,c){return FloatMul(c,11132E3*Math.cos(a*Math.PI/180))}this.mEnableUISmoothing=!0;this.SHOW_LOCATOR_DEFAULT=this.SHOW_AREA_DEFAULT=!1;var g=function(a,c){return L.Util.isArray(a)?L.latLng(a[1],a[0]):L.latLng(c,a)},k=L.icon({iconUrl:"/images/orig-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),
l=L.icon({iconUrl:"/images/coord-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),q=L.icon({iconUrl:"/images/marker-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),t=L.icon({iconUrl:"/images/tag-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,
47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),u=L.icon({iconUrl:"/images/marker-sleep-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),F=L.icon({iconUrl:"/images/marker-sleep-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),G=L.icon({iconUrl:"/images/anchor-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),y=L.icon({iconUrl:"/images/locator-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),H=L.icon({iconUrl:"/images/locator-notalive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),I=L.icon({iconUrl:"/images/locator-poweroff-icon-2x.png",
shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),J=L.icon({iconUrl:"/images/gray-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),K=L.icon({iconUrl:"/images/gray-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,
-35]}),M=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]});L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[50,74],shadowSize:[41,41],iconAnchor:[25,74],shadowAnchor:[14,41],popupAnchor:[0,-35]});var N=L.icon({iconUrl:"/images/inactive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,
37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),O=L.icon({iconUrl:"/images/inactive-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),P=L.icon({iconUrl:"/images/norollcall-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),Q=L.icon({iconUrl:"/images/norollcall-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),z=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),A=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),B=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),x=L.icon({iconUrl:"/images/pin_lidar.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),C=L.icon({iconUrl:"/images/pin_user.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),D="#FF6347 #FFA500 #FFD700 #32CD32 #87CEEB #7B68EE #8A2BE2 #4245f4 #F08080 #f441d9".split(" ");
this.mMapLayer_nodes=[];this.mMapLayerId=1;this.OriginMarker=null;this.Anchors=[];this.Tags=[];this.Coords=[];this.Locators=[];this.Sensors=[];this.Users=[];this.TagDrawList=[];this.TagGPSDrawList=[];this.MapAreas=[];this.AddressList=[];this.AlertIconScaleIndexList=[];this.AlertIconScaleUpDownList=[];this.StreetMaps=[[]];this.NodeAlertFunction=[];this.areaborder_color="#8b95aa";this.areaborder_opacity="0.8";this.FadeOutPolylines=[[]];this.FadeOutNodes=[[]];this.mRotateMap=this.mShowTrack=!1;this.mTargetDragCallback=
this.mEditModeCallback=this.mNodeClickCallback=this.mUpdateMapInfoCallback=this.mOrigNodeDragCallback=this.mNodeDragCallback=null;this.mEdit_delete_mode=this.mEdit_mode=!1;this.mEdit_maparea_index=-1;this.mLayerControl=this.mUsermapScaleDown=this.mUsermapScaleUp=this.mUsermapEdit=null;this.mMap_OrigY=this.mMap_OrigX=this.mMap_coeff=this.mMap_scale=this.mUsermap_height=this.mUsermap_width=this.mMAP_North=this.mWGS48OriginY=this.mWGS48OriginX=0;this.mBounds=[g(0,0),g(1E3,1E3)];this.mUserProject_Name=
this.mUserMap_url=this.mUserMaplayer=null;this.smoothing_time=400;this.move_step_size=6;this.move_loop_count=0;this.GPS_smoothing_time=400;this.GPS_move_step_size=10;this.GPS_move_loop_count=0;this.popupZoom=20;this.mDrawControl=null;this.baseLayers={};this.layer_areas=new L.FeatureGroup;this.overlays={};L.Map=L.Map.extend({openPopup:function(a,c,b){a instanceof L.Popup||(a=(new L.Popup(b)).setContent(a));c&&a.setLatLng(c);if(this.hasLayer(a))return this;this._popup=a;return this.addLayer(a)}});this.mMap=
L.map(d,{maxZoom:26,zoomSnap:0,zoomDelta:.25,doubleClickZoom:!1});this.mLayerControl=L.control.layers().addTo(this.mMap);this.mMap.attributionControl.setPrefix('<a href="http://smims.com">SMIMS</a>');this.mMap.orig_this=this;d=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:26,attribution:'&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'});var E=L.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,
subdomains:["mt0","mt1","mt2","mt3"]}),R=L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,subdomains:["mt0","mt1","mt2","mt3"]});this.mLayerControl.addOverlay(d,"OpenStreetMap");this.mLayerControl.addOverlay(E,"Google Streets");this.mLayerControl.addOverlay(R,"Google Satellite");this.StreetMaps.OpenStreetMap=0;this.StreetMaps["Google Streets"]=0;this.StreetMaps["Google Satellite"]=0;Indoor2DMap.prototype.create_alert_scale_icon=function(){var a;for(a=
0;10>a;a++){var c=25*(1+.1*a),b=37*(1+.1*a),c=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[c,b],shadowSize:[41,41],iconAnchor:[c/2,b],shadowAnchor:[14,41],popupAnchor:[0,-35]});this.AlertIconScaleUpDownList[a]=c}};Indoor2DMap.prototype.onOverlayAdd=function(a){a.name in this.orig_this.StreetMaps&&(this.orig_this.StreetMaps[a.name]=1,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.onOverlayRemove=function(a){a.name in this.orig_this.StreetMaps&&
(this.orig_this.StreetMaps[a.name]=0,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.updateMapRotate=function(a){var c=!1;for(map in a.StreetMaps)if(1==a.StreetMaps[map]){c=!0;break}a.mRotateMap=c;a.update_2d_map(a);a.update_node_pos(a,a.Anchors);a.update_node_pos(a,a.Coords);a.load_allmaparea(a)};Indoor2DMap.prototype.update_2d_map=function(a){null!=a.mUserMaplayer&&a.mMap.removeLayer(a.mUserMaplayer);var c=FloatDiv(a.mUsermap_width,a.mMap_scale*a.mMap_coeff),b=FloatDiv(a.mUsermap_height,
a.mMap_scale*a.mMap_coeff),m=a.mWGS48OriginY+FloatDiv(FloatMul(a.mMap_OrigY,-1),11057400),d=a.mWGS48OriginX+e(m,FloatMul(a.mMap_OrigX,-1)),m=g(d,m),d=FloatDiv(1E4,11057400),h=e(a.mWGS48OriginY+d,1E4),c=g(m.lng+c,m.lat+d/h*b);a.mBounds=[m,c];d=new L.latLng(a.mBounds[1].lat,a.mBounds[0].lng);h=new L.latLng(a.mBounds[1].lat,a.mBounds[1].lng);c=new L.latLng(a.mBounds[0].lat,a.mBounds[0].lng);b=new L.latLng(a.mWGS48OriginY,this.mWGS48OriginX);m=0;a.mRotateMap&&(m=a.mMAP_North);d=rotatePoint(d,m,b);h=rotatePoint(h,
m,b);c=rotatePoint(c,m,b);a.mUserMaplayer=L.imageOverlay.rotated(a.mUserMap_url,d,h,c,{opacity:.5,interactive:!0,attribution:a.mUserProject_Name});a.mMap.addLayer(a.mUserMaplayer,a.mUserProject_Name)};Indoor2DMap.prototype.update_node_pos=function(a,c){for(var b=0;b<c.length;b++){var m=c[b];if(null!=m){var d=a.convertToLatLng(a,m.posX,m.posY);m.setLatLng(d)}}};Indoor2DMap.prototype.setMapCoeff=function(a,c,b,m,d,h,f,S,k){null==a&&(a=0);null==c&&(c=0);this.mWGS48OriginX=parseFloat(f);this.mWGS48OriginY=
parseFloat(S);this.mMAP_North=parseFloat(k);this.mUsermap_width=parseInt(b);this.mUsermap_height=parseInt(m);this.mMap_scale=parseFloat(d);this.mMap_coeff=parseFloat(h);this.mMap_OrigX=parseFloat(a);this.mMap_OrigY=parseFloat(c);a=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);c=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);b=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);m=this.mWGS48OriginX+e(b,FloatMul(this.mMap_OrigX,-1));b=g(m,b);m=FloatDiv(1E4,
11057400);d=e(this.mWGS48OriginY+m,1E4);a=g(b.lng+a,b.lat+m/d*c);this.mBounds=[b,a]};Indoor2DMap.prototype.setMapImage=function(a,c){this.mUserMap_url=a;this.mUserProject_Name=c;this.update_2d_map(this);this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]});this.mMap.zoomControl.setPosition("topright");L.control.scale({imperial:!1,maxWidth:300}).addTo(this.mMap);this.mLayerControl.addOverlay(this.layer_areas,"Areas");1==this.SHOW_AREA_DEFAULT&&this.mMap.addLayer(this.layer_areas,"Areas");this.create_map_action(this.mMap)};
Indoor2DMap.prototype.setMapLayerInfo=function(a){this.mMapLayerId=a};Indoor2DMap.prototype.changeUserMap=function(a,c,b){this.mUserMap_url=a;this.mMap.removeLayer(this.mUserMaplayer);this.mUsermap_width=c;this.mUsermap_height=b;a=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);c=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);b=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);var m=this.mWGS48OriginX+e(b,FloatMul(this.mMap_OrigX,-1));b=g(m,b);var m=
FloatDiv(1E4,11057400),d=e(this.mWGS48OriginY+m,1E4);a=g(b.lng+a,b.lat+m/d*c);this.mBounds=[b,a];this.mUserMaplayer=L.imageOverlay(this.mUserMap_url,this.mBounds,{attribution:this.mUserProject_Name,opacity:.5});this.mMap.addLayer(this.mUserMaplayer,this.mUserProject_Name)};Indoor2DMap.prototype.editmode=function(){return this.mEdit_mode};Indoor2DMap.prototype.setShowTrack=function(a){this.mShowTrack=a};Indoor2DMap.prototype.refresh=function(){var a=this.mMap.getZoom();this.mMap._onResize();0==a&&
setTimeout(this.fitBounds,100,this)};Indoor2DMap.prototype.fitBounds=function(a){a.mMap.fitBounds(a.mBounds,{paddingTopLeft:[0,0]})};Indoor2DMap.prototype.setBounds=function(a,c,b,m){b=g(m,b);a=g(c,a);this.mBounds=[b,a];this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]})};Indoor2DMap.prototype.clearAddressTarget=function(){for(var a=this.getCurrentLayer("Origin",this.mMapLayerId),c=0;c<this.AddressList.length;c++)a.removeLayer(this.AddressList[c]);this.AddressList=[]};Indoor2DMap.prototype.setTargetLocation=
function(a,c,b){for(var m,d=!1,h=0;h<this.AddressList.length;h++){var e=this.AddressList[h];if(e.name===a){d=!0;m=e;break}}0==d&&(m=a+"&nbsp;&nbsp;&nbsp;&nbsp;<br>",m=L.popup({closeOnClick:!1,autoClose:!1}).setContent(m),d=g(b,c),m=L.marker(d,{title:a,draggable:!1}).bindPopup(m),m.name=a,m.orig_this=this,m.setIcon(k),this.AddressList.push(m),m.on("click",this.markerOnClick),m.on("dragend",function(a){a=a.target;var b=a.orig_this,c=a.getLatLng();"function"===typeof b.mTargetDragCallback&&b.mTargetDragCallback(b.mMapLayerId,
a.name,c.lat,c.lng)}),a=this.getCurrentLayer("Origin",this.mMapLayerId),m.addTo(a));c=g(b,c);m.setLatLng(c)};Indoor2DMap.prototype.setUISmoothing=function(a){a&&!this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,100,this),setTimeout(this.draw_tag_GPS_smooth_move,100,this));this.mEnableUISmoothing=a};Indoor2DMap.prototype.markerOnClick=function(a){this.orig_this.markclick(a.target.type,a.target.index);"function"===typeof this.orig_this.mNodeClickCallback&&this.orig_this.mNodeClickCallback(a.target)};
Indoor2DMap.prototype.mapAreaOnClick=function(a){var c=a.target.orig_this;if(c.mEdit_mode&&!c.mEdit_delete_mode){var b=c.MapAreas[a.target.index],b=b.toGeoJSON();c.toggle_map_area_editor(b,a.target.index)}else b=c.MapAreas[a.target.index],b=b.toGeoJSON(),999!=b.properties.areatype&&fetch_rollcall(b.properties.areaid,b.properties.areaname)};Indoor2DMap.prototype.createVILSMarker=function(a,c,b,m,d,h,e,g,k){var w=b+"&nbsp;&nbsp;&nbsp;&nbsp;<br>";0==b.length&&(w=c+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");var w=
L.popup({closeOnClick:!1,autoClose:!1}).setContent(w),p=this.convertToLatLng(this,m,d),n=L.marker(p,{title:c,draggable:g}).bindPopup(w);n.nodeid=c;n.macaddress=a;n.nodename=b;n.posX=m;n.posY=d;n.posZ=h;n.date=e;n.orig_this=this;n.maplayer=k;n.on("click",this.markerOnClick);n.on("dragend",function(a){a=a.target;var b=a.orig_this,c=a.getLatLng();a.posY=FloatMul(c.lat,11057400)-FloatMul(b.mWGS48OriginY,11057400);posX1=f(c.lat,c.lng);posX2=f(c.lat,b.mWGS48OriginX);a.posX=posX1-posX2;"function"===typeof b.mNodeDragCallback&&
b.mNodeDragCallback(b.mMapLayerId,a.type,n.macaddress,a.nodeid,a.posX,a.posY,a.posZ,c.lat,c.lng)});return n};Indoor2DMap.prototype.fadeout_tag_footprint=function(a,c){var b=[],m=[],d=this.FadeOutPolylines[a],h=this.FadeOutNodes[a],e=this.getCurrentLayer("Tags",c);null!=d&&e.removeLayer(d);if(null!=h&&void 0!=h){for(var d="rgb(244, 131, 66)",g=0;g<h.length;g++){var f=h[g],k=f.options.radius,d=f.options.color;.5>=k||0==mShowTrack?e.removeLayer(f):(f.setStyle({radius:k-.5}),k=f.getLatLng(),b.push([k.lat,
k.lng]),m[m.length]=f)}this.FadeOutNodes[a]=m;d=new L.Polyline(b,{color:d,weight:4,opacity:.4,smoothFactor:1});e.addLayer(d);this.FadeOutPolylines[a]=d}};Indoor2DMap.prototype.fadeout_loop=function(a){for(var c=0;c<a.Tags.length;c++){var b=a.Tags[c];a.fadeout_tag_footprint(b.nodeid,b.maplayer)}setTimeout(a.fadeout_loop,1E3,a)};Indoor2DMap.prototype.showGoolgeMap=function(){this.mMap.addLayer(E,"Google Streets")};Indoor2DMap.prototype.showOriginLayer=function(){var a=this.getCurrentLayer("Origin",
this.mMapLayerId);this.mMap.addLayer(a,"Origin")};Indoor2DMap.prototype.createMapEditor=function(a){this.mUsermapScaleDown=new this.UserMapScaleDownControl;this.mUsermapScaleUp=new this.UserMapScaleUpControl;this.mUsermapEdit=new this.UserMapEditControl;this.mMap.addControl(this.mUsermapEdit);this.fadeout_loop(this);this.mEditModeCallback=a};Indoor2DMap.prototype.setNodeDragCallback=function(a){this.mNodeDragCallback=a};Indoor2DMap.prototype.setOrigNodeDragCallback=function(a){this.mOrigNodeDragCallback=
a};Indoor2DMap.prototype.setUpdateMapInfoCallback=function(a){this.mUpdateMapInfoCallback=a};Indoor2DMap.prototype.setNodeClickCallback=function(a){this.mNodeClickCallback=a};Indoor2DMap.prototype.addOriginMarker=function(a,c,b){a=this.createVILSMarker("0000","OriginXYZID","Origin",a,c,b,null,!1,this.mMapLayerId);a.setIcon(k);c=this.getCurrentLayer("Origin",this.mMapLayerId);a.addTo(c);this.OriginMarker=a;a.type="Origin";a.index=0;a.on("dragend",function(a){a=a.target;var b=a.getLatLng(),c=this.orig_this,
d=FloatMul(b.lat,11057400)-FloatMul(c.mWGS48OriginY,11057400);posX1=f(b.lat,b.lng);posX2=f(b.lat,c.mWGS48OriginX);b=posX1-posX2;c.mMap_OrigY+=d;c.mMap_OrigX+=b;c.update_2d_map(c);a.setLatLng(new L.LatLng(c.mWGS48OriginY,c.mWGS48OriginX));c.mMap.panTo(a.getLatLng());"function"===typeof c.mOrigNodeDragCallback&&c.mOrigNodeDragCallback(c.mMapLayerId,c.mMap_OrigX,c.mMap_OrigY)})};Indoor2DMap.prototype.createDummyTag=function(a,c,b,m,d,h,e,f,g){this.updateMarker(this.Tags,a,c,b,m,d,h,e,f,g,!1)||this.addTag(this.Tags.length,
a,c,b,m,d,h,e,f,g)};Indoor2DMap.prototype.addAnchor=function(a,c,b,m,d,h,e,f,g,k,p){c=this.createVILSMarker(c,b,m,d,h,e,k,!1,p);p=this.getCurrentLayer("Anchors",p);c.setIcon(G);c.addTo(p);this.Anchors[a]=c;c.type="anchor";c.index=a};Indoor2DMap.prototype.addTag=function(a,c,b,m,d,h,e,f,g,k,p){c=this.createVILSMarker(c,b,m,d,h,e,k,!1,p);p=this.getCurrentLayer("Tags",p);c.setIcon(q);p.addLayer(c);this.Tags[a]=c;c.type="tag";c.index=a};Indoor2DMap.prototype.addCoordinator=function(a,c,b,m,d,h,e,f,g,
k,p){c=this.createVILSMarker(c,b,m,d,h,e,k,!1,p);p=this.getCurrentLayer("Coordinators",p);c.setIcon(l);c.addTo(p);this.Coords[a]=c;c.type="coord";c.index=a};Indoor2DMap.prototype.addLocator=function(a,c,b,m,d,h,e,f,g,k,p){c=this.createVILSMarker(c,b,m,d,h,e,k,!1,p,p);p=this.getCurrentLayer("Locators",p);c.setIcon(y);c.addTo(p);this.Locators[a]=c;c.type="locator";c.index=a};Indoor2DMap.prototype.getCurrentLayer=function(a,c){var b=this.mMapLayer_nodes[a];void 0==b&&(b=new L.LayerGroup,this.mMapLayer_nodes[a]=
b,"Tags"==a&&this.mMap.addLayer(b,a),"Locators"==a&&1==this.SHOW_LOCATOR_DEFAULT&&this.mMap.addLayer(b,a),"Sensors"==a&&this.mMap.addLayer(b,a),"Users"==a&&this.mMap.addLayer(b,a),this.mLayerControl.addOverlay(b,a));return b};Indoor2DMap.prototype.updateAnchorMarker=function(a,c,b,m,d,h,e,f,g,k){if(0!=this.mMapLayerId&&0!=k&&this.mMapLayerId!=k)return!0;this.updateMarker(this.Anchors,a,c,b,m,d,h,e,f,g,!1,!0,k)||this.addAnchor(this.Anchors.length,a,c,b,m,d,h,e,f,g,k)};Indoor2DMap.prototype.updateTagMarker=
function(a,c,b,m,d,h,e,f,g,k,p){if(0!=this.mMapLayerId&&0!=p&&this.mMapLayerId!=p)return this.setMarkerVisible(this.Tags,c,!1),this.updateMarker(this.Tags,a,c,b,m,d,h,e,f,g,!0,!1,p),this.push_to_drawlist(a,c,b,m,d,h,e,f,g,p),!0;0!=this.check_visible_state(this.Tags,c)||k||(this.reset_node(c,m,d,h,e,f,p),this.updateMarker(this.Tags,a,c,b,m,d,h,e,f,g,!0,!0,p),this.setMarkerVisible(this.Tags,c,!0));k?this.hide_2d_drawlist(c):(this.hide_2d_drawGPSlist(c),this.push_to_drawlist(a,c,b,m,d,h,e,f,g,p));(k=
this.updateMarker(this.Tags,a,c,b,m,d,h,e,f,g,!0,!this.mEnableUISmoothing&&!k,p))||this.addTag(this.Tags.length,a,c,b,m,d,h,e,f,g,p);return k};Indoor2DMap.prototype.updateCoordinatorMarker=function(a,c,b,d,e,h,f,g,k,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return this.setMarkerVisible(this.Coords,c,!1),this.updateMarker(this.Coords,a,c,b,d,e,h,f,g,k,!0,!1,l),!0;this.updateMarker(this.Coords,a,c,b,d,e,h,f,g,k,!1,!0,l)||this.addCoordinator(this.Coords.length,a,c,b,d,e,h,f,g,k,l)};Indoor2DMap.prototype.updateLocatorMarker=
function(a,c,b,d,e,h,f,g,k,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return this.setMarkerVisible(this.Locators,c,!1),this.updateMarker(this.Locators,a,c,b,d,e,h,f,g,k,!0,!1,l),!0;var p=this.updateMarker(this.Locators,a,c,b,d,e,h,f,g,k,!1,!0,l);p||this.addLocator(this.Locators.length,a,c,b,d,e,h,f,g,k,l);return p};Indoor2DMap.prototype.updateMarker=function(a,c,b,d,e,h,f,g,k,l,p,n,q){var t=!1,v,u;for(u=0;u<a.length;u++)if(v=a[u],v.nodeid===b){v.nodename=0==d.length?b:d;v.posX=e;v.posY=
h;v.posZ=f;v.buildingid=g;v.floor=k;v.maplayer=q;v.date=l;v.macaddress=c;if(n&&(a=this.convertToLatLng(this,e,h),v.setLatLng(a),p&&this.mShowTrack)){void 0!=v._icon&&"hidden"==v._icon.style.visibility&&this.showMarker(v);p=u;10<=p&&(p-=10);p=L.circleMarker(a,{color:D[p],opacity:.3,fillColor:D[p],fillOpacity:.2,className:"geoData",radius:5});q=this.getCurrentLayer("Tags",q);p.buildingid=g;p.floor=k;p.addTo(q);g=this.FadeOutNodes[v.nodeid];if(null==g||void 0==g)g=[];g[g.length]=p;this.FadeOutNodes[v.nodeid]=
g}t=!0;break}return t};Indoor2DMap.prototype.updateSensorMarker=function(a,c,b,d,e,h,f,k){var l=this.getCurrentLayer("Sensors",h);if(0!=this.mMapLayerId&&0!=h&&this.mMapLayerId!=h)return!0;for(var q=!1,p=0;p<this.Sensors.length;p++){var n=this.Sensors[p];if(n.id===a){q=!0;n.setLatLng(g(d,e));break}}0==q?(q=new moment,c=this.createVILSMarker(a,a,c,0,0,0,q,!1,h),"LiDAR"===b?c.setIcon(x):0==f.length||0==f?c.setIcon(A):1==k?c.setIcon(B):c.setIcon(z),c.setLatLng(g(d,e)),l.addLayer(c),b=this.Sensors.length,
this.Sensors[b]=c,c.id=a,c.type="sensor",c.index=b):"LiDAR"===b?n.setIcon(x):0==f.length||0==f?n.setIcon(A):1==k?n.setIcon(B):n.setIcon(z)};Indoor2DMap.prototype.updateUserMarker=function(a,c,b,d,e,h,f,k){h=this.getCurrentLayer("Users",b);if(0!=this.mMapLayerId&&0!=b&&this.mMapLayerId!=b)return!0;var l=g(f,k);f=parseInt(f);k=parseInt(k);if(0==f||0==k)l=this.convertToLatLng(this,d,e);d=!1;for(e=0;e<this.Users.length;e++)if(k=this.Users[e],k.id===a){d=!0;k.setLatLng(l);break}0==d&&(d=new moment,c=this.createVILSMarker(a,
a,c,0,0,0,d,!1,b),c.setIcon(C),c.setLatLng(l),h.addLayer(c),b=this.Users.length,this.Users[b]=c,c.id=a,c.type="user",c.index=b)};Indoor2DMap.prototype.getTagList=function(){return this.Tags};Indoor2DMap.prototype.getLocatorList=function(){return this.Locators};Indoor2DMap.prototype.setTagPopup=function(a,c){var b;for(b=0;b<this.Tags.length;b++){var d=this.Tags[b];if(d.nodeid===a){c?(d.openPopup(),this.mMap.setView(d.getLatLng())):d.closePopup();break}}};Indoor2DMap.prototype.setLocatorPopup=function(a,
c){var b;for(b=0;b<this.Locators.length;b++){var d=this.Locators[b];if(d.nodeid===a){c?(d.openPopup(),this.mMap.setView(d.getLatLng())):d.closePopup();break}}};Indoor2DMap.prototype.setSensorPopup=function(a,c){var b;for(b=0;b<this.Sensors.length;b++){var d=this.Sensors[b];console.log("setSensorPopup() index:"+b+" id:"+a+" exist_sensor.id:"+d.id);if(d.id===a){c?(d.openPopup(),this.mMap.setView(d.getLatLng())):d.closePopup();break}}};Indoor2DMap.prototype.setUserPopup=function(a,c){var b;for(b=0;b<
this.Users.length;b++){var d=this.Users[b];if(d.id==a){c?(d.setIcon(C),d.openPopup(),this.mMap.setView(d.getLatLng())):(d.setIcon(x),d.closePopup());break}}};Indoor2DMap.prototype.setTagAlert=function(a,c){this.set_TagDraw_Alert(a,c);this.set_TagGPSDraw_Alert(a,c)};Indoor2DMap.prototype.setStartAlert=function(a){void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={});this.NodeAlertFunction[a]=1;console.log("setStartAlert() "+a)};Indoor2DMap.prototype.setStopAlert=function(a){void 0==this.NodeAlertFunction[a]&&
(this.NodeAlertFunction[a]={});this.NodeAlertFunction[a]=0;this.getTargetNode(a).setIcon(this.AlertIconScaleUpDownList[0]);console.log("setStopAlert() "+a)};Indoor2DMap.prototype.check_tag_layer_alertcircle=function(){var a=this.getCurrentLayer("Tags",this.mMapLayerId),c=a.getLayers(),b;for(b=0;b<c.length;b++){var d=c[b];"circleMarker"===d.type&&(console.log("check_tag_layer_alertcircle() Found!"),a.removeLayer(d))}};Indoor2DMap.prototype.check_locator_layer_alertcircle=function(){for(var a=this.getCurrentLayer("Locators",
this.mMapLayerId),c=a.getLayers(),b=0;b<c.length;b++){var d=c[b];"circleMarker"===d.type&&(console.log("check_locator_layer_alertcircle() Found!"),a.removeLayer(d))}};Indoor2DMap.prototype.set_TagDraw_Alert=function(a,c){for(var b=0;b<this.TagDrawList.length;b++){var d=this.TagDrawList[b];if(d.nodeid===a){b=this.getTargetNode(a);if(null==b)break;if(b.maplayer!=this.mMapLayerId)break;0<d.alertcount&&d.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=
1);if(0==c||0==this.NodeAlertFunction[a]){d.alertcount=0;var e=this.getCurrentLayer("Tags",this.mMapLayerId),h=d.alertcircle;void 0!=h&&null!=h&&(e.removeLayer(h),d.alertcircle=null,b.closePopup());b.setPopupContent(b.nodename);break}var e=this.convertToLatLng(this,d.curposX,d.curposY),f="rgb(244, 20, 20)",g="rgb(244, 20, 20)";2==c&&(g=f="rgb(244, 20, 20)");h=d.alertcircle;if(void 0==h||null==h)h=L.circleMarker(e,{color:f,opacity:.2,fillColor:g,fillOpacity:.2,className:"geoData",radius:25}),h.type=
"circleMarker",e=this.getCurrentLayer("Tags",this.mMapLayerId),h.addTo(e),d.alertcircle=h,d.alertcount=50,b.setPopupContent(b.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),b.openPopup(),this.mMap.setView(b.getLatLng());break}}};Indoor2DMap.prototype.set_TagGPSDraw_Alert=function(a,c){for(var b=0;b<this.TagGPSDrawList.length;b++){var d=this.TagGPSDrawList[b];if(d.nodeid===a){b=this.getTargetNode(a);if(null==b){console.log("set_TagGPSDraw_Alert() nodeid:"+a+" TargetNode == null");break}if(b.maplayer!=
this.mMapLayerId){console.log("set_TagGPSDraw_Alert() "+a+" not in this map");break}0<d.alertcount&&d.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==c||0==this.NodeAlertFunction[a]){d.alertcount=0;var e=this.getCurrentLayer("Tags",this.mMapLayerId),h=d.alertcircle;void 0!=h&&null!=h&&(e.removeLayer(h),d.alertcircle=null,b.closePopup());b.setPopupContent(b.nodename);break}var e=g(d.curposLng,d.curposLat),f="rgb(244, 20, 20)",k="rgb(244, 20, 20)";
2==c&&(k=f="rgb(244, 20, 20)");h=d.alertcircle;if(void 0==h||null==h)h=L.circleMarker(e,{color:f,opacity:.2,fillColor:k,fillOpacity:.2,className:"geoData",radius:25}),h.type="circleMarker",e=this.getCurrentLayer("Tags",this.mMapLayerId),h.addTo(e),d.alertcircle=h,d.alertcount=50,console.log("set_TagGPSDraw_Alert()"+d.nodeid+" circle:"+h+" alertcount:"+d.alertcount+" alertType:"+c),b.bindPopup(a+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),b.openPopup(),this.mMap.setView(b.getLatLng());break}}};Indoor2DMap.prototype.getTargetNode=
function(a){for(var c=null,b=0;b<this.Tags.length&&(c=this.Tags[b],c.nodeid!==a);b++);return c};Indoor2DMap.prototype.getTargetLocatorNode=function(a){for(var c=null,b=0;b<this.Locators.length&&(c=this.Locators[b],c.nodeid!==a);b++);return c};Indoor2DMap.prototype.setTagLocation=function(a,c,b,d,e,h,f,g,k,l,p){for(d=0;d<this.Tags.length;d++){var n=this.Tags[d];if(n.nodeid===a){0!=c?0==n.alertcount&&(1==l?n.setIcon(t):n.setIcon(q)):(0<b.length&&(0==e?1==l?n.setIcon(t):n.setIcon(q):1==e?1==l?n.setIcon(K):
n.setIcon(J):2==e&&n.setIcon(M)),1==p?1==l?n.setIcon(F):n.setIcon(u):0==h||1==g?1==l?n.setIcon(O):n.setIcon(N):0<f.length&&!k?1==l?n.setIcon(Q):n.setIcon(P):1==l?n.setIcon(t):n.setIcon(q));break}}};Indoor2DMap.prototype.setTagLngLat=function(a,c,b,d,e){this.setMarkerVisible(this.Tags,a,!0);if(!(0>=c&&0>=b))for(var h=0;h<this.Tags.length;h++){var f=this.Tags[h];f.nodeid===a&&(f.setIcon(q),this.mEnableUISmoothing?this.push_to_GPSdrawlist(a,c,b,d,e):f.setLatLng(g(c,b)))}};Indoor2DMap.prototype.updateTagGPS=
function(a,c,b){for(var d=0;d<this.Tags.length;d++){var e=this.Tags[d];e.nodeid===a&&e.setLatLng(g(c,b))}};Indoor2DMap.prototype.setLocatorAlert=function(a,c,b,d){if(0<=c)for(var e=0;e<this.Locators.length;e++){var h=this.Locators[e];if(h.nodeid===a){if(h.maplayer!=this.mMapLayerId)break;0<h.alertcount&&h.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==c||0==this.NodeAlertFunction[a]){h.alertcount=0;1==d?h.setIcon(I):0<b?h.setIcon(y):
h.setIcon(H);a=this.getCurrentLayer("Locators",this.mMapLayerId);c=h.alertcircle;void 0!=c&&null!=c&&(a.removeLayer(c),h.alertcircle=null,h.closePopup());h.setPopupContent(h.nodename);break}a=this.convertToLatLng(this,h.posX,h.posY);d=b="rgb(244, 20, 20)";2==c&&(d=b="rgb(244, 20, 20)");c=h.alertcircle;if(void 0==c||null==c)c=L.circleMarker(a,{color:b,opacity:.2,fillColor:d,fillOpacity:.2,className:"geoData",radius:25}),c.type="circleMarker",a=this.getCurrentLayer("Locators",this.mMapLayerId),c.addTo(a),
h.alertcircle=c,h.alertcount=50,h.setPopupContent(h.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),h.openPopup(),this.mMap.setView(h.getLatLng());break}}};Indoor2DMap.prototype.setMarkerVisible=function(a,c,b){for(var d=!1,e=0;e<a.length;e++){var h=a[e];if(h.nodeid===c){d=b?this.showMarker(h):this.hideMarker(h);break}}return d};Indoor2DMap.prototype.hideMarker=function(a){var c=!1;null!=a._icon&&("hidden"!=a._icon.style.visibility&&(c=!0),a._icon.style.visibility="hidden");null!=a._shadow&&(a._shadow.style.visibility=
"hidden");a.closePopup();return c};Indoor2DMap.prototype.showMarker=function(a){var c=!1;null!=a._icon&&("visible"!=a._icon.style.visibility&&(c=!0),a._icon.style.visibility="visible");null!=a._shadow&&(a._shadow.style.visibility="visible");return c};Indoor2DMap.prototype.check_visible_state=function(a,c){for(var b=!1,d=0;d<a.length;d++){var e=a[d];if(e.nodeid===c){b=this.check_node_visible_state(e);break}}return b};Indoor2DMap.prototype.check_node_visible_state=function(a){var c=!1;null!=a._icon&&
"visible"==a._icon.style.visibility&&(c=!0);return c};Indoor2DMap.prototype.markclick=function(a,c){"anchor"===a?(this.Anchors[c].openPopup(),this.mMap.setView(this.Anchors[c].getLatLng()),$("#ProfileMarkerName").text(this.Anchors[c].nodename),$("#ProfileMarkerPosition").text("("+this.Anchors[c].posX+","+this.Anchors[c].posY+","+this.Anchors[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Anchors[c].date).local().format("MMM Do, hh:mm A"))):"tag"===a?(this.Tags[c].openPopup(),this.mMap.setView(this.Tags[c].getLatLng()),
$("#ProfileMarkerName").text(this.Tags[c].nodename),$("#ProfileMarkerPosition").text("("+this.Tags[c].posX+","+this.Tags[c].posY+","+this.Tags[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Tags[c].date).local().format("MMM Do, hh:mm A"))):"Origin"===a?null!=this.OriginMarker&&(this.OriginMarker.openPopup(),this.mMap.setView(this.OriginMarker.getLatLng()),$("#ProfileMarkerName").text(this.OriginMarker.nodename),$("#ProfileMarkerPosition").text("("+this.OriginMarker.posX+","+this.OriginMarker.posY+
","+this.OriginMarker.posZ+")"),$("#ProfileMarkerLocation").text(""),$("#ProfileMarkerUpdateTime").text("")):"coord"===a?(this.Coords[c].openPopup(),this.mMap.setView(this.Coords[c].getLatLng()),$("#ProfileMarkerName").text(this.Coords[c].nodename),$("#ProfileMarkerPosition").text("("+this.Coords[c].posX+","+this.Coords[c].posY+","+this.Coords[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Coords[c].date).local().format("MMM Do, hh:mm A"))):"locator"===a&&(this.Locators[c].openPopup(),
this.mMap.setView(this.Locators[c].getLatLng()),$("#ProfileMarkerName").text(this.Locators[c].nodename),$("#ProfileMarkerPosition").text("("+this.Locators[c].posX+","+this.Locators[c].posY+","+this.Locators[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Locators[c].date).local().format("MMM Do, hh:mm A")))};Indoor2DMap.prototype.UserMapEditControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var c=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");
c.style.backgroundColor="white";c.style.backgroundImage="url(/images/edit-icon.png)";c.style.backgroundSize="28px 28px";c.style.width="32px";c.style.height="32px";c.onclick=function(){a.orig_this.mEdit_mode?(a.removeControl(a.orig_this.mUsermapScaleUp),a.removeControl(a.orig_this.mUsermapScaleDown),a.removeControl(a.orig_this.mDrawControl),a.orig_this.mEdit_mode=!1,$("#areaname_edit").css("display","none"),a.orig_this.setMakerDragable(a.orig_this.mEdit_mode),"function"===typeof a.orig_this.mEditModeCallback&&
a.orig_this.mEditModeCallback(!1)):(a.addControl(a.orig_this.mUsermapScaleUp),a.addControl(a.orig_this.mUsermapScaleDown),a.orig_this.mDrawControl=a.orig_this.creat_drawControl(a.orig_this),a.addControl(a.orig_this.mDrawControl),a.orig_this.mEdit_mode=!0,a.orig_this.setMakerDragable(a.orig_this.mEdit_mode),"function"===typeof a.orig_this.mEditModeCallback&&a.orig_this.mEditModeCallback(!0))};return c}});Indoor2DMap.prototype.UserMapScaleUpControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var c=
L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");c.style.backgroundColor="white";c.style.backgroundImage="url(/images/maximize-25.png)";c.style.backgroundSize="28px 28px";c.style.width="32px";c.style.height="32px";c.style.backgroundRepeat="no-repeat";c.onclick=function(){a.orig_this.mMap_scale-=.01*a.orig_this.mMap_scale;a.orig_this.update_2d_map(a.orig_this);"function"===typeof a.orig_this.mUpdateMapInfoCallback&&a.orig_this.mUpdateMapInfoCallback(a.orig_this.mMapLayerId,
a.orig_this.mMap_scale,a.orig_this.mMap_coeff)};return c}});Indoor2DMap.prototype.UserMapScaleDownControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var c=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");c.style.backgroundColor="white";c.style.backgroundImage="url(/images/minimize-25.png)";c.style.backgroundSize="28px 28px";c.style.width="32px";c.style.height="32px";c.style.backgroundRepeat="no-repeat";c.onclick=function(){a.orig_this.mMap_scale+=
.01*a.orig_this.mMap_scale;a.orig_this.update_2d_map(a.orig_this);"function"===typeof a.orig_this.mUpdateMapInfoCallback&&a.orig_this.mUpdateMapInfoCallback(a.orig_this.mMapLayerId,a.orig_this.mMap_scale,a.orig_this.mMap_coeff)};return c}});Indoor2DMap.prototype.drawControl=new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,
weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:this.layer_areas}});Indoor2DMap.prototype.creat_drawControl=function(a){return new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:a.layer_areas}})};Indoor2DMap.prototype.setMakerDragable=
function(a){var c=this.getCurrentLayer("Origin",this.mMapLayerId);this.mMap.hasLayer(c)&&null!=this.OriginMarker&&null!=this.OriginMarker.dragging&&(a?this.OriginMarker.dragging.enable():this.OriginMarker.dragging.disable());c=this.getCurrentLayer("Anchors",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Anchors.length;c++){var b=this.Anchors[c];null!=b&&null!=b.dragging&&(a?b.dragging.enable():b.dragging.disable())}c=this.getCurrentLayer("Tags",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=
0;c<this.Tags.length;c++)b=this.Tags[c],null!=b&&null!=b.dragging&&(a?b.dragging.enable():b.dragging.disable());c=this.getCurrentLayer("Coordinators",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Coords.length;c++)coord_node=this.Coords[c],null!=coord_node&&null!=coord_node.dragging&&(a?coord_node.dragging.enable():coord_node.dragging.disable());c=this.getCurrentLayer("Locators",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Locators.length;c++)locator_node=this.Locators[c],
null!=locator_node&&null!=locator_node.dragging&&(a?locator_node.dragging.enable():locator_node.dragging.disable());c=this.getCurrentLayer("Sensors",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Sensors.length;c++)sensor_node=this.Sensors[c],null!=sensor_node&&null!=sensor_node.dragging&&(a?sensor_node.dragging.enable():sensor_node.dragging.disable());c=this.getCurrentLayer("Users",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Users.length;c++)user_node=this.Users[c],null!=
user_node&&null!=user_node.dragging&&(a?user_node.dragging.enable():user_node.dragging.disable())};Indoor2DMap.prototype.create_maparea_from_geoJSON=function(a,c,b){L.geoJson(b,{pointToLayer:function(a,b){},style:function(a){return a.properties.style},onEachFeature:function(a,b){var c='<label id="maparea_popup_'+a.properties.areaid+'">\u5340\u57df:'+a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;</label>",c=(new L.popup({minWidth:"16",closeButton:!0,closeOnClick:!0,maxWidth:"190"})).setContent(c);
b.bindPopup(c)}}).eachLayer(function(b){b.index=c;b.orig_this=a;b.on("click",a.mapAreaOnClick);a.MapAreas[c]=b;a.layer_areas.addLayer(b)})};Indoor2DMap.prototype.load_allmaparea=function(a){a.layer_areas.eachLayer(function(b){a.layer_areas.removeLayer(b)});var c=[];"function"===typeof get_maplayerarea&&get_maplayerarea(this.mMapLayerId,function(b){$.each(b,function(a,b){var d=JSON.parse(b);c[a]=d});b=0;for(var d in c){var e=c[d];"6"!==e.properties.areatype&&(a.create_maparea_from_geoJSON(a,b,e),b++)}for(d in c)e=
c[d],"6"===e.properties.areatype&&(a.create_maparea_from_geoJSON(a,b,e),b++)})};Indoor2DMap.prototype.load_maparea=function(){this.load_allmaparea(this)};Indoor2DMap.prototype.create_map_success=function(a,c,b){a.layer_areas.removeLayer(a.MapAreas[b]);a.create_map_area(a,c.geojson,b)};Indoor2DMap.prototype.create_map_action=function(a){a.on("draw:created",function(c){c=c.layer;c.options.fillColor=c.options.color;c.options.fillOpacity=c.options.opacity;c.options.color=a.orig_this.areaborder_color;
c.options.opacity=a.orig_this.areaborder_opacity;c.index=Object.keys(a.orig_this.MapAreas).length;c.orig_this=a.orig_this;c.on("click",a.orig_this.mapAreaOnClick);a.orig_this.layer_areas.addLayer(c);var b=c.toGeoJSON();b.properties.style={};b.properties.style.color=c.options.color;b.properties.style.opacity=c.options.opacity;b.properties.style.weight=c.options.weight;for(var d=b.properties.style,e="#",h=0;6>h;h++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];d.fillColor=e;b.properties.style.fillOpacity=
c.options.fillOpacity;b.properties.areaid="area"+getRandomInt(1E3,9999);b.properties.areaname="Area "+Object.keys(a.orig_this.MapAreas).length;a.orig_this.MapAreas[c.index]=c;d=JSON.stringify(b);create_maplayerarea(a.orig_this,a.orig_this.mMapLayerId,d,b.properties.areaid,b.properties.areaname,0,c.index,a.orig_this.create_map_success)});a.on("draw:edited",function(c){c.layers.eachLayer(function(b){b=b.toGeoJSON();var c=b.properties.areaid,d=JSON.stringify(b);update_maplayerarea_shape(a.orig_this.mMapLayerId,
c,d,b.properties.areaname)})});a.on("draw:deletestart",function(c){a.orig_this.mEdit_delete_mode=!0});a.on("draw:deletestop",function(c){a.orig_this.mEdit_delete_mode=!1});a.on("draw:deleted",function(c){c.layers.eachLayer(function(b){b=b.toGeoJSON().properties.areaid;a.orig_this.delete_map_area(a.orig_this,b)});a.orig_this.mEdit_delete_mode=!1});a.on("moveend",function(){})};Indoor2DMap.prototype.delete_map_area=function(a,c){delete_maplayerarea(a.mMapLayerId,c)};Indoor2DMap.prototype.create_map_area=
function(a,c,b){return L.geoJson(JSON.parse(c),{pointToLayer:function(a,b){},style:function(a){return a.properties.style},onEachFeature:function(a,b){b.bindPopup(a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;")}}).eachLayer(function(c){c.index=b;c.orig_this=a;c.on("click",a.mapAreaOnClick);a.MapAreas[b]=c;a.layer_areas.addLayer(c)})};Indoor2DMap.prototype.areacolorOnInput=function(){var a=$("#areacolor_input").val();if("#"!=a.charAt(0))console.log("areacolorOnInput() not valid color!");
else if(9!=a.length)console.log("areacolorOnInput() not valid color string length! need 9, get "+a.length);else{var c=a.substring(0,7),a="0x"+a.substring(7,9),a=parseInt(a),a=parseFloat(a)/255;$("#areaname_color").minicolors("value",c);$("#areaname_color").minicolors("opacity",a)}};Indoor2DMap.prototype.toggle_map_area_editor=function(a,c){this.mEdit_maparea_index=c;$("#areaname_input").val(a.properties.areaname);$("#area_type_show").html(convert_area_type_name(a.properties.areatype));$("#area_type_show").attr("data-id",
a.properties.areatype);$("#areaname_color").minicolors("value",a.properties.style.fillColor);$("#areaname_color").minicolors("opacity",a.properties.style.fillOpacity);var b=parseInt(255*a.properties.style.fillOpacity).toString(16);$("#areacolor_input").val(a.properties.style.fillColor+b);document.getElementById("areacolor_input").addEventListener("input",this.areacolorOnInput);$("#areaname_edit").css("display","block")};Indoor2DMap.prototype.areaname_save=function(a){var c=$("#areaname_color").minicolors("value"),
b=$("#areaname_color").minicolors("opacity"),d=$("#areaname_input").val(),e=$("#area_type_show").attr("data-id"),h=a.MapAreas[a.mEdit_maparea_index];h.setStyle({color:a.areaborder_color,opacity:a.areaborder_opacity,fillColor:c,fillOpacity:b});h.bindPopup(d+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");$("#areaname_edit").css("display","none");h=h.toGeoJSON();h.properties.areaname=d;h.properties.areatype=e;h.properties.style.color=a.areaborder_color;h.properties.style.opacity=a.areaborder_opacity;h.properties.style.fillColor=
c;h.properties.style.fillOpacity=b;c=h.properties.areaid;b=JSON.stringify(h);update_maplayerarea(a.mMapLayerId,c,b,d,e)};Indoor2DMap.prototype.push_to_drawlist=function(a,c,b,d,e,h,f,g,k){for(var l=!1,p=0;p<this.TagDrawList.length;p++){var n=this.TagDrawList[p];n.nodeid===c&&(0==n.preposX&&0==n.preposY&&0==n.preposZ?(n.totalposX=parseInt(d),n.totalposY=parseInt(e),n.totalposZ=parseInt(h),n.count=1):(n.totalposX+=parseInt(d),n.totalposY+=parseInt(e),n.totalposZ+=parseInt(h),n.count++),n.buildingid=
f,n.floor=g,n.date=k,n.hide=!1,l=!0)}0==l&&(l={},l.nodeid=c,l.macaddress=a,l.nodename=b,l.date=k,this.reset_draw_node(l,d,e,h,f,g),this.TagDrawList.push(l))};Indoor2DMap.prototype.hide_2d_drawlist=function(a){for(var c=0;c<this.TagDrawList.length;c++){var b=this.TagDrawList[c];if(b.nodeid===a){b.hide=!0;break}}};Indoor2DMap.prototype.hide_2d_drawGPSlist=function(a){for(var c=0;c<this.TagGPSDrawList.length;c++){var b=this.TagGPSDrawList[c];if(b.nodeid===a){b.hide=!0;break}}};Indoor2DMap.prototype.reset_node=
function(a,c,b,d,e,h){for(var f=0;f<this.TagDrawList.length;f++){var g=this.TagDrawList[f];if(g.nodeid===a){this.reset_draw_node(g,c,b,d,e,h);break}}};Indoor2DMap.prototype.reset_draw_node=function(a,c,b,d,e,h){a.buildingid=e;a.floor=h;a.count=0;a.totalposX=0;a.totalposY=0;a.totalposZ=0;a.preAveragePosX=parseInt(c);a.preAveragePosY=parseInt(b);a.preAveragePosZ=parseInt(d);a.preposX=parseInt(c);a.preposY=parseInt(b);a.preposZ=parseInt(d);a.curposX=parseInt(c);a.curposY=parseInt(b);a.curposZ=parseInt(d);
a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_X=parseInt(c);a.move_no_block_old_X=parseInt(c);a.move_moving_X=parseInt(c);a.move_moving_old_X=parseInt(c);a.move_no_block_Y=parseInt(b);a.move_no_block_old_Y=parseInt(b);a.move_moving_Y=parseInt(b);a.move_moving_old_Y=parseInt(b);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1;a.hide=!1};Indoor2DMap.prototype.push_to_GPSdrawlist=function(a,c,b,d,e){for(var h=!1,f=0;f<this.TagGPSDrawList.length;f++){var g=this.TagGPSDrawList[f];
g.nodeid===a&&(0==g.preposLng&&0==g.preposLat?(g.totalposLng=parseFloat(c),g.totalposLat=parseFloat(b),g.count=1):(g.totalposLng+=parseFloat(c),g.totalposLat+=parseFloat(b),g.count++),g.hide=!1,h=!0)}0==h&&(h={},h.nodeid=a,this.reset_GPSdraw_node(h,c,b,d,e),this.TagGPSDrawList.push(h))};Indoor2DMap.prototype.reset_GPSdraw_node=function(a,c,b,d,e){a.buildingid=d;a.floor=e;a.count=0;a.totalposLng=0;a.totalposLat=0;a.preAveragePosLng=parseFloat(c);a.preAveragePosLat=parseFloat(b);a.preposLng=parseFloat(c);
a.preposLat=parseFloat(b);a.curposLng=parseFloat(c);a.curposLat=parseFloat(b);a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_Lng=parseFloat(c);a.move_no_block_old_Lng=parseFloat(c);a.move_moving_Lng=parseFloat(c);a.move_moving_old_Lng=parseFloat(c);a.move_no_block_Lat=parseFloat(b);a.move_no_block_old_Lat=parseFloat(b);a.move_moving_Lat=parseFloat(b);a.move_moving_old_Lat=parseFloat(b);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1};Indoor2DMap.prototype.draw_tag_smooth_move=
function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_smooth_move,1E3,a);else{for(var c=0;c<a.TagDrawList.length;c++){var b=a.TagDrawList[c];if(1!=b.hide){var d=b.curposX-b.preposX,e=b.curposY-b.preposY,h=b.curposZ-b.preposZ,f;5<=Math.sqrt(d*d+e*e+h*h)||10<b.not_move_count?(f=b.draw_loop_index+1,d/=a.move_step_size,e/=a.move_step_size,h/=a.move_step_size,f>=a.move_step_size&&(f=a.move_step_size),d=parseInt(d*f),e=parseInt(e*f),h=parseInt(h*f),b.not_move_count=0,10>a.move_loop_count||(f=b.preposX+d,d=
b.preposY+e,h=b.preposZ+h,a.updateMarker(a.Tags,b.macaddress,b.nodeid,b.nodename,f,d,h,b.buildingid,b.floor,b.date,!0,!0))):b.not_move_count++;b.draw_loop_index++;if(b.draw_loop_index>=a.move_step_size){if(0<b.count){f=parseInt(b.totalposX/b.count);h=parseInt(b.totalposY/b.count);d=parseInt(b.totalposZ/b.count);r=1;b.move_moving_X=parseInt(r*(f-b.move_no_block_old_X));b.move_no_block_X=b.move_moving_X+b.move_no_block_old_X;b.move_moving_old_X=b.move_moving_X;b.move_moving_Y=parseInt(r*(h-b.move_no_block_old_Y));
b.move_no_block_Y=b.move_moving_Y+b.move_no_block_old_Y;b.move_moving_old_Y=b.move_moving_Y;b.move_status+=1;if(6<b.move_status||0>b.move_moving_X*b.move_moving_old_X)b.move_status=1;b.move_no_block_old_X=b.move_no_block_X;b.move_no_block_old_Y=b.move_no_block_Y;b.preposX=b.curposX;b.preposY=b.curposY;b.preposZ=b.curposZ;b.curposX=b.move_no_block_X;b.curposY=b.move_no_block_Y;b.curposZ=d;b.preAveragePosX=parseInt(b.totalposX/b.count);b.preAveragePosY=parseInt(b.totalposY/b.count);b.preAveragePosZ=
parseInt(b.totalposZ/b.count);b.totalposX=0;b.totalposY=0;b.totalposZ=0;b.count=0;b.draw_loop_index=0}b.draw_loop_index>2*a.move_step_size&&(b.preposX=b.curposX,b.preposY=b.curposY,b.preposZ=b.curposZ,b.draw_loop_index=0)}}}a.move_loop_count++;1E4<=a.move_loop_count&&(a.move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_smooth_move,a.smoothing_time/a.move_step_size,a)}};Indoor2DMap.prototype.draw_tag_GPS_smooth_move=function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_GPS_smooth_move,1E3,
a);else{for(var c=0;c<a.TagGPSDrawList.length;c++){var b=a.TagGPSDrawList[c];if(1!=b.hide){var d=b.curposLng-b.preposLng,e=b.curposLat-b.preposLat,f;10<b.not_move_count?(f=b.draw_loop_index+1,d/=a.GPS_move_step_size,e/=a.GPS_move_step_size,f>=a.GPS_move_step_size&&(f=a.GPS_move_step_size),d=parseFloat(d*f),e=parseFloat(e*f),b.not_move_count=0,10>a.GPS_move_loop_count||(f=b.preposLng+d,e=b.preposLat+e,a.updateTagGPS(b.nodeid,f,e))):b.not_move_count++;b.draw_loop_index++;if(b.draw_loop_index>=a.GPS_move_step_size){if(0<
b.count){f=parseFloat(b.totalposLng/b.count);e=parseFloat(b.totalposLat/b.count);d=.1;switch(b.move_status){case 1:case 2:d=.1;break;case 3:case 4:case 5:case 6:d=.8}a.GPS_smoothing_time=.1==d?200:.4==d?400:800;b.move_moving_Lng=parseFloat(d*(f-b.move_no_block_old_Lng));b.move_no_block_Lng=b.move_moving_Lng+b.move_no_block_old_Lng;b.move_moving_old_Lng=b.move_moving_Lng;b.move_moving_Lat=parseFloat(d*(e-b.move_no_block_old_Lat));b.move_no_block_Lat=b.move_moving_Lat+b.move_no_block_old_Lat;b.move_moving_old_Lat=
b.move_moving_Lat;b.move_status+=1;if(6<b.move_status||0>b.move_moving_Lng*b.move_moving_old_Lng)b.move_status=1;b.move_no_block_old_Lng=b.move_no_block_Lng;b.move_no_block_old_Lat=b.move_no_block_Lat;b.preposLng=b.curposLng;b.preposLat=b.curposLat;b.curposLng=b.move_no_block_Lng;b.curposLat=b.move_no_block_Lat;b.preAveragePosX=parseFloat(b.totalposLng/b.count);b.preAveragePosY=parseFloat(b.totalposLat/b.count);b.totalposLng=0;b.totalposLat=0;b.count=0;b.draw_loop_index=0}b.draw_loop_index>2*a.GPS_move_step_size&&
(b.preposLng=b.curposLng,b.preposLat=b.curposLat,b.draw_loop_index=0)}}}a.GPS_move_loop_count++;1E4<=a.GPS_move_loop_count&&(a.GPS_move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_GPS_smooth_move,a.GPS_smoothing_time/a.GPS_move_step_size,a)}};Indoor2DMap.prototype.update_alert_circle=function(a){a.update_tag_alert_circle();a.update_tag_GPS_alert_circle();a.update_locator_alert_circle();setTimeout(a.update_alert_circle,100,a)};Indoor2DMap.prototype.update_tag_alert_circle=function(){for(var a=
0;a<this.TagDrawList.length;a++){var c=this.TagDrawList[a];if(1!=c.hide){var b=c.alertcircle;if(void 0!=b&&null!=b){var d=b.options.opacity,e=d,f=b.options.radius,g=f;.2==d?5<f?g=f-5:e=.3:20<f?e=.2:g=f+5;d=this.getTargetNode(c.nodeid);b.setStyle({radius:g,opacity:e});b.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[c.nodeid]&&(this.AlertIconScaleIndexList[c.nodeid]=0);b=this.AlertIconScaleIndexList[c.nodeid];0==this.NodeAlertFunction[c.nodeid]?d.setIcon(this.AlertIconScaleUpDownList[0]):
d.setIcon(this.AlertIconScaleUpDownList[b]);b++;10<=b&&(b=0);this.AlertIconScaleIndexList[c.nodeid]=b}}}};Indoor2DMap.prototype.update_tag_GPS_alert_circle=function(){for(var a=0;a<this.TagGPSDrawList.length;a++){var c=this.TagGPSDrawList[a];if(1!=c.hide){var b=c.alertcircle;if(void 0!=b&&null!=b){var d=b.options.opacity,e=d,f=b.options.radius,g=f;.2==d?5<f?g=f-5:e=.3:20<f?e=.2:g=f+5;d=this.getTargetNode(c.nodeid);b.setStyle({radius:g,opacity:e});b.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[c.nodeid]&&
(this.AlertIconScaleIndexList[c.nodeid]=0);b=this.AlertIconScaleIndexList[c.nodeid];d.setIcon(this.AlertIconScaleUpDownList[b]);b++;10<=b&&(b=0);this.AlertIconScaleIndexList[c.nodeid]=b}}}};Indoor2DMap.prototype.update_locator_alert_circle=function(){for(var a=0;a<this.Locators.length;a++){var c=this.Locators[a],b=c.alertcircle;if(void 0!=b&&null!=b){var d=b.options.opacity,e=d,f=b.options.radius,g=f;.2==d?5<f?g=f-5:e=.3:20<f?e=.2:g=f+5;d=this.getTargetLocatorNode(c.nodeid);b.setStyle({radius:g,opacity:e});
b.setLatLng(c.getLatLng());void 0==this.AlertIconScaleIndexList[c.nodeid]&&(this.AlertIconScaleIndexList[c.nodeid]=0);b=this.AlertIconScaleIndexList[c.nodeid];d.setIcon(this.AlertIconScaleUpDownList[b]);b++;10<=b&&(b=0);this.AlertIconScaleIndexList[c.nodeid]=b}}};Indoor2DMap.prototype.convertToLatLng=function(a,c,b){var d=FloatDiv(parseFloat(b),11057400);FloatMul(d,11057400);b=a.mWGS48OriginY+FloatDiv(parseFloat(b),11057400);c=a.mWGS48OriginX+e(b,parseFloat(c));return a.mRotateMap?a.rotateLatLng(b,
c):g(c,b)};Indoor2DMap.prototype.rotateLatLng=function(a,c){var b=new L.latLng(a,c),d=new L.latLng(this.mWGS48OriginY,this.mWGS48OriginX);return rotatePoint(b,this.mMAP_North,d)};this.mMap.on("overlayadd",this.onOverlayAdd);this.mMap.on("overlayremove ",this.onOverlayRemove);this.create_alert_scale_icon();this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,2E3,this),setTimeout(this.draw_tag_GPS_smooth_move,2E3,this));setTimeout(this.update_alert_circle,2E3,this)};
$(document).ready(function(){$(".colorpicker").each(function(){$(this).minicolors({changeDelay:200,format:"hex",position:"bottom left",theme:"bootstrap",opacity:$(this).attr("data-opacity"),change:function(d,e){console.log("change() fillColorhex:"+d+", opacity:"+e);var f=parseInt(255*e).toString(16);$("#areacolor_input").val(d+f)},theme:"default"})})});var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glLiveMap,glFireFightingList=[],glNFCdevices=[],glAoAdevices=[],glAllUsers=[],glCaseUsers=[];check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,create_map(),CurrentLoadIndex+=1);break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_user_info());break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_cases());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_NFCdevices());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),
PreLoadIndex=CurrentLoadIndex,load_AoAdevices());break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function create_map(){glLiveMap=new Indoor2DMap("mapid");glLiveMap.setMapCoeff(0,0,10240,10240,5,1E5,121.51,25.04,0);glLiveMap.setMapImage("/images/empty.png","Indoor 2D Map");glLiveMap.setMapLayerInfo(1);glLiveMap.showGoolgeMap();glLiveMap.showOriginLayer()}
function load_cases(){glFireFightingList=[];$.getJSON(gl_target_server+"/php/firefighting.php","loadfirefightingcases=1&closed=1&project_id="+project_id,function(d){$.each(d,function(d,f){glFireFightingList.push(f)})}).complete(function(){CurrentLoadIndex+=1})}
function load_user_info(){glAllUsers=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loaduserbaseinfo=1&project_id="+project_id,function(d){$.each(d,function(d,f){glAllUsers.push(f)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_NFCdevices(){$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&s=0&count=100&project_id="+project_id+"&showonline=1&showoffline=1",function(d){$.each(d,function(d,f){glNFCdevices.push(f)})}).success(function(){}).error(function(){}).complete(function(){CurrentLoadIndex+=1})}
function load_AoAdevices(){glAoAdevices=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadaoa=1&project_id="+project_id,function(d){for(var e=parseInt(d.LOC_AOA_NUM),f=0;f<e;++f){var g="LOC_AOA_INDEX_"+f;if(void 0!=d[g]&&null!=d[g]){var g=d[g].split(","),k=g[1],l=g[5],q=g[6],t=g[7],u={};u.id=g[0];u.name=k;u.posX=l;u.posY=q;u.posZ=t;u.type="aoadevice";glAoAdevices.push(u)}}}).success(function(){}).error(function(){}).complete(function(){CurrentLoadIndex+=1})}
function manual_search_text_onfocus(d){d=document.getElementById("manual_search_text").value;add_search_result_to_table(d)}function manual_search_text_change(d){d=document.getElementById("manual_search_text").value;add_search_result_to_table(d)}var $source=document.querySelector("#manual_search_text");$source.addEventListener("input",manual_search_text_change);
function add_search_result_to_table(d){for(var e=document.getElementById("dropdown_searchresult");e.hasChildNodes();)e.removeChild(e.firstChild);d=d.toLowerCase();for(var f=0,g=0;g<glFireFightingList.length;g++){var k=glFireFightingList[g];if(!(0>(""+k.casenumber).indexOf(d))){var l=document.createElement("li"),q=document.createElement("a");q.setAttribute("class","small");q.setAttribute("tabIndex","-1");q.setAttribute("data-value",k.casenumber);q.setAttribute("href","javascript:;");q.setAttribute("onclick",
'searchresult_click("'+k.casenumber+'");return true;');q.appendChild(document.createTextNode(" "+k.casenumber));l.appendChild(q);e.appendChild(l);f+=1}}0<f&&$("#dropdown_searchresult").is(":hidden")&&$("#dropdown_searchresult").toggle()}function searchresult_click(d){console.log("searchresult_click() id:"+d);$("#dropdown_searchresult").toggle();update_FireFighting_info(d);update_cases_users(d);update_cases_events(d)}
function update_FireFighting_info(d){for(var e=document.getElementById("record_address"),f=document.getElementById("record_starttime"),g=document.getElementById("record_closetime"),k=document.getElementById("record_StandbyDeviceIds"),l=document.getElementById("record_NFCDeviceIds");k.hasChildNodes();)k.removeChild(k.firstChild);for(;l.hasChildNodes();)l.removeChild(l.firstChild);for(var q=0;q<glFireFightingList.length;q++){var t=glFireFightingList[q];if(t.casenumber===d){e.innerHTML=t.address;f.innerHTML=
t.starttime;g.innerHTML=t.closetime;k.appendChild(create_StandbyDeviceList(t.StandbyDeviceIds));l.appendChild(create_NFCList(t.NFCDeviceIds));break}}}function update_cases_users(d){var e=[];$.getJSON(gl_target_server+"/php/firefighting.php","loadfirefightingusers=1&casenumber="+d+"&project_id="+project_id,function(d){$.each(d,function(d,f){e.push(f)})}).complete(function(){update_cases_users_info(e)})}
function update_cases_events(d){var e=[];$.getJSON(gl_target_server+"/php/firefighting.php","loadfirefightingevent=1&casenumber="+d+"&project_id="+project_id,function(d){$.each(d,function(d,f){e.push(f)})}).complete(function(){update_cases_events_info(e)})}
function create_StandbyDeviceList(d){var e=document.createElement("div");if(void 0==d)return e;d=d.split(",");for(var f=0;f<d.length;++f){for(var g=d[f],k=0;k<glAoAdevices.length;++k){var l=glAoAdevices[k];if(l.id===g){k=document.createElement("span");k.textContent=l.name;k.setAttribute("class","badge bg-green");e.appendChild(k);break}}for(k=0;k<glNFCdevices.length;++k)if(l=glNFCdevices[k],""+l.deviceid===g){g=document.createElement("span");g.textContent=l.name;g.setAttribute("class","badge bg-yellow");
e.appendChild(g);break}}return e}function create_NFCList(d){var e=document.createElement("div");d=d.split(",");for(var f=0;f<d.length;++f)for(var g=d[f],k=0;k<glNFCdevices.length;++k){var l=glNFCdevices[k];if(l.deviceid===g){g=document.createElement("span");g.textContent=l.name;g.setAttribute("class","badge bg-yellow");e.appendChild(g);break}}return e}
function update_cases_users_info(d){for(var e=document.getElementById("record_Users");e.hasChildNodes();)e.removeChild(e.firstChild);for(var f=0;f<d.length;f++){var g=getUserName(d[f].userid),k=document.createElement("span");k.setAttribute("class","badge bg-blue-active");k.setAttribute("style","font-size:18px; font-weight:bold; color:#330033; margin-top:2px; margin-right:2px;");k.textContent=g;e.appendChild(k)}}
function update_cases_events_info(d){for(var e=document.getElementById("record_events");e.hasChildNodes();)e.removeChild(e.firstChild);for(var f=0;f<d.length;f++){var g=d[f],k=document.createElement("tr"),l=document.createElement("td");k.appendChild(l);var q=document.createElement("div");q.textContent=g.datetime;l.appendChild(q);l=document.createElement("td");k.appendChild(l);q=document.createElement("div");q.textContent=g.eventtype;l.appendChild(q);l=document.createElement("td");k.appendChild(l);
l.appendChild(convertEventData(g.eventtype,g.json));e.appendChild(k)}}function convertEventData(d,e){if("FireFightingInfo"===d)return convertEventData_FireFightingInfo(e);if("FireFightingUser"===d)return convertEventData_FireFightingUser(e);if("FireFightingAirUsing"===d)return convertEventData_FireFightingAirUsing(e);if("UserFireFightingAirUsing"===d)return convertEventData_UserFireFightingAirUsing(e)}
function convertEventData_FireFightingInfo(d){var e=document.createElement("div");e.appendChild(create_two_col_block("\u6848\u4ef6\u72c0\u614b",document.createTextNode(getCaseStatus(d.caseclosed))));e.appendChild(create_two_col_block("\u706b\u5834\u8a18\u9304\u958b\u59cb\u6642\u9593",document.createTextNode(d.starttime)));e.appendChild(create_two_col_block("\u706b\u5834\u8a18\u9304\u7d50\u675f\u6642\u9593",document.createTextNode(d.closetime)));e.appendChild(create_two_col_block("\u5f85\u547d\u5340\u5b9a\u4f4d\u5668",
create_StandbyDeviceList(d.StandbyDeviceIds)));e.appendChild(create_two_col_block("\u9032\u5165\u7ba1\u5236\u5668",create_NFCList(d.NFCDeviceIds)));return e}
function convertEventData_FireFightingUser(d){var e=document.createElement("div");e.appendChild(create_two_col_block("\u4eba\u54e1",document.createTextNode(getUserName(d.userid))));e.appendChild(create_two_col_block("\u5340\u57df\u578b\u614b",document.createTextNode(getAreaName(d.areaType))));e.appendChild(create_two_col_block("\u6c23\u74f6\u5269\u9918\u91cf",document.createTextNode(d.airremain)));e.appendChild(create_two_col_block("\u9032\u5165\u6642\u9593",document.createTextNode(d.enterTime)));
e.appendChild(create_two_col_block("\u6d3b\u52d5\u72c0\u614b",document.createTextNode(d.activity)));e.appendChild(create_two_col_block("\u5fc3\u7387",document.createTextNode(d.HR)));e.appendChild(create_two_col_block("\u8840\u6c27",document.createTextNode(d.SPO2)));e.appendChild(create_two_col_block("\u96fb\u91cf",document.createTextNode(d.battery)));return e}
function convertEventData_FireFightingAirUsing(d){var e=document.createElement("div");e.appendChild(create_two_col_block("\u4eba\u54e1",document.createTextNode(getUserName(d.userid))));e.appendChild(create_two_col_block("\u958b\u59cb\u6c23\u74f6\u5269\u9918\u91cf",document.createTextNode(d.startairremain)));e.appendChild(create_two_col_block("\u958b\u59cb\u6642\u9593",document.createTextNode(d.airremain)));e.appendChild(create_two_col_block("\u7d50\u675f\u6c23\u74f6\u5269\u9918\u91cf",document.createTextNode(d.endairremain)));
e.appendChild(create_two_col_block("\u7d50\u675f\u6642\u9593",document.createTextNode(d.starttime)));e.appendChild(create_two_col_block("\u6c23\u74f6\u6d88\u8017",document.createTextNode(d.airusing)));e.appendChild(create_two_col_block("\u4f7f\u7528\u6642\u9593",document.createTextNode(d.totaltime)));return e}
function convertEventData_UserFireFightingAirUsing(d){var e=document.createElement("div");e.appendChild(create_two_col_block("\u4eba\u54e1",document.createTextNode(getUserName(d.userid))));e.appendChild(create_two_col_block("\u6c23\u74f6\u5269\u9918\u91cf",document.createTextNode(d.airremain)));return e}
function create_two_col_block(d,e){var f=document.createElement("div");f.setAttribute("class","input-group");var g=document.createElement("span");g.setAttribute("class","input-group-addon");g.setAttribute("style","font-size:12px; font-weight:bold; color:#330033; width:150px;");g.textContent=d;f.appendChild(g);g=document.createElement("span");g.setAttribute("class","input-group-addon");g.setAttribute("style","font-size:12px; font-weight:bold; color:#003333; background-color:#eeeeee; width:150px;");
g.appendChild(e);f.appendChild(g);return f}function getAreaName(d){return"0"==d?"\u706b\u5834":"1"==d?"\u5f85\u547d\u71b1\u5340":"\u4e00\u822c\u5f85\u547d\u5340"}function getCaseStatus(d){return"1"==d?"\u7d50\u675f":"\u5c1a\u672a\u7d50\u675f"}function getUserName(d){parseInt(d);for(var e=0;e<glAllUsers.length;++e){var f=glAllUsers[e];if(parseInt(f.userid)==d)return f.name}return d}
function checkExceedTime(d){var e=moment(d,"HH:mm:ss");d=e.hour();var f=e.minutes();e.seconds();e=!1;0<d?e=!0:20<=f&&(e=!0);return e}function getDiffTime(d){d=moment(d,"YYYY-MM-DD HH:mm:ss");var e=moment().utcOffset("+08:00");return moment(e-d).utc()}function convertToStayTime(d){d=moment(d,"YYYY-MM-DD HH:mm:ss");var e=moment();d=moment(e-d).utc();return convertPrettyTime(d)}function convertFormatTime(d){return moment.utc(1E3*d).format("HH:mm:ss")}
function convertPrettyTime(d){var e=moment(d,"HH:mm:ss");d=e.hour();var f=e.minutes(),e=e.seconds(),g="";0<d&&(g+=d+"\u5c0f\u6642");0<f&&(g+=f+"\u5206");0<e&&(g+=e+"\u79d2");return g}function getRandomInt(d,e){return Math.floor(Math.random()*(e-d+1))+d}function FloatAdd(d,e){var f,g;try{f=d.toString().split(".")[1].length}catch(k){f=0}try{g=e.toString().split(".")[1].length}catch(k){g=0}f=Math.pow(10,Math.max(f,g));return(FloatMul(d,f)+FloatMul(e,f))/f}
function FloatSubtraction(d,e){var f,g,k;try{f=d.toString().split(".")[1].length}catch(l){f=0}try{g=e.toString().split(".")[1].length}catch(l){g=0}k=Math.pow(10,Math.max(f,g));return((d*k-e*k)/k).toFixed(f>=g?f:g)}function FloatMul(d,e){var f=0,g=d.toString(),k=e.toString();try{f+=g.split(".")[1].length}catch(l){}try{f+=k.split(".")[1].length}catch(l){}return Number(g.replace(".",""))*Number(k.replace(".",""))/Math.pow(10,f)}
function FloatDiv(d,e){var f=0,g=0,k,l;try{f=d.toString().split(".")[1].length}catch(q){}try{g=e.toString().split(".")[1].length}catch(q){}k=Number(d.toString().replace(".",""));l=Number(e.toString().replace(".",""));return k/l*Math.pow(10,g-f)}function rotatePoint(d,e,f){e=e*Math.PI/180;return new L.latLng(Math.sin(e)*(d.lng-f.lng)+Math.cos(e)*(d.lat-f.lat)+f.lat,Math.cos(e)*(d.lng-f.lng)-Math.sin(e)*(d.lat-f.lat)+f.lng)}
function open_firefighting_history_page(){window.open("/index.php/vilsfirefightinghistory/"+project_id,"_blank").focus()};
