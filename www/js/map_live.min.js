var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,d,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[d]=b.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var d=0;return $jscomp.iteratorPrototype(function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var b=0,c={next:function(){if(b<a.length){var e=b++;return{value:d(e,a[e]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(a,d,b,c){if(d){b=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in b||(b[e]={});b=b[e]}a=a[a.length-1];c=b[a];d=d(c);d!=c&&null!=d&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:d})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6-impl","es3");
L.ImageOverlay.Rotated=L.ImageOverlay.extend({initialize:function(a,d,b,c,e){"string"===typeof a?this._url=a:this._rawImage=a;this._topLeft=L.latLng(d);this._topRight=L.latLng(b);this._bottomLeft=L.latLng(c);L.setOptions(this,e)},onAdd:function(a){this._image||(this._initImage(),1>this.options.opacity&&this._updateOpacity());this.options.interactive&&(L.DomUtil.addClass(this._rawImage,"leaflet-interactive"),this.addInteractiveTarget(this._rawImage));a.on("zoomend resetview",this._reset,this);this.getPane().appendChild(this._image);
this._reset()},onRemove:function(a){a.off("zoomend resetview",this._reset,this);L.ImageOverlay.prototype.onRemove.call(this,a)},_initImage:function(){var a=this._rawImage;this._url&&(a=L.DomUtil.create("img"),a.style.display="none",this.options.crossOrigin&&(a.crossOrigin=""),a.src=this._url,this._rawImage=a);L.DomUtil.addClass(a,"leaflet-image-layer");var d=this._image=L.DomUtil.create("div","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));this._updateZIndex();d.appendChild(a);
d.onselectstart=L.Util.falseFn;d.onmousemove=L.Util.falseFn;a.onload=function(){this._reset();a.style.display="block";this.fire("load")}.bind(this);a.alt=this.options.alt},_reset:function(){var a=this._image;if(void 0!=this._map){var d=this._map.latLngToLayerPoint(this._topLeft),b=this._map.latLngToLayerPoint(this._topRight),c=this._map.latLngToLayerPoint(this._bottomLeft),e=b.subtract(d).add(c),f=L.bounds([d,b,c,e]),k=f.getSize(),e=d.subtract(f.min),n=b.subtract(d),m=c.subtract(d),n=Math.atan2(n.y,
n.x),m=Math.atan2(m.x,m.y);this._bounds=L.latLngBounds(this._map.layerPointToLatLng(f.min),this._map.layerPointToLatLng(f.max));L.DomUtil.setPosition(a,f.min);a.style.width=k.x+"px";a.style.height=k.y+"px";f=this._rawImage.width;a=this._rawImage.height;f&&a&&(b=d.distanceTo(b)/f*Math.cos(n),d=d.distanceTo(c)/a*Math.cos(m),this._rawImage.style.transformOrigin="0 0",this._rawImage.style.transform="translate("+e.x+"px, "+e.y+"px)skew("+m+"rad, "+n+"rad) scale("+b+", "+d+") ")}},reposition:function(a,
d,b){this._topLeft=L.latLng(a);this._topRight=L.latLng(d);this._bottomLeft=L.latLng(b);this._reset()},setUrl:function(a){this._url=a;this._rawImage&&(this._rawImage.src=a);return this}});L.imageOverlay.rotated=function(a,d,b,c,e){return new L.ImageOverlay.Rotated(a,d,b,c,e)};var upload_img_width=0,upload_img_height=0,_URL=window.URL||window.webkitURL;function get_maplayerarea(a,d){$.getJSON(gl_target_server+"/php/map.php","loadmaplayerarea=1&project_id="+project_id+"&maplayerid="+a,function(a){d(a)})}
function update_orig_node_info(a,d,b){var c={};c.project_id=""+project_id;c.updateorig="1";c.maplayerid=a;c.POSX=""+d;c.POSY=""+b;jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",data:c,dataType:"json",success:function(a){},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}});return!1}
function update_map_info(a,d,b){var c={};c.project_id=""+project_id;c.updatemap="1";c.maplayerid=a;c.SCALE=""+d;c.COEFF=""+b;jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",data:c,dataType:"json",success:function(a){},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}});return!1}
function update_map_node_info(a,d,b,c,e,f,k,n,m){var l={};l.project_id=""+project_id;l.EDIT_NODE=1;l.maplayerid=a;l.TYPE=d;l.MAC=b;l.NODEID=c;l.POSX=e;l.POSY=f;l.POSZ=k;l.LAT=n;l.LNG=m;Node_Updateing=!0;jQuery.ajax({url:gl_target_server+"/php/vilsnodes.php",type:"POST",data:l,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a))},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}}).complete(function(){Node_Updateing=!1});return!1}
function update_maplayer_info(a,d,b){var c={};c.project_id=""+project_id;c.updatemaplayerinfo="1";c.maplayerid=a;c.data_key=d;c.data_value=b;jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",data:c,dataType:"json",success:function(a){},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}});return!1}
function create_maplayer(a,d,b){var c={};c.project_id=""+project_id;c.createmaplayer=1;c.layer_name=a;return jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",data:c,success:function(a){d(b)},error:function(a,b,c){alert(c);alert(a.responseText)}})}
function delete_maplayer(a,d){var b={};b.project_id=""+project_id;b.deletemaplayer=1;b.maplayerid=a;return jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",data:b,success:function(a){d()},error:function(a,b,d){alert(d);alert(a.responseText)}})}
function create_maplayerarea(a,d,b,c,e,f,k,n){var m={};m.project_id=""+project_id;m.createmaplayerarea=1;m.maplayerid=d;m.geojson=b;m.areaid=c;m.areaname=e;m.type=f;return jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",data:m,success:function(b){n(a,b,k)},error:function(a,b,c){alert(c);alert(a.responseText)}})}
function update_maplayerarea_shape(a,d,b,c){var e={};e.project_id=""+project_id;e.updatemaplayerarea=1;e.maplayerid=a;e.geojson=b;e.areaid=d;e.areaname=c;return jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",dataType:"json",data:e,success:function(a){},error:function(a,b,c){alert("error="+c+",responseText="+a.responseText)}})}
function update_maplayerarea(a,d,b,c,e){var f={};f.project_id=""+project_id;f.updatemaplayerarea=1;f.maplayerid=a;f.geojson=b;f.areaid=d;f.areaname=c;f.type=e;return jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",dataType:"json",data:f,success:function(a){},error:function(a,b,c){alert("error="+c+",responseText="+a.responseText)}})}
function delete_maplayerarea(a,d){var b={};b.project_id=""+project_id;b.deletemaplayerarea=1;b.maplayerid=a;b.areaid=d;return jQuery.ajax({url:gl_target_server+"/php/map.php",type:"POST",dataType:"json",data:b,success:function(a){},error:function(a,b,d){alert(d);alert(a.responseText)}})}
function submit_newmap(a,d,b){var c=document.getElementById("imageUpload_"+d).files[0];if(void 0==c)return alert("Please assign image file!"),$("#upload_msg_"+d).text("Please assign image file!"),!1;var e=c.type,f=["image/jpeg","image/png","image/jpg"];e!=f[0]&&e!=f[1]&&e!=f[2]?$("#upload_msg_"+d).text("Only Jpeg/ Jpg /Png /Gif are allowed!"):(img=new Image,img.onload=function(){upload_image(a,d,b,c,this.width,this.height);return!1},img.src=_URL.createObjectURL(c));return!1}
function upload_image(a,d,b,c,e,f){a=new FormData(a);a.append("upload_img_width",e);a.append("upload_img_height",f);a.append("project_id",""+project_id);a.append("maplayerid",""+b);$("#uploadIm_"+d).show();jQuery.ajax({url:gl_target_server+"/php/uploadmap.php",type:"POST",processData:!1,contentType:!1,data:a,success:function(a){$("#uploadIm_"+d).hide();$("#upload_msg_"+d).show().html("Image uploaded successfully<br>");window.glLiveMapList[d]?window.glLiveMapList[d].changeUserMap("/upload/"+c.name,
e,f):$("#upload_msg_"+d).show().html("Can not change map.<br>")},error:function(a,b,c){$("#uploadIm_"+d).hide();alert("upload image error!")}});return!1}function area_type_select(a){var d=$("#area_type_"+a).html();a=$("#area_type_"+a).attr("data-id");$("#area_type_show").html(d);$("#area_type_show").attr("data-id",a)}
function convert_area_type_name(a){return"0"==a?"\u666e\u901a":"1"==a?"\u96fb\u5b50\u570d\u6b04":"2"==a?"\u96fb\u5b50\u9ede\u540d":"3"==a?"\u623f\u9593":"4"==a?"\u6559\u5ba4":"5"==a?"\u75c5\u623f":"6"==a?"\u75c5\u5e8a":"999"==a?"\u865b\u64ec\u7246":"\u666e\u901a"}function getRandomInt(a,d){return Math.floor(Math.random()*(d-a+1))+a}
function FloatAdd(a,d){var b,c;try{b=a.toString().split(".")[1].length}catch(e){b=0}try{c=d.toString().split(".")[1].length}catch(e){c=0}b=Math.pow(10,Math.max(b,c));return(FloatMul(a,b)+FloatMul(d,b))/b}function FloatSubtraction(a,d){var b,c,e;try{b=a.toString().split(".")[1].length}catch(f){b=0}try{c=d.toString().split(".")[1].length}catch(f){c=0}e=Math.pow(10,Math.max(b,c));return((a*e-d*e)/e).toFixed(b>=c?b:c)}
function FloatMul(a,d){var b=0,c=a.toString(),e=d.toString();try{b+=c.split(".")[1].length}catch(f){}try{b+=e.split(".")[1].length}catch(f){}return Number(c.replace(".",""))*Number(e.replace(".",""))/Math.pow(10,b)}function FloatDiv(a,d){var b=0,c=0,e,f;try{b=a.toString().split(".")[1].length}catch(k){}try{c=d.toString().split(".")[1].length}catch(k){}e=Number(a.toString().replace(".",""));f=Number(d.toString().replace(".",""));return e/f*Math.pow(10,c-b)}
function rotatePoint(a,d,b){d=d*Math.PI/180;return new L.latLng(Math.sin(d)*(a.lng-b.lng)+Math.cos(d)*(a.lat-b.lat)+b.lat,Math.cos(d)*(a.lng-b.lng)-Math.sin(d)*(a.lat-b.lat)+b.lng)};var Indoor2DMap=function(a){function d(h,a){return FloatDiv(a,11132E3*Math.cos(h*Math.PI/180))}function b(h,a){return FloatMul(a,11132E3*Math.cos(h*Math.PI/180))}this.mEnableUISmoothing=!0;this.SHOW_AREA_DEFAULT=!1;this.SHOW_LOCATOR_DEFAULT=!0;var c=function(h,a){return L.Util.isArray(h)?L.latLng(h[1],h[0]):L.latLng(a,h)},e=L.icon({iconUrl:"/images/orig-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),
f=L.icon({iconUrl:"/images/coord-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),k=L.icon({iconUrl:"/images/marker-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),n=L.icon({iconUrl:"/images/tag-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,
47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),m=L.icon({iconUrl:"/images/marker-sleep-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),l=L.icon({iconUrl:"/images/marker-sleep-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),A=L.icon({iconUrl:"/images/anchor-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),z=L.icon({iconUrl:"/images/locator-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),w=L.icon({iconUrl:"/images/locator-notalive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),B=L.icon({iconUrl:"/images/locator-poweroff-icon-2x.png",
shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),u=L.icon({iconUrl:"/images/gray-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),E=L.icon({iconUrl:"/images/gray-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,
-35]}),F=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]});L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[50,74],shadowSize:[41,41],iconAnchor:[25,74],shadowAnchor:[14,41],popupAnchor:[0,-35]});var x=L.icon({iconUrl:"/images/inactive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,
37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),C=L.icon({iconUrl:"/images/inactive-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),G=L.icon({iconUrl:"/images/norollcall-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),q=L.icon({iconUrl:"/images/norollcall-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),M=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),N=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),t=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),J=L.icon({iconUrl:"/images/pin_lidar.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),O=L.icon({iconUrl:"/images/pin_user.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),P="#FF6347 #FFA500 #FFD700 #32CD32 #87CEEB #7B68EE #8A2BE2 #4245f4 #F08080 #f441d9".split(" ");
this.mMapLayer_nodes=[];this.mMapLayerId=1;this.OriginMarker=null;this.Anchors=[];this.Tags=[];this.Coords=[];this.Locators=[];this.Sensors=[];this.Users=[];this.TagDrawList=[];this.TagGPSDrawList=[];this.MapAreas=[];this.AlertIconScaleIndexList=[];this.AlertIconScaleUpDownList=[];this.StreetMaps=[[]];this.NodeAlertFunction=[];this.areaborder_color="#8b95aa";this.areaborder_opacity="0.8";this.FadeOutPolylines=[[]];this.FadeOutNodes=[[]];this.mRotateMap=this.mShowTrack=!1;this.mEditModeCallback=this.mNodeClickCallback=
this.mUpdateMapInfoCallback=this.mOrigNodeDragCallback=this.mNodeDragCallback=null;this.mEdit_delete_mode=this.mEdit_mode=!1;this.mEdit_maparea_index=-1;this.mLayerControl=this.mUsermapScaleDown=this.mUsermapScaleUp=this.mUsermapEdit=null;this.mMap_OrigY=this.mMap_OrigX=this.mMap_coeff=this.mMap_scale=this.mUsermap_height=this.mUsermap_width=this.mMAP_North=this.mWGS48OriginY=this.mWGS48OriginX=0;this.mBounds=[c(0,0),c(1E3,1E3)];this.mUserProject_Name=this.mUserMap_url=this.mUserMaplayer=null;this.smoothing_time=
400;this.move_step_size=6;this.move_loop_count=0;this.GPS_smoothing_time=400;this.GPS_move_step_size=10;this.GPS_move_loop_count=0;this.popupZoom=20;this.mDrawControl=null;this.baseLayers={};this.layer_areas=new L.FeatureGroup;this.overlays={};L.Map=L.Map.extend({openPopup:function(h,a,g){h instanceof L.Popup||(h=(new L.Popup(g)).setContent(h));a&&h.setLatLng(a);if(this.hasLayer(h))return this;this._popup=h;return this.addLayer(h)}});this.mMap=L.map(a,{maxZoom:26,zoomSnap:0,zoomDelta:.25,doubleClickZoom:!1});
this.mLayerControl=L.control.layers().addTo(this.mMap);this.mMap.attributionControl.setPrefix('<a href="http://smims.com">SMIMS</a>');this.mMap.orig_this=this;a=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:26,attribution:'&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'});var D=L.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,subdomains:["mt0","mt1","mt2","mt3"]}),Q=L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
{attribution:"Google",maxZoom:26,subdomains:["mt0","mt1","mt2","mt3"]});this.mLayerControl.addOverlay(a,"OpenStreetMap");this.mLayerControl.addOverlay(D,"Google Streets");this.mLayerControl.addOverlay(Q,"Google Satellite");this.StreetMaps.OpenStreetMap=0;this.StreetMaps["Google Streets"]=0;this.StreetMaps["Google Satellite"]=0;Indoor2DMap.prototype.create_alert_scale_icon=function(){var h;for(h=0;10>h;h++){var a=25*(1+.1*h),g=37*(1+.1*h),a=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[a,g],shadowSize:[41,41],iconAnchor:[a/2,g],shadowAnchor:[14,41],popupAnchor:[0,-35]});this.AlertIconScaleUpDownList[h]=a}};Indoor2DMap.prototype.onOverlayAdd=function(h){h.name in this.orig_this.StreetMaps&&(this.orig_this.StreetMaps[h.name]=1,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.onOverlayRemove=function(h){h.name in this.orig_this.StreetMaps&&(this.orig_this.StreetMaps[h.name]=0,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.updateMapRotate=
function(h){var a=!1;for(map in h.StreetMaps)if(1==h.StreetMaps[map]){a=!0;break}h.mRotateMap=a;h.update_2d_map(h);h.update_node_pos(h,h.Anchors);h.update_node_pos(h,h.Coords);h.load_allmaparea(h)};Indoor2DMap.prototype.update_2d_map=function(h){null!=h.mUserMaplayer&&h.mMap.removeLayer(h.mUserMaplayer);var a=FloatDiv(h.mUsermap_width,h.mMap_scale*h.mMap_coeff),g=FloatDiv(h.mUsermap_height,h.mMap_scale*h.mMap_coeff),b=h.mWGS48OriginY+FloatDiv(FloatMul(h.mMap_OrigY,-1),11057400),e=h.mWGS48OriginX+
d(b,FloatMul(h.mMap_OrigX,-1)),b=c(e,b),e=FloatDiv(1E4,11057400),H=d(h.mWGS48OriginY+e,1E4),a=c(b.lng+a,b.lat+e/H*g);h.mBounds=[b,a];e=new L.latLng(h.mBounds[1].lat,h.mBounds[0].lng);H=new L.latLng(h.mBounds[1].lat,h.mBounds[1].lng);a=new L.latLng(h.mBounds[0].lat,h.mBounds[0].lng);g=new L.latLng(h.mWGS48OriginY,this.mWGS48OriginX);b=0;h.mRotateMap&&(b=h.mMAP_North);e=rotatePoint(e,b,g);H=rotatePoint(H,b,g);a=rotatePoint(a,b,g);h.mUserMaplayer=L.imageOverlay.rotated(h.mUserMap_url,e,H,a,{opacity:.5,
interactive:!0,attribution:h.mUserProject_Name});h.mMap.addLayer(h.mUserMaplayer,h.mUserProject_Name)};Indoor2DMap.prototype.update_node_pos=function(h,a){for(var g=0;g<a.length;g++){var b=a[g];if(null!=b){var c=h.convertToLatLng(h,b.posX,b.posY);b.setLatLng(c)}}};Indoor2DMap.prototype.setMapCoeff=function(h,a,g,b,e,H,f,K,k){null==h&&(h=0);null==a&&(a=0);this.mWGS48OriginX=parseFloat(f);this.mWGS48OriginY=parseFloat(K);this.mMAP_North=parseFloat(k);this.mUsermap_width=parseInt(g);this.mUsermap_height=
parseInt(b);this.mMap_scale=parseFloat(e);this.mMap_coeff=parseFloat(H);this.mMap_OrigX=parseFloat(h);this.mMap_OrigY=parseFloat(a);h=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);a=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);g=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);b=this.mWGS48OriginX+d(g,FloatMul(this.mMap_OrigX,-1));g=c(b,g);b=FloatDiv(1E4,11057400);e=d(this.mWGS48OriginY+b,1E4);h=c(g.lng+h,g.lat+b/e*a);this.mBounds=[g,h]};Indoor2DMap.prototype.setMapImage=
function(h,a){this.mUserMap_url=h;this.mUserProject_Name=a;this.update_2d_map(this);this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]});this.mMap.zoomControl.setPosition("topright");L.control.scale({imperial:!1,maxWidth:300}).addTo(this.mMap);this.mLayerControl.addOverlay(this.layer_areas,"Areas");1==this.SHOW_AREA_DEFAULT&&this.mMap.addLayer(this.layer_areas,"Areas");this.create_map_action(this.mMap)};Indoor2DMap.prototype.setMapLayerInfo=function(h){this.mMapLayerId=h};Indoor2DMap.prototype.changeUserMap=
function(h,a,g){this.mUserMap_url=h;this.mMap.removeLayer(this.mUserMaplayer);this.mUsermap_width=a;this.mUsermap_height=g;h=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);a=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);g=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);var b=this.mWGS48OriginX+d(g,FloatMul(this.mMap_OrigX,-1));g=c(b,g);var b=FloatDiv(1E4,11057400),e=d(this.mWGS48OriginY+b,1E4);h=c(g.lng+h,g.lat+b/e*a);this.mBounds=[g,h];this.mUserMaplayer=
L.imageOverlay(this.mUserMap_url,this.mBounds,{attribution:this.mUserProject_Name,opacity:.5});this.mMap.addLayer(this.mUserMaplayer,this.mUserProject_Name)};Indoor2DMap.prototype.editmode=function(){return this.mEdit_mode};Indoor2DMap.prototype.setShowTrack=function(h){this.mShowTrack=h};Indoor2DMap.prototype.refresh=function(){var h=this.mMap.getZoom();this.mMap._onResize();0==h&&setTimeout(this.fitBounds,100,this)};Indoor2DMap.prototype.fitBounds=function(h){h.mMap.fitBounds(h.mBounds,{paddingTopLeft:[0,
0]})};Indoor2DMap.prototype.setUISmoothing=function(h){h&&!this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,100,this),setTimeout(this.draw_tag_GPS_smooth_move,100,this));this.mEnableUISmoothing=h};Indoor2DMap.prototype.markerOnClick=function(h){this.orig_this.markclick(h.target.type,h.target.index);"function"===typeof this.orig_this.mNodeClickCallback&&this.orig_this.mNodeClickCallback(h.target)};Indoor2DMap.prototype.mapAreaOnClick=function(h){var a=h.target.orig_this;if(a.mEdit_mode&&
!a.mEdit_delete_mode){var g=a.MapAreas[h.target.index],g=g.toGeoJSON();a.toggle_map_area_editor(g,h.target.index)}else g=a.MapAreas[h.target.index],g=g.toGeoJSON(),999!=g.properties.areatype&&fetch_rollcall(g.properties.areaid,g.properties.areaname)};Indoor2DMap.prototype.createVILSMarker=function(h,a,g,c,d,e,f,K,k){var l=g+"&nbsp;&nbsp;&nbsp;&nbsp;<br>";0==g.length&&(l=a+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");var l=L.popup({closeOnClick:!1,autoClose:!1}).setContent(l),m=this.convertToLatLng(this,c,d),p=
L.marker(m,{title:a,draggable:K}).bindPopup(l);p.nodeid=a;p.macaddress=h;p.nodename=g;p.posX=c;p.posY=d;p.posZ=e;p.date=f;p.orig_this=this;p.maplayer=k;p.on("click",this.markerOnClick);p.on("dragend",function(h){h=h.target;var a=h.orig_this,g=h.getLatLng();h.posY=FloatMul(g.lat,11057400)-FloatMul(a.mWGS48OriginY,11057400);posX1=b(g.lat,g.lng);posX2=b(g.lat,a.mWGS48OriginX);h.posX=posX1-posX2;"function"===typeof a.mNodeDragCallback&&a.mNodeDragCallback(a.mMapLayerId,h.type,p.macaddress,h.nodeid,h.posX,
h.posY,h.posZ,g.lat,g.lng)});return p};Indoor2DMap.prototype.fadeout_tag_footprint=function(h,a){var g=[],b=[],c=this.FadeOutPolylines[h],d=this.FadeOutNodes[h],e=this.getCurrentLayer("Tags",a);null!=c&&e.removeLayer(c);if(null!=d&&void 0!=d){for(var c="rgb(244, 131, 66)",f=0;f<d.length;f++){var k=d[f],l=k.options.radius,c=k.options.color;.5>=l||0==this.mShowTrack?e.removeLayer(k):(k.setStyle({radius:l-.5}),l=k.getLatLng(),g.push([l.lat,l.lng]),b[b.length]=k)}this.FadeOutNodes[h]=b;c=new L.Polyline(g,
{color:c,weight:4,opacity:.4,smoothFactor:1});e.addLayer(c);this.FadeOutPolylines[h]=c}};Indoor2DMap.prototype.fadeout_loop=function(h){for(var a=0;a<h.Tags.length;a++){var g=h.Tags[a];h.fadeout_tag_footprint(g.nodeid,g.maplayer)}setTimeout(h.fadeout_loop,1E3,h)};Indoor2DMap.prototype.showGoolgeMap=function(){this.mMap.addLayer(D,"Google Streets")};Indoor2DMap.prototype.createMapEditor=function(h){this.mUsermapScaleDown=new this.UserMapScaleDownControl;this.mUsermapScaleUp=new this.UserMapScaleUpControl;
this.mUsermapEdit=new this.UserMapEditControl;this.mMap.addControl(this.mUsermapEdit);this.fadeout_loop(this);this.mEditModeCallback=h};Indoor2DMap.prototype.setNodeDragCallback=function(h){this.mNodeDragCallback=h};Indoor2DMap.prototype.setOrigNodeDragCallback=function(h){this.mOrigNodeDragCallback=h};Indoor2DMap.prototype.setUpdateMapInfoCallback=function(h){this.mUpdateMapInfoCallback=h};Indoor2DMap.prototype.setNodeClickCallback=function(h){this.mNodeClickCallback=h};Indoor2DMap.prototype.addOriginMarker=
function(h,a,g){h=this.createVILSMarker("0000","OriginXYZID","Origin",h,a,g,null,!1,this.mMapLayerId);h.setIcon(e);a=this.getCurrentLayer("Origin",this.mMapLayerId);h.addTo(a);this.OriginMarker=h;h.type="Origin";h.index=0;h.on("dragend",function(h){h=h.target;var a=h.getLatLng(),g=this.orig_this,c=FloatMul(a.lat,11057400)-FloatMul(g.mWGS48OriginY,11057400);posX1=b(a.lat,a.lng);posX2=b(a.lat,g.mWGS48OriginX);a=posX1-posX2;g.mMap_OrigY+=c;g.mMap_OrigX+=a;g.update_2d_map(g);h.setLatLng(new L.LatLng(g.mWGS48OriginY,
g.mWGS48OriginX));g.mMap.panTo(h.getLatLng());"function"===typeof g.mOrigNodeDragCallback&&g.mOrigNodeDragCallback(g.mMapLayerId,g.mMap_OrigX,g.mMap_OrigY)})};Indoor2DMap.prototype.createDummyTag=function(h,a,g,b,c,d,e,f,k){this.updateMarker(this.Tags,h,a,g,b,c,d,e,f,k,!1)||this.addTag(this.Tags.length,h,a,g,b,c,d,e,f,k)};Indoor2DMap.prototype.addAnchor=function(h,a,g,b,c,d,e,f,k,l,m){a=this.createVILSMarker(a,g,b,c,d,e,l,!1,m);m=this.getCurrentLayer("Anchors",m);a.setIcon(A);a.addTo(m);this.Anchors[h]=
a;a.type="anchor";a.index=h};Indoor2DMap.prototype.addTag=function(h,a,g,b,c,d,e,f,l,m,y){a=this.createVILSMarker(a,g,b,c,d,e,m,!1,y);y=this.getCurrentLayer("Tags",y);a.setIcon(k);y.addLayer(a);this.Tags[h]=a;a.type="tag";a.index=h};Indoor2DMap.prototype.addCoordinator=function(h,a,g,b,c,d,e,k,l,m,y){a=this.createVILSMarker(a,g,b,c,d,e,m,!1,y);y=this.getCurrentLayer("Coordinators",y);a.setIcon(f);a.addTo(y);this.Coords[h]=a;a.type="coord";a.index=h};Indoor2DMap.prototype.addLocator=function(h,a,g,
b,c,d,e,f,k,l,m){a=this.createVILSMarker(a,g,b,c,d,e,l,!1,m,m);m=this.getCurrentLayer("Locators",m);a.setIcon(z);a.addTo(m);this.Locators[h]=a;a.type="locator";a.index=h};Indoor2DMap.prototype.getCurrentLayer=function(h,a){var g=this.mMapLayer_nodes[h];void 0==g&&(g=new L.LayerGroup,this.mMapLayer_nodes[h]=g,"Tags"==h&&this.mMap.addLayer(g,h),"Locators"==h&&1==this.SHOW_LOCATOR_DEFAULT&&this.mMap.addLayer(g,h),"Sensors"==h&&this.mMap.addLayer(g,h),"Users"==h&&this.mMap.addLayer(g,h),this.mLayerControl.addOverlay(g,
h));return g};Indoor2DMap.prototype.updateAnchorMarker=function(h,a,g,b,c,d,e,f,k,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return!0;this.updateMarker(this.Anchors,h,a,g,b,c,d,e,f,k,!1,!0,l)||this.addAnchor(this.Anchors.length,h,a,g,b,c,d,e,f,k,l)};Indoor2DMap.prototype.updateTagMarker=function(h,a,g,b,c,d,e,f,k,l,m){if(0!=this.mMapLayerId&&0!=m&&this.mMapLayerId!=m)return this.setMarkerVisible(this.Tags,a,!1),this.updateMarker(this.Tags,h,a,g,b,c,d,e,f,k,!0,!1,m),this.push_to_drawlist(h,
a,g,b,c,d,e,f,k,m),!0;0!=this.check_visible_state(this.Tags,a)||l||(this.reset_node(a,b,c,d,e,f,m),this.updateMarker(this.Tags,h,a,g,b,c,d,e,f,k,!0,!0,m),this.setMarkerVisible(this.Tags,a,!0));l?this.hide_2d_drawlist(a):(this.hide_2d_drawGPSlist(a),this.push_to_drawlist(h,a,g,b,c,d,e,f,k,m));(l=this.updateMarker(this.Tags,h,a,g,b,c,d,e,f,k,!0,!this.mEnableUISmoothing&&!l,m))||this.addTag(this.Tags.length,h,a,g,b,c,d,e,f,k,m);return l};Indoor2DMap.prototype.updateCoordinatorMarker=function(a,b,g,c,
d,e,f,k,l,m){if(0!=this.mMapLayerId&&0!=m&&this.mMapLayerId!=m)return this.setMarkerVisible(this.Coords,b,!1),this.updateMarker(this.Coords,a,b,g,c,d,e,f,k,l,!0,!1,m),!0;this.updateMarker(this.Coords,a,b,g,c,d,e,f,k,l,!1,!0,m)||this.addCoordinator(this.Coords.length,a,b,g,c,d,e,f,k,l,m)};Indoor2DMap.prototype.updateLocatorMarker=function(a,b,g,c,d,e,f,k,l,m){if(0!=this.mMapLayerId&&0!=m&&this.mMapLayerId!=m)return this.setMarkerVisible(this.Locators,b,!1),this.updateMarker(this.Locators,a,b,g,c,d,
e,f,k,l,!0,!1,m),!0;var n=this.updateMarker(this.Locators,a,b,g,c,d,e,f,k,l,!1,!0,m);n||this.addLocator(this.Locators.length,a,b,g,c,d,e,f,k,l,m);return n};Indoor2DMap.prototype.updateMarker=function(a,b,g,c,d,e,f,k,l,m,n,p,q){var t=!1,v,u;for(u=0;u<a.length;u++)if(v=a[u],v.nodeid===g){v.nodename=0==c.length?g:c;v.posX=d;v.posY=e;v.posZ=f;v.buildingid=k;v.floor=l;v.maplayer=q;v.date=m;v.macaddress=b;if(p&&(a=this.convertToLatLng(this,d,e),v.setLatLng(a),n&&this.mShowTrack)){void 0!=v._icon&&"hidden"==
v._icon.style.visibility&&this.showMarker(v);n=u;10<=n&&(n-=10);n=L.circleMarker(a,{color:P[n],opacity:.3,fillColor:P[n],fillOpacity:.2,className:"geoData",radius:5});q=this.getCurrentLayer("Tags",q);n.buildingid=k;n.floor=l;n.addTo(q);k=this.FadeOutNodes[v.nodeid];if(null==k||void 0==k)k=[];k[k.length]=n;this.FadeOutNodes[v.nodeid]=k}t=!0;break}return t};Indoor2DMap.prototype.updateSensorMarker=function(a,b,g,d,e,f,k,l){var m=this.getCurrentLayer("Sensors",f);if(0!=this.mMapLayerId&&0!=f&&this.mMapLayerId!=
f)return!0;for(var n=!1,q=0;q<this.Sensors.length;q++){var p=this.Sensors[q];if(p.id===a){n=!0;p.setLatLng(c(d,e));break}}0==n?(n=new moment,b=this.createVILSMarker(a,a,b,0,0,0,n,!1,f),"LiDAR"===g?b.setIcon(J):0==k.length||0==k?b.setIcon(N):1==l?b.setIcon(t):b.setIcon(M),b.setLatLng(c(d,e)),m.addLayer(b),g=this.Sensors.length,this.Sensors[g]=b,b.id=a,b.type="sensor",b.index=g):"LiDAR"===g?p.setIcon(J):0==k.length||0==k?p.setIcon(N):1==l?p.setIcon(t):p.setIcon(M)};Indoor2DMap.prototype.updateUserMarker=
function(a,b,g,d,e,f,k,l){f=this.getCurrentLayer("Users",g);if(0!=this.mMapLayerId&&0!=g&&this.mMapLayerId!=g)return!0;var m=c(k,l);k=parseInt(k);l=parseInt(l);if(0==k||0==l)m=this.convertToLatLng(this,d,e);d=!1;for(e=0;e<this.Users.length;e++)if(l=this.Users[e],l.id===a){d=!0;l.setLatLng(m);break}0==d&&(d=new moment,b=this.createVILSMarker(a,a,b,0,0,0,d,!1,g),b.setIcon(O),b.setLatLng(m),f.addLayer(b),g=this.Users.length,this.Users[g]=b,b.id=a,b.type="user",b.index=g)};Indoor2DMap.prototype.getTagList=
function(){return this.Tags};Indoor2DMap.prototype.getLocatorList=function(){return this.Locators};Indoor2DMap.prototype.setTagPopup=function(a,b){var g;for(g=0;g<this.Tags.length;g++){var c=this.Tags[g];if(c.nodeid===a){b?(c.openPopup(),this.mMap.setView(c.getLatLng())):c.closePopup();break}}};Indoor2DMap.prototype.setLocatorPopup=function(a,b){var g;for(g=0;g<this.Locators.length;g++){var c=this.Locators[g];if(c.nodeid===a){b?(c.openPopup(),this.mMap.setView(c.getLatLng())):c.closePopup();break}}};
Indoor2DMap.prototype.setSensorPopup=function(a,b){var g;for(g=0;g<this.Sensors.length;g++){var c=this.Sensors[g];console.log("setSensorPopup() index:"+g+" id:"+a+" exist_sensor.id:"+c.id);if(c.id===a){b?(c.openPopup(),this.mMap.setView(c.getLatLng())):c.closePopup();break}}};Indoor2DMap.prototype.setUserPopup=function(a,b){var g;for(g=0;g<this.Users.length;g++){var c=this.Users[g];if(c.id==a){b?(c.setIcon(O),c.openPopup(),this.mMap.setView(c.getLatLng())):(c.setIcon(J),c.closePopup());break}}};Indoor2DMap.prototype.setTagAlert=
function(a,b){this.set_TagDraw_Alert(a,b);this.set_TagGPSDraw_Alert(a,b)};Indoor2DMap.prototype.setStartAlert=function(a){void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={});this.NodeAlertFunction[a]=1;console.log("setStartAlert() "+a)};Indoor2DMap.prototype.setStopAlert=function(a){void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={});this.NodeAlertFunction[a]=0;this.getTargetNode(a).setIcon(this.AlertIconScaleUpDownList[0]);console.log("setStopAlert() "+a)};Indoor2DMap.prototype.check_tag_layer_alertcircle=
function(){var a=this.getCurrentLayer("Tags",this.mMapLayerId),b=a.getLayers(),g;for(g=0;g<b.length;g++){var c=b[g];"circleMarker"===c.type&&(console.log("check_tag_layer_alertcircle() Found!"),a.removeLayer(c))}};Indoor2DMap.prototype.check_locator_layer_alertcircle=function(){for(var a=this.getCurrentLayer("Locators",this.mMapLayerId),b=a.getLayers(),g=0;g<b.length;g++){var c=b[g];"circleMarker"===c.type&&(console.log("check_locator_layer_alertcircle() Found!"),a.removeLayer(c))}};Indoor2DMap.prototype.set_TagDraw_Alert=
function(a,b){for(var g=0;g<this.TagDrawList.length;g++){var c=this.TagDrawList[g];if(c.nodeid===a){g=this.getTargetNode(a);if(null==g)break;if(g.maplayer!=this.mMapLayerId)break;0<c.alertcount&&c.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==b||0==this.NodeAlertFunction[a]){c.alertcount=0;var d=this.getCurrentLayer("Tags",this.mMapLayerId),e=c.alertcircle;void 0!=e&&null!=e&&(d.removeLayer(e),c.alertcircle=null,g.closePopup());g.setPopupContent(g.nodename);
break}var d=this.convertToLatLng(this,c.curposX,c.curposY),f="rgb(244, 20, 20)",k="rgb(244, 20, 20)";2==b&&(k=f="rgb(244, 20, 20)");e=c.alertcircle;if(void 0==e||null==e)e=L.circleMarker(d,{color:f,opacity:.2,fillColor:k,fillOpacity:.2,className:"geoData",radius:25}),e.type="circleMarker",d=this.getCurrentLayer("Tags",this.mMapLayerId),e.addTo(d),c.alertcircle=e,c.alertcount=50,g.setPopupContent(g.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),g.openPopup(),this.mMap.setView(g.getLatLng());break}}};
Indoor2DMap.prototype.set_TagGPSDraw_Alert=function(a,b){for(var g=0;g<this.TagGPSDrawList.length;g++){var d=this.TagGPSDrawList[g];if(d.nodeid===a){g=this.getTargetNode(a);if(null==g){console.log("set_TagGPSDraw_Alert() nodeid:"+a+" TargetNode == null");break}if(g.maplayer!=this.mMapLayerId){console.log("set_TagGPSDraw_Alert() "+a+" not in this map");break}0<d.alertcount&&d.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==b||0==this.NodeAlertFunction[a]){d.alertcount=
0;var e=this.getCurrentLayer("Tags",this.mMapLayerId),f=d.alertcircle;void 0!=f&&null!=f&&(e.removeLayer(f),d.alertcircle=null,g.closePopup());g.setPopupContent(g.nodename);break}var e=c(d.curposLng,d.curposLat),k="rgb(244, 20, 20)",l="rgb(244, 20, 20)";2==b&&(l=k="rgb(244, 20, 20)");f=d.alertcircle;if(void 0==f||null==f)f=L.circleMarker(e,{color:k,opacity:.2,fillColor:l,fillOpacity:.2,className:"geoData",radius:25}),f.type="circleMarker",e=this.getCurrentLayer("Tags",this.mMapLayerId),f.addTo(e),
d.alertcircle=f,d.alertcount=50,console.log("set_TagGPSDraw_Alert()"+d.nodeid+" circle:"+f+" alertcount:"+d.alertcount+" alertType:"+b),g.bindPopup(a+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),g.openPopup(),this.mMap.setView(g.getLatLng());break}}};Indoor2DMap.prototype.getTargetNode=function(a){for(var b=null,g=0;g<this.Tags.length&&(b=this.Tags[g],b.nodeid!==a);g++);return b};Indoor2DMap.prototype.getTargetLocatorNode=function(a){for(var b=null,g=0;g<this.Locators.length&&(b=this.Locators[g],b.nodeid!==
a);g++);return b};Indoor2DMap.prototype.setTagLocation=function(a,b,g,c,d,e,f,K,t,I,y){for(c=0;c<this.Tags.length;c++){var p=this.Tags[c];if(p.nodeid===a){0!=b?0==p.alertcount&&(1==I?p.setIcon(n):p.setIcon(k)):(0<g.length&&(0==d?1==I?p.setIcon(n):p.setIcon(k):1==d?1==I?p.setIcon(E):p.setIcon(u):2==d&&p.setIcon(F)),1==y?1==I?p.setIcon(l):p.setIcon(m):0==e||1==K?1==I?p.setIcon(C):p.setIcon(x):0<f.length&&!t?1==I?p.setIcon(q):p.setIcon(G):1==I?p.setIcon(n):p.setIcon(k));break}}};Indoor2DMap.prototype.setTagLngLat=
function(a,b,g,d,e){this.setMarkerVisible(this.Tags,a,!0);if(!(0>=b&&0>=g))for(var f=0;f<this.Tags.length;f++){var l=this.Tags[f];l.nodeid===a&&(l.setIcon(k),this.mEnableUISmoothing?this.push_to_GPSdrawlist(a,b,g,d,e):l.setLatLng(c(b,g)))}};Indoor2DMap.prototype.updateTagGPS=function(a,b,g){for(var d=0;d<this.Tags.length;d++){var e=this.Tags[d];e.nodeid===a&&e.setLatLng(c(b,g))}};Indoor2DMap.prototype.setLocatorAlert=function(a,b,c,d){if(0<=b)for(var e=0;e<this.Locators.length;e++){var f=this.Locators[e];
if(f.nodeid===a){if(f.maplayer!=this.mMapLayerId)break;0<f.alertcount&&f.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==b||0==this.NodeAlertFunction[a]){f.alertcount=0;1==d?f.setIcon(B):0<c?f.setIcon(z):f.setIcon(w);a=this.getCurrentLayer("Locators",this.mMapLayerId);b=f.alertcircle;void 0!=b&&null!=b&&(a.removeLayer(b),f.alertcircle=null,f.closePopup());f.setPopupContent(f.nodename);break}a=this.convertToLatLng(this,f.posX,f.posY);
d=c="rgb(244, 20, 20)";2==b&&(d=c="rgb(244, 20, 20)");b=f.alertcircle;if(void 0==b||null==b)b=L.circleMarker(a,{color:c,opacity:.2,fillColor:d,fillOpacity:.2,className:"geoData",radius:25}),b.type="circleMarker",a=this.getCurrentLayer("Locators",this.mMapLayerId),b.addTo(a),f.alertcircle=b,f.alertcount=50,f.setPopupContent(f.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),f.openPopup(),this.mMap.setView(f.getLatLng());break}}};Indoor2DMap.prototype.setMarkerVisible=function(a,b,c){for(var d=!1,
e=0;e<a.length;e++){var f=a[e];if(f.nodeid===b){d=c?this.showMarker(f):this.hideMarker(f);break}}return d};Indoor2DMap.prototype.hideMarker=function(a){var b=!1;null!=a._icon&&("hidden"!=a._icon.style.visibility&&(b=!0),a._icon.style.visibility="hidden");null!=a._shadow&&(a._shadow.style.visibility="hidden");a.closePopup();return b};Indoor2DMap.prototype.showMarker=function(a){var b=!1;null!=a._icon&&("visible"!=a._icon.style.visibility&&(b=!0),a._icon.style.visibility="visible");null!=a._shadow&&
(a._shadow.style.visibility="visible");return b};Indoor2DMap.prototype.check_visible_state=function(a,b){for(var c=!1,d=0;d<a.length;d++){var e=a[d];if(e.nodeid===b){c=this.check_node_visible_state(e);break}}return c};Indoor2DMap.prototype.check_node_visible_state=function(a){var b=!1;null!=a._icon&&"visible"==a._icon.style.visibility&&(b=!0);return b};Indoor2DMap.prototype.markclick=function(a,b){"anchor"===a?(this.Anchors[b].openPopup(),this.mMap.setView(this.Anchors[b].getLatLng()),$("#ProfileMarkerName").text(this.Anchors[b].nodename),
$("#ProfileMarkerPosition").text("("+this.Anchors[b].posX+","+this.Anchors[b].posY+","+this.Anchors[b].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Anchors[b].date).local().format("MMM Do, hh:mm A"))):"tag"===a?(this.Tags[b].openPopup(),this.mMap.setView(this.Tags[b].getLatLng()),$("#ProfileMarkerName").text(this.Tags[b].nodename),$("#ProfileMarkerPosition").text("("+this.Tags[b].posX+","+this.Tags[b].posY+","+this.Tags[b].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Tags[b].date).local().format("MMM Do, hh:mm A"))):
"Origin"===a?null!=this.OriginMarker&&(this.OriginMarker.openPopup(),this.mMap.setView(this.OriginMarker.getLatLng()),$("#ProfileMarkerName").text(this.OriginMarker.nodename),$("#ProfileMarkerPosition").text("("+this.OriginMarker.posX+","+this.OriginMarker.posY+","+this.OriginMarker.posZ+")"),$("#ProfileMarkerLocation").text(""),$("#ProfileMarkerUpdateTime").text("")):"coord"===a?(this.Coords[b].openPopup(),this.mMap.setView(this.Coords[b].getLatLng()),$("#ProfileMarkerName").text(this.Coords[b].nodename),
$("#ProfileMarkerPosition").text("("+this.Coords[b].posX+","+this.Coords[b].posY+","+this.Coords[b].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Coords[b].date).local().format("MMM Do, hh:mm A"))):"locator"===a&&(this.Locators[b].openPopup(),this.mMap.setView(this.Locators[b].getLatLng()),$("#ProfileMarkerName").text(this.Locators[b].nodename),$("#ProfileMarkerPosition").text("("+this.Locators[b].posX+","+this.Locators[b].posY+","+this.Locators[b].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Locators[b].date).local().format("MMM Do, hh:mm A")))};
Indoor2DMap.prototype.UserMapEditControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var b=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");b.style.backgroundColor="white";b.style.backgroundImage="url(/images/edit-icon.png)";b.style.backgroundSize="28px 28px";b.style.width="32px";b.style.height="32px";b.onclick=function(){a.orig_this.mEdit_mode?(a.removeControl(a.orig_this.mUsermapScaleUp),a.removeControl(a.orig_this.mUsermapScaleDown),a.removeControl(a.orig_this.mDrawControl),
a.orig_this.mEdit_mode=!1,$("#areaname_edit").css("display","none"),a.orig_this.setMakerDragable(a.orig_this.mEdit_mode),"function"===typeof a.orig_this.mEditModeCallback&&a.orig_this.mEditModeCallback(!1)):(a.addControl(a.orig_this.mUsermapScaleUp),a.addControl(a.orig_this.mUsermapScaleDown),a.orig_this.mDrawControl=a.orig_this.creat_drawControl(a.orig_this),a.addControl(a.orig_this.mDrawControl),a.orig_this.mEdit_mode=!0,a.orig_this.setMakerDragable(a.orig_this.mEdit_mode),"function"===typeof a.orig_this.mEditModeCallback&&
a.orig_this.mEditModeCallback(!0))};return b}});Indoor2DMap.prototype.UserMapScaleUpControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var b=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");b.style.backgroundColor="white";b.style.backgroundImage="url(/images/maximize-25.png)";b.style.backgroundSize="28px 28px";b.style.width="32px";b.style.height="32px";b.style.backgroundRepeat="no-repeat";b.onclick=function(){a.orig_this.mMap_scale-=.01*a.orig_this.mMap_scale;
a.orig_this.update_2d_map(a.orig_this);"function"===typeof a.orig_this.mUpdateMapInfoCallback&&a.orig_this.mUpdateMapInfoCallback(a.orig_this.mMapLayerId,a.orig_this.mMap_scale,a.orig_this.mMap_coeff)};return b}});Indoor2DMap.prototype.UserMapScaleDownControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var b=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");b.style.backgroundColor="white";b.style.backgroundImage="url(/images/minimize-25.png)";b.style.backgroundSize=
"28px 28px";b.style.width="32px";b.style.height="32px";b.style.backgroundRepeat="no-repeat";b.onclick=function(){a.orig_this.mMap_scale+=.01*a.orig_this.mMap_scale;a.orig_this.update_2d_map(a.orig_this);"function"===typeof a.orig_this.mUpdateMapInfoCallback&&a.orig_this.mUpdateMapInfoCallback(a.orig_this.mMapLayerId,a.orig_this.mMap_scale,a.orig_this.mMap_coeff)};return b}});Indoor2DMap.prototype.drawControl=new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",
message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:this.layer_areas}});Indoor2DMap.prototype.creat_drawControl=function(a){return new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,
weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:a.layer_areas}})};Indoor2DMap.prototype.setMakerDragable=function(a){var b=this.getCurrentLayer("Origin",this.mMapLayerId);this.mMap.hasLayer(b)&&null!=this.OriginMarker&&null!=this.OriginMarker.dragging&&(a?this.OriginMarker.dragging.enable():this.OriginMarker.dragging.disable());b=this.getCurrentLayer("Anchors",this.mMapLayerId);if(this.mMap.hasLayer(b))for(b=0;b<this.Anchors.length;b++){var c=this.Anchors[b];null!=c&&
null!=c.dragging&&(a?c.dragging.enable():c.dragging.disable())}b=this.getCurrentLayer("Tags",this.mMapLayerId);if(this.mMap.hasLayer(b))for(b=0;b<this.Tags.length;b++)c=this.Tags[b],null!=c&&null!=c.dragging&&(a?c.dragging.enable():c.dragging.disable());b=this.getCurrentLayer("Coordinators",this.mMapLayerId);if(this.mMap.hasLayer(b))for(b=0;b<this.Coords.length;b++)coord_node=this.Coords[b],null!=coord_node&&null!=coord_node.dragging&&(a?coord_node.dragging.enable():coord_node.dragging.disable());
b=this.getCurrentLayer("Locators",this.mMapLayerId);if(this.mMap.hasLayer(b))for(b=0;b<this.Locators.length;b++)locator_node=this.Locators[b],null!=locator_node&&null!=locator_node.dragging&&(a?locator_node.dragging.enable():locator_node.dragging.disable());b=this.getCurrentLayer("Sensors",this.mMapLayerId);if(this.mMap.hasLayer(b))for(b=0;b<this.Sensors.length;b++)sensor_node=this.Sensors[b],null!=sensor_node&&null!=sensor_node.dragging&&(a?sensor_node.dragging.enable():sensor_node.dragging.disable());
b=this.getCurrentLayer("Users",this.mMapLayerId);if(this.mMap.hasLayer(b))for(b=0;b<this.Users.length;b++)user_node=this.Users[b],null!=user_node&&null!=user_node.dragging&&(a?user_node.dragging.enable():user_node.dragging.disable())};Indoor2DMap.prototype.create_maparea_from_geoJSON=function(a,b,c){L.geoJson(c,{pointToLayer:function(a,b){},style:function(a){return a.properties.style},onEachFeature:function(a,b){var c='<label id="maparea_popup_'+a.properties.areaid+'">\u5340\u57df:'+a.properties.areaname+
"&nbsp;&nbsp;&nbsp;&nbsp;</label>",c=(new L.popup({minWidth:"16",closeButton:!0,closeOnClick:!0,maxWidth:"190"})).setContent(c);b.bindPopup(c)}}).eachLayer(function(c){c.index=b;c.orig_this=a;c.on("click",a.mapAreaOnClick);a.MapAreas[b]=c;a.layer_areas.addLayer(c)})};Indoor2DMap.prototype.load_allmaparea=function(a){a.layer_areas.eachLayer(function(b){a.layer_areas.removeLayer(b)});console.log("load_allmaparea");var b=[];get_maplayerarea(this.mMapLayerId,function(c){$.each(c,function(a,c){var g=JSON.parse(c);
b[a]=g});c=0;for(var d in b){var e=b[d];"6"!==e.properties.areatype&&(a.create_maparea_from_geoJSON(a,c,e),c++)}for(d in b)e=b[d],"6"===e.properties.areatype&&(a.create_maparea_from_geoJSON(a,c,e),c++)})};Indoor2DMap.prototype.load_maparea=function(){this.load_allmaparea(this)};Indoor2DMap.prototype.create_map_success=function(a,b,c){a.layer_areas.removeLayer(a.MapAreas[c]);a.create_map_area(a,b.geojson,c)};Indoor2DMap.prototype.create_map_action=function(a){a.on("draw:created",function(b){b=b.layer;
b.options.fillColor=b.options.color;b.options.fillOpacity=b.options.opacity;b.options.color=a.orig_this.areaborder_color;b.options.opacity=a.orig_this.areaborder_opacity;b.index=Object.keys(a.orig_this.MapAreas).length;b.orig_this=a.orig_this;b.on("click",a.orig_this.mapAreaOnClick);a.orig_this.layer_areas.addLayer(b);var c=b.toGeoJSON();c.properties.style={};c.properties.style.color=b.options.color;c.properties.style.opacity=b.options.opacity;c.properties.style.weight=b.options.weight;for(var d=
c.properties.style,e="#",f=0;6>f;f++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];d.fillColor=e;c.properties.style.fillOpacity=b.options.fillOpacity;c.properties.areaid="area"+getRandomInt(1E3,9999);c.properties.areaname="Area "+Object.keys(a.orig_this.MapAreas).length;a.orig_this.MapAreas[b.index]=b;d=JSON.stringify(c);create_maplayerarea(a.orig_this,a.orig_this.mMapLayerId,d,c.properties.areaid,c.properties.areaname,0,b.index,a.orig_this.create_map_success)});a.on("draw:edited",function(b){b.layers.eachLayer(function(b){b=
b.toGeoJSON();var c=b.properties.areaid,d=JSON.stringify(b);update_maplayerarea_shape(a.orig_this.mMapLayerId,c,d,b.properties.areaname)})});a.on("draw:deletestart",function(b){a.orig_this.mEdit_delete_mode=!0});a.on("draw:deletestop",function(b){a.orig_this.mEdit_delete_mode=!1});a.on("draw:deleted",function(b){b.layers.eachLayer(function(b){b=b.toGeoJSON().properties.areaid;a.orig_this.delete_map_area(a.orig_this,b)});a.orig_this.mEdit_delete_mode=!1});a.on("moveend",function(){})};Indoor2DMap.prototype.delete_map_area=
function(a,b){delete_maplayerarea(a.mMapLayerId,b)};Indoor2DMap.prototype.create_map_area=function(a,b,c){return L.geoJson(JSON.parse(b),{pointToLayer:function(a,b){},style:function(a){return a.properties.style},onEachFeature:function(a,b){b.bindPopup(a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;")}}).eachLayer(function(b){b.index=c;b.orig_this=a;b.on("click",a.mapAreaOnClick);a.MapAreas[c]=b;a.layer_areas.addLayer(b)})};Indoor2DMap.prototype.areacolorOnInput=function(){var a=$("#areacolor_input").val();
if("#"!=a.charAt(0))console.log("areacolorOnInput() not valid color!");else if(9!=a.length)console.log("areacolorOnInput() not valid color string length! need 9, get "+a.length);else{var b=a.substring(0,7),a="0x"+a.substring(7,9),a=parseInt(a),a=parseFloat(a)/255;$("#areaname_color").minicolors("value",b);$("#areaname_color").minicolors("opacity",a)}};Indoor2DMap.prototype.toggle_map_area_editor=function(a,b){this.mEdit_maparea_index=b;$("#areaname_input").val(a.properties.areaname);$("#area_type_show").html(convert_area_type_name(a.properties.areatype));
$("#area_type_show").attr("data-id",a.properties.areatype);$("#areaname_color").minicolors("value",a.properties.style.fillColor);$("#areaname_color").minicolors("opacity",a.properties.style.fillOpacity);var c=parseInt(255*a.properties.style.fillOpacity).toString(16);$("#areacolor_input").val(a.properties.style.fillColor+c);document.getElementById("areacolor_input").addEventListener("input",this.areacolorOnInput);$("#areaname_edit").css("display","block")};Indoor2DMap.prototype.areaname_save=function(a){var b=
$("#areaname_color").minicolors("value"),c=$("#areaname_color").minicolors("opacity"),d=$("#areaname_input").val(),e=$("#area_type_show").attr("data-id"),f=a.MapAreas[a.mEdit_maparea_index];f.setStyle({color:a.areaborder_color,opacity:a.areaborder_opacity,fillColor:b,fillOpacity:c});f.bindPopup(d+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");$("#areaname_edit").css("display","none");f=f.toGeoJSON();f.properties.areaname=d;f.properties.areatype=e;f.properties.style.color=a.areaborder_color;f.properties.style.opacity=
a.areaborder_opacity;f.properties.style.fillColor=b;f.properties.style.fillOpacity=c;b=f.properties.areaid;c=JSON.stringify(f);update_maplayerarea(a.mMapLayerId,b,c,d,e)};Indoor2DMap.prototype.push_to_drawlist=function(a,b,c,d,e,f,k,l,m){for(var n=!1,q=0;q<this.TagDrawList.length;q++){var p=this.TagDrawList[q];p.nodeid===b&&(0==p.preposX&&0==p.preposY&&0==p.preposZ?(p.totalposX=parseInt(d),p.totalposY=parseInt(e),p.totalposZ=parseInt(f),p.count=1):(p.totalposX+=parseInt(d),p.totalposY+=parseInt(e),
p.totalposZ+=parseInt(f),p.count++),p.buildingid=k,p.floor=l,p.date=m,p.hide=!1,n=!0)}0==n&&(n={},n.nodeid=b,n.macaddress=a,n.nodename=c,n.date=m,this.reset_draw_node(n,d,e,f,k,l),this.TagDrawList.push(n))};Indoor2DMap.prototype.hide_2d_drawlist=function(a){for(var b=0;b<this.TagDrawList.length;b++){var c=this.TagDrawList[b];if(c.nodeid===a){c.hide=!0;break}}};Indoor2DMap.prototype.hide_2d_drawGPSlist=function(a){for(var b=0;b<this.TagGPSDrawList.length;b++){var c=this.TagGPSDrawList[b];if(c.nodeid===
a){c.hide=!0;break}}};Indoor2DMap.prototype.reset_node=function(a,b,c,d,e,f){for(var k=0;k<this.TagDrawList.length;k++){var l=this.TagDrawList[k];if(l.nodeid===a){this.reset_draw_node(l,b,c,d,e,f);break}}};Indoor2DMap.prototype.reset_draw_node=function(a,b,c,d,e,f){a.buildingid=e;a.floor=f;a.count=0;a.totalposX=0;a.totalposY=0;a.totalposZ=0;a.preAveragePosX=parseInt(b);a.preAveragePosY=parseInt(c);a.preAveragePosZ=parseInt(d);a.preposX=parseInt(b);a.preposY=parseInt(c);a.preposZ=parseInt(d);a.curposX=
parseInt(b);a.curposY=parseInt(c);a.curposZ=parseInt(d);a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_X=parseInt(b);a.move_no_block_old_X=parseInt(b);a.move_moving_X=parseInt(b);a.move_moving_old_X=parseInt(b);a.move_no_block_Y=parseInt(c);a.move_no_block_old_Y=parseInt(c);a.move_moving_Y=parseInt(c);a.move_moving_old_Y=parseInt(c);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1;a.hide=!1};Indoor2DMap.prototype.push_to_GPSdrawlist=function(a,b,c,d,e){for(var f=!1,k=0;k<this.TagGPSDrawList.length;k++){var l=
this.TagGPSDrawList[k];l.nodeid===a&&(0==l.preposLng&&0==l.preposLat?(l.totalposLng=parseFloat(b),l.totalposLat=parseFloat(c),l.count=1):(l.totalposLng+=parseFloat(b),l.totalposLat+=parseFloat(c),l.count++),l.hide=!1,f=!0)}0==f&&(f={},f.nodeid=a,this.reset_GPSdraw_node(f,b,c,d,e),this.TagGPSDrawList.push(f))};Indoor2DMap.prototype.reset_GPSdraw_node=function(a,b,c,d,e){a.buildingid=d;a.floor=e;a.count=0;a.totalposLng=0;a.totalposLat=0;a.preAveragePosLng=parseFloat(b);a.preAveragePosLat=parseFloat(c);
a.preposLng=parseFloat(b);a.preposLat=parseFloat(c);a.curposLng=parseFloat(b);a.curposLat=parseFloat(c);a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_Lng=parseFloat(b);a.move_no_block_old_Lng=parseFloat(b);a.move_moving_Lng=parseFloat(b);a.move_moving_old_Lng=parseFloat(b);a.move_no_block_Lat=parseFloat(c);a.move_no_block_old_Lat=parseFloat(c);a.move_moving_Lat=parseFloat(c);a.move_moving_old_Lat=parseFloat(c);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1};Indoor2DMap.prototype.draw_tag_smooth_move=
function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_smooth_move,1E3,a);else{for(var b=0;b<a.TagDrawList.length;b++){var c=a.TagDrawList[b];if(1!=c.hide){var d=c.curposX-c.preposX,e=c.curposY-c.preposY,f=c.curposZ-c.preposZ,k;5<=Math.sqrt(d*d+e*e+f*f)||10<c.not_move_count?(k=c.draw_loop_index+1,d/=a.move_step_size,e/=a.move_step_size,f/=a.move_step_size,k>=a.move_step_size&&(k=a.move_step_size),d=parseInt(d*k),e=parseInt(e*k),f=parseInt(f*k),c.not_move_count=0,10>a.move_loop_count||(k=c.preposX+d,d=
c.preposY+e,f=c.preposZ+f,a.updateMarker(a.Tags,c.macaddress,c.nodeid,c.nodename,k,d,f,c.buildingid,c.floor,c.date,!0,!0))):c.not_move_count++;c.draw_loop_index++;if(c.draw_loop_index>=a.move_step_size){if(0<c.count){k=parseInt(c.totalposX/c.count);f=parseInt(c.totalposY/c.count);d=parseInt(c.totalposZ/c.count);r=1;c.move_moving_X=parseInt(r*(k-c.move_no_block_old_X));c.move_no_block_X=c.move_moving_X+c.move_no_block_old_X;c.move_moving_old_X=c.move_moving_X;c.move_moving_Y=parseInt(r*(f-c.move_no_block_old_Y));
c.move_no_block_Y=c.move_moving_Y+c.move_no_block_old_Y;c.move_moving_old_Y=c.move_moving_Y;c.move_status+=1;if(6<c.move_status||0>c.move_moving_X*c.move_moving_old_X)c.move_status=1;c.move_no_block_old_X=c.move_no_block_X;c.move_no_block_old_Y=c.move_no_block_Y;c.preposX=c.curposX;c.preposY=c.curposY;c.preposZ=c.curposZ;c.curposX=c.move_no_block_X;c.curposY=c.move_no_block_Y;c.curposZ=d;c.preAveragePosX=parseInt(c.totalposX/c.count);c.preAveragePosY=parseInt(c.totalposY/c.count);c.preAveragePosZ=
parseInt(c.totalposZ/c.count);c.totalposX=0;c.totalposY=0;c.totalposZ=0;c.count=0;c.draw_loop_index=0}c.draw_loop_index>2*a.move_step_size&&(c.preposX=c.curposX,c.preposY=c.curposY,c.preposZ=c.curposZ,c.draw_loop_index=0)}}}a.move_loop_count++;1E4<=a.move_loop_count&&(a.move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_smooth_move,a.smoothing_time/a.move_step_size,a)}};Indoor2DMap.prototype.draw_tag_GPS_smooth_move=function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_GPS_smooth_move,1E3,
a);else{for(var b=0;b<a.TagGPSDrawList.length;b++){var c=a.TagGPSDrawList[b];if(1!=c.hide){var d=c.curposLng-c.preposLng,e=c.curposLat-c.preposLat,f;10<c.not_move_count?(f=c.draw_loop_index+1,d/=a.GPS_move_step_size,e/=a.GPS_move_step_size,f>=a.GPS_move_step_size&&(f=a.GPS_move_step_size),d=parseFloat(d*f),e=parseFloat(e*f),c.not_move_count=0,10>a.GPS_move_loop_count||(f=c.preposLng+d,e=c.preposLat+e,a.updateTagGPS(c.nodeid,f,e))):c.not_move_count++;c.draw_loop_index++;if(c.draw_loop_index>=a.GPS_move_step_size){if(0<
c.count){f=parseFloat(c.totalposLng/c.count);e=parseFloat(c.totalposLat/c.count);d=.1;switch(c.move_status){case 1:case 2:d=.1;break;case 3:case 4:case 5:case 6:d=.8}a.GPS_smoothing_time=.1==d?200:.4==d?400:800;c.move_moving_Lng=parseFloat(d*(f-c.move_no_block_old_Lng));c.move_no_block_Lng=c.move_moving_Lng+c.move_no_block_old_Lng;c.move_moving_old_Lng=c.move_moving_Lng;c.move_moving_Lat=parseFloat(d*(e-c.move_no_block_old_Lat));c.move_no_block_Lat=c.move_moving_Lat+c.move_no_block_old_Lat;c.move_moving_old_Lat=
c.move_moving_Lat;c.move_status+=1;if(6<c.move_status||0>c.move_moving_Lng*c.move_moving_old_Lng)c.move_status=1;c.move_no_block_old_Lng=c.move_no_block_Lng;c.move_no_block_old_Lat=c.move_no_block_Lat;c.preposLng=c.curposLng;c.preposLat=c.curposLat;c.curposLng=c.move_no_block_Lng;c.curposLat=c.move_no_block_Lat;c.preAveragePosX=parseFloat(c.totalposLng/c.count);c.preAveragePosY=parseFloat(c.totalposLat/c.count);c.totalposLng=0;c.totalposLat=0;c.count=0;c.draw_loop_index=0}c.draw_loop_index>2*a.GPS_move_step_size&&
(c.preposLng=c.curposLng,c.preposLat=c.curposLat,c.draw_loop_index=0)}}}a.GPS_move_loop_count++;1E4<=a.GPS_move_loop_count&&(a.GPS_move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_GPS_smooth_move,a.GPS_smoothing_time/a.GPS_move_step_size,a)}};Indoor2DMap.prototype.update_alert_circle=function(a){a.update_tag_alert_circle();a.update_tag_GPS_alert_circle();a.update_locator_alert_circle();setTimeout(a.update_alert_circle,100,a)};Indoor2DMap.prototype.update_tag_alert_circle=function(){for(var a=
0;a<this.TagDrawList.length;a++){var b=this.TagDrawList[a];if(1!=b.hide){var c=b.alertcircle;if(void 0!=c&&null!=c){var d=c.options.opacity,e=d,f=c.options.radius,k=f;.2==d?5<f?k=f-5:e=.3:20<f?e=.2:k=f+5;d=this.getTargetNode(b.nodeid);c.setStyle({radius:k,opacity:e});c.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[b.nodeid]&&(this.AlertIconScaleIndexList[b.nodeid]=0);c=this.AlertIconScaleIndexList[b.nodeid];0==this.NodeAlertFunction[b.nodeid]?d.setIcon(this.AlertIconScaleUpDownList[0]):
d.setIcon(this.AlertIconScaleUpDownList[c]);c++;10<=c&&(c=0);this.AlertIconScaleIndexList[b.nodeid]=c}}}};Indoor2DMap.prototype.update_tag_GPS_alert_circle=function(){for(var a=0;a<this.TagGPSDrawList.length;a++){var b=this.TagGPSDrawList[a];if(1!=b.hide){var c=b.alertcircle;if(void 0!=c&&null!=c){var d=c.options.opacity,e=d,f=c.options.radius,k=f;.2==d?5<f?k=f-5:e=.3:20<f?e=.2:k=f+5;d=this.getTargetNode(b.nodeid);c.setStyle({radius:k,opacity:e});c.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[b.nodeid]&&
(this.AlertIconScaleIndexList[b.nodeid]=0);c=this.AlertIconScaleIndexList[b.nodeid];d.setIcon(this.AlertIconScaleUpDownList[c]);c++;10<=c&&(c=0);this.AlertIconScaleIndexList[b.nodeid]=c}}}};Indoor2DMap.prototype.update_locator_alert_circle=function(){for(var a=0;a<this.Locators.length;a++){var b=this.Locators[a],c=b.alertcircle;if(void 0!=c&&null!=c){var d=c.options.opacity,e=d,f=c.options.radius,k=f;.2==d?5<f?k=f-5:e=.3:20<f?e=.2:k=f+5;d=this.getTargetLocatorNode(b.nodeid);c.setStyle({radius:k,opacity:e});
c.setLatLng(b.getLatLng());void 0==this.AlertIconScaleIndexList[b.nodeid]&&(this.AlertIconScaleIndexList[b.nodeid]=0);c=this.AlertIconScaleIndexList[b.nodeid];d.setIcon(this.AlertIconScaleUpDownList[c]);c++;10<=c&&(c=0);this.AlertIconScaleIndexList[b.nodeid]=c}}};Indoor2DMap.prototype.convertToLatLng=function(a,b,e){var f=FloatDiv(parseFloat(e),11057400);FloatMul(f,11057400);e=a.mWGS48OriginY+FloatDiv(parseFloat(e),11057400);b=a.mWGS48OriginX+d(e,parseFloat(b));return a.mRotateMap?a.rotateLatLng(e,
b):c(b,e)};Indoor2DMap.prototype.rotateLatLng=function(a,b){var c=new L.latLng(a,b),d=new L.latLng(this.mWGS48OriginY,this.mWGS48OriginX);return rotatePoint(c,this.mMAP_North,d)};this.mMap.on("overlayadd",this.onOverlayAdd);this.mMap.on("overlayremove ",this.onOverlayRemove);this.create_alert_scale_icon();this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,2E3,this),setTimeout(this.draw_tag_GPS_smooth_move,2E3,this));setTimeout(this.update_alert_circle,2E3,this)};
$(document).ready(function(){$(".colorpicker").each(function(){$(this).minicolors({changeDelay:200,format:"hex",position:"bottom left",theme:"bootstrap",opacity:$(this).attr("data-opacity"),change:function(a,d){console.log("change() fillColorhex:"+a+", opacity:"+d);var b=parseInt(255*d).toString(16);$("#areacolor_input").val(a+b)},theme:"default"})})});var Node_Updateing=!1,glLiveCount=100,glAnchor_List=[],glTag_List=[],glCoord_List=[],glLocator_List=[],glSensor_List=[],glUser_List=[],gl_anchor_num=0,gl_tag_num=0,gl_coord_num=0,gl_locator_num=0,gl_sensor_num=0,gl_anchor_load_index=0,gl_tag_load_index=0,gl_coord_load_index=0,gl_locator_load_index=0,gl_sensor_load_index=0,gl_user_load_index=0,gl_tag_alert_count=0,gl_locator_alert_count=0,gl_rollcall_all_tag=[],gl_rollcall_area_tag=[],gl_rollcall_none_tag=[],gl_rollcall_tag_load_index=0,gl_rollcall_areaid=
"",gl_rollcall_areaname="",gl_rollcall_tag_num=0,LOAD_DEVICE_NUM=20,glCurrentMapIndex=0,glLiveMapList=[],glEditMode=!1,glRefreshAll=!1,glShowDefaultNode=!0,glShowDefaultNodeId=show_nodeid,glShowDefaultNodeMapLayer=0,gl_usermaingroups=[];load_usermaingroup();
function load_usermaingroup(){gl_usermaingroups=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadmaingroup=1&project_id="+project_id,function(a){$.each(a,function(a,b){b.id=parseInt(b.id);gl_usermaingroups.push(b)})}).success(function(){load_map_config(0)}).error(function(){}).complete(function(){})}
function load_map_config(a){glEditMode=!1;glRefreshAll=!0;glCurrentMapIndex=a;glLiveMapList=[];$.getJSON(gl_target_server+"/php/map.php","loadmap=1&project_id="+project_id,function(a){for(var b=document.getElementById("map_nav_tabs");b.firstChild;)b.removeChild(b.firstChild);for(b=document.getElementById("map_tab_content");b.firstChild;)b.removeChild(b.firstChild);console.log("load_map_config() glCurrentMapIndex:"+glCurrentMapIndex+" mapsdata.length:"+a.length);var c=0;$.each(a,function(a,b){add_map(a,
b);c++});1==GL_CONFIG_EDIT_2DMAP&&add_create_new_layer_btn(c);runLive_all()});return!1}
function add_map(a,d){var b=create_map_tab(a,d);document.getElementById("map_nav_tabs").appendChild(b);b=create_map_content(a,d);document.getElementById("map_tab_content").appendChild(b);b=new Indoor2DMap("mapid_"+a);glLiveMapList.push(b);b.setMapCoeff(d.POSX,d.POSY,d.MAPWIDTH,d.MAPHEIGHT,d.SCALE,d.COEFF,d.WGS48OriginX,d.WGS48OriginY,d.MAP_North);b.setMapImage(d.FILE,"Indoor 2D Map "+a);b.setMapLayerInfo(d.layerid);b.addOriginMarker(0,0,0);console.log("add_map() ui_index:"+a);b.load_maparea();1==
GL_CONFIG_2DMAP_SHOW_GMAP&&b.showGoolgeMap();1==GL_CONFIG_EDIT_2DMAP&&b.createMapEditor(editmode_click);b.setNodeDragCallback(update_map_node_info);b.setOrigNodeDragCallback(update_orig_node_info);b.setUpdateMapInfoCallback(update_map_info);b.setNodeClickCallback(node_click)}
function create_map_tab(a,d){var b=document.createElement("li");b.setAttribute("id","map_tab_li_"+a);a==glCurrentMapIndex&&b.setAttribute("class","active");var c=document.createElement("a");c.setAttribute("href","#map_tab_"+a);c.setAttribute("data-toggle","tab");c.setAttribute("id","map_tab_href_"+a);c.setAttribute("onclick","map_tab_onclick("+a+', "'+d.layerid+'", "'+d.layer_name+'");return false;');var e=document.createElement("span");e.setAttribute("class","badge bg-blue-active");e.setAttribute("id",
"layer_name_"+a);e.textContent=d.layer_name;c.appendChild(e);b.appendChild(c);return b}
function create_map_content(a,d){var b=document.createElement("div");a==glCurrentMapIndex?b.setAttribute("class","tab-pane active"):b.setAttribute("class","tab-pane");b.setAttribute("id","map_tab_"+a);var c=getMainGroupInfo(d.maingroupid),e=document.createElement("div");b.appendChild(e);if(void 0!=c){var f=document.createElement("strong");f.innerHTML="\u4e3b\u96c6\u5408:"+c.name+"[ ID:"+c.id+" ]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";f.setAttribute("style","font-weight:bold;");e.appendChild(f)}c=document.createElement("strong");
c.innerHTML=d.layer_description+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("style","font-weight:bold;");c.setAttribute("id","layer_description_"+a);c.setAttribute("onclick","layer_description_onclick("+a+', "'+d.layerid+'", "'+d.layer_description+'");return false;');e.appendChild(c);c=document.createElement("i");c.setAttribute("class","fa fa-map-marker margin-r-5");c.setAttribute("style","color:#1a1;");e.appendChild(c);c=document.createElement("strong");c.innerHTML=d.WGS48OriginX+"&nbsp;&nbsp;&nbsp";
c.setAttribute("id","WGS48OriginX_"+a);c.setAttribute("onclick","WGS48OriginX_onclick("+a+', "'+d.layerid+'", "'+d.WGS48OriginX+'");return false;');c.setAttribute("style","color:#1a1;");e.appendChild(c);c=document.createElement("strong");c.innerHTML=d.WGS48OriginY+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("id","WGS48OriginY_"+a);c.setAttribute("onclick","WGS48OriginY_onclick("+a+', "'+d.layerid+'", "'+d.WGS48OriginY+'");return false;');c.setAttribute("style","color:#1a1;");e.appendChild(c);
c=document.createElement("i");c.setAttribute("class","fa fa-compass margin-r-5");c.setAttribute("style","color:#811;");e.appendChild(c);c=document.createElement("strong");c.innerHTML=d.MAP_North+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("id","MAP_North_"+a);c.setAttribute("onclick","MAP_North_onclick("+a+', "'+d.layerid+'", "'+d.MAP_North+'");return false;');c.setAttribute("style","color:#822;");e.appendChild(c);c=document.createElement("strong");c.innerHTML="Building:&nbsp;"+d.BuildingID+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
c.setAttribute("id","BuildingID_"+a);c.setAttribute("onclick","BuildingID_onclick("+a+', "'+d.layerid+'", "'+d.BuildingID+'");return false;');c.setAttribute("style","color:#328;");e.appendChild(c);c=document.createElement("strong");c.innerHTML="Floor:&nbsp;"+d.BuildingFloor;c.setAttribute("id","BuildingFloor_"+a);c.setAttribute("onclick","BuildingFloor_onclick("+a+', "'+d.layerid+'", "'+d.BuildingFloor+'");return false;');c.setAttribute("style","color:#328;");e.appendChild(c);e=document.createElement("button");
e.setAttribute("id","DeleteMapLayer_Btn_"+a);e.setAttribute("style","display:none;");e.setAttribute("title","Delete this Group");e.setAttribute("class","btn btn-danger pull-right");e.setAttribute("href","javascript:;");e.setAttribute("onclick","delete_maplayer_onclick("+a+',"'+d.layerid+'", "'+d.layer_name+'");return false;');c=document.createElement("i");c.setAttribute("class","fa fa-trash-o");e.appendChild(c);b.appendChild(e);e=document.createElement("form");e.setAttribute("id","formContent_"+a);
e.setAttribute("method","POST");e.setAttribute("enctype","multipart/form-data");e.setAttribute("onsubmit","return submit_newmap(this, "+a+',"'+d.layerid+'");');b.appendChild(e);c=document.createElement("div");c.setAttribute("id","ChangeMap_"+a);c.setAttribute("class","form-group");c.setAttribute("style","display:none;");e.appendChild(c);e=document.createElement("label");e.setAttribute("class","control-sidebar-subheading");e.innerHTML="\u66f4\u63db\u5730\u5716";c.appendChild(e);c=document.createElement("input");
c.setAttribute("id","imageUpload_"+a);c.setAttribute("type","file");c.setAttribute("name","imageUpload");e.appendChild(c);c=document.createElement("img");c.setAttribute("id","uploadIm_"+a);c.setAttribute("src","/images/load.gif");c.setAttribute("style","display: none;");e.appendChild(c);c=document.createElement("p");c.setAttribute("id","upload_msg_"+a);c.setAttribute("class","help-block");e.appendChild(c);c=document.createElement("button");c.setAttribute("class","btn btn-primary");e.appendChild(c);
e=document.createElement("i");e.setAttribute("class","fa fa-cloud-upload");c.appendChild(e);e=document.createElement("pad");e.setAttribute("class","pad");b.appendChild(e);c=document.createElement("div");c.setAttribute("id","mapid_"+a);c.setAttribute("style","height:85vh");e.appendChild(c);return b}
function add_create_new_layer_btn(a){var d=document.createElement("li");d.setAttribute("id","map_tab_li_"+a);var b=document.createElement("a");b.setAttribute("onclick","create_tab_onclick("+a+");return false;");a=document.createElement("span");a.setAttribute("class","badge bg-red");a.textContent="\u65b0\u589e\u5730\u5716+";b.appendChild(a);d.appendChild(b);document.getElementById("map_nav_tabs").appendChild(d)}
function runLive_all(){null!=glLiveMapList[glCurrentMapIndex]&&$.getJSON(gl_target_server+"/php/vilsnodes.php","devicescount=1&project_id="+project_id,function(a){gl_anchor_num=parseInt(a.LOC_ANCHOR_NUM);gl_tag_num=parseInt(a.LOC_TAG_NUM);gl_coord_num=parseInt(a.LOC_COORD_NUM);gl_locator_num=parseInt(a.LOC_LOCATOR_NUM);gl_sensor_num=parseInt(a.LOC_SENSOR_NUM);gl_sensor_load_index=gl_locator_load_index=gl_coord_load_index=gl_tag_load_index=gl_anchor_load_index=0;glRefreshAll=!1}).success(function(){setTimeout(runLive_anchor,
200);setTimeout(runLive_tag,300);setTimeout(runLive_coord,400);setTimeout(runLive_locator,500);setTimeout(runLive_sensor,100);setTimeout(runLive_user,200)}).error(function(){setTimeout(runLive_all,5E3)}).complete(function(){})}
function runLive_anchor(){glRefreshAll?console.log("runLive_anchor() glRefreshAll"):Node_Updateing||glLiveMapList[glCurrentMapIndex].editmode()?setTimeout(runLive_anchor,3E3):gl_anchor_load_index>=gl_anchor_num?(gl_anchor_load_index=0,setTimeout(runLive_anchor,3E4)):(0==gl_anchor_load_index&&(glAnchor_List=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadanchor=1&s="+gl_anchor_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var d=parseInt(a.LOC_ANCHOR_NUM),b=
gl_anchor_load_index;b<gl_anchor_load_index+d;++b){var c="LOC_ANCHOR_INDEX_"+b;if(void 0!=a[c]&&null!=a[c]){var c=a[c].split(","),e=c[6],f=c[3],k=c[5],n=c[7],m=c[8],l=c[9],A=c[13],z=c[14],w=c[20];"0"==w&&(w=getFirstMapLayer());var B=new moment;if(glRefreshAll){console.log("runLive_anchor() glRefreshAll");return}for(var u=0;u<glLiveMapList.length;u++)glLiveMapList[u].updateAnchorMarker(e,f,k,n,m,l,A,z,B,w);glAnchor_List.push(c)}}gl_anchor_load_index+=d}).success(function(){glRefreshAll?console.log("runLive_anchor() glRefreshAll"):
gl_anchor_load_index>=gl_anchor_num?(gl_anchor_load_index=0,setTimeout(runLive_anchor,3E4)):runLive_anchor()}).error(function(){gl_anchor_load_index=0;setTimeout(runLive_anchor,3E4)}).complete(function(){}))}
function runLive_tag(){if(glRefreshAll)console.log("runLive_tag() glRefreshAll");else if(Node_Updateing||glLiveMapList[glCurrentMapIndex].editmode())setTimeout(runLive_tag,1E3);else if(gl_tag_load_index>=gl_tag_num)gl_tag_alert_count=gl_tag_load_index=0,setTimeout(runLive_tag,300);else{0==gl_tag_load_index&&(glTag_List=[]);var a=document.getElementById("showtrack").checked;glLiveMapList[glCurrentMapIndex].setShowTrack(a);a=document.getElementById("uismoothingcheckbtn").checked;glLiveMapList[glCurrentMapIndex].setUISmoothing(a);
$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtag=1&s="+gl_tag_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var b=parseInt(a.LOC_TAG_NUM),c=-1,e=!1,f=gl_tag_load_index;f<gl_tag_load_index+b;++f){var k="LOC_TAG_INDEX_"+f;if(void 0!=a[k]&&null!=a[k]){var k=a[k].split(","),n=k[1],m=k[6],l=k[3],A=k[5],z=k[7],w=k[8],B=k[9],u=k[13],E=k[14],F=k[19],x=k[20],C=parseInt(k[22]),G=k[23],q=parseFloat(k[24]),M=parseFloat(k[25]),N=k[26],t=k[27],J=k[28],O=parseInt(k[32]),
P=parseInt(k[35]),D=k[36];"0"==D&&(D=getFirstMapLayer());void 0!=glShowDefaultNodeId&&glShowDefaultNodeId===l&&(glShowDefaultNodeMapLayer=D);if(glRefreshAll){console.log("runLive_tag() glRefreshAll");return}var Q=new moment,h=!1;if("3"==t)for(h=!0,t=0;t<glLiveMapList.length;t++)glLiveMapList[t].setTagLngLat(l,q,M,u,E);q=C;0!=q&&(gl_tag_alert_count+=1);for(t=0;t<glLiveMapList.length;t++)if(glLiveMapList[t].updateTagMarker(m,l,A,z,w,B,u,E,Q,h,D)||(e=!0),glLiveMapList[t].mMapLayerId==D||0==t&&"0"==D)0>
c&&0!=C&&1==glLiveMapList[t].NodeAlertFunction[l]&&(c=t),glLiveMapList[t].setTagAlert(l,q),glLiveMapList[t].setTagLocation(l,q,F,x,G,n,N,J,h,O,P);glTag_List.push(k)}}e&&create_dropdown_taglist();gl_tag_load_index+=b;0<=c&&$("#map_tab_href_"+c).trigger("click")}).success(function(){glRefreshAll?console.log("runLive_tag() glRefreshAll"):gl_tag_load_index>=gl_tag_num?(0==gl_tag_alert_count&&glLiveMapList[glCurrentMapIndex].check_tag_layer_alertcircle(),gl_tag_alert_count=gl_tag_load_index=0,setTimeout(runLive_tag,
300),glShowDefaultNode&&0<glShowDefaultNodeId.length&&1==dropdown_tag_click(glShowDefaultNodeId,glShowDefaultNodeMapLayer)&&(console.log("runLive_tag() glShowDefaultNodeMapLayer:"+glShowDefaultNodeMapLayer+" glShowDefaultNodeId:"+glShowDefaultNodeId),glShowDefaultNode=!1,glShowDefaultNodeId="")):runLive_tag()}).error(function(){gl_tag_alert_count=gl_tag_load_index=0;setTimeout(runLive_tag,300)}).complete(function(){})}}
function runLive_coord(){glRefreshAll?console.log("runLive_coord() glRefreshAll"):Node_Updateing||glLiveMapList[glCurrentMapIndex].editmode()?setTimeout(runLive_coord,3E3):gl_coord_load_index>=gl_coord_num?(gl_coord_load_index=0,setTimeout(runLive_coord,3E4)):(0==gl_coord_load_index&&(glCoord_List=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadcoord=1&s="+gl_coord_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var d=parseInt(a.LOC_COORD_NUM),b=gl_coord_load_index;b<
gl_coord_load_index+d;++b){var c="LOC_COORD_INDEX_"+b;if(void 0!=a[c]&&null!=a[c]){var c=a[c].split(","),e=c[6],f=c[3],k=c[5],n=c[7],m=c[8],l=c[9],A=c[13],z=c[14],w=c[26];"0"==w&&(w=getFirstMapLayer());var B=new moment;if(glRefreshAll){console.log("runLive_coord() glRefreshAll");return}for(var u=0;u<glLiveMapList.length;u++)glLiveMapList[u].updateCoordinatorMarker(e,f,k,n,m,l,A,z,B,w);glCoord_List.push(c)}}gl_coord_load_index+=d}).success(function(){glRefreshAll?console.log("runLive_coord() glRefreshAll"):
gl_coord_load_index>=gl_coord_num?(gl_coord_load_index=0,setTimeout(runLive_coord,1E4)):runLive_coord()}).error(function(){gl_coord_load_index=0;setTimeout(runLive_coord,300)}).complete(function(){}))}
function runLive_locator(){glRefreshAll?console.log("runLive_locator() glRefreshAll"):Node_Updateing||glLiveMapList[glCurrentMapIndex].editmode()?setTimeout(runLive_locator,3E3):gl_locator_load_index>=gl_locator_num?(gl_locator_alert_count=gl_locator_load_index=0,setTimeout(runLive_locator,300)):(0==gl_locator_load_index&&(glLocator_List=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadlocator=1&s="+gl_locator_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){for(var d=
parseInt(a.LOC_LOCATOR_NUM),b=-1,c=!1,e=gl_locator_load_index;e<gl_locator_load_index+d;++e){var f="LOC_LOCATOR_INDEX_"+e;if(void 0!=a[f]&&null!=a[f]){var f=a[f].split(","),k=parseInt(f[1]),n=f[6],m=f[3],l=f[5],A=f[7],z=f[8],w=f[9],B=f[13],u=f[14],E=parseInt(f[20]),F=f[22],x=f[26],C=f[29],G=moment(f[28],"YYYY-MM-DD HH:mm:ss"),q=moment(C,"YYYY-MM-DD HH:mm:ss"),C=0;G>q&&(C=1);"0"==x&&(x=getFirstMapLayer());void 0!=glShowDefaultNodeId&&(glShowDefaultNodeId===m&&(glShowDefaultNodeMapLayer=x),glShowDefaultNodeId===
n&&(glShowDefaultNodeId=m,glShowDefaultNodeMapLayer=x),glShowDefaultNodeId===F&&(glShowDefaultNodeId=m,glShowDefaultNodeMapLayer=x));F=new moment;if(glRefreshAll){console.log("runLive_locator() glRefreshAll");return}G=E;0!=E&&(gl_locator_alert_count+=1);for(q=0;q<glLiveMapList.length;q++)if(glLiveMapList[q].updateLocatorMarker(n,m,l,A,z,w,B,u,F,x)||(c=!0),glLiveMapList[q].mMapLayerId==x||0==q&&"0"==x)0>b&&0!=E&&1==glLiveMapList[q].NodeAlertFunction[m]&&(b=q),glLiveMapList[q].setLocatorAlert(m,G,k,
C);glLocator_List.push(f)}}c&&create_dropdown_locatorlist();gl_locator_load_index+=d;0<=b&&$("#map_tab_href_"+b).trigger("click")}).success(function(){glRefreshAll?console.log("runLive_locator() glRefreshAll"):gl_locator_load_index>=gl_locator_num?(0==gl_locator_alert_count&&glLiveMapList[glCurrentMapIndex].check_locator_layer_alertcircle(),gl_locator_alert_count=gl_locator_load_index=0,setTimeout(runLive_locator,300),glShowDefaultNode&&0<glShowDefaultNodeId.length&&1==dropdown_locator_click(glShowDefaultNodeId,
glShowDefaultNodeMapLayer)&&(console.log("runLive_locator() glShowDefaultNodeMapLayer:"+glShowDefaultNodeMapLayer+" glShowDefaultNodeId:"+glShowDefaultNodeId),glShowDefaultNode=!1,glShowDefaultNodeId="")):runLive_locator()}).error(function(){gl_locator_alert_count=gl_locator_load_index=0;setTimeout(runLive_locator,300)}).complete(function(){}))}
function runLive_sensor(){glRefreshAll?console.log("runLive_sensor() glRefreshAll"):Node_Updateing||glLiveMapList[glCurrentMapIndex].editmode()?setTimeout(runLive_sensor,3E3):gl_sensor_load_index>=gl_sensor_num?(gl_sensor_load_index=0,setTimeout(runLive_sensor,5E3)):(0==gl_sensor_load_index&&(glSensor_List=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadsensordevice=1&s="+gl_sensor_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){$.each(a,function(a,b){for(a=0;a<
glLiveMapList.length;a++){var c=getFirstMapLayer();b.maplayer=c;glLiveMapList[a].updateSensorMarker(b.id,b.name,b.type,b.Longitude,b.Latitude,c,b.Battery,b.unknownLocation);void 0!=glShowDefaultNodeId&&glShowDefaultNodeId===b.id&&(glShowDefaultNodeMapLayer=c)}gl_sensor_load_index+=1;glSensor_List.push(b)})}).success(function(){if(glRefreshAll)console.log("runLive_sensor() glRefreshAll");else if(gl_sensor_load_index>=gl_sensor_num){if(gl_sensor_load_index=0,setTimeout(runLive_sensor,5E3),glShowDefaultNode&&
0<glShowDefaultNodeId.length)for(var a=0;a<glSensor_List.length;a++)if(glSensor_List[a].id===glShowDefaultNodeId){console.log("runLive_sensor() glShowDefaultNodeMapLayer:"+glShowDefaultNodeMapLayer+" glShowDefaultNodeId:"+glShowDefaultNodeId);searchresult_sensor_click(glShowDefaultNodeId,glShowDefaultNodeMapLayer);glShowDefaultNode=!1;glShowDefaultNodeId="";break}}else setTimeout(runLive_sensor,50)}).error(function(){gl_sensor_load_index=0;setTimeout(runLive_sensor,300)}).complete(function(){}))}
function runLive_user(){if(glRefreshAll)console.log("runLive_user() glRefreshAll");else if(Node_Updateing||glLiveMapList[glCurrentMapIndex].editmode())setTimeout(runLive_user,3E3);else{0==gl_user_load_index&&(glUser_List=[]);var a=0;$.getJSON(gl_target_server+"/php/vilsnodes.php","loaduserpoistioninfo=1&s="+gl_user_load_index+"&count=500&project_id="+project_id,function(d){$.each(d,function(b,c){c.userid=parseInt(c.userid);for(b=0;b<glLiveMapList.length;b++)glLiveMapList[b].updateUserMarker(c.userid,
c.name,c.maplayer,c.posX,c.posY,c.posZ,c.Longitude,c.Latitude),void 0!=glShowDefaultNodeId&&isANumber(glShowDefaultNodeId)&&parseInt(glShowDefaultNodeId)==c.userid&&(console.log("runLive_user() glShowDefaultNodeMapLayer:"+glShowDefaultNodeMapLayer+" glShowDefaultNodeId:"+glShowDefaultNodeId),glShowDefaultNodeMapLayer=c.maplayer);a+=1;gl_user_load_index+=1;glUser_List.push(c)})}).success(function(){glRefreshAll?console.log("runLive_user() glRefreshAll"):500>a?(create_dropdown_userlist(),gl_user_load_index=
0,setTimeout(runLive_user,5E3),glShowDefaultNode&&(0<glShowDefaultNodeId.length&&searchresult_user_click(glShowDefaultNodeId,glShowDefaultNodeMapLayer),glShowDefaultNode=!1,glShowDefaultNodeId="")):setTimeout(runLive_user,50)}).error(function(){gl_user_load_index=0;setTimeout(runLive_user,300)}).complete(function(){})}}
function create_dropdown_userlist(){for(var a=document.getElementById("dropdown_tags"),d=0;d<glUser_List.length;d++){var b=glUser_List[d],b=create_dropdown_user_item(d,b.userid,b.name,b.maplayer);null!=b&&a.appendChild(b)}}
function create_dropdown_user_item(a,d,b,c){a=document.getElementById("dropdown_checkbox_user_"+d);if(void 0!=a)return null;a=document.createElement("li");var e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("tabIndex","-1");e.setAttribute("data-value",d);e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_user_click("'+d+'", "'+c+'");return true;');c=document.createElement("input");c.setAttribute("type","checkbox");c.setAttribute("id","dropdown_checkbox_user_"+
d);c.setAttribute("onclick",'dropdown_checkbox_user_click("'+d+'");return true;');c.checked=!1;e.appendChild(c);e.appendChild(document.createTextNode(" "+b));a.appendChild(e);return a}var PosDiff=[];
function test_calculate_Standard_Deviation(a,d){for(var b=null,c=null,e=0;e<glTag_List.length;++e){var f=glTag_List[e],k=f[3];k==a?b=f:k==d&&(c=f)}if(null!=b&&null!=c){c=calculate_distance(Number(b[7]),Number(b[8]),Number(b[9]),Number(c[7]),Number(c[8]),Number(c[9]));for(b=e=0;19>b;b++)void 0==PosDiff[b+1]&&(PosDiff[b+1]=0),PosDiff[b]=PosDiff[b+1],e+=PosDiff[b];PosDiff[19]=c;c=(e+c)/20;for(b=e=0;19>b;b++)e+=Math.pow(PosDiff[b]-c,2);return Math.sqrt(e/30)}}
function calculate_distance(a,d,b,c,e,f){a-=c;d-=e;b-=f;return Math.sqrt(a*a,d*d,b*b)}function areaname_save(){var a=glLiveMapList[glCurrentMapIndex];a.areaname_save(a)}
function map_tab_onclick(a,d,b){glEditMode?1==glEditMode&&a==glCurrentMapIndex&&(b=prompt("Edit Layer Name:",b))&&(console.log("map_tab_onclick() newValue:"+b),document.getElementById("map_tab_href_"+a).setAttribute("onclick","map_tab_onclick("+a+', "'+d+'", "'+b+'");return false;'),document.getElementById("layer_name_"+a).innerHTML=b,update_maplayer_info(d,"layer_name",b)):(glCurrentMapIndex=a,glLiveMapList[a].refresh())}
function create_tab_onclick(a){glEditMode||(a=prompt("\u65b0\u589e\u5730\u5716\u5716\u5c64, \u5730\u5716\u540d\u7a31:","\u5730\u5716"+parseInt(glLiveMapList.length+1)))&&create_maplayer(a,create_finish,glLiveMapList.length)}function create_finish(a){load_map_config(a)}function delete_maplayer_onclick(a,d,b){confirm("Are you sure you want to delete this Map Layer:"+b+" ?")&&delete_maplayer(d,delete_finish)}function delete_finish(){load_map_config(0)}
function editmode_click(a){glEditMode=a;for(var d=0;d<glLiveMapList.length;d++){var b=document.getElementById("map_tab_li_"+d),c=document.getElementById("map_tab_href_"+d);1==a?d==glCurrentMapIndex?enable_editmode(glCurrentMapIndex):(b.setAttribute("class","disabled"),c.setAttribute("data-toggle","")):(disable_editmode(d),d==glCurrentMapIndex?b.setAttribute("class","active"):b.setAttribute("class",""),c.setAttribute("data-toggle","tab"))}}
function enable_editmode(a){document.getElementById("layer_description_"+a).setAttribute("style","font-weight:bold;border:thin dotted red;");document.getElementById("WGS48OriginX_"+a).setAttribute("style","border:thin dotted red;");document.getElementById("WGS48OriginY_"+a).setAttribute("style","border:thin dotted red;");document.getElementById("MAP_North_"+a).setAttribute("style","border:thin dotted red;");document.getElementById("BuildingID_"+a).setAttribute("style","border:thin dotted red;");document.getElementById("BuildingFloor_"+
a).setAttribute("style","border:thin dotted red;");document.getElementById("ChangeMap_"+a).setAttribute("style","display:block;");document.getElementById("DeleteMapLayer_Btn_"+a).setAttribute("style","display:block;")}
function disable_editmode(a){document.getElementById("layer_description_"+a).setAttribute("style","font-weight:bold;");document.getElementById("WGS48OriginX_"+a).setAttribute("style","border:;");document.getElementById("WGS48OriginY_"+a).setAttribute("style","border:;");document.getElementById("MAP_North_"+a).setAttribute("style","border:;");document.getElementById("BuildingID_"+a).setAttribute("style","border:;");document.getElementById("BuildingFloor_"+a).setAttribute("style","border:;");document.getElementById("ChangeMap_"+
a).setAttribute("style","display:none;");document.getElementById("DeleteMapLayer_Btn_"+a).setAttribute("style","display:none;")}
function layer_description_onclick(a,d,b){if(1==glEditMode&&(b=prompt("Edit Layer Description:",b))){console.log("layer_description_onclick() newValue:"+b);var c=document.getElementById("layer_description_"+a);c.innerHTML=b+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("onclick","layer_description_onclick("+a+', "'+d+'", "'+b+'");return false;');update_maplayer_info(d,"layer_description",b)}}
function WGS48OriginX_onclick(a,d,b){if(1==glEditMode&&(b=prompt("Edit GPS WGS48O Origin Longitude:",b))){console.log("WGS48OriginX_onclick() newValue:"+b);var c=document.getElementById("WGS48OriginX_"+a);c.innerHTML=b+"&nbsp;&nbsp;&nbsp";c.setAttribute("onclick","WGS48OriginX_onclick("+a+', "'+d+'", "'+b+'");return false;');update_maplayer_info(d,"WGS48OriginX",b)}}
function WGS48OriginY_onclick(a,d,b){if(1==glEditMode&&(b=prompt("Edit GPS WGS48O Origin Latitude:",b))){console.log("WGS48OriginY_onclick() newValue:"+b);var c=document.getElementById("WGS48OriginY_"+a);c.innerHTML=b+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("onclick","WGS48OriginY_onclick("+a+', "'+d+'", "'+b+'");return false;');update_maplayer_info(d,"WGS48OriginY",b)}}
function MAP_North_onclick(a,d,b){if(1==glEditMode&&(b=prompt("Edit GPS WGS48O Origin North:",b))){console.log("MAP_North_onclick() newValue:"+b);var c=document.getElementById("MAP_North_"+a);c.innerHTML=b+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("onclick","MAP_North_onclick("+a+', "'+d+'", "'+b+'");return false;');update_maplayer_info(d,"MAP_North",b)}}
function BuildingID_onclick(a,d,b){if(1==glEditMode&&(b=prompt("Edit Building:",b))){console.log("BuildingID_onclick() newValue:"+b);var c=document.getElementById("BuildingID_"+a);c.innerHTML="Building:&nbsp;"+b+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("onclick","BuildingID_onclick("+a+', "'+d+'", "'+b+'");return false;');update_maplayer_info(d,"BuildingID",b)}}
function BuildingFloor_onclick(a,d,b){if(1==glEditMode&&(b=prompt("Edit Building Floor:",b))){console.log("BuildingFloor_onclick() newValue:"+b);var c=document.getElementById("BuildingFloor_"+a);c.innerHTML="Floor:&nbsp;"+b+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";c.setAttribute("onclick","BuildingFloor_onclick("+a+', "'+d+'", "'+b+'");return false;');update_maplayer_info(d,"BuildingFloor",b)}}function node_click(a){}
window.addEventListener("load",function(){var a=document.getElementById("preventPullToRefresh"),d=document.getElementById("preventOverscrollGlow"),b=document.getElementById("preventScroll"),c=!1,e=0;document.addEventListener("touchstart",function(b){1==b.touches.length&&(e=b.touches[0].clientY,c=a.checked&&0==window.pageYOffset)},{passive:!1});document.addEventListener("touchmove",function(a){var k=a.touches[0].clientY,n=k-e;e=k;if(c&&(c=!1,0<n)){a.preventDefault();return}b.checked?a.preventDefault():
d.checked&&0==window.pageYOffset&&0<n&&a.preventDefault()},{passive:!1})});var DUMP_TIME=10,DumpTime=DUMP_TIME;
function DumpRangingResult(){if(DumpTime>=DUMP_TIME){var a=document.getElementById("dumprangingresulttimeout").value;DumpTime=DUMP_TIME=a;document.getElementById("dumprangingresultbtn").disabled=!0;document.getElementById("dumprangingresultbtn").innerHTML="Dump Ranging Result("+DumpTime+" Seconds)";document.getElementById("dumprangingresulttimeout").disabled=!0;var d=gl_target_server+"/php/vilsnodes.php",b={};b.project_id=""+project_id;b.DUMP_RANGING_RESULT=a;jQuery.ajax({url:d,type:"POST",data:b,
success:function(a){},error:function(a,b,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}});DumpTime--;setTimeout(DumpRangingResult,1E3)}else 0<=DumpTime?(document.getElementById("dumprangingresultbtn").disabled=!0,document.getElementById("dumprangingresultbtn").innerHTML="Dump Ranging Result("+DumpTime+" Seconds)",document.getElementById("dumprangingresulttimeout").disabled=!0,DumpTime--,setTimeout(DumpRangingResult,1E3)):(DumpTime=DUMP_TIME,document.getElementById("dumprangingresultbtn").disabled=
!1,document.getElementById("dumprangingresultbtn").innerHTML="Dump Ranging Result("+DumpTime+" Seconds)",document.getElementById("dumprangingresulttimeout").disabled=!1)}function DumpAoARangingLog(){var a=gl_target_server+"/php/vilsnodes.php",d={};d.project_id=""+project_id;d.dumplogtype="PrintAoACirclePoint";jQuery.ajax({url:a,type:"POST",data:d,success:function(a){},error:function(a,c,d){alert("error = "+d);alert("xhr.responseText = "+a.responseText)}})}gl_rollcall_all_tag=[];
gl_rollcall_area_tag=[];gl_rollcall_none_tag=[];gl_rollcall_tag_load_index=gl_rollcall_tag_num=0;gl_rollcall_areaname=gl_rollcall_areaid="";function fetch_rollcall(a,d){gl_rollcall_all_tag=[];gl_rollcall_area_tag=[];gl_rollcall_none_tag=[];gl_rollcall_tag_load_index=gl_rollcall_tag_num=0;gl_rollcall_areaname=gl_rollcall_areaid="";load_rollcall_Tags_Info(a,d)}
function show_rollcall_info(){var a="\u5340\u57df:"+gl_rollcall_areaname+"<br>\u5be6\u5230:"+gl_rollcall_area_tag.length,d="maparea_popup_"+gl_rollcall_areaid,b=document.getElementById(d);null==b?console.log(d+" is null"):b.innerHTML=a;console.log(a)}
function load_rollcall_Tags_Info(a,d){gl_rollcall_areaid=a;gl_rollcall_areaname=d;$.getJSON(gl_target_server+"/php/vilsnodes.php","devicescount=1&project_id="+project_id,function(a){gl_rollcall_tag_num=parseInt(a.LOC_TAG_NUM);gl_rollcall_tag_load_index=0}).success(function(){setTimeout(load_rollcall_Tags,10)}).error(function(){setTimeout(load_rollcall_Tags_Info,1E3)}).complete(function(){})}
function load_rollcall_Tags(){gl_rollcall_tag_load_index>=gl_rollcall_tag_num?gl_rollcall_tag_load_index=0:$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtagrollcall=1&s="+gl_rollcall_tag_load_index+"&count="+LOAD_DEVICE_NUM+"&areaid="+gl_rollcall_areaid+"&project_id="+project_id,function(a){for(var d=parseInt(a.LOC_TAG_NUM),b=gl_rollcall_tag_load_index;b<gl_rollcall_tag_load_index+d;++b){var c="LOC_TAG_INDEX_"+b;if(void 0!=a[c]&&null!=a[c]){var c=a[c].split(","),e=c[1],f=c[6],k=c[8],n=c[10],
m=c[11];gl_rollcall_all_tag.push(c);f!=gl_rollcall_areaid&&m!=gl_rollcall_areaid||"1"!=k?gl_rollcall_none_tag.push(c):"0"==e&&"0"==n?gl_rollcall_none_tag.push(c):gl_rollcall_area_tag.push(c)}}gl_rollcall_tag_load_index+=d}).success(function(){gl_rollcall_tag_load_index>=gl_rollcall_tag_num?(gl_rollcall_tag_load_index=0,show_rollcall_info()):setTimeout(load_rollcall_Tags,10)}).error(function(){gl_rollcall_tag_load_index=0}).complete(function(){})}
function create_dropdown_taglist(){for(var a=document.getElementById("dropdown_tags");a.hasChildNodes();)a.removeChild(a.firstChild);for(var d=0;d<glTag_List.length;d++){var b=glTag_List[d],b=create_dropdown_tag_item(d,b[3],b[5],b[36]);a.appendChild(b)}}
function create_dropdown_tag_item(a,d,b,c){a=document.createElement("li");var e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("tabIndex","-1");e.setAttribute("data-value",d);e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_tag_click("'+d+'", "'+c+'");return true;');c=document.createElement("input");c.setAttribute("type","checkbox");c.setAttribute("id","dropdown_checkbox_tag_"+d);c.setAttribute("onclick",'dropdown_checkbox_tag_click("'+d+'");return true;');
c.checked=!1;e.appendChild(c);e.appendChild(document.createTextNode(" "+b));a.appendChild(e);return a}function create_dropdown_locatorlist(){for(var a=document.getElementById("dropdown_locators");a.hasChildNodes();)a.removeChild(a.firstChild);for(var d=0;d<glLocator_List.length;d++){var b=glLocator_List[d],b=create_dropdown_locator_item(d,b[3],b[5],b[26]);a.appendChild(b)}}
function create_dropdown_locator_item(a,d,b,c){a=document.createElement("li");var e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("tabIndex","-1");e.setAttribute("data-value",d);e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_locator_click("'+d+'", "'+c+'");return true;');c=document.createElement("input");c.setAttribute("type","checkbox");c.setAttribute("id","dropdown_checkbox_locator_"+d);c.setAttribute("onclick",'dropdown_checkbox_locator_click("'+
d+'");return true;');c.checked=!1;e.appendChild(c);e.appendChild(document.createTextNode(" "+b));a.appendChild(e);return a}var glDropdown_checkbox_tag_click=!1;
function dropdown_tag_click(a,d){console.log("dropdown_item_click() nodeid:"+a+" maplayer:"+d);if(void 0!=document.getElementById("dropdown_checkbox_tag_"+a)){var b=document.getElementById("dropdown_checkbox_tag_"+a).checked;glDropdown_checkbox_tag_click||(document.getElementById("dropdown_checkbox_tag_"+a).checked=!b,b=document.getElementById("dropdown_checkbox_tag_"+a).checked)}else return!1;for(var c=0;c<glLiveMapList.length;c++)if(glLiveMapList[c].mMapLayerId===d||0==c&&"0"==d){$("#map_tab_href_"+
c).trigger("click");glLiveMapList[c].setTagPopup(a,b);console.log("dropdown_tag_click() nodeid:"+a+", show:"+b);break}glDropdown_checkbox_tag_click=!1;return!0}function dropdown_checkbox_tag_click(a){glDropdown_checkbox_tag_click=!0}var glDropdown_checkbox_locator_click=!1;
function dropdown_locator_click(a,d){var b=document.getElementById("dropdown_checkbox_locator_"+a);if(void 0==b)return!1;var c=b.checked;glDropdown_checkbox_locator_click||(b.checked=!c,c=b.checked);for(b=0;b<glLiveMapList.length;b++)if(glLiveMapList[b].mMapLayerId===d||0==b&&"0"==d){$("#map_tab_href_"+b).trigger("click");glLiveMapList[glCurrentMapIndex].setLocatorPopup(a,c);break}glDropdown_checkbox_locator_click=!1}
function dropdown_checkbox_locator_click(a){glDropdown_checkbox_locator_click=!0}var glDropdown_checkbox_user_click=!1;
function dropdown_user_click(a,d){console.log("dropdown_user_click() userid:"+a+" maplayer:"+d);if(void 0!=document.getElementById("dropdown_checkbox_user_"+a)){var b=document.getElementById("dropdown_checkbox_user_"+a).checked;glDropdown_checkbox_user_click||(document.getElementById("dropdown_checkbox_user_"+a).checked=!b,b=document.getElementById("dropdown_checkbox_user_"+a).checked)}else return!1;for(var c=0;c<glLiveMapList.length;c++)if(glLiveMapList[c].mMapLayerId===d||0==c&&"0"==d){$("#map_tab_href_"+
c).trigger("click");glLiveMapList[c].setUserPopup(a,b);console.log("dropdown_user_click() userid:"+a+", show:"+b);break}glDropdown_checkbox_user_click=!1;return!0}function dropdown_checkbox_user_click(a){glDropdown_checkbox_user_click=!0}
function searchresult_tag_click(a,d){console.log("searchresult_tag_click() nodeid:"+a);for(var b=0;b<glLiveMapList.length;b++)if(glLiveMapList[b].mMapLayerId===d||0==b&&"0"==d){$("#map_tab_href_"+b).trigger("click");glLiveMapList[b].setTagPopup(a,!0);break}$("#dropdown_searchresult").toggle()}
function searchresult_locator_click(a,d){console.log("searchresult_locator_click() nodeid:"+a);for(var b=0;b<glLiveMapList.length;b++)if(glLiveMapList[b].mMapLayerId===d||0==b&&"0"==d){$("#map_tab_href_"+b).trigger("click");glLiveMapList[glCurrentMapIndex].setLocatorPopup(a,!0);break}$("#dropdown_searchresult").toggle()}
function searchresult_sensor_click(a,d){console.log("searchresult_sensor_click() id:"+a+" maplayer:"+d);for(var b=0;b<glLiveMapList.length;b++)if(glLiveMapList[b].mMapLayerId===d||0==b&&"0"==d){$("#map_tab_href_"+b).trigger("click");glLiveMapList[glCurrentMapIndex].setSensorPopup(a,!0);break}$("#dropdown_searchresult").toggle()}
function searchresult_user_click(a,d){console.log("searchresult_user_click() id:"+a+" maplayer:"+d);for(var b=0;b<glLiveMapList.length;b++)if(glLiveMapList[b].mMapLayerId===d||0==b&&"0"==d){$("#map_tab_href_"+b).trigger("click");glLiveMapList[glCurrentMapIndex].setUserPopup(a,!0);break}$("#dropdown_searchresult").toggle()}function getFirstMapLayer(){return glLiveMapList[0].mMapLayerId}
function start_alert(a){console.log("LiveMap.js start_alert() nodeid:"+a);for(var d=0;d<glLiveMapList.length;d++)glLiveMapList[d].setStartAlert(a)}function stop_alert(a){console.log("LiveMap.js stop_alert() nodeid:"+a);for(var d=0;d<glLiveMapList.length;d++)glLiveMapList[glCurrentMapIndex].setStopAlert(a)}function show_sensor(a){console.log("LiveMap.js show_sensor() id:"+a)}function map_search_text_onfocus(a){a=document.getElementById("map_search_text").value;add_search_result_to_table(a)}
function map_search_text_change(a){a=document.getElementById("map_search_text").value;add_search_result_to_table(a)}var $source=document.querySelector("#map_search_text");$source.addEventListener("input",map_search_text_change);
function add_search_result_to_table(a){for(var d=document.getElementById("dropdown_searchresult");d.hasChildNodes();)d.removeChild(d.firstChild);for(var b=a.toLowerCase(),c=0,e=0;e<glTag_List.length;e++){var f=glTag_List[e],k=f[3],n=f[5],f=f[36],m=n.toLowerCase(),l=k.toLowerCase(),m=m.indexOf(b);if(0>m&&(m=l.indexOf(b),0>m))continue;m=document.createElement("li");l=document.createElement("a");l.setAttribute("class","small");l.setAttribute("tabIndex","-1");l.setAttribute("data-value",k);l.setAttribute("href",
"javascript:;");l.setAttribute("onclick",'searchresult_tag_click("'+k+'", "'+f+'");return true;');l.appendChild(document.createTextNode(" "+n));m.appendChild(l);d.appendChild(m);c++}for(e=0;e<glLocator_List.length;e++)f=glLocator_List[e],k=f[3],n=f[5],f=f[26],m=n.indexOf(a),0>m||(m=document.createElement("li"),l=document.createElement("a"),l.setAttribute("class","small"),l.setAttribute("tabIndex","-1"),l.setAttribute("data-value",k),l.setAttribute("href","javascript:;"),l.setAttribute("onclick",'searchresult_locator_click("'+
k+'", "'+f+'");return true;'),l.appendChild(document.createTextNode(" "+n)),m.appendChild(l),d.appendChild(m),c++);for(e=0;e<glSensor_List.length;e++)b=glSensor_List[e],m=b.name.indexOf(a),0>m||(m=document.createElement("li"),l=document.createElement("a"),l.setAttribute("class","small"),l.setAttribute("tabIndex","-1"),l.setAttribute("data-value",b.id),l.setAttribute("href","javascript:;"),l.setAttribute("onclick",'searchresult_sensor_click("'+b.id+'", "'+b.maplayer+'");return true;'),l.appendChild(document.createTextNode(" "+
b.name)),m.appendChild(l),d.appendChild(m),c++);for(e=0;e<glUser_List.length;e++)b=glUser_List[e],m=b.name.indexOf(a),0>m||(m=document.createElement("li"),l=document.createElement("a"),l.setAttribute("class","small"),l.setAttribute("tabIndex","-1"),l.setAttribute("data-value",b.userid),l.setAttribute("href","javascript:;"),l.setAttribute("onclick",'searchresult_user_click("'+b.userid+'", "'+b.maplayer+'");return true;'),l.appendChild(document.createTextNode(" "+b.name)),m.appendChild(l),d.appendChild(m),
c++);0<c&&$("#dropdown_searchresult").is(":hidden")&&$("#dropdown_searchresult").toggle()}function getMainGroupInfo(a){a=parseInt(a);for(var d=0;d<gl_usermaingroups.length;++d){var b=gl_usermaingroups[d];if(a==b.id)return b}}function markclick(a){glShowDefaultNode=!0;glShowDefaultNodeId=a}function isANumber(a){return!/\D/.test(a)}function open_log_page(){window.open("/index.php/log","_blank").focus()}function open_2dmap_page(){window.open("/index.php/vils2dmap/"+project_id,"_blank").focus()};var glTag_List=[],glUnknown_pos_Tag_List=[],glNonAliveTag_List=[],glFetch_unknown_poistion_count=0;
function fetch_unknown_poistion_tag(){0==glFetch_unknown_poistion_count&&(glUnknown_pos_Tag_List=[]);$.getJSON(gl_target_server+"/php/vilsnodes.php","loadunknownpositiontag=1&project_id="+project_id,function(a){var d=0;$.each(a,function(a,c){for(var e=0;e<glTag_List.length;++e){var f=glTag_List[e],k=f[6];if(k===c.macaddress){for(var n=c.pos.split(","),m=!1,l=0;l<glUnknown_pos_Tag_List.length;++l)if(k===glUnknown_pos_Tag_List[l][6]){f[100]=n[0];f[101]=n[1];f[102]=n[2];m=!0;break}0==m&&(f[100]=n[0],
f[101]=n[1],f[102]=n[2],glUnknown_pos_Tag_List.push(f))}}d++})}).success(function(){show_unknown_poistion_tag();5>glFetch_unknown_poistion_count&&setTimeout(fetch_unknown_poistion_tag,500);glFetch_unknown_poistion_count++}).error(function(){}).complete(function(){})}
function fetch_NonAlive_tag(){glNonAliveTag_List=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtag=1&project_id="+project_id,function(a){for(var d=parseInt(a.LOC_TAG_NUM),b=0;b<d;++b){var c="LOC_TAG_INDEX_"+b;if(void 0!=a[c]&&null!=a[c]){var c=a[c].split(","),e=c[1];parseInt(c[35]);"0"===e&&glNonAliveTag_List.push(c)}}}).success(function(){show_non_alive_tag()}).error(function(){}).complete(function(){})}
function fetch_all_tag(){glTag_List=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtag=1&project_id="+project_id,function(a){for(var d=parseInt(a.LOC_TAG_NUM),b=0;b<d;++b){var c="LOC_TAG_INDEX_"+b;void 0!=a[c]&&null!=a[c]&&(c=a[c].split(","),parseInt(c[35]),glTag_List.push(c))}}).success(function(){setTimeout(fetch_unknown_poistion_tag,10)}).error(function(){}).complete(function(){})}
function FixPosition(){$("#openfixpositionmodalbtn").click();glFetch_unknown_poistion_count=0;fetch_all_tag()}
function show_unknown_poistion_tag(){for(var a=document.getElementById("tag_list_content_fixposition");a.firstChild;)a.removeChild(a.firstChild);for(var d=0;d<glUnknown_pos_Tag_List.length;++d){var b=glUnknown_pos_Tag_List[d],c=b[5],e=b[6],f=parseInt(b[7]),k=parseInt(b[8]),n=parseInt(b[9]);parseInt(b[35]);var m=parseInt(b[100]),l=parseInt(b[101]);parseInt(b[102]);b=m-f;k=l-k;n=l-n;n=parseInt(Math.sqrt(b*b+k*k+n*n));c=create_fixposition_tag_status_row(d+1,c,e,n);a.appendChild(c)}}
function create_fixposition_tag_status_row(a,d,b,c){var e=document.createElement("tr"),f=0;e.appendChild(document.createElement("td"));e.cells[f].appendChild(document.createTextNode(""+a));f++;e.appendChild(document.createElement("td"));a=document.createElement("span");a.setAttribute("class","badge bg-light-blue-active");a.textContent=d;e.cells[f].appendChild(a);f++;e.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("class","badge bg-fuchsia");d.textContent=
c;e.cells[f].appendChild(d);f++;e.appendChild(document.createElement("td"));c=document.createElement("div");c.setAttribute("class","form-group");e.cells[f].appendChild(c);d=document.createElement("div");d.setAttribute("class","radio");c.appendChild(d);f=document.createElement("label");d.appendChild(f);d=document.createElement("input");d.setAttribute("type","radio");d.setAttribute("name","optionRadio_"+b);d.setAttribute("id","optionRadio1_"+b);d.setAttribute("value","option1");d.setAttribute("checked",
"true");f.appendChild(d);f.appendChild(document.createTextNode("\u7dad\u6301"));f=document.createElement("div");f.setAttribute("class","radio");c.appendChild(f);c=document.createElement("label");f.appendChild(c);f=document.createElement("input");f.setAttribute("type","radio");f.setAttribute("name","optionRadio_"+b);f.setAttribute("id","optionRadio2_"+b);f.setAttribute("value","option2");c.appendChild(f);c.appendChild(document.createTextNode("\u79fb\u52d5(\u81f3\u6700\u65b0\u5750\u6a19)"));return e}
function fixposition_update(){document.getElementById("fixposition_updatebtn").disabled=!0;document.getElementById("fixposition_sending_callout").style.display="block";document.getElementById("fixposition_failed_callout").style.display="none";document.getElementById("fixposition_finished_callout").style.display="none";for(var a=[],d=0;d<glUnknown_pos_Tag_List.length;++d){var b=glUnknown_pos_Tag_List[d][6],c=document.getElementsByName("optionRadio_"+b);c[0].checked?console.log(b+":"+c[0].value):c[1].checked&&
(console.log(b+":"+c[1].value),a.push(b))}0==a.length?(document.getElementById("fixposition_sending_callout").style.display="none",document.getElementById("fixposition_failed_callout").style.display="none",document.getElementById("fixposition_finished_callout").style.display="none",document.getElementById("fixposition_reponse_msg_callout").style.display="block",document.getElementById("fixposition_reponse_msg_callout").innerHTML="<p>\u6c92\u6709\u9078\u64c7\u88dd\u7f6e\u66f4\u65b0!</p>",setTimeout(close_callout,
5E3,"fixposition_reponse_msg_callout"),document.getElementById("fixposition_updatebtn").disabled=!1):(d=gl_target_server+"/php/vilsnodes.php",b={},b.project_id=""+project_id,b.fixposition="1",b.updatenode=a,jQuery.ajax({url:d,type:"POST",data:b,success:function(a){document.getElementById("fixposition_sending_callout").style.display="none";document.getElementById("fixposition_failed_callout").style.display="none";document.getElementById("fixposition_finished_callout").style.display="block";setTimeout(close_callout,
5E3,"fixposition_finished_callout");document.getElementById("fixposition_updatebtn").disabled=!1},error:function(a,b,c){document.getElementById("fixposition_sending_callout").style.display="none";document.getElementById("fixposition_failed_callout").style.display="block";document.getElementById("fixposition_finished_callout").style.display="none";setTimeout(close_callout,5E3,"fixposition_failed_callout");document.getElementById("fixposition_updatebtn").disabled=!1}}))}
function FixDevice(){$("#openfixdevicemodalbtn").click();fetch_NonAlive_tag()}function show_non_alive_tag(){for(var a=document.getElementById("tag_list_content_fixdevice");a.firstChild;)a.removeChild(a.firstChild);for(var d=0;d<glNonAliveTag_List.length;++d){var b=glNonAliveTag_List[d],b=create_fixdevice_tag_status_row(d+1,b[5],b[6],b[35]);a.appendChild(b)}}
function create_fixdevice_tag_status_row(a,d,b,c){var e=document.createElement("tr"),f=0;e.appendChild(document.createElement("td"));e.cells[f].appendChild(document.createTextNode(""+a));f++;e.appendChild(document.createElement("td"));a=document.createElement("span");a.setAttribute("class","badge bg-light-blue-active");a.textContent=d;e.cells[f].appendChild(a);f++;e.appendChild(document.createElement("td"));d=document.createElement("span");a="\u5df2\u96e2\u958b";"1"===c?(a="\u4f11\u7720\u4e2d",d.setAttribute("class",
"badge bg-yellow")):d.setAttribute("class","badge bg-fuchsia");d.textContent=a;e.cells[f].appendChild(d);f++;e.appendChild(document.createElement("td"));c=document.createElement("div");c.setAttribute("class","form-group");e.cells[f].appendChild(c);d=document.createElement("div");d.setAttribute("class","radio");c.appendChild(d);f=document.createElement("label");d.appendChild(f);d=document.createElement("input");d.setAttribute("type","radio");d.setAttribute("name","optionRadio_"+b);d.setAttribute("value",
"option1");d.setAttribute("checked","true");f.appendChild(d);f.appendChild(document.createTextNode("\u7dad\u6301"));f=document.createElement("div");f.setAttribute("class","radio");c.appendChild(f);c=document.createElement("label");f.appendChild(c);f=document.createElement("input");f.setAttribute("type","radio");f.setAttribute("name","optionRadio_"+b);f.setAttribute("value","option2");c.appendChild(f);c.appendChild(document.createTextNode("\u79fb\u52d5(\u642c\u5230\u66ab\u5b58\u5340\u57df)"));return e}
function fixdevice_update(){document.getElementById("fixdevice_updatebtn").disabled=!0;document.getElementById("fixdevice_sending_callout").style.display="block";document.getElementById("fixdevice_failed_callout").style.display="none";document.getElementById("fixdevice_finished_callout").style.display="none";for(var a=[],d=0;d<glNonAliveTag_List.length;++d){var b=glNonAliveTag_List[d][6],c=document.getElementsByName("optionRadio_"+b);c[0].checked?console.log(b+":"+c[0].value):c[1].checked&&(console.log(b+
":"+c[1].value),a.push(b))}0==a.length?(document.getElementById("fixdevice_sending_callout").style.display="none",document.getElementById("fixdevice_failed_callout").style.display="none",document.getElementById("fixdevice_finished_callout").style.display="none",document.getElementById("fixdevice_reponse_msg_callout").style.display="block",document.getElementById("fixdevice_reponse_msg_callout").innerHTML="<p>\u6c92\u6709\u9078\u64c7\u88dd\u7f6e\u66f4\u65b0!</p>",setTimeout(close_callout,5E3,"fixdevice_reponse_msg_callout"),
document.getElementById("fixdevice_updatebtn").disabled=!1):(d=gl_target_server+"/php/vilsnodes.php",b={},b.project_id=""+project_id,b.fixdevice="1",b.updatenode=a,jQuery.ajax({url:d,type:"POST",data:b,success:function(a){document.getElementById("fixdevice_sending_callout").style.display="none";document.getElementById("fixdevice_failed_callout").style.display="none";document.getElementById("fixdevice_finished_callout").style.display="block";setTimeout(close_callout,5E3,"fixdevice_finished_callout");
document.getElementById("fixdevice_updatebtn").disabled=!1},error:function(a,b,c){document.getElementById("fixdevice_sending_callout").style.display="none";document.getElementById("fixdevice_failed_callout").style.display="block";document.getElementById("fixdevice_finished_callout").style.display="none";setTimeout(close_callout,5E3,"fixdevice_failed_callout");document.getElementById("fixdevice_updatebtn").disabled=!1}}))}function close_callout(a){document.getElementById(a).style.display="none"};
