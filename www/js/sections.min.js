var glSection_Type="0D",glAnchors=[],glAreas=[],gl_anchor_num=0,gl_locator_num=0,gl_anchor_load_index=0,gl_locator_load_index=0,LOAD_DEVICE_NUM=20,PreLoadIndex=-1,CurrentLoadIndex=0,glDropdown_checkbox_anchor_click=!1,glSection_AlertTypes=[{}];glSection_AlertTypes[0].itemid=0;glSection_AlertTypes[0].itemname="normal";glSection_AlertTypes[1]={};glSection_AlertTypes[1].itemid=1;glSection_AlertTypes[1].itemname="room";glSection_AlertTypes[2]={};glSection_AlertTypes[2].itemid=2;
glSection_AlertTypes[2].itemname="danger";var glSection_Types=[{}];glSection_Types[0].itemid="0D";glSection_Types[0].itemname="0D";glSection_Types[1]={};glSection_Types[1].itemid="1D";glSection_Types[1].itemname="1D";check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_areas());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_section_type());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+
PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_devices());break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_section_exist());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_alert_type());
break;case 5:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),"0D"==glSection_Type?(document.getElementById("section_type_0D_btn-group").style.display="block",document.getElementById("section_type_1D_btn-group").style.display="none"):(document.getElementById("section_type_0D_btn-group").style.display="none",document.getElementById("section_type_1D_btn-group").style.display="block"),PreLoadIndex=CurrentLoadIndex,
CurrentLoadIndex=6)}6!=CurrentLoadIndex&&setTimeout(check_loading_status,100)}
function section_type_select(a,b){var d=$("#section_type_"+a+"_item_"+b).html(),c=$("#section_type_"+a+"_item_"+b).attr("data-id");$("#section_type_"+a+"_name").html(d);$("#section_type_"+a+"_name").attr("data-id",c);glSection_Type=d;"0D"==c?(document.getElementById("section_type_0D_btn-group").style.display="block",document.getElementById("section_type_1D_btn-group").style.display="none"):(document.getElementById("section_type_0D_btn-group").style.display="none",document.getElementById("section_type_1D_btn-group").style.display=
"block")}function section_anchor_select(a,b){var d=$("#section_anchor_"+a+"_item_"+b).html(),c=$("#section_anchor_"+a+"_item_"+b).attr("data-id");$("#section_anchor_"+a+"_name").html(d);$("#section_anchor_"+a+"_name").attr("data-id",c)}
function section_anchor_1_select(a,b){var d=$("#section_anchor_1_"+a+"_item_"+b).html(),c=$("#section_anchor_1_"+a+"_item_"+b).attr("data-id");$("#section_anchor_1_"+a+"_name").html(d);$("#section_anchor_1_"+a+"_name").attr("data-id",c);change_section_frompoint_value(d)}
function section_anchor_2_select(a,b){var d=$("#section_anchor_2_"+a+"_item_"+b).html(),c=$("#section_anchor_2_"+a+"_item_"+b).attr("data-id");$("#section_anchor_2_"+a+"_name").html(d);$("#section_anchor_2_"+a+"_name").attr("data-id",c);change_section_topoint_value(d)}function section_area_select(a,b){var d=$("#section_area_"+a+"_item_"+b).html(),c=$("#section_area_"+a+"_item_"+b).attr("data-id");$("#section_area_"+a+"_name").html(d);$("#section_area_"+a+"_name").attr("data-id",c)}
function section_alerttype_select(a,b){var d=$("#section_alerttype_"+a+"_item_"+b).html();$("#section_alerttype_"+a+"_item_"+b).attr("data-id");$("#section_alerttype_"+a+"_name").html(d);$("#section_alerttype_"+a+"_name").attr("data-id",b)}
function section_type_delete(a){return 1==confirm("Do you want to delete this section group?")?(a="group_id="+a+("&project_id="+project_id),jQuery.ajax({url:"/php/sections.php",type:"POST",data:a+"&delete_group=1",dataType:"text",success:function(a){console.log(JSON.stringify(a));setTimeout(load_section_exist,100)},error:function(a,d,c){console.log(c);console.log(a.responseText);setTimeout(load_section_exist,100)}})):!1}
function section_group_create(){var a=$("#section_type_0_name").attr("data-id"),b={};if("0D"==a){var a=$("#section_anchor_0_name").attr("data-id"),d=$("#section_area_0_name").attr("data-id"),c=document.getElementById("section_range_selection_input").value,e=$("#section_alerttype_0_name").attr("data-id");b.section_type=0;b.project_id=project_id;b.anchor=a;b.area=d;b.range=c;b.alerttype=e;console.log("section_group_create() section_0D_anchor:"+a);console.log("section_group_create() section_0D_area:"+
d);console.log("section_group_create() section_0D_range:"+c);console.log("section_group_create() section_0D_alerttype:"+e)}else if("1D"==a){a=document.getElementById("section_frompoint_selection_input").value;d=document.getElementById("section_topoint_selection_input").value;c="";for(e=0;e<glAnchors.length;e++)document.getElementById("dropdown_checkbox_anchor_"+e).checked&&(c=0==c.length?glAnchors[e].itemid:c+(","+glAnchors[e].itemid));b.project_id=""+project_id;b.section_type=1;b.anchors=c;b.frompoint=
a;b.topoint=d;console.log("section_group_create() SectionAnchors:"+c);console.log("section_group_create() section_1D_frompoint:"+a);console.log("section_group_create() section_1D_topoint:"+d)}return jQuery.ajax({url:"/php/sections.php",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(b),success:function(a){console.log(JSON.stringify(a));setTimeout(load_section_exist,100)},error:function(a,b,c){console.log(c);console.log(a.responseText)}})}
function add_exist_section_0D(a,b,d,c,e,g){b=document.getElementById("section_box_body");var f=document.createElement("div");b.appendChild(f);f.setAttribute("class","breadcrumb section0");f.id="section_type_"+a;var h=document.createElement("a");f.appendChild(h);h.setAttribute("class","active");var l=document.createElement("span");l.textContent="0D";l.setAttribute("class","badge bg-gray disabled");h.appendChild(l);h=document.createElement("a");f.appendChild(h);d=document.createTextNode(d);h.appendChild(d);
d=document.createElement("a");f.appendChild(d);c=document.createTextNode(c);d.appendChild(c);c=document.createElement("a");f.appendChild(c);e=document.createTextNode(e);c.appendChild(e);e=document.createElement("a");f.appendChild(e);g=document.createTextNode(glSection_AlertTypes[parseInt(g)].itemname);e.appendChild(g);f=document.createElement("div");f.setAttribute("class","btn-group pull-right");b.appendChild(f);g=document.createElement("div");g.setAttribute("class","tools");f.appendChild(g);f=document.createElement("a");
g.appendChild(f);f.setAttribute("href","javascript:;");f.setAttribute("onclick","section_type_delete("+a+");return false;");f.setAttribute("data-id","sectionid");f.id="section_type_delete_"+a;a=document.createElement("i");a.setAttribute("class","fa fa-trash-o");f.appendChild(a);a=document.createElement("br");b.appendChild(a)}
function add_exist_section_1D(a,b,d,c,e,g,f,h,l){b=document.getElementById("section_box_body");var n=document.createElement("div");b.appendChild(n);n.setAttribute("class","breadcrumb section1");n.id="section_type_"+a;var k=document.createElement("a");n.appendChild(k);k.setAttribute("class","active");var m=document.createElement("span");m.textContent="1D";m.setAttribute("class","badge bg-red disabled");k.appendChild(m);k=document.createElement("a");n.appendChild(k);d=d.split(",");for(m=0;m<d.length;m++){var q=
d[m],p=document.createElement("span");p.textContent=q;p.setAttribute("class","badge bg-green-active");k.appendChild(p)}k=document.createElement("a");n.appendChild(k);c=document.createTextNode("("+c+","+e+","+g+")");k.appendChild(c);c=document.createElement("a");n.appendChild(c);f=document.createTextNode("("+f+","+h+","+l+")");c.appendChild(f);h=document.createElement("div");h.setAttribute("class","btn-group pull-right");b.appendChild(h);f=document.createElement("div");f.setAttribute("class","tools");
h.appendChild(f);h=document.createElement("a");f.appendChild(h);h.setAttribute("href","javascript:;");h.setAttribute("onclick","section_type_delete("+a+");return false;");h.id="section_type_delete_"+a;a=document.createElement("i");a.setAttribute("class","fa fa-trash-o");h.appendChild(a);a=document.createElement("br");b.appendChild(a)}
function load_section_exist(){$.getJSON(gl_target_server+"/php/sections.php","loadsections=1&project_id="+project_id,function(a){for(var b=document.getElementById("section_box_body");b.firstChild;)b.removeChild(b.firstChild);var d=1;$.each(a,function(a,b){for(var g=[],f=b.nodeIDList.split(","),h=0;h<f.length;h++){for(var l=f[h],n=!1,k=0;k<glAnchors.length;k++){var m=glAnchors[k];if(void 0!=m&&m.itemid==l){g=0==g.length?m.itemname:g+","+m.itemname;n=!0;break}}0==n&&(g=0==g.length?l:g+","+l)}f="";for(h=
0;h<glAreas.length;h++)if(l=glAreas[h],l.itemid==b.AreaID){f=l.itemname;break}"0"==b.SectionType?add_exist_section_0D(parseInt(a),b.SectionType,g,f,b.Param1,b.Param2):add_exist_section_1D(parseInt(a),b.SectionType,g,b.Param1,b.Param2,b.Param3,b.Param4,b.Param5,b.Param6);d++});CurrentLoadIndex=4});return!1}
function load_Items_to_newevent_UI(a,b,d,c){var e="",g="";console.log("load_Items_to_newevent_UI() items.length:"+c.length+" itemtype:"+a);0<c.length&&(e=c[0].itemid,g=c[0].itemname);var f=document.createElement("button");d.appendChild(f);f.setAttribute("class","btn "+b);f.setAttribute("data-id",e);f.id="section_"+a+"_0_name";e=document.createTextNode(g);f.appendChild(e);f=document.createElement("button");d.appendChild(f);f.setAttribute("class","btn "+b+" dropdown-toggle");f.setAttribute("data-toggle",
"dropdown");f.id="section_"+a+"_0";b=document.createElement("span");f.appendChild(b);b.setAttribute("class","caret");b=document.createElement("span");f.appendChild(b);b.setAttribute("class","sr-only");b=document.createElement("ul");d.appendChild(b);b.setAttribute("class","dropdown-menu");b.setAttribute("role","menu");for(d=0;d<c.length;d++)void 0!=c[d]&&(e=document.createElement("li"),b.appendChild(e),f=document.createElement("a"),e.appendChild(f),f.setAttribute("href","javascript:;"),f.setAttribute("onclick",
"section_"+a+"_select(0,"+d+");return false;"),f.setAttribute("data-id",c[d].itemid),f.id="section_"+a+"_0_item_"+d,"anchor"==a&&"anchor"==c[d].type?(e=document.createElement("span"),e.textContent=c[d].itemname,e.setAttribute("class","badge bg-green-active")):"anchor"==a&&"locator"==c[d].type?(e=document.createElement("span"),e.textContent=c[d].itemname,e.setAttribute("class","badge bg-yellow-active")):"anchor"==a&&"rfiddevice"==c[d].type?(e=document.createElement("span"),e.textContent=c[d].itemname+
" (RFID)",e.setAttribute("class","badge bg-aqua-active")):"anchor"==a&&"nfcdevice"==c[d].type?(e=document.createElement("span"),e.textContent=c[d].itemname+" (NFC)",e.setAttribute("class","badge bg-yellow")):"0D"==c[d].itemid?(e=document.createElement("span"),e.textContent=c[d].itemname,e.setAttribute("class","badge bg-gray disabled")):"1D"==c[d].itemid?(e=document.createElement("span"),e.textContent=c[d].itemname,e.setAttribute("class","badge bg-red disabled")):e=document.createTextNode(c[d].itemname),
f.appendChild(e))}function load_dropdown_Items_to_UI(a,b){var d;for(d=0;d<b.length;d++)if(void 0!=b[d]){var c=create_dropdown_anchor_item(d,b[d].itemid,!1);a.appendChild(c)}}function load_section_type(){var a=document.getElementById("section_type_selection");load_Items_to_newevent_UI("type","btn-warning",a,glSection_Types);CurrentLoadIndex=2}
function load_devices(){$.getJSON(gl_target_server+"/php/vilsnodes.php","devicescount=1&project_id="+project_id,function(a){gl_anchor_num=parseInt(a.LOC_ANCHOR_NUM);gl_locator_num=parseInt(a.LOC_LOCATOR_NUM);console.log("load_devices() gl_anchor_num:"+gl_anchor_num+", gl_locator_num:"+gl_locator_num);gl_locator_load_index=gl_anchor_load_index=0}).success(function(){setTimeout(load_anchors,10)}).error(function(){setTimeout(load_devices,1E3)}).complete(function(){})}
function load_anchors(){gl_anchor_load_index>=gl_anchor_num?(gl_anchor_load_index=0,setTimeout(load_locators,10)):(0==gl_anchor_load_index&&(glAnchors=[]),$.getJSON(gl_target_server+"/php/vilsnodes.php","loadanchor=1&s="+gl_anchor_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){var b=parseInt(a.LOC_ANCHOR_NUM);console.log("load_anchors() anchor_num:"+b+", gl_anchor_load_index:"+gl_anchor_load_index);for(var d=gl_anchor_load_index;d<gl_anchor_load_index+b;++d){var c="LOC_ANCHOR_INDEX_"+
d;void 0!=a[c]&&null!=a[c]&&(console.log("load_anchors() key:"+c+", data[key]:"+a[c]),c=a[c].split(","),glAnchors[d]={},glAnchors[d].itemid=c[3],glAnchors[d].itemname=c[5],glAnchors[d].posX=c[7],glAnchors[d].posY=c[8],glAnchors[d].posZ=c[9],glAnchors[d].type="anchor")}gl_anchor_load_index+=b}).success(function(){console.log("load_anchors() success gl_anchor_load_index:"+gl_anchor_load_index+", gl_anchor_num:"+gl_anchor_num);gl_anchor_load_index>=gl_anchor_num?(gl_anchor_load_index=0,setTimeout(load_locators,
10)):load_anchors()}).error(function(){console.log("load_anchors() error gl_anchor_load_index:"+gl_anchor_load_index+", gl_anchor_num:"+gl_anchor_num);gl_anchor_load_index=0;setTimeout(load_locators,10)}).complete(function(){}))}
function load_locators(){gl_locator_load_index>=gl_locator_num?(gl_locator_load_index=0,load_RFIDdevices()):$.getJSON(gl_target_server+"/php/vilsnodes.php","loadlocator=1&s="+gl_locator_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(a){var b=parseInt(a.LOC_LOCATOR_NUM);console.log("load_locators() locator_num:"+b+", gl_locator_load_index:"+gl_locator_load_index);for(var d=gl_anchor_num,c=gl_locator_load_index;c<gl_locator_load_index+b;++c){var e="LOC_LOCATOR_INDEX_"+c;void 0!=
a[e]&&null!=a[e]&&(e=a[e].split(","),glAnchors[d+c]={},glAnchors[d+c].itemid=e[3],glAnchors[d+c].itemname=e[5],glAnchors[d+c].posX=e[7],glAnchors[d+c].posY=e[8],glAnchors[d+c].posZ=e[9],glAnchors[d+c].type="locator")}gl_locator_load_index+=b;gl_anchor_num+=b}).success(function(){console.log("load_locators() gl_locator_load_index:"+gl_locator_load_index+", gl_locator_num:"+gl_locator_num);gl_locator_load_index>=gl_locator_num?(gl_locator_load_index=0,load_RFIDdevices()):load_locators()}).error(function(){gl_locator_load_index=
0;setTimeout(load_locators,1E3)}).complete(function(){})}
function load_RFIDdevices(){$.getJSON(gl_target_server+"/php/rfiddevice.php","loaddevice=1&s=0&count=100&project_id="+project_id+"&showonline=1&showoffline=1",function(a){var b=gl_anchor_num;$.each(a,function(a,c){glAnchors[b]={};glAnchors[b].itemid=c.macaddress;glAnchors[b].itemname=c.name;glAnchors[b].posX=0;glAnchors[b].posY=0;glAnchors[b].posZ=0;glAnchors[b].type="rfiddevice";b+=1});gl_anchor_num+=b}).success(function(){}).error(function(){}).complete(function(){load_NFCdevices()})}
function load_NFCdevices(){$.getJSON(gl_target_server+"/php/nfclocator.php","loadnfclocator=1&s=0&count=100&project_id="+project_id+"&showonline=1&showoffline=1",function(a){var b=gl_anchor_num;$.each(a,function(a,c){glAnchors[b]={};glAnchors[b].itemid=c.macaddress;glAnchors[b].itemname=c.name;glAnchors[b].posX=0;glAnchors[b].posY=0;glAnchors[b].posZ=0;glAnchors[b].type="nfcdevice";b+=1});gl_anchor_num+=b}).success(function(){}).error(function(){}).complete(function(){show_anchor_to_UI();CurrentLoadIndex=
3})}function show_anchor_to_UI(){var a=document.getElementById("section_anchor_selection");load_Items_to_newevent_UI("anchor","btn-info",a,glAnchors);a=document.getElementById("dropdown_anchors");load_dropdown_Items_to_UI(a,glAnchors)}
function load_locators_old(){$.getJSON(gl_target_server+"/php/vilsnodes.php","&loadlocator=1&project_id="+project_id,function(a){var b=parseInt(a.LOC_LOCATOR_NUM),d=glAnchors.length;console.log("load_locators() loc_locator_num:"+b+", anchor_size:"+d);for(var c=0;c<b;++c){var e=a["LOC_LOCATOR_INDEX_"+c].split(",");glAnchors[d+c]={};glAnchors[d+c].itemid=e[3];glAnchors[d+c].itemname=e[5];glAnchors[d+c].posX=e[7];glAnchors[d+c].posY=e[8];glAnchors[d+c].posZ=e[9];glAnchors[d+c].type="locator"}a=document.getElementById("section_anchor_selection");
load_Items_to_newevent_UI("anchor","btn-info",a,glAnchors);a=document.getElementById("dropdown_anchors");load_dropdown_Items_to_UI(a,glAnchors);CurrentLoadIndex=3})}
function load_areas(){var a=document.getElementById("section_area_selection");$.getJSON(gl_target_server+"/php/map.php","project_id="+project_id,function(b){var d=0;$.each(b,function(a,b){var g=JSON.parse(b);glAreas[d]={};glAreas[d].itemid=g.properties.areaid;glAreas[d].itemname=g.properties.areaname;d++});load_Items_to_newevent_UI("area","btn-success",a,glAreas);"1D"==glSection_Type&&(a.style.visibility="hidden",document.getElementById("section_area_selection_text").style.visibility="hidden");CurrentLoadIndex=
1})}function load_alert_type(){var a=document.getElementById("section_alerttype_selection");load_Items_to_newevent_UI("alerttype","btn-success",a,glSection_AlertTypes);CurrentLoadIndex=5}
function load_section_conditions(){load_section_type();load_anchors();load_locators();load_areas();load_alert_type();"0D"==glSection_Type?(document.getElementById("section_type_0D_btn-group").style.display="block",document.getElementById("section_type_1D_btn-group").style.display="none"):(document.getElementById("section_type_0D_btn-group").style.display="none",document.getElementById("section_type_1D_btn-group").style.display="block");return!1}
function change_section_frompoint_value(a){for(var b=0;b<glAnchors.length;b++)if(anchor=glAnchors[b],anchor.itemid==a){document.getElementById("section_frompoint_selection_input").value=anchor.posX+","+anchor.posY+","+anchor.posZ;break}}function change_section_topoint_value(a){for(var b=0;b<glAnchors.length;b++)if(anchor=glAnchors[b],anchor.itemid==a){document.getElementById("section_topoint_selection_input").value=anchor.posX+","+anchor.posY+","+anchor.posZ;break}}
function create_dropdown_anchor_item(a,b,d){var c=document.createElement("li"),e=document.createElement("a");e.setAttribute("class","small");e.setAttribute("tabIndex","-1");e.setAttribute("data-value",a);e.setAttribute("href","javascript:;");e.setAttribute("onclick",'dropdown_anchor_click("'+a+'");return true;');var g=document.createElement("input");g.setAttribute("type","checkbox");g.setAttribute("id","dropdown_checkbox_anchor_"+a);g.setAttribute("onclick",'dropdown_checkbox_anchor_click("'+a+'");return true;');
g.checked=d;e.appendChild(g);a=document.createElement("span");a.textContent=b;a.setAttribute("class","badge bg-green-active");e.appendChild(a);c.appendChild(e);return c}function dropdown_checkbox_anchor_click(a){glDropdown_checkbox_anchor_click=!0}glDropdown_checkbox_anchor_click=!1;
function dropdown_anchor_click(a){glDropdown_checkbox_anchor_click||(document.getElementById("dropdown_checkbox_anchor_"+a).checked?document.getElementById("dropdown_checkbox_anchor_"+a).checked=!1:document.getElementById("dropdown_checkbox_anchor_"+a).checked=!0);glDropdown_checkbox_anchor_click=!1}function open_sections_page(){window.open("/index.php/vilssections/"+project_id,"_blank").focus()};
