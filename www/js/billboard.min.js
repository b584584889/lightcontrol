var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,NODE_TYPE_SUBGROUP=4,gl_userdatasubgroups=[],gl_send_list=[],gl_uploadimage_uid="",glCannedMessages_type=207;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_userdatasubgroup());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,click_subgroup(""),CurrentLoadIndex+=1);break;case 2:PreLoadIndex!=
CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_userdatasubgroup(){$.getJSON(gl_target_server+"/php/vilsnodes.php","loaddatasubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,c){gl_userdatasubgroups.push(c)})}).success(function(){add_subgroup_to_table();CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function add_subgroup_to_table(){for(var a=document.getElementById("subgroup_list_content");1<=a.rows.length;)a.deleteRow(0);console.log("add_subgroup_to_table() gl_userdatasubgroups.length:"+gl_userdatasubgroups.length);for(var b=0;b<gl_userdatasubgroups.length;b++)a.appendChild(create_subgroup_item(b+1,gl_userdatasubgroups[b]))}
function create_subgroup_item(a,b){var c=document.getElementById("subgroup_list_content"),d=document.createElement("tr");c.appendChild(d);c=document.createElement("td");c.textContent=a;c.setAttribute("id","subgroup_row_"+b.subgroupid);d.appendChild(c);c=document.createElement("td");d.appendChild(c);var e=document.createElement("input");e.setAttribute("id","subgroup_row_checkbox_"+b.subgroupid);e.setAttribute("type","checkbox");e.setAttribute("onclick",'click_subgroup("'+b.subgroupid+'");return true;');
c.appendChild(e);c=document.createElement("td");c.setAttribute("id","subgroup_row_name_"+b.subgroupid);d.appendChild(c);e=create_subgroup_label(b.subgroupname);e.setAttribute("onclick",'checkbox_subgroup_click("'+b.subgroupid+'");return true;');c.appendChild(e);return d}
function create_subgroup_label(a){var b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a65a;");b.textContent=a;return b}function click_subgroup(a){update_send_list()}
function subgroup_list_checkbox_click(){for(var a=0;a<gl_userdatasubgroups.length;a++)document.getElementById("subgroup_row_checkbox_"+gl_userdatasubgroups[a].subgroupid).checked=document.getElementById("subgroup_list_checkbox").checked;update_send_list()}function checkbox_subgroup_click(a){a=document.getElementById("subgroup_row_checkbox_"+a);void 0==a?console.log("checkbox_subgroup_click() checkbox_ui == undefined"):(a.checked=a.checked?!1:!0,update_send_list())}
function update_send_list(){for(var a=0;a<gl_userdatasubgroups.length;a++){var b=gl_userdatasubgroups[a],c=document.getElementById("subgroup_row_checkbox_"+b.subgroupid);null!=c&&(c.checked?add_send_node_list(b.subgroupid,b.subgroupname,NODE_TYPE_SUBGROUP):delete_send_node_list(b.subgroupid,b.subgroupname,NODE_TYPE_SUBGROUP))}update_send_list_ui()}
function add_send_node_list(a,b,c){for(var d=!1,e=0;e<gl_send_list.length;e++){var f=gl_send_list[e];if(f.nodeid==a&&f.node_name==b&&f.node_type==c){d=!0;break}}d||(f={},f.nodeid=a,f.node_name=b,f.node_type=c,gl_send_list.push(f))}function delete_send_node_list(a,b,c){for(var d=0;d<gl_send_list.length;d++){var e=gl_send_list[d];if(e.nodeid==a&&e.node_name==b&&e.node_type==c){gl_send_list.splice(d,1);break}}}
function update_send_list_ui(){for(var a=document.getElementById("send_node_list_ui");a.firstChild;)a.removeChild(a.firstChild);for(var b=0;b<gl_send_list.length;b++){var c=gl_send_list[b];add_send_node(a,c.node_name,c.node_type);0<b&&0==b%10&&(c=document.createElement("div"),a.appendChild(c))}}
function add_send_node(a,b,c){var d=document.createElement("span");c==NODE_TYPE_SUBGROUP&&(d=create_subgroup_label(b));a.appendChild(d);b=document.createElement("span");b.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;");b.textContent="  ";a.appendChild(b)}
$("#savebillboardbtn").click(function(){var a=document.getElementById("inputTitle").value,b=document.getElementById("inputContext").value;if(0==a.length)return alert("\u8acb\u8f38\u5165\u516c\u544a\u6a19\u984c!"),!1;if(100<a.length)return alert("\u8acb\u7e2e\u77ed\u516c\u544a\u6a19\u984c, 100\u5b57\u4ee5\u5167. \u76ee\u524d\u5b57\u6578:"+a.length),!1;if(0==b.length)return alert("\u8acb\u8f38\u5165\u516c\u544a\u5167\u5bb9!"),!1;if(3E3<b.length)return alert("\u8acb\u7e2e\u77ed\u516c\u544a\u5167\u5bb9, 3000\u5b57\u4ee5\u5167.. \u76ee\u524d\u5b57\u6578:"+
b.length),!1;a=[];for(b=0;b<gl_send_list.length;b++){var c=gl_send_list[b];c.node_type==NODE_TYPE_SUBGROUP&&a.push(c.nodeid)}if(0==a.length)return alert("\u8acb\u9078\u64c7\u516c\u544a\u5c0d\u8c61!"),!1;check_upload_image();return!1});
function check_upload_image(){gl_uploadimage_uid="";void 0!=document.getElementById("imageUpload").files[0]?(gl_uploadimage_uid=sendUploadImageRequest(uploadImageFinihed),console.log("check_upload_image() gl_uploadimage_uid:"+gl_uploadimage_uid)):check_send_notification()}
function uploadImageFinihed(a){console.log("uploadImageFinihed() uploadimage_uid:"+a);if(null==a)alert("\u4e0a\u50b3\u7167\u7247\u5931\u6557!");else{var b=document.getElementById("imageDescription").value,c=document.getElementById("imageUpload").files[0],d=c.name.split("."),e=d[1].toLowerCase();"jpg"!=e&&"jpeg"!=e&&"png"!=e&&"bmp"!=e&&alert("\u8acb\u9078\u64c7\u7167\u7247\u683c\u5f0f .jpg .jpeg .png .bmp ");e="project_id="+project_id;e=e+"&createnewimage=1"+("&name="+d[0])+("&description="+b);e+=
"&filename="+c.name;e=e+("&fileuid="+a)+("&filetype="+c.type);e+="&filesize="+c.size;e+="&subgroups=";e+="&leaveform=0";return jQuery.ajax({url:"/php/uploadfile.php",type:"POST",data:e,dataType:"text",success:function(a){setTimeout(check_send_notification,300)},error:function(a,b,c){setTimeout(check_send_notification,300)}})}}function check_send_notification(){var a=document.getElementById("sendNotify").checked;create_billboard();a?send_notification():alert("\u5df2\u65b0\u589e\u516c\u544a!")}
function send_notification(){for(var a=document.getElementById("inputTitle").value,b=document.getElementById("inputContext").value,c=[],d=0;d<gl_send_list.length;d++){var e=gl_send_list[d];e.node_type==NODE_TYPE_SUBGROUP&&c.push(e.nodeid)}document.getElementById("sendnotification_sending_callout").style.display="block";document.getElementById("sendnotification_failed_callout").style.display="none";document.getElementById("sendnotification_finished_callout").style.display="none";d={};d.project_id=
""+project_id;d.sendmultinotification="1";d.subgrouplist=c;d.targetlist=[];d.surveylist=[];d.deadlinelist=[];d.title=a;d.context=b;d.type=glCannedMessages_type;d.imageuid=gl_uploadimage_uid;document.getElementById("savebillboardbtn").disabled=!0;jQuery.ajax({url:gl_target_server+"/php/pushnotify.php",type:"POST",data:d,success:function(a){a=JSON.parse(a);setTimeout(wait_pushnotify_finish,1,a.waitkey)},error:function(a,b,c){console.log("error = "+c);console.log("xhr.responseText = "+a.responseText);
document.getElementById("sendnotification_sending_callout").style.display="none";document.getElementById("sendnotification_failed_callout").style.display="block";document.getElementById("sendnotification_finished_callout").style.display="none";setTimeout(close_callout,5E3,"sendnotification_failed_callout");document.getElementById("savebillboardbtn").disabled=!1}})}
function create_billboard(){var a=document.getElementById("inputTitle").value,b=document.getElementById("inputContext").value,c=0;document.getElementById("sendNotify").checked&&(c=1);for(var d=[],e=0;e<gl_send_list.length;e++){var f=gl_send_list[e];f.node_type==NODE_TYPE_SUBGROUP&&d.push(f.nodeid)}e={};e.project_id=""+project_id;e.createbillboard="1";e.sendpushnotify=c;e.subgrouplist=d.toString();e.title=a;e.content=b;e.imageuid=gl_uploadimage_uid;jQuery.ajax({url:gl_target_server+"/php/pushnotify.php",
type:"POST",data:e,success:function(a){},error:function(a,b,c){}})}function close_callout(a){document.getElementById(a).style.display="none"}
function wait_pushnotify_finish(a){$.getJSON(gl_target_server+"/php/pushnotify.php","waitpushnotify=1&project_id="+project_id+"&waitkey="+a,function(b){void 0==b.success?setTimeout(wait_pushnotify_finish,1E3,a):"true"===b.success?(document.getElementById("sendnotification_sending_callout").style.display="none",document.getElementById("sendnotification_failed_callout").style.display="none",document.getElementById("sendnotification_finished_callout").style.display="block",setTimeout(close_callout,5E3,
"sendnotification_finished_callout"),document.getElementById("savebillboardbtn").disabled=!1):"false"===b.success?(document.getElementById("sendnotification_failed_callout_msg").innerHTML="<p>\u767c\u51fa\u63a8\u64ad \u5931\u6557! "+b.msg+"</p>",document.getElementById("sendnotification_sending_callout").style.display="none",document.getElementById("sendnotification_failed_callout").style.display="block",document.getElementById("sendnotification_finished_callout").style.display="none",setTimeout(close_callout,
1E4,"sendnotification_failed_callout"),document.getElementById("savebillboardbtn").disabled=!1):"wait"===b.success&&setTimeout(wait_pushnotify_finish,1E3,a)}).success(function(){}).error(function(){}).complete(function(){})}function open_billboard_page(){window.open("/index.php/vilsbillboard/"+project_id,"_blank").focus()};window.BlobBuilder=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;var blob,start,end,part,uploaded,SIZE,BYTES_PER_CHUNK,xhr,chunk,UploadImageFinishedCallback=null,uid="";
function sendUploadImageRequest(a){blob=document.getElementById("imageUpload").files[0];if(void 0==blob)return alert("\u8b80\u53d6\u6a94\u6848\u5931\u6557!"),null;BYTES_PER_CHUNK=1048576;SIZE=blob.size;part=start=0;end=BYTES_PER_CHUNK;uploaded=0;UploadImageFinishedCallback=a;uid=Date.now();chunk=blob.slice(start,end);uploadImageFile(chunk,part);start=end;end=start+BYTES_PER_CHUNK;part+=1;uploaded=0;return uid}
function imageSelected(){var a=document.getElementById("imageUpload").files[0];if(a){var b;b=1048576<a.size?(Math.round(100*a.size/1048576)/100).toString()+"MB":(Math.round(100*a.size/1024)/100).toString()+"KB";var c=a.name.split("."),d=document.getElementById("id_new_image_name");void 0!=d&&(d.value=c[0]);d=document.getElementById("id_new_image_description");void 0!=d&&(d.value=c[0]);document.getElementById("imageFileSize").innerHTML="Size: "+b;document.getElementById("imageFileType").innerHTML=
"Type: "+a.type;a=document.getElementById("removebutton");void 0!=a&&a.setAttribute("style","display:block;")}}
function uploadImageFile(a,b){var c=document.getElementById("imageUpload").files[0],d=new FormData;d.append("imageUpload",a);d.append("file",c.name);d.append("uid",uid);d.append("num",parseInt(b));c=new XMLHttpRequest;c.upload.addEventListener("progress",uploadImageProgress,!1);c.addEventListener("load",uploadImageComplete,!1);c.addEventListener("error",uploadImageFailed,!1);c.addEventListener("abort",uploadImageCanceled,!1);c.open("POST","/php/uploadfile.php");c.onload=function(a){};c.setRequestHeader("Cache-Control",
"no-cache");c.send(d)}function uploadImageProgress(a){a.lengthComputable?(a=Math.round(100*(uploaded+a.loaded)/SIZE),document.getElementById("imageProgressNumber").innerHTML=a.toString()+"%"):document.getElementById("imageProgressNumber").innerHTML="unable to compute"}
function uploadImageComplete(a){start<SIZE?(chunk=blob.slice(start,end),uploadImageFile(chunk,part),start=end,end=start+BYTES_PER_CHUNK,part+=1,uploaded+=BYTES_PER_CHUNK):"function"===typeof UploadImageFinishedCallback&&(0==JSON.parse(a.target.responseText).FileSize?UploadImageFinishedCallback(null):UploadImageFinishedCallback(uid))}function uploadImageFailed(a){alert("There was an error attempting to upload the file.");uid=null}
function uploadImageCanceled(a){xhr.abort();uid=xhr=null;alert("The upload has been canceled by the user or the browser dropped the connection.")};
