var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,LOAD_PAGE_NUM=20,gl_usermaingroups=[],gl_usersubgroups=[],glSurvey_List=[],glCurrentPage=1,glNewSurveyIndex=0;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usermaingroups(),load_usersubgroup());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_surveys());break;case 2:PreLoadIndex!=
CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,show_surveys(),CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}function load_usermaingroups(){gl_usermaingroups=gl_maingroups.split(",")}
function load_usersubgroup(){gl_usersubgroups=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,b){gl_usersubgroups.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_surveys(){var a=gl_target_server+"/php/survey.php",c=(glCurrentPage-1)*LOAD_PAGE_NUM,b=LOAD_PAGE_NUM;glSurvey_List=[];$.getJSON(a,"loadsurveys=1&project_id="+project_id+"&offset="+c+"&count="+b+"&accountid="+accountid,function(a){$.each(a,function(a,b){glSurvey_List.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){CurrentLoadIndex+=1}).complete(function(){})}
function show_surveys(){for(var a=document.getElementById("SURVEY_TABLE_BODY");a.firstChild;)a.removeChild(a.firstChild);for(var c=0;c<glSurvey_List.length;c++)show_survey(a,(glCurrentPage-1)*LOAD_PAGE_NUM+c+1,glSurvey_List[c])}
function show_survey(a,c,b){var d=0,e=document.createElement("tr");e.setAttribute("id",b.dbId+"_TABLE_ROW");0==c%2&&e.setAttribute("bgcolor","#ebebe0");a.appendChild(e);e.appendChild(document.createElement("td"));e.cells[d].appendChild(document.createTextNode(""+c));d++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","title_"+b.surveyid);a.appendChild(document.createTextNode(b.title));e.cells[d].appendChild(a);d++;e.appendChild(document.createElement("td"));
a=document.createElement("div");a.setAttribute("id","description_"+b.surveyid);a.appendChild(document.createTextNode(b.description));e.cells[d].appendChild(a);d++;e.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("id","type_"+b.surveyid);e.cells[d].appendChild(a);"0"===b.type&&a.appendChild(document.createTextNode("\u55ae\u9078"));"1"===b.type&&a.appendChild(document.createTextNode("\u8907\u9078"));d++;e.appendChild(document.createElement("td"));a=show_survey_item(b.surveyid,
b.items);e.cells[d].appendChild(a);d++;a=create_subgroup(b.subgroups);a.setAttribute("id","uiid_subgroup_"+b.surveyid);e.appendChild(a);d++;e.appendChild(document.createElement("td"));check_editable(b.maingroups)&&(a=document.createElement("button"),a.setAttribute("id","editbtn_"+b.surveyid),a.setAttribute("title","Edit this Survey"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","edit_survey("+b.surveyid+");return false;"),c=document.createElement("i"),c.setAttribute("id","editimg_"+
b.surveyid),c.setAttribute("class","fa fa-edit"),a.appendChild(c),e.cells[d].appendChild(a),a=document.createElement("button"),a.setAttribute("id","deletebtn_"+b.surveyid),a.setAttribute("style","display:none"),a.setAttribute("title","Delete this Survey"),a.setAttribute("href","javascript:;"),a.setAttribute("onclick","confirm_delete_survey("+b.surveyid+");return false;"),b=document.createElement("i"),b.setAttribute("class","fa fa-trash-o"),a.appendChild(b),e.cells[d].appendChild(a))}
function show_survey_item(a,c){var b=document.createElement("div");b.setAttribute("id","survey_item_"+a);var d=document.createElement("table");b.appendChild(d);var e=document.createElement("thead");d.appendChild(e);var g=document.createElement("tr");e.appendChild(g);e=document.createElement("th");e.setAttribute("style","width: 30px");g.appendChild(e);e=document.createElement("th");g.appendChild(e);e=document.createElement("th");g.appendChild(e);g=document.createElement("tbody");g.setAttribute("id",
"survey_table_body_"+a);d.appendChild(g);for(d=0;d<c.length;d++){var f=c[d],e=document.createElement("tr");g.appendChild(e);var h=document.createElement("td");e.appendChild(h);h.appendChild(document.createTextNode(d+1));h=document.createElement("td");e.appendChild(h);h.appendChild(document.createTextNode(f.description));f=document.createElement("td");e.appendChild(f)}return b}
function edit_survey(a){for(var c=document.getElementById("title_"+a),b=document.getElementById("description_"+a),d=document.getElementById("type_"+a),e=document.getElementById("survey_item_"+a),g=document.getElementById("survey_table_body_"+a),f=document.getElementById("uiid_subgroup_"+a);c.firstChild;)c.removeChild(c.firstChild);for(;b.firstChild;)b.removeChild(b.firstChild);for(;d.firstChild;)d.removeChild(d.firstChild);for(;g.firstChild;)g.removeChild(g.firstChild);for(;f.firstChild;)f.removeChild(f.firstChild);
var h=document.getElementById("editbtn_"+a),k=document.getElementById("editimg_"+a);h.setAttribute("title","Save this Survey");h.setAttribute("onclick","save_survey("+a+");return false;");k.setAttribute("class","fa fa-save");document.getElementById("deletebtn_"+a).setAttribute("style","display:block");for(k=0;k<glSurvey_List.length;k++)if(h=glSurvey_List[k],h.surveyid==a){c.appendChild(create_input_text("input_title_"+a,h.title));b.appendChild(create_input_text("input_description_"+a,h.description));
c=b=!1;"0"===h.type&&(b=!0);"1"===h.type&&(c=!0);b=create_radio_button("optionsRadios1_"+a,"optionsRadios_"+a,"option1","\u55ae\u9078",b);d.appendChild(b);c=create_radio_button("optionsRadios2_"+a,"optionsRadios_"+a,"option2","\u8907\u9078",c);d.appendChild(c);for(d=0;d<h.items.length;d++){c=h.items[d];b=document.createElement("tr");b.setAttribute("id","surveyitem_row_"+a+"_"+c.surveyitemid);g.appendChild(b);k=document.createElement("td");b.appendChild(k);k.appendChild(document.createTextNode(d+1));
k=document.createElement("td");b.appendChild(k);var l=create_input_text("surveyitem_"+a+"_"+c.surveyitemid,c.description);k.appendChild(l);k=document.createElement("td");b.appendChild(k);b=document.createElement("div");b.setAttribute("class","btn-group");k.appendChild(b);k=document.createElement("button");k.setAttribute("class","btn btn-block btn-danger");k.setAttribute("onclick","delete_survey_item_click("+a+", "+c.surveyitemid+");return true;");b.appendChild(k);c=document.createElement("i");c.setAttribute("class",
"fa fa-minus");k.appendChild(c)}b=document.createElement("div");b.setAttribute("class","btn-group");e.appendChild(b);k=document.createElement("button");k.setAttribute("class","btn btn-block btn-success");k.setAttribute("onclick","create_survey_item_click("+a+");return true;");b.appendChild(k);c=document.createElement("i");c.setAttribute("class","fa fa-plus");k.appendChild(c);a=create_edit_subgrouplist_ui(a,h.subgroups);f.appendChild(a);break}}
function save_survey(a){var c=document.getElementById("input_title_"+a).value,b=document.getElementById("input_description_"+a).value,d=document.getElementById("optionsRadios1_"+a),e=document.getElementById("optionsRadios2_"+a);if(0==c.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u540d\u7a31");else if(0==b.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u8aaa\u660e");else{var g=0;d.checked?g=0:e.checked&&(g=1);for(var e=void 0,f=0;f<glSurvey_List.length;f++)if(d=glSurvey_List[f],d.surveyid==a){e=d;break}if(void 0==
e)alert("\u7121\u6b64\u4e8b\u9805\u7d00\u9304!");else{d=[];for(f=0;f<e.items.length;f++){var h=e.items[f],k=document.getElementById("surveyitem_"+a+"_"+h.surveyitemid);if(void 0==k&&(k=document.getElementById("surveyitem_"+a+"_new_"+h.surveyitemnewid),void 0==k))break;h.description=k.value;d.push(h)}e=getSelectedSubgroup(a);f={};f.project_id=""+project_id;f.update_survey=1;f.surveyid=a;f.title=c;f.description=b;f.type=g;f.items=d;f.accountid=accountid;f.subgroups=e;jQuery.ajax({url:gl_target_server+
"/php/survey.php",type:"POST",data:f,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}}
function save_new_survey(){var a=document.getElementById("input_title").value,c=document.getElementById("input_description").value,b=document.getElementById("optionsRadios1"),d=document.getElementById("optionsRadios2"),e=getSelectedSubgroup("new");console.log("save_new_survey() subgroups:"+e);if(0==a.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u540d\u7a31");else if(0==c.length)alert("\u8acb\u8f38\u5165\u4e8b\u9805\u8aaa\u660e");else{var g=0;b.checked?g=0:d.checked&&(g=1);b=[];for(d=1;d<=glNewSurveyIndex;d++){var f=
document.getElementById("surveyitem_"+d).value;b.push(f)}d={};d.project_id=""+project_id;d.create_new_survey=1;d.title=a;d.description=c;d.type=g;d.items=b;d.accountid=accountid;d.subgroups=e;jQuery.ajax({url:gl_target_server+"/php/survey.php",type:"POST",data:d,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,b,c){alert("error = "+c);alert("xhr.responseText = "+a.responseText)}})}}
function confirm_delete_survey(a){confirm("Are you sure you want to delete this survey ?")&&delete_survey(a)}
function delete_survey(a){var c={};c.project_id=""+project_id;c.delete_survey=1;c.surveyid=a;c.accountid=accountid;jQuery.ajax({url:gl_target_server+"/php/survey.php",type:"POST",data:c,success:function(a){400==a.status&&alert("update Error! response = "+JSON.stringify(a));setTimeout(reload_page,300)},error:function(a,c,e){alert("error = "+e);alert("xhr.responseText = "+a.responseText)}})}
function create_empty_survey_table_item(a){a=document.getElementById("SURVEY_TABLE_BODY");if(void 0==document.getElementById("input_title")){a=a.insertRow(0);var c=0;a.appendChild(document.createElement("td"));a.cells[c].appendChild(document.createTextNode(""));c++;a.appendChild(document.createElement("td"));a.cells[c].appendChild(create_input_text("input_title"));c++;a.appendChild(document.createElement("td"));a.cells[c].appendChild(create_input_text("input_description"));c++;a.appendChild(document.createElement("td"));
var b=create_radio_button("optionsRadios1","optionsRadios","option1","\u55ae\u9078",!0);a.cells[c].appendChild(b);b=create_radio_button("optionsRadios2","optionsRadios","option2","\u8907\u9078",!1);a.cells[c].appendChild(b);c++;a.appendChild(document.createElement("td"));b=create_survey_item();a.cells[c].appendChild(b);c++;a.appendChild(document.createElement("td"));b=create_edit_subgrouplist_ui("new","");a.cells[c].appendChild(b);c++;a.appendChild(document.createElement("td"));b=document.createElement("button");
b.setAttribute("class","btn btn-block btn-primary btn-lg");b.setAttribute("onclick","save_new_survey();");b.textContent="\u5132\u5b58";a.cells[c].appendChild(b)}}function create_input_text(a,c){var b=document.createElement("textarea");b.setAttribute("rows","1");b.setAttribute("id",a);b.textContent=c;return b}
function create_subgroup_label(a){var c=document.createElement("span");c.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a65a;");c.textContent=a;return c}
function create_empty_spcae(){var a=document.createElement("span");a.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;");a.textContent="  ";return a}
function create_radio_button(a,c,b,d,e){var g=document.createElement("div");g.setAttribute("class","radio");var f=document.createElement("label");g.appendChild(f);var h=document.createElement("input");h.setAttribute("type","radio");h.setAttribute("id",a);h.setAttribute("name",c);h.setAttribute("value",b);f.appendChild(h);f.appendChild(document.createTextNode(d));e&&(h.checked=!0);return g}
function create_survey_item(){glNewSurveyIndex=1;var a=document.createElement("div"),c=document.createElement("table");a.appendChild(c);var b=document.createElement("thead");c.appendChild(b);var d=document.createElement("tr");b.appendChild(d);b=document.createElement("th");b.setAttribute("style","width: 30px");d.appendChild(b);b=document.createElement("th");d.appendChild(b);d=document.createElement("tbody");d.setAttribute("id","new_survey_table_body");c.appendChild(d);c=document.createElement("tr");
d.appendChild(c);d=document.createElement("td");c.appendChild(d);d.appendChild(document.createTextNode(glNewSurveyIndex));d=document.createElement("td");c.appendChild(d);c=create_input_text("surveyitem_"+glNewSurveyIndex,"");d.appendChild(c);d=document.createElement("div");d.setAttribute("class","btn-group");a.appendChild(d);c=document.createElement("button");c.setAttribute("class","btn btn-block btn-success btn-lg");c.setAttribute("onclick","createnewsurvey_item_click();return true;");d.appendChild(c);
d=document.createElement("i");d.setAttribute("class","fa fa-plus");c.appendChild(d);return a}
function createnewsurvey_item_click(){glNewSurveyIndex++;console.log("createnewsurvey_item_click() glNewSurveyIndex:"+glNewSurveyIndex);var a=document.getElementById("new_survey_table_body"),c=document.createElement("tr");a.appendChild(c);a=document.createElement("td");c.appendChild(a);a.appendChild(document.createTextNode(glNewSurveyIndex));a=document.createElement("td");c.appendChild(a);c=create_input_text("surveyitem_"+glNewSurveyIndex,"");a.appendChild(c);return!1}
function create_survey_item_click(a){for(var c=document.getElementById("survey_table_body_"+a),b=0;b<glSurvey_List.length;b++){var d=glSurvey_List[b];if(d.surveyid==a){var b=d.items.length,e={surveyitemid:-1};e.surveyitemnewid=b;e.surveyitemdelete=0;e.description="";e.DateTime="";d.items.push(e);d=document.createElement("tr");c.appendChild(d);c=document.createElement("td");d.appendChild(c);c.appendChild(document.createTextNode(b+1));c=document.createElement("td");d.appendChild(c);a=create_input_text("surveyitem_"+
a+"_new_"+b,e.description);c.appendChild(a);break}}}function delete_survey_item_click(a,c){for(var b=0;b<glSurvey_List.length;b++){var d=glSurvey_List[b];if(d.surveyid==a){for(b=0;b<d.items.length;b++){var e=d.items[b];if(e.surveyitemid==c){document.getElementById("surveyitem_row_"+a+"_"+c).setAttribute("style","display:none");e.surveyitemdelete=1;d.items[b]=e;break}}break}}}
function create_edit_subgrouplist_ui(a,c){var b=document.createElement("div");b.setAttribute("class","btn-group");var d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("class","btn btn-default btn-sm dropdown-toggle");d.setAttribute("data-toggle","dropdown");d.textContent="\u5b50\u96c6\u5408";b.appendChild(d);var e=document.createElement("span");e.setAttribute("class","caret");d.appendChild(e);d=document.createElement("ul");d.setAttribute("class","dropdown-menu");b.appendChild(d);
if(2==gl_groupid||3==gl_groupid){var e=document.createElement("li"),g=document.createElement("a");g.setAttribute("class","small");g.setAttribute("href","javascript:;");g.setAttribute("onclick",'dropdown_selectall("subgroup","'+a+'");return true;');e.appendChild(g);g.appendChild(document.createTextNode("\u5168\u9078"));d.appendChild(e)}e=c.split(",");for(g=0;g<gl_usersubgroups.length;++g){var f=gl_usersubgroups[g],h=check_numer_in_list(parseInt(f.subgroupid),e);d.appendChild(create_dropdown_subgroup_item(a,
g,parseInt(f.subgroupid),f.subgroupname,h))}return b}
function create_dropdown_subgroup_item(a,c,b,d,e){var g=document.createElement("li"),f=document.createElement("a");f.setAttribute("class","small");f.setAttribute("tabIndex","-1");f.setAttribute("data-value",b);f.setAttribute("href","javascript:;");f.setAttribute("onclick",'dropdown_subgroup_click("'+a+'",'+c+");return true;");b=document.createElement("input");b.setAttribute("type","checkbox");b.setAttribute("id","dropdown_checkbox_subgroup_"+a+"_"+c);b.setAttribute("onclick",'dropdown_checkbox_subgroup_click("'+
a+'",'+c+");return true;");b.checked=e;f.appendChild(b);f.appendChild(document.createTextNode(" "+d));g.appendChild(f);return g}function dropdown_checkbox_subgroup_click(a,c){glDropdown_checkbox_subgroup_click=!0}var glDropdown_checkbox_subgroup_click=!1;
function dropdown_subgroup_click(a,c){1!=glDropdown_checkbox_subgroup_click&&(1==document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c).checked?document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c).checked=!1:document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c).checked=!0);glDropdown_checkbox_subgroup_click=!1}
function dropdown_selectall(a,c){console.log("dropdown_selectall() prefix:"+a+" fileid:"+c);for(var b=0;100>b;b++){var d=document.getElementById("dropdown_checkbox_"+a+"_"+c+"_"+b);if(void 0==d){console.log("dropdown_selectall() fileid:"+c+" i:"+b+" ele == undefined ");break}d.checked=!0}}
function create_subgroup(a){var c=document.createElement("td");a=a.split(",");if(0<=a.indexOf("99999")){var b=document.createElement("div");b.appendChild(create_subgroup_label("\u5168\u90e8"));c.appendChild(b)}else for(var d=0,b=void 0,e=0;e<a.length;e++){var g=getSubgroupName(a[e]);0<g.length&&(0==d&&(b=document.createElement("div"),c.appendChild(b)),b.appendChild(create_subgroup_label(g)),b.appendChild(create_empty_spcae()),d++,5<=d&&(d=0))}return c}
function getSelectedSubgroup(a){for(var c=[],b=0,d=0;d<gl_usersubgroups.length;++d){var e=gl_usersubgroups[d];document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+d).checked&&(e=parseInt(e.subgroupid),c.push(e),b++)}1!=gl_groupid&&2!=gl_groupid||b!=gl_usersubgroups.length||(c=[],c.push(99999));return c.toString()}function check_numer_in_list(a,c){for(var b=!1,d=0;d<c.length;++d){var e=c[d];if(parseInt(e)==a||99999==parseInt(e)){b=!0;break}}return b}
function check_editable(a){var c=!1;a=a.split(",");for(var b=0;b<gl_usermaingroups.length;++b){for(var d=gl_usermaingroups[b],e=0;e<a.length;++e)if(d==a[e]){c=!0;break}if(c)break}return c}function getSubgroupName(a){var c="";if("99999"==a)return"\u5168\u90e8";for(var b=0;b<gl_usersubgroups.length;++b){var d=gl_usersubgroups[b];if(parseInt(d.subgroupid)==a){c=d.subgroupname;break}}return c}function create_new_survey(){create_empty_survey_table_item(glSurvey_List.length+1);return!1}
function reload_page(){PreLoadIndex=-1;CurrentLoadIndex=0;check_loading_status()}function move_page_backward(){var a=document.getElementById("id_current_page_num");1>=glCurrentPage||(glCurrentPage--,a.textContent=glCurrentPage,reload_page())}function move_page_forward(){var a=document.getElementById("id_current_page_num");glCurrentPage++;a.textContent=glCurrentPage;reload_page()}function open_survey_page(){window.open("/index.php/vilssurvey/"+project_id,"_blank").focus()};
