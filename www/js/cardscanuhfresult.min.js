var glAllCardScanResult={},gl_rfiddevices=[],gl_rfidcards=[],gl_user_info=[],gl_cardscanresult=[],LOAD_CARD_NUM=300,gl_rfidcard_load_index=0,LOAD_USER_NUM=500,gl_user_load_index=0,PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=999,MAX_SHOW_RESULT=20,LOAD_PAGE_NUM=20,gl_CurrentPage=1;loading_status();
function loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_rfiddevice());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_cardscan_result());break;case 2:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,show_cardscan_result(),CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=CurrentLoadIndex,load_rfidcard());break;case 4:PreLoadIndex!=CurrentLoadIndex&&(PreLoadIndex=
CurrentLoadIndex,load_user_info())}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(loading_status,100):setTimeout(reload_cardscan_result,5E3)}function reload_cardscan_result(){PreLoadIndex=0;CurrentLoadIndex=1;loading_status()}
function load_rfiddevice(){gl_rfiddevices=[];$.getJSON(gl_target_server+"/php/rfiddevice.php","loaddevice=1&project_id="+project_id,function(c){$.each(c,function(b,a){gl_rfiddevices.push(a)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function load_rfidcard(){for(var c=[],b=0;b<gl_cardscanresult.length;++b){for(var a=gl_cardscanresult[b],e=!1,d=0;d<gl_rfidcards.length;++d){var f=gl_rfidcards[d];if(f.cardid===a.cardid){e=!0;break}}if(0==e)for(d=0;d<c.length;++d)if(f=c[d],f===a.cardid){e=!0;break}0==e&&c.push(a.cardid)}0==c.length?CurrentLoadIndex+=1:(querycard=c.toString(),$.getJSON(gl_target_server+"/php/rfiddevice.php","querycards=1&cardid="+querycard+"&project_id="+project_id,function(a){$.each(a,function(a,b){gl_rfidcards.push(b)})}).success(function(){CurrentLoadIndex+=
1}).error(function(){CurrentLoadIndex+=1}).complete(function(){}))}
function load_user_info(){for(var c="",b=0,a=0;a<gl_rfidcards.length;++a){for(var e=gl_rfidcards[a],d=parseInt(e.userid),f=!1,g=0;g<gl_user_info.length;++g)if(gl_user_info[g].userid==d){f=!0;break}0==f&&0!=d&&(0<b&&(c+=","),c+=e.userid,b+=1)}0==c.length?CurrentLoadIndex=LOAD_STATE_END:$.getJSON(gl_target_server+"/php/vilsnodes.php","queryusers=1&userid="+c+"&project_id="+project_id,function(a){$.each(a,function(a,b){b.userid=parseInt(b.userid);gl_user_info.push(b)})}).success(function(){PreLoadIndex=
0;CurrentLoadIndex=1}).error(function(){}).complete(function(){})}
function load_cardscan_result(){var c=(gl_CurrentPage-1)*LOAD_PAGE_NUM,b=LOAD_PAGE_NUM;gl_cardscanresult=[];var a=document.getElementById("search_uhfcard_text").value,e="loadcardscan=1&s="+c+"&count="+b+"&project_id="+project_id;0<a.length&&(e="loadcardscan=1&s="+c+"&count="+b+"&project_id="+project_id+"&matchname="+a);$.getJSON(gl_target_server+"/php/rfiddevice.php",e,function(a){$.each(a,function(a,b){gl_cardscanresult.push(b)})}).success(function(){CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function show_cardscan_result(){document.getElementById("CARDSCAN_TABLE_MSG").innerText="";for(var c=document.getElementById("CARDSCAN_TABLE");1<=c.rows.length;)c.deleteRow(0);for(var b=0;b<gl_cardscanresult.length;++b){var a=uhfcards_create_record_table_item((gl_CurrentPage-1)*LOAD_PAGE_NUM+b,gl_cardscanresult[b]);c.appendChild(a)}}
function uhfcards_create_record_table_item(c,b){if(null==b)return null;var a=document.createElement("tr");1==c%2&&a.setAttribute("bgcolor","#ebebe0");var e=getRFIDCard(b.cardid),d=b.cardid,f="";null!=e&&(d=e.name,0<e.userid&&(f=d=getUserName(e.userid)),0==d.length&&(d=b.cardid));e=0;a.appendChild(document.createElement("td"));a.cells[e].appendChild(document.createTextNode(""+c));e++;a.appendChild(document.createElement("td"));var g=document.createElement("span");g.setAttribute("id","card_name_"+b.cardid);
g.setAttribute("class","badge bg-blue-active");g.textContent=d;a.cells[e].appendChild(g);e++;a.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");d.textContent=b.cardid;a.cells[e].appendChild(d);e++;a.appendChild(document.createElement("td"));d=document.createElement("span");d.setAttribute("class","badge bg-blue");d.textContent=getRFIDDeviceName(b.LoRAMacaddress);a.cells[e].appendChild(d);e++;a.appendChild(document.createElement("td"));
d=document.createElement("span");d.setAttribute("id","card_username_"+b.cardid);0<f.length&&(d.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:1;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:rgb(54, 127, 169);"),d.textContent=f);a.cells[e].appendChild(d);e++;a.appendChild(document.createElement("td"));f=document.createElement("span");f.setAttribute("class","badge bg-green-active");f.textContent=b.datetime;
a.cells[e].appendChild(f);return a}function getRFIDCard(c){for(var b=0;b<gl_rfidcards.length;b++){var a=gl_rfidcards[b];if(a.cardid===c)return a}return null}function getRFIDDeviceName(c){for(var b=0;b<gl_rfiddevices.length;b++){var a=gl_rfiddevices[b];if(a.LoRAMacaddress===c)return a.name}return""}function getUserName(c){for(var b="",a=0;a<gl_user_info.length;a++)if(c==gl_user_info[a].userid){b=gl_user_info[a].name;break}return b}
function move_page_backward(){var c=document.getElementById("id_current_page_num");1>=gl_CurrentPage||(gl_CurrentPage--,c.textContent=gl_CurrentPage,reload_cardscan_result())}function move_page_forward(){var c=document.getElementById("id_current_page_num");gl_CurrentPage++;c.textContent=gl_CurrentPage;reload_cardscan_result()}function search_rfidcard_text_change(c){glCurrentPage=1;reload_cardscan_result();return!1}var $source=document.querySelector("#search_uhfcard_text");
$source.addEventListener("input",search_rfidcard_text_change);function open_cardscanuhfresult_page(){window.open("/index.php/vilscardscanuhfresult/"+project_id,"_blank").focus()};
