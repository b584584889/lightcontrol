var glAllAreas=[],glTagLocation=[],glUserLocation=[],gl_tag_num=0,gl_tag_load_index=0,gl_user_load_index=0,LOAD_DEVICE_NUM=20;load_maparea();
function create_location_table_item(b,a,f,c,d,e){if(null==a||void 0==d&&void 0==e)return null;var g=0;void 0!=d&&(g+=d.length);void 0!=e&&(g+=e.length);var h=document.createElement("tr"),k=0;h.appendChild(document.createElement("td"));h.cells[k].appendChild(document.createTextNode(""+b));k++;b=document.createElement("td");b.setAttribute("style","height: 90px;");h.appendChild(b);var l=document.createElement("span");l.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");l.textContent=
a;h.cells[k].appendChild(l);k++;l=document.createElement("td");b.setAttribute("style","height: 90px;");h.appendChild(l);b=document.createElement("span");b.setAttribute("style","font-size:14px; font-weight:bold; color:#330033;");"0"==f&&b.setAttribute("class","badge bg-yellow-active");"1"==f&&b.setAttribute("class","badge bg-fuchsia");"2"==f&&b.setAttribute("class","badge bg-green-active");"3"==f&&b.setAttribute("class","badge bg-purple");"4"==f&&b.setAttribute("class","badge bg-teal-active");"5"==
f&&b.setAttribute("class","badge bg-green-active");"6"==f&&b.setAttribute("class","badge bg-purple");b.textContent=get_Areatype(f);"Unknown"===a||"0"!=f&&"1"!=f&&"2"!=f&&"3"!=f&&"4"!=f&&"5"!=f&&"6"!=f||(a=document.createElement("button"),a.setAttribute("class","btn btn-danger pull-right"),a.setAttribute("onclick","window.open('"+gl_target_server+"/index.php/vilsrollcall/"+project_id+"?areaid="+c+"','_blank');"),a.textContent="\u7522\u751f\u5831\u544a",h.cells[k].appendChild(a));h.cells[k].appendChild(b);
k++;h.appendChild(document.createElement("td"));a=document.createElement("div");a.setAttribute("class","color-palette-set");h.cells[k].appendChild(a);c=document.createElement("div");c.setAttribute("style","text-align:center;");a.appendChild(c);a=document.createElement("span");a.textContent=g;a.setAttribute("style","font-size:18px; font-weight:bold; color:#003300;");c.appendChild(a);k++;h.appendChild(document.createElement("td"));void 0!=d&&(d=create_tag_node(d),h.cells[k].appendChild(d));void 0!=
e&&(e=create_user_node(e),h.cells[k].appendChild(e));return h}
function create_tag_node(b){for(var a=document.createElement("div"),f=0;f<b.length;++f){var c=b[f],d=c[3],e=decodeURIComponent(c[5]),g=!0;"-1"==c[0]&&(g=!1);var h=c[1],c="bg-teal";1==g&&(c="bg-purple");"0"==h&&(c="bg-light-blue");var k=document.createElement("div");k.setAttribute("class","col-sm-4 col-md-2");a.appendChild(k);g=document.createElement("div");g.setAttribute("class","color-palette-set");k.appendChild(g);k=document.createElement("div");k.setAttribute("class",c+" disabled color-palette");
k.setAttribute("style","text-align:center;");g.appendChild(k);var l=document.createElement("span");l.textContent=d;l.setAttribute("style","font-size:18px; font-weight:bold; color:#e6f5ff;");k.appendChild(l);k=document.createElement("div");k.setAttribute("class",c+" color-palette");k.setAttribute("style","text-align:center;");g.appendChild(k);l=document.createElement("span");l.textContent=e;l.setAttribute("style","font-size:16px; font-weight:bold; color:#e6f5ff;");k.appendChild(l);e=document.createElement("div");
e.setAttribute("class",c+"-active color-palette");e.setAttribute("style","text-align:center;");g.appendChild(e);k=document.createElement("span");k.textContent=h;k.setAttribute("style","font-size:14px; font-weight:bold; color:#e6f5ff;");e.appendChild(k);h=document.createElement("div");h.setAttribute("class",c+"-active color-palette");h.setAttribute("style","text-align:center;");g.appendChild(h);c=document.createElement("span");c.textContent="";e=document.createElement("a");e.setAttribute("href","javascript:;");
e.setAttribute("onclick",'show_on_2dmap("'+d+'");return false;');e.setAttribute("style","font-size:14px; color:#eeeeee;");e.title="\u8df3\u8f49\u52302D\u5730\u5716";e.textContent="\u67e5\u770b\u5730\u5716";c.appendChild(e);h.appendChild(c);d=document.createElement("div");d.setAttribute("style","text-align:center; color:#e6f5ff;");g.appendChild(d);g=document.createElement("span");g.textContent="-";g.setAttribute("style","font-size:14px; font-weight:bold; color:#e6f5ff;");d.appendChild(g)}return a}
function create_user_node(b){for(var a=document.createElement("div"),f=0;f<b.length;++f){var c=b[f],d=document.createElement("div");d.setAttribute("class","col-sm-4 col-md-2");a.appendChild(d);var e=document.createElement("div");e.setAttribute("class","color-palette-set");d.appendChild(e);d=document.createElement("div");d.setAttribute("class","bg-purple disabled color-palette");d.setAttribute("style","text-align:center;");e.appendChild(d);var g=document.createElement("span");g.textContent=c.userid;
g.setAttribute("style","font-size:18px; font-weight:bold; color:#e6f5ff;");d.appendChild(g);d=document.createElement("div");d.setAttribute("class","bg-purple color-palette");d.setAttribute("style","text-align:center;");e.appendChild(d);g=document.createElement("span");g.textContent=c.name;g.setAttribute("style","font-size:16px; font-weight:bold; color:#e6f5ff;");d.appendChild(g);d=document.createElement("div");d.setAttribute("class","bg-purple-active color-palette");d.setAttribute("style","text-align:center;");
e.appendChild(d);g=document.createElement("span");g.setAttribute("style","font-size:14px; font-weight:bold; color:#e6f5ff;");d.appendChild(g);d=document.createElement("div");d.setAttribute("class","bg-purple-active color-palette");d.setAttribute("style","text-align:center;");e.appendChild(d);g=document.createElement("span");g.textContent="";var h=document.createElement("a");h.setAttribute("href","javascript:;");h.setAttribute("onclick",'show_user_on_2dmap("'+c.userid+'");return false;');h.setAttribute("style",
"font-size:14px; color:#eeeeee;");h.title="\u8df3\u8f49\u52302D\u5730\u5716";h.textContent="\u67e5\u770b\u5730\u5716";g.appendChild(h);d.appendChild(g);c=document.createElement("div");c.setAttribute("style","text-align:center; color:#e6f5ff;");e.appendChild(c);e=document.createElement("span");e.textContent="-";e.setAttribute("style","font-size:14px; font-weight:bold; color:#e6f5ff;");c.appendChild(e)}return a}
function load_maparea(){$.getJSON(gl_target_server+"/php/map.php","project_id="+project_id+"&loadLocationArea=1",function(b){var a=0;$.each(b,function(b,c){var d=JSON.parse(c);glAllAreas[a]={};glAllAreas[a].itemid=d.properties.areaid;glAllAreas[a].itemname=d.properties.areaname;glAllAreas[a].itemtype=d.properties.areatype;glTagLocation[glAllAreas[a].itemid]=[];a++});sortAreaList();glAllAreas[a]={};glAllAreas[a].itemid="Unknown";glAllAreas[a].itemname="Unknown";glAllAreas[a].itemtype=0;glTagLocation.Unknown=
[];updateLocation()})}function load_Tags_Info(){$.getJSON(gl_target_server+"/php/vilsnodes.php","devicescount=1&project_id="+project_id,function(b){gl_tag_num=parseInt(b.LOC_TAG_NUM);gl_tag_load_index=0}).success(function(){clear_old_data();setTimeout(load_Tags,10)}).error(function(){setTimeout(load_Tags_Info,1E3)}).complete(function(){})}
function load_Tags(){gl_tag_load_index>=gl_tag_num?(gl_tag_load_index=0,draw_table(),setTimeout(load_Tags_Info,500)):$.getJSON(gl_target_server+"/php/vilsnodes.php","loadtag=1&s="+gl_tag_load_index+"&count="+LOAD_DEVICE_NUM+"&project_id="+project_id,function(b){for(var a=parseInt(b.LOC_TAG_NUM),f=gl_tag_load_index;f<gl_tag_load_index+a;++f){var c="LOC_TAG_INDEX_"+f;if(void 0!=b[c]&&null!=b[c]){var c=b[c].split(","),d=c[1],e=c[19],g=c[28],h=c[33],k=c[34],l=c[35];0==c[20].length&&0==k.length||"1"===
g?(e="Unknown",h=""):"0"==d&&"0"==l&&(e="Unknown",h="");0<h.length?(void 0!=glTagLocation[e]&&glTagLocation[e].push(c),e!==h&&void 0!=glTagLocation[h]&&glTagLocation[h].push(c)):void 0!=glTagLocation[e]?glTagLocation[e].push(c):glTagLocation.Unknown.push(c)}}gl_tag_load_index+=a}).success(function(){gl_tag_load_index>=gl_tag_num?(gl_tag_load_index=0,draw_table(),setTimeout(load_Tags_Info,500)):setTimeout(load_Tags,10)}).error(function(){gl_tag_load_index=0;setTimeout(load_Tags,1E3)}).complete(function(){})}
function runLive_user(){0==gl_user_load_index&&(glUserLocation=[]);var b=0;$.getJSON(gl_target_server+"/php/vilsnodes.php","loaduserpoistioninfo=1&s="+gl_user_load_index+"&count=500&project_id="+project_id,function(a){$.each(a,function(a,c){b+=1;gl_user_load_index+=1;var d=c.AreaId;void 0!=d&&0<d.length?(void 0==glUserLocation[d]&&(glUserLocation[d]=[]),glUserLocation[d].push(c)):(void 0==glUserLocation.Unknown&&(glUserLocation.Unknown=[]),glUserLocation.Unknown.push(c))})}).success(function(){500>
b?(gl_user_load_index=0,setTimeout(runLive_user,1E3)):setTimeout(runLive_user,50)}).error(function(){gl_user_load_index=0;setTimeout(runLive_user,500)}).complete(function(){})}function updateLocation(){load_Tags_Info();runLive_user()}
function draw_table(){for(var b=document.getElementById("NODE_LOCATION_TABLE_BODY");1<=b.rows.length;)b.deleteRow(0);for(var a=0;a<glAllAreas.length;++a){var f=glAllAreas[a],f=create_location_table_item(a,f.itemname,f.itemtype,f.itemid,glTagLocation[f.itemid],glUserLocation[f.itemid]);b.appendChild(f)}}
function sortAreaList(){for(var b=0;b<glAllAreas.length;b++)for(var a=glAllAreas[b],f=b+1;f<glAllAreas.length;f++){var c=glAllAreas[f];if(a.itemname>c.itemname){var d=a.itemid,e=a.itemname,g=a.itemtype;a.itemid=c.itemid;a.itemname=c.itemname;a.itemtype=c.itemtype;glAllAreas[b]=a;glAllAreas[f].itemid=d;glAllAreas[f].itemname=e;glAllAreas[f].itemtype=g}}}function clear_old_data(){for(var b=0;b<glAllAreas.length;++b)glTagLocation[glAllAreas[b].itemid]=[]}
function get_node_type(b){var a="";"0"==b?a="ANCHOR":"1"==b?a="TAG":"2"==b&&(a="COORD");return a}function get_Areatype(b){var a="";"0"==b?a="\u666e\u901a":"1"==b?a="\u96fb\u5b50\u570d\u6b04":"2"==b?a="\u96fb\u5b50\u9ede\u540d":"3"==b?a="\u623f\u9593":"4"==b?a="\u6559\u5ba4":"5"==b?a="\u75c5\u623f":"6"==b&&(a="\u75c5\u5e8a");return a}function show_on_2dmap(b){window.open("/index.php/vils2dmap/"+project_id+"?nodeid="+b,"_self")}
function show_user_on_2dmap(b){window.open("/index.php/vils2dmap/"+project_id+"?userid="+b,"_self")}function open_location_page(){window.open("/index.php/vilslocation/"+project_id,"_blank").focus()};
