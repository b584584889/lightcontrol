var $jscomp={scope:{}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(d,f,h){if(h.get||h.set)throw new TypeError("ES3 does not support getters and setters.");d!=Array.prototype&&d!=Object.prototype&&(d[f]=h.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.symbolCounter_=0;$jscomp.Symbol=function(d){return $jscomp.SYMBOL_PREFIX+(d||"")+$jscomp.symbolCounter_++};
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var d=$jscomp.global.Symbol.iterator;d||(d=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[d]&&$jscomp.defineProperty(Array.prototype,d,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(d){var f=0;return $jscomp.iteratorPrototype(function(){return f<d.length?{done:!1,value:d[f++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(d){$jscomp.initSymbolIterator();d={next:d};d[$jscomp.global.Symbol.iterator]=function(){return this};return d};$jscomp.array=$jscomp.array||{};$jscomp.iteratorFromArray=function(d,f){$jscomp.initSymbolIterator();d instanceof String&&(d+="");var h=0,k={next:function(){if(h<d.length){var l=h++;return{value:f(l,d[l]),done:!1}}k.next=function(){return{done:!0,value:void 0}};return k.next()}};k[Symbol.iterator]=function(){return k};return k};
$jscomp.polyfill=function(d,f,h,k){if(f){h=$jscomp.global;d=d.split(".");for(k=0;k<d.length-1;k++){var l=d[k];l in h||(h[l]={});h=h[l]}d=d[d.length-1];k=h[d];f=f(k);f!=k&&null!=f&&$jscomp.defineProperty(h,d,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Array.prototype.keys",function(d){return d?d:function(){return $jscomp.iteratorFromArray(this,function(d){return d})}},"es6-impl","es3");
L.ImageOverlay.Rotated=L.ImageOverlay.extend({initialize:function(d,f,h,k,l){"string"===typeof d?this._url=d:this._rawImage=d;this._topLeft=L.latLng(f);this._topRight=L.latLng(h);this._bottomLeft=L.latLng(k);L.setOptions(this,l)},onAdd:function(d){this._image||(this._initImage(),1>this.options.opacity&&this._updateOpacity());this.options.interactive&&(L.DomUtil.addClass(this._rawImage,"leaflet-interactive"),this.addInteractiveTarget(this._rawImage));d.on("zoomend resetview",this._reset,this);this.getPane().appendChild(this._image);
this._reset()},onRemove:function(d){d.off("zoomend resetview",this._reset,this);L.ImageOverlay.prototype.onRemove.call(this,d)},_initImage:function(){var d=this._rawImage;this._url&&(d=L.DomUtil.create("img"),d.style.display="none",this.options.crossOrigin&&(d.crossOrigin=""),d.src=this._url,this._rawImage=d);L.DomUtil.addClass(d,"leaflet-image-layer");var f=this._image=L.DomUtil.create("div","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));this._updateZIndex();f.appendChild(d);
f.onselectstart=L.Util.falseFn;f.onmousemove=L.Util.falseFn;d.onload=function(){this._reset();d.style.display="block";this.fire("load")}.bind(this);d.alt=this.options.alt},_reset:function(){var d=this._image;if(void 0!=this._map){var f=this._map.latLngToLayerPoint(this._topLeft),h=this._map.latLngToLayerPoint(this._topRight),k=this._map.latLngToLayerPoint(this._bottomLeft),l=h.subtract(f).add(k),q=L.bounds([f,h,k,l]),v=q.getSize(),l=f.subtract(q.min),u=h.subtract(f),w=k.subtract(f),u=Math.atan2(u.y,
u.x),w=Math.atan2(w.x,w.y);this._bounds=L.latLngBounds(this._map.layerPointToLatLng(q.min),this._map.layerPointToLatLng(q.max));L.DomUtil.setPosition(d,q.min);d.style.width=v.x+"px";d.style.height=v.y+"px";q=this._rawImage.width;d=this._rawImage.height;q&&d&&(h=f.distanceTo(h)/q*Math.cos(u),f=f.distanceTo(k)/d*Math.cos(w),this._rawImage.style.transformOrigin="0 0",this._rawImage.style.transform="translate("+l.x+"px, "+l.y+"px)skew("+w+"rad, "+u+"rad) scale("+h+", "+f+") ")}},reposition:function(d,
f,h){this._topLeft=L.latLng(d);this._topRight=L.latLng(f);this._bottomLeft=L.latLng(h);this._reset()},setUrl:function(d){this._url=d;this._rawImage&&(this._rawImage.src=d);return this}});L.imageOverlay.rotated=function(d,f,h,k,l){return new L.ImageOverlay.Rotated(d,f,h,k,l)};var Indoor2DMap=function(d){function f(a,c){return FloatDiv(c,11132E3*Math.cos(a*Math.PI/180))}function h(a,c){return FloatMul(c,11132E3*Math.cos(a*Math.PI/180))}this.mEnableUISmoothing=!0;this.SHOW_LOCATOR_DEFAULT=this.SHOW_AREA_DEFAULT=!1;var k=function(a,c){return L.Util.isArray(a)?L.latLng(a[1],a[0]):L.latLng(c,a)},l=L.icon({iconUrl:"/images/orig-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),
q=L.icon({iconUrl:"/images/coord-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),v=L.icon({iconUrl:"/images/marker-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),u=L.icon({iconUrl:"/images/tag-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,
47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),w=L.icon({iconUrl:"/images/marker-sleep-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),G=L.icon({iconUrl:"/images/marker-sleep-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),H=L.icon({iconUrl:"/images/anchor-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),z=L.icon({iconUrl:"/images/locator-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),I=L.icon({iconUrl:"/images/locator-notalive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),J=L.icon({iconUrl:"/images/locator-poweroff-icon-2x.png",
shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),K=L.icon({iconUrl:"/images/gray-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),M=L.icon({iconUrl:"/images/gray-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,
-35]}),N=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]});L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[50,74],shadowSize:[41,41],iconAnchor:[25,74],shadowAnchor:[14,41],popupAnchor:[0,-35]});var O=L.icon({iconUrl:"/images/inactive-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,
37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),P=L.icon({iconUrl:"/images/inactive-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),Q=L.icon({iconUrl:"/images/norollcall-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[25,37],shadowSize:[41,41],iconAnchor:[14,37],shadowAnchor:[14,41],popupAnchor:[0,-35]}),R=L.icon({iconUrl:"/images/norollcall-lowbattery-icon-2x.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[30,47],shadowSize:[41,41],iconAnchor:[15,47],shadowAnchor:[14,41],popupAnchor:[0,-35]}),A=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),B=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),C=L.icon({iconUrl:"/images/pin_watch.png",shadowUrl:"/images/marker-shadow.png",
iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),y=L.icon({iconUrl:"/images/pin_lidar.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),D=L.icon({iconUrl:"/images/pin_user.png",shadowUrl:"/images/marker-shadow.png",iconSize:[42,56],shadowSize:[41,41],iconAnchor:[21,56],shadowAnchor:[15,56],popupAnchor:[0,-56]}),E="#FF6347 #FFA500 #FFD700 #32CD32 #87CEEB #7B68EE #8A2BE2 #4245f4 #F08080 #f441d9".split(" ");
this.mMapLayer_nodes=[];this.mMapLayerId=1;this.OriginMarker=null;this.Anchors=[];this.Tags=[];this.Coords=[];this.Locators=[];this.Sensors=[];this.Users=[];this.TagDrawList=[];this.TagGPSDrawList=[];this.MapAreas=[];this.AddressList=[];this.AlertIconScaleIndexList=[];this.AlertIconScaleUpDownList=[];this.StreetMaps=[[]];this.NodeAlertFunction=[];this.areaborder_color="#8b95aa";this.areaborder_opacity="0.8";this.FadeOutPolylines=[[]];this.FadeOutNodes=[[]];this.mRotateMap=this.mShowTrack=!1;this.mTargetDragCallback=
this.mEditModeCallback=this.mNodeClickCallback=this.mUpdateMapInfoCallback=this.mOrigNodeDragCallback=this.mNodeDragCallback=null;this.mEdit_delete_mode=this.mEdit_mode=!1;this.mEdit_maparea_index=-1;this.mLayerControl=this.mUsermapScaleDown=this.mUsermapScaleUp=this.mUsermapEdit=null;this.mMap_OrigY=this.mMap_OrigX=this.mMap_coeff=this.mMap_scale=this.mUsermap_height=this.mUsermap_width=this.mMAP_North=this.mWGS48OriginY=this.mWGS48OriginX=0;this.mBounds=[k(0,0),k(1E3,1E3)];this.mUserProject_Name=
this.mUserMap_url=this.mUserMaplayer=null;this.smoothing_time=400;this.move_step_size=6;this.move_loop_count=0;this.GPS_smoothing_time=400;this.GPS_move_step_size=10;this.GPS_move_loop_count=0;this.popupZoom=20;this.mDrawControl=null;this.baseLayers={};this.layer_areas=new L.FeatureGroup;this.overlays={};L.Map=L.Map.extend({openPopup:function(a,c,b){a instanceof L.Popup||(a=(new L.Popup(b)).setContent(a));c&&a.setLatLng(c);if(this.hasLayer(a))return this;this._popup=a;return this.addLayer(a)}});this.mMap=
L.map(d,{maxZoom:26,zoomSnap:0,zoomDelta:.25,doubleClickZoom:!1});this.mLayerControl=L.control.layers().addTo(this.mMap);this.mMap.attributionControl.setPrefix('<a href="http://smims.com">SMIMS</a>');this.mMap.orig_this=this;d=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:26,attribution:'&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors'});var F=L.tileLayer("http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,
subdomains:["mt0","mt1","mt2","mt3"]}),S=L.tileLayer("http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{attribution:"Google",maxZoom:26,subdomains:["mt0","mt1","mt2","mt3"]});this.mLayerControl.addOverlay(d,"OpenStreetMap");this.mLayerControl.addOverlay(F,"Google Streets");this.mLayerControl.addOverlay(S,"Google Satellite");this.StreetMaps.OpenStreetMap=0;this.StreetMaps["Google Streets"]=0;this.StreetMaps["Google Satellite"]=0;Indoor2DMap.prototype.create_alert_scale_icon=function(){var a;for(a=
0;10>a;a++){var c=25*(1+.1*a),b=37*(1+.1*a),c=L.icon({iconUrl:"/images/alert-icon-2x.png",shadowUrl:"/images/marker-shadow.png",iconSize:[c,b],shadowSize:[41,41],iconAnchor:[c/2,b],shadowAnchor:[14,41],popupAnchor:[0,-35]});this.AlertIconScaleUpDownList[a]=c}};Indoor2DMap.prototype.onOverlayAdd=function(a){a.name in this.orig_this.StreetMaps&&(this.orig_this.StreetMaps[a.name]=1,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.onOverlayRemove=function(a){a.name in this.orig_this.StreetMaps&&
(this.orig_this.StreetMaps[a.name]=0,this.orig_this.updateMapRotate(this.orig_this))};Indoor2DMap.prototype.updateMapRotate=function(a){var c=!1;for(map in a.StreetMaps)if(1==a.StreetMaps[map]){c=!0;break}a.mRotateMap=c;a.update_2d_map(a);a.update_node_pos(a,a.Anchors);a.update_node_pos(a,a.Coords);a.load_allmaparea(a)};Indoor2DMap.prototype.update_2d_map=function(a){null!=a.mUserMaplayer&&a.mMap.removeLayer(a.mUserMaplayer);var c=FloatDiv(a.mUsermap_width,a.mMap_scale*a.mMap_coeff),b=FloatDiv(a.mUsermap_height,
a.mMap_scale*a.mMap_coeff),e=a.mWGS48OriginY+FloatDiv(FloatMul(a.mMap_OrigY,-1),11057400),n=a.mWGS48OriginX+f(e,FloatMul(a.mMap_OrigX,-1)),e=k(n,e),n=FloatDiv(1E4,11057400),g=f(a.mWGS48OriginY+n,1E4),c=k(e.lng+c,e.lat+n/g*b);a.mBounds=[e,c];n=new L.latLng(a.mBounds[1].lat,a.mBounds[0].lng);g=new L.latLng(a.mBounds[1].lat,a.mBounds[1].lng);c=new L.latLng(a.mBounds[0].lat,a.mBounds[0].lng);b=new L.latLng(a.mWGS48OriginY,this.mWGS48OriginX);e=0;a.mRotateMap&&(e=a.mMAP_North);n=rotatePoint(n,e,b);g=rotatePoint(g,
e,b);c=rotatePoint(c,e,b);a.mUserMaplayer=L.imageOverlay.rotated(a.mUserMap_url,n,g,c,{opacity:.5,interactive:!0,attribution:a.mUserProject_Name});a.mMap.addLayer(a.mUserMaplayer,a.mUserProject_Name)};Indoor2DMap.prototype.update_node_pos=function(a,c){for(var b=0;b<c.length;b++){var e=c[b];if(null!=e){var n=a.convertToLatLng(a,e.posX,e.posY);e.setLatLng(n)}}};Indoor2DMap.prototype.setMapCoeff=function(a,c,b,e,n,g,d,T,h){null==a&&(a=0);null==c&&(c=0);this.mWGS48OriginX=parseFloat(d);this.mWGS48OriginY=
parseFloat(T);this.mMAP_North=parseFloat(h);this.mUsermap_width=parseInt(b);this.mUsermap_height=parseInt(e);this.mMap_scale=parseFloat(n);this.mMap_coeff=parseFloat(g);this.mMap_OrigX=parseFloat(a);this.mMap_OrigY=parseFloat(c);a=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);c=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);b=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);e=this.mWGS48OriginX+f(b,FloatMul(this.mMap_OrigX,-1));b=k(e,b);e=FloatDiv(1E4,
11057400);n=f(this.mWGS48OriginY+e,1E4);a=k(b.lng+a,b.lat+e/n*c);this.mBounds=[b,a]};Indoor2DMap.prototype.setMapImage=function(a,c){this.mUserMap_url=a;this.mUserProject_Name=c;this.update_2d_map(this);this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]});this.mMap.zoomControl.setPosition("topright");L.control.scale({imperial:!1,maxWidth:300}).addTo(this.mMap);this.mLayerControl.addOverlay(this.layer_areas,"Areas");1==this.SHOW_AREA_DEFAULT&&this.mMap.addLayer(this.layer_areas,"Areas");this.create_map_action(this.mMap)};
Indoor2DMap.prototype.setMapLayerInfo=function(a){this.mMapLayerId=a};Indoor2DMap.prototype.changeUserMap=function(a,c,b){this.mUserMap_url=a;this.mMap.removeLayer(this.mUserMaplayer);this.mUsermap_width=c;this.mUsermap_height=b;a=FloatDiv(this.mUsermap_width,this.mMap_scale*this.mMap_coeff);c=FloatDiv(this.mUsermap_height,this.mMap_scale*this.mMap_coeff);b=this.mWGS48OriginY+FloatDiv(FloatMul(this.mMap_OrigY,-1),11057400);var e=this.mWGS48OriginX+f(b,FloatMul(this.mMap_OrigX,-1));b=k(e,b);var e=
FloatDiv(1E4,11057400),n=f(this.mWGS48OriginY+e,1E4);a=k(b.lng+a,b.lat+e/n*c);this.mBounds=[b,a];this.mUserMaplayer=L.imageOverlay(this.mUserMap_url,this.mBounds,{attribution:this.mUserProject_Name,opacity:.5});this.mMap.addLayer(this.mUserMaplayer,this.mUserProject_Name)};Indoor2DMap.prototype.editmode=function(){return this.mEdit_mode};Indoor2DMap.prototype.setShowTrack=function(a){this.mShowTrack=a};Indoor2DMap.prototype.refresh=function(){var a=this.mMap.getZoom();this.mMap._onResize();0==a&&
setTimeout(this.fitBounds,100,this)};Indoor2DMap.prototype.fitBounds=function(a){a.mMap.fitBounds(a.mBounds,{paddingTopLeft:[0,0]})};Indoor2DMap.prototype.setBounds=function(a,c,b,e){b=k(e,b);a=k(c,a);this.mBounds=[b,a];this.mMap.fitBounds(this.mBounds,{paddingTopLeft:[0,0]})};Indoor2DMap.prototype.clearAddressTarget=function(){for(var a=this.getCurrentLayer("Origin",this.mMapLayerId),c=0;c<this.AddressList.length;c++)a.removeLayer(this.AddressList[c]);this.AddressList=[]};Indoor2DMap.prototype.setTargetLocation=
function(a,c,b){for(var e,n=!1,g=0;g<this.AddressList.length;g++){var d=this.AddressList[g];if(d.name===a){n=!0;e=d;break}}0==n&&(e=a+"&nbsp;&nbsp;&nbsp;&nbsp;<br>",e=L.popup({closeOnClick:!1,autoClose:!1}).setContent(e),n=k(b,c),e=L.marker(n,{title:a,draggable:!1}).bindPopup(e),e.name=a,e.orig_this=this,e.setIcon(l),this.AddressList.push(e),e.on("click",this.markerOnClick),e.on("dragend",function(a){a=a.target;var b=a.orig_this,c=a.getLatLng();"function"===typeof b.mTargetDragCallback&&b.mTargetDragCallback(b.mMapLayerId,
a.name,c.lat,c.lng)}),a=this.getCurrentLayer("Origin",this.mMapLayerId),e.addTo(a));c=k(b,c);e.setLatLng(c)};Indoor2DMap.prototype.setUISmoothing=function(a){a&&!this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,100,this),setTimeout(this.draw_tag_GPS_smooth_move,100,this));this.mEnableUISmoothing=a};Indoor2DMap.prototype.markerOnClick=function(a){this.orig_this.markclick(a.target.type,a.target.index);"function"===typeof this.orig_this.mNodeClickCallback&&this.orig_this.mNodeClickCallback(a.target)};
Indoor2DMap.prototype.mapAreaOnClick=function(a){var c=a.target.orig_this;if(c.mEdit_mode&&!c.mEdit_delete_mode){var b=c.MapAreas[a.target.index],b=b.toGeoJSON();c.toggle_map_area_editor(b,a.target.index)}else b=c.MapAreas[a.target.index],b=b.toGeoJSON(),999!=b.properties.areatype&&fetch_rollcall(b.properties.areaid,b.properties.areaname)};Indoor2DMap.prototype.createVILSMarker=function(a,c,b,e,n,g,d,f,k){var x=b+"&nbsp;&nbsp;&nbsp;&nbsp;<br>";0==b.length&&(x=c+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");var x=
L.popup({closeOnClick:!1,autoClose:!1}).setContent(x),p=this.convertToLatLng(this,e,n),m=L.marker(p,{title:c,draggable:f}).bindPopup(x);m.nodeid=c;m.macaddress=a;m.nodename=b;m.posX=e;m.posY=n;m.posZ=g;m.date=d;m.orig_this=this;m.maplayer=k;m.on("click",this.markerOnClick);m.on("dragend",function(a){a=a.target;var b=a.orig_this,c=a.getLatLng();a.posY=FloatMul(c.lat,11057400)-FloatMul(b.mWGS48OriginY,11057400);posX1=h(c.lat,c.lng);posX2=h(c.lat,b.mWGS48OriginX);a.posX=posX1-posX2;"function"===typeof b.mNodeDragCallback&&
b.mNodeDragCallback(b.mMapLayerId,a.type,m.macaddress,a.nodeid,a.posX,a.posY,a.posZ,c.lat,c.lng)});return m};Indoor2DMap.prototype.fadeout_tag_footprint=function(a,c){var b=[],e=[],n=this.FadeOutPolylines[a],g=this.FadeOutNodes[a],d=this.getCurrentLayer("Tags",c);null!=n&&d.removeLayer(n);if(null!=g&&void 0!=g){for(var n="rgb(244, 131, 66)",f=0;f<g.length;f++){var h=g[f],k=h.options.radius,n=h.options.color;.5>=k||0==mShowTrack?d.removeLayer(h):(h.setStyle({radius:k-.5}),k=h.getLatLng(),b.push([k.lat,
k.lng]),e[e.length]=h)}this.FadeOutNodes[a]=e;n=new L.Polyline(b,{color:n,weight:4,opacity:.4,smoothFactor:1});d.addLayer(n);this.FadeOutPolylines[a]=n}};Indoor2DMap.prototype.fadeout_loop=function(a){for(var c=0;c<a.Tags.length;c++){var b=a.Tags[c];a.fadeout_tag_footprint(b.nodeid,b.maplayer)}setTimeout(a.fadeout_loop,1E3,a)};Indoor2DMap.prototype.showGoolgeMap=function(){this.mMap.addLayer(F,"Google Streets")};Indoor2DMap.prototype.showOriginLayer=function(){var a=this.getCurrentLayer("Origin",
this.mMapLayerId);this.mMap.addLayer(a,"Origin")};Indoor2DMap.prototype.createMapEditor=function(a){this.mUsermapScaleDown=new this.UserMapScaleDownControl;this.mUsermapScaleUp=new this.UserMapScaleUpControl;this.mUsermapEdit=new this.UserMapEditControl;this.mMap.addControl(this.mUsermapEdit);this.fadeout_loop(this);this.mEditModeCallback=a};Indoor2DMap.prototype.setNodeDragCallback=function(a){this.mNodeDragCallback=a};Indoor2DMap.prototype.setOrigNodeDragCallback=function(a){this.mOrigNodeDragCallback=
a};Indoor2DMap.prototype.setUpdateMapInfoCallback=function(a){this.mUpdateMapInfoCallback=a};Indoor2DMap.prototype.setNodeClickCallback=function(a){this.mNodeClickCallback=a};Indoor2DMap.prototype.addOriginMarker=function(a,c,b){a=this.createVILSMarker("0000","OriginXYZID","Origin",a,c,b,null,!1,this.mMapLayerId);a.setIcon(l);c=this.getCurrentLayer("Origin",this.mMapLayerId);a.addTo(c);this.OriginMarker=a;a.type="Origin";a.index=0;a.on("dragend",function(a){a=a.target;var b=a.getLatLng(),c=this.orig_this,
d=FloatMul(b.lat,11057400)-FloatMul(c.mWGS48OriginY,11057400);posX1=h(b.lat,b.lng);posX2=h(b.lat,c.mWGS48OriginX);b=posX1-posX2;c.mMap_OrigY+=d;c.mMap_OrigX+=b;c.update_2d_map(c);a.setLatLng(new L.LatLng(c.mWGS48OriginY,c.mWGS48OriginX));c.mMap.panTo(a.getLatLng());"function"===typeof c.mOrigNodeDragCallback&&c.mOrigNodeDragCallback(c.mMapLayerId,c.mMap_OrigX,c.mMap_OrigY)})};Indoor2DMap.prototype.createDummyTag=function(a,c,b,e,n,g,d,f,h){this.updateMarker(this.Tags,a,c,b,e,n,g,d,f,h,!1)||this.addTag(this.Tags.length,
a,c,b,e,n,g,d,f,h)};Indoor2DMap.prototype.addAnchor=function(a,c,b,e,n,g,d,f,h,k,p){c=this.createVILSMarker(c,b,e,n,g,d,k,!1,p);p=this.getCurrentLayer("Anchors",p);c.setIcon(H);c.addTo(p);this.Anchors[a]=c;c.type="anchor";c.index=a};Indoor2DMap.prototype.addTag=function(a,c,b,e,n,g,d,f,h,k,p){c=this.createVILSMarker(c,b,e,n,g,d,k,!1,p);p=this.getCurrentLayer("Tags",p);c.setIcon(v);p.addLayer(c);this.Tags[a]=c;c.type="tag";c.index=a};Indoor2DMap.prototype.addCoordinator=function(a,c,b,e,n,g,d,f,h,
k,p){c=this.createVILSMarker(c,b,e,n,g,d,k,!1,p);p=this.getCurrentLayer("Coordinators",p);c.setIcon(q);c.addTo(p);this.Coords[a]=c;c.type="coord";c.index=a};Indoor2DMap.prototype.addLocator=function(a,c,b,e,n,g,d,f,h,k,p){c=this.createVILSMarker(c,b,e,n,g,d,k,!1,p,p);p=this.getCurrentLayer("Locators",p);c.setIcon(z);c.addTo(p);this.Locators[a]=c;c.type="locator";c.index=a};Indoor2DMap.prototype.getCurrentLayer=function(a,c){var b=this.mMapLayer_nodes[a];void 0==b&&(b=new L.LayerGroup,this.mMapLayer_nodes[a]=
b,"Tags"==a&&this.mMap.addLayer(b,a),"Locators"==a&&1==this.SHOW_LOCATOR_DEFAULT&&this.mMap.addLayer(b,a),"Sensors"==a&&this.mMap.addLayer(b,a),"Users"==a&&this.mMap.addLayer(b,a),this.mLayerControl.addOverlay(b,a));return b};Indoor2DMap.prototype.updateAnchorMarker=function(a,c,b,e,n,g,d,f,h,k){if(0!=this.mMapLayerId&&0!=k&&this.mMapLayerId!=k)return!0;this.updateMarker(this.Anchors,a,c,b,e,n,g,d,f,h,!1,!0,k)||this.addAnchor(this.Anchors.length,a,c,b,e,n,g,d,f,h,k)};Indoor2DMap.prototype.updateTagMarker=
function(a,c,b,e,n,g,d,f,h,k,p){if(0!=this.mMapLayerId&&0!=p&&this.mMapLayerId!=p)return this.setMarkerVisible(this.Tags,c,!1),this.updateMarker(this.Tags,a,c,b,e,n,g,d,f,h,!0,!1,p),this.push_to_drawlist(a,c,b,e,n,g,d,f,h,p),!0;0!=this.check_visible_state(this.Tags,c)||k||(this.reset_node(c,e,n,g,d,f,p),this.updateMarker(this.Tags,a,c,b,e,n,g,d,f,h,!0,!0,p),this.setMarkerVisible(this.Tags,c,!0));k?this.hide_2d_drawlist(c):(this.hide_2d_drawGPSlist(c),this.push_to_drawlist(a,c,b,e,n,g,d,f,h,p));(k=
this.updateMarker(this.Tags,a,c,b,e,n,g,d,f,h,!0,!this.mEnableUISmoothing&&!k,p))||this.addTag(this.Tags.length,a,c,b,e,n,g,d,f,h,p);return k};Indoor2DMap.prototype.updateCoordinatorMarker=function(a,c,b,e,n,g,d,f,h,k){if(0!=this.mMapLayerId&&0!=k&&this.mMapLayerId!=k)return this.setMarkerVisible(this.Coords,c,!1),this.updateMarker(this.Coords,a,c,b,e,n,g,d,f,h,!0,!1,k),!0;this.updateMarker(this.Coords,a,c,b,e,n,g,d,f,h,!1,!0,k)||this.addCoordinator(this.Coords.length,a,c,b,e,n,g,d,f,h,k)};Indoor2DMap.prototype.updateLocatorMarker=
function(a,c,b,e,d,g,f,h,k,l){if(0!=this.mMapLayerId&&0!=l&&this.mMapLayerId!=l)return this.setMarkerVisible(this.Locators,c,!1),this.updateMarker(this.Locators,a,c,b,e,d,g,f,h,k,!0,!1,l),!0;var p=this.updateMarker(this.Locators,a,c,b,e,d,g,f,h,k,!1,!0,l);p||this.addLocator(this.Locators.length,a,c,b,e,d,g,f,h,k,l);return p};Indoor2DMap.prototype.updateMarker=function(a,c,b,e,d,g,f,h,k,l,p,m,q){var v=!1,t,u;for(u=0;u<a.length;u++)if(t=a[u],t.nodeid===b){t.nodename=0==e.length?b:e;t.posX=d;t.posY=
g;t.posZ=f;t.buildingid=h;t.floor=k;t.maplayer=q;t.date=l;t.macaddress=c;if(m&&(a=this.convertToLatLng(this,d,g),t.setLatLng(a),p&&this.mShowTrack)){void 0!=t._icon&&"hidden"==t._icon.style.visibility&&this.showMarker(t);p=u;10<=p&&(p-=10);p=L.circleMarker(a,{color:E[p],opacity:.3,fillColor:E[p],fillOpacity:.2,className:"geoData",radius:5});q=this.getCurrentLayer("Tags",q);p.buildingid=h;p.floor=k;p.addTo(q);h=this.FadeOutNodes[t.nodeid];if(null==h||void 0==h)h=[];h[h.length]=p;this.FadeOutNodes[t.nodeid]=
h}v=!0;break}return v};Indoor2DMap.prototype.updateSensorMarker=function(a,c,b,e,d,g,h,f){var l=this.getCurrentLayer("Sensors",g);if(0!=this.mMapLayerId&&0!=g&&this.mMapLayerId!=g)return!0;for(var q=!1,p=0;p<this.Sensors.length;p++){var m=this.Sensors[p];if(m.id===a){q=!0;m.setLatLng(k(e,d));break}}0==q?(q=new moment,c=this.createVILSMarker(a,a,c,0,0,0,q,!1,g),"LiDAR"===b?c.setIcon(y):0==h.length||0==h?c.setIcon(B):1==f?c.setIcon(C):c.setIcon(A),c.setLatLng(k(e,d)),l.addLayer(c),b=this.Sensors.length,
this.Sensors[b]=c,c.id=a,c.type="sensor",c.index=b):"LiDAR"===b?m.setIcon(y):0==h.length||0==h?m.setIcon(B):1==f?m.setIcon(C):m.setIcon(A)};Indoor2DMap.prototype.updateUserMarker=function(a,c,b,e,d,g,h,f){g=this.getCurrentLayer("Users",b);if(0!=this.mMapLayerId&&0!=b&&this.mMapLayerId!=b)return!0;var l=k(h,f);h=parseInt(h);f=parseInt(f);if(0==h||0==f)l=this.convertToLatLng(this,e,d);e=!1;for(d=0;d<this.Users.length;d++)if(f=this.Users[d],f.id===a){e=!0;f.setLatLng(l);break}0==e&&(e=new moment,c=this.createVILSMarker(a,
a,c,0,0,0,e,!1,b),c.setIcon(D),c.setLatLng(l),g.addLayer(c),b=this.Users.length,this.Users[b]=c,c.id=a,c.type="user",c.index=b)};Indoor2DMap.prototype.getTagList=function(){return this.Tags};Indoor2DMap.prototype.getLocatorList=function(){return this.Locators};Indoor2DMap.prototype.setTagPopup=function(a,c){var b;for(b=0;b<this.Tags.length;b++){var e=this.Tags[b];if(e.nodeid===a){c?(e.openPopup(),this.mMap.setView(e.getLatLng())):e.closePopup();break}}};Indoor2DMap.prototype.setLocatorPopup=function(a,
c){var b;for(b=0;b<this.Locators.length;b++){var e=this.Locators[b];if(e.nodeid===a){c?(e.openPopup(),this.mMap.setView(e.getLatLng())):e.closePopup();break}}};Indoor2DMap.prototype.setSensorPopup=function(a,c){var b;for(b=0;b<this.Sensors.length;b++){var e=this.Sensors[b];console.log("setSensorPopup() index:"+b+" id:"+a+" exist_sensor.id:"+e.id);if(e.id===a){c?(e.openPopup(),this.mMap.setView(e.getLatLng())):e.closePopup();break}}};Indoor2DMap.prototype.setUserPopup=function(a,c){var b;for(b=0;b<
this.Users.length;b++){var e=this.Users[b];if(e.id==a){c?(e.setIcon(D),e.openPopup(),this.mMap.setView(e.getLatLng())):(e.setIcon(y),e.closePopup());break}}};Indoor2DMap.prototype.setTagAlert=function(a,c){this.set_TagDraw_Alert(a,c);this.set_TagGPSDraw_Alert(a,c)};Indoor2DMap.prototype.setStartAlert=function(a){void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={});this.NodeAlertFunction[a]=1;console.log("setStartAlert() "+a)};Indoor2DMap.prototype.setStopAlert=function(a){void 0==this.NodeAlertFunction[a]&&
(this.NodeAlertFunction[a]={});this.NodeAlertFunction[a]=0;this.getTargetNode(a).setIcon(this.AlertIconScaleUpDownList[0]);console.log("setStopAlert() "+a)};Indoor2DMap.prototype.check_tag_layer_alertcircle=function(){var a=this.getCurrentLayer("Tags",this.mMapLayerId),c=a.getLayers(),b;for(b=0;b<c.length;b++){var e=c[b];"circleMarker"===e.type&&(console.log("check_tag_layer_alertcircle() Found!"),a.removeLayer(e))}};Indoor2DMap.prototype.check_locator_layer_alertcircle=function(){for(var a=this.getCurrentLayer("Locators",
this.mMapLayerId),c=a.getLayers(),b=0;b<c.length;b++){var e=c[b];"circleMarker"===e.type&&(console.log("check_locator_layer_alertcircle() Found!"),a.removeLayer(e))}};Indoor2DMap.prototype.set_TagDraw_Alert=function(a,c){for(var b=0;b<this.TagDrawList.length;b++){var e=this.TagDrawList[b];if(e.nodeid===a){b=this.getTargetNode(a);if(null==b)break;if(b.maplayer!=this.mMapLayerId)break;0<e.alertcount&&e.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=
1);if(0==c||0==this.NodeAlertFunction[a]){e.alertcount=0;var d=this.getCurrentLayer("Tags",this.mMapLayerId),g=e.alertcircle;void 0!=g&&null!=g&&(d.removeLayer(g),e.alertcircle=null,b.closePopup());b.setPopupContent(b.nodename);break}var d=this.convertToLatLng(this,e.curposX,e.curposY),h="rgb(244, 20, 20)",f="rgb(244, 20, 20)";2==c&&(f=h="rgb(244, 20, 20)");g=e.alertcircle;if(void 0==g||null==g)g=L.circleMarker(d,{color:h,opacity:.2,fillColor:f,fillOpacity:.2,className:"geoData",radius:25}),g.type=
"circleMarker",d=this.getCurrentLayer("Tags",this.mMapLayerId),g.addTo(d),e.alertcircle=g,e.alertcount=50,b.setPopupContent(b.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),b.openPopup(),this.mMap.setView(b.getLatLng());break}}};Indoor2DMap.prototype.set_TagGPSDraw_Alert=function(a,c){for(var b=0;b<this.TagGPSDrawList.length;b++){var e=this.TagGPSDrawList[b];if(e.nodeid===a){b=this.getTargetNode(a);if(null==b){console.log("set_TagGPSDraw_Alert() nodeid:"+a+" TargetNode == null");break}if(b.maplayer!=
this.mMapLayerId){console.log("set_TagGPSDraw_Alert() "+a+" not in this map");break}0<e.alertcount&&e.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==c||0==this.NodeAlertFunction[a]){e.alertcount=0;var d=this.getCurrentLayer("Tags",this.mMapLayerId),g=e.alertcircle;void 0!=g&&null!=g&&(d.removeLayer(g),e.alertcircle=null,b.closePopup());b.setPopupContent(b.nodename);break}var d=k(e.curposLng,e.curposLat),h="rgb(244, 20, 20)",f="rgb(244, 20, 20)";
2==c&&(f=h="rgb(244, 20, 20)");g=e.alertcircle;if(void 0==g||null==g)g=L.circleMarker(d,{color:h,opacity:.2,fillColor:f,fillOpacity:.2,className:"geoData",radius:25}),g.type="circleMarker",d=this.getCurrentLayer("Tags",this.mMapLayerId),g.addTo(d),e.alertcircle=g,e.alertcount=50,console.log("set_TagGPSDraw_Alert()"+e.nodeid+" circle:"+g+" alertcount:"+e.alertcount+" alertType:"+c),b.bindPopup(a+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),b.openPopup(),this.mMap.setView(b.getLatLng());break}}};Indoor2DMap.prototype.getTargetNode=
function(a){for(var c=null,b=0;b<this.Tags.length&&(c=this.Tags[b],c.nodeid!==a);b++);return c};Indoor2DMap.prototype.getTargetLocatorNode=function(a){for(var c=null,b=0;b<this.Locators.length&&(c=this.Locators[b],c.nodeid!==a);b++);return c};Indoor2DMap.prototype.setTagLocation=function(a,c,b,e,d,g,h,f,k,l,p){for(e=0;e<this.Tags.length;e++){var m=this.Tags[e];if(m.nodeid===a){0!=c?0==m.alertcount&&(1==l?m.setIcon(u):m.setIcon(v)):(0<b.length&&(0==d?1==l?m.setIcon(u):m.setIcon(v):1==d?1==l?m.setIcon(M):
m.setIcon(K):2==d&&m.setIcon(N)),1==p?1==l?m.setIcon(G):m.setIcon(w):0==g||1==f?1==l?m.setIcon(P):m.setIcon(O):0<h.length&&!k?1==l?m.setIcon(R):m.setIcon(Q):1==l?m.setIcon(u):m.setIcon(v));break}}};Indoor2DMap.prototype.setTagLngLat=function(a,c,b,e,d){this.setMarkerVisible(this.Tags,a,!0);if(!(0>=c&&0>=b))for(var g=0;g<this.Tags.length;g++){var h=this.Tags[g];h.nodeid===a&&(h.setIcon(v),this.mEnableUISmoothing?this.push_to_GPSdrawlist(a,c,b,e,d):h.setLatLng(k(c,b)))}};Indoor2DMap.prototype.updateTagGPS=
function(a,c,b){for(var e=0;e<this.Tags.length;e++){var d=this.Tags[e];d.nodeid===a&&d.setLatLng(k(c,b))}};Indoor2DMap.prototype.setLocatorAlert=function(a,c,b,e){if(0<=c)for(var d=0;d<this.Locators.length;d++){var g=this.Locators[d];if(g.nodeid===a){if(g.maplayer!=this.mMapLayerId)break;0<g.alertcount&&g.alertcount--;void 0==this.NodeAlertFunction[a]&&(this.NodeAlertFunction[a]={},this.NodeAlertFunction[a]=1);if(0==c||0==this.NodeAlertFunction[a]){g.alertcount=0;1==e?g.setIcon(J):0<b?g.setIcon(z):
g.setIcon(I);a=this.getCurrentLayer("Locators",this.mMapLayerId);c=g.alertcircle;void 0!=c&&null!=c&&(a.removeLayer(c),g.alertcircle=null,g.closePopup());g.setPopupContent(g.nodename);break}a=this.convertToLatLng(this,g.posX,g.posY);e=b="rgb(244, 20, 20)";2==c&&(e=b="rgb(244, 20, 20)");c=g.alertcircle;if(void 0==c||null==c)c=L.circleMarker(a,{color:b,opacity:.2,fillColor:e,fillOpacity:.2,className:"geoData",radius:25}),c.type="circleMarker",a=this.getCurrentLayer("Locators",this.mMapLayerId),c.addTo(a),
g.alertcircle=c,g.alertcount=50,g.setPopupContent(g.nodename+" \u6309\u4e0b\u8b66\u6025\u6309\u9215"),g.openPopup(),this.mMap.setView(g.getLatLng());break}}};Indoor2DMap.prototype.setMarkerVisible=function(a,c,b){for(var e=!1,d=0;d<a.length;d++){var g=a[d];if(g.nodeid===c){e=b?this.showMarker(g):this.hideMarker(g);break}}return e};Indoor2DMap.prototype.hideMarker=function(a){var c=!1;null!=a._icon&&("hidden"!=a._icon.style.visibility&&(c=!0),a._icon.style.visibility="hidden");null!=a._shadow&&(a._shadow.style.visibility=
"hidden");a.closePopup();return c};Indoor2DMap.prototype.showMarker=function(a){var c=!1;null!=a._icon&&("visible"!=a._icon.style.visibility&&(c=!0),a._icon.style.visibility="visible");null!=a._shadow&&(a._shadow.style.visibility="visible");return c};Indoor2DMap.prototype.check_visible_state=function(a,c){for(var b=!1,e=0;e<a.length;e++){var d=a[e];if(d.nodeid===c){b=this.check_node_visible_state(d);break}}return b};Indoor2DMap.prototype.check_node_visible_state=function(a){var c=!1;null!=a._icon&&
"visible"==a._icon.style.visibility&&(c=!0);return c};Indoor2DMap.prototype.markclick=function(a,c){"anchor"===a?(this.Anchors[c].openPopup(),this.mMap.setView(this.Anchors[c].getLatLng()),$("#ProfileMarkerName").text(this.Anchors[c].nodename),$("#ProfileMarkerPosition").text("("+this.Anchors[c].posX+","+this.Anchors[c].posY+","+this.Anchors[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Anchors[c].date).local().format("MMM Do, hh:mm A"))):"tag"===a?(this.Tags[c].openPopup(),this.mMap.setView(this.Tags[c].getLatLng()),
$("#ProfileMarkerName").text(this.Tags[c].nodename),$("#ProfileMarkerPosition").text("("+this.Tags[c].posX+","+this.Tags[c].posY+","+this.Tags[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Tags[c].date).local().format("MMM Do, hh:mm A"))):"Origin"===a?null!=this.OriginMarker&&(this.OriginMarker.openPopup(),this.mMap.setView(this.OriginMarker.getLatLng()),$("#ProfileMarkerName").text(this.OriginMarker.nodename),$("#ProfileMarkerPosition").text("("+this.OriginMarker.posX+","+this.OriginMarker.posY+
","+this.OriginMarker.posZ+")"),$("#ProfileMarkerLocation").text(""),$("#ProfileMarkerUpdateTime").text("")):"coord"===a?(this.Coords[c].openPopup(),this.mMap.setView(this.Coords[c].getLatLng()),$("#ProfileMarkerName").text(this.Coords[c].nodename),$("#ProfileMarkerPosition").text("("+this.Coords[c].posX+","+this.Coords[c].posY+","+this.Coords[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Coords[c].date).local().format("MMM Do, hh:mm A"))):"locator"===a&&(this.Locators[c].openPopup(),
this.mMap.setView(this.Locators[c].getLatLng()),$("#ProfileMarkerName").text(this.Locators[c].nodename),$("#ProfileMarkerPosition").text("("+this.Locators[c].posX+","+this.Locators[c].posY+","+this.Locators[c].posZ+")"),$("#ProfileMarkerUpdateTime").text(moment.utc(this.Locators[c].date).local().format("MMM Do, hh:mm A")))};Indoor2DMap.prototype.UserMapEditControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var c=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");
c.style.backgroundColor="white";c.style.backgroundImage="url(/images/edit-icon.png)";c.style.backgroundSize="28px 28px";c.style.width="32px";c.style.height="32px";c.onclick=function(){a.orig_this.mEdit_mode?(a.removeControl(a.orig_this.mUsermapScaleUp),a.removeControl(a.orig_this.mUsermapScaleDown),a.removeControl(a.orig_this.mDrawControl),a.orig_this.mEdit_mode=!1,$("#areaname_edit").css("display","none"),a.orig_this.setMakerDragable(a.orig_this.mEdit_mode),"function"===typeof a.orig_this.mEditModeCallback&&
a.orig_this.mEditModeCallback(!1)):(a.addControl(a.orig_this.mUsermapScaleUp),a.addControl(a.orig_this.mUsermapScaleDown),a.orig_this.mDrawControl=a.orig_this.creat_drawControl(a.orig_this),a.addControl(a.orig_this.mDrawControl),a.orig_this.mEdit_mode=!0,a.orig_this.setMakerDragable(a.orig_this.mEdit_mode),"function"===typeof a.orig_this.mEditModeCallback&&a.orig_this.mEditModeCallback(!0))};return c}});Indoor2DMap.prototype.UserMapScaleUpControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var c=
L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");c.style.backgroundColor="white";c.style.backgroundImage="url(/images/maximize-25.png)";c.style.backgroundSize="28px 28px";c.style.width="32px";c.style.height="32px";c.style.backgroundRepeat="no-repeat";c.onclick=function(){a.orig_this.mMap_scale-=.01*a.orig_this.mMap_scale;a.orig_this.update_2d_map(a.orig_this);"function"===typeof a.orig_this.mUpdateMapInfoCallback&&a.orig_this.mUpdateMapInfoCallback(a.orig_this.mMapLayerId,
a.orig_this.mMap_scale,a.orig_this.mMap_coeff)};return c}});Indoor2DMap.prototype.UserMapScaleDownControl=L.Control.extend({options:{position:"topleft"},onAdd:function(a){var c=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");c.style.backgroundColor="white";c.style.backgroundImage="url(/images/minimize-25.png)";c.style.backgroundSize="28px 28px";c.style.width="32px";c.style.height="32px";c.style.backgroundRepeat="no-repeat";c.onclick=function(){a.orig_this.mMap_scale+=
.01*a.orig_this.mMap_scale;a.orig_this.update_2d_map(a.orig_this);"function"===typeof a.orig_this.mUpdateMapInfoCallback&&a.orig_this.mUpdateMapInfoCallback(a.orig_this.mMapLayerId,a.orig_this.mMap_scale,a.orig_this.mMap_coeff)};return c}});Indoor2DMap.prototype.drawControl=new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,
weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:this.layer_areas}});Indoor2DMap.prototype.creat_drawControl=function(a){return new L.Control.Draw({position:"topleft",draw:{polygon:{allowIntersection:!1,drawError:{color:"#e1e100",message:"<strong>Oh snap!<strong> you can't draw that!"},shapeOptions:{color:"#bada55"}},rectangle:{shapeOptions:{clickable:!0,weight:1}},polyline:!1,circle:!1,marker:!1,circlemarker:!1},edit:{featureGroup:a.layer_areas}})};Indoor2DMap.prototype.setMakerDragable=
function(a){var c=this.getCurrentLayer("Origin",this.mMapLayerId);this.mMap.hasLayer(c)&&null!=this.OriginMarker&&null!=this.OriginMarker.dragging&&(a?this.OriginMarker.dragging.enable():this.OriginMarker.dragging.disable());c=this.getCurrentLayer("Anchors",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Anchors.length;c++){var b=this.Anchors[c];null!=b&&null!=b.dragging&&(a?b.dragging.enable():b.dragging.disable())}c=this.getCurrentLayer("Tags",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=
0;c<this.Tags.length;c++)b=this.Tags[c],null!=b&&null!=b.dragging&&(a?b.dragging.enable():b.dragging.disable());c=this.getCurrentLayer("Coordinators",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Coords.length;c++)coord_node=this.Coords[c],null!=coord_node&&null!=coord_node.dragging&&(a?coord_node.dragging.enable():coord_node.dragging.disable());c=this.getCurrentLayer("Locators",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Locators.length;c++)locator_node=this.Locators[c],
null!=locator_node&&null!=locator_node.dragging&&(a?locator_node.dragging.enable():locator_node.dragging.disable());c=this.getCurrentLayer("Sensors",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Sensors.length;c++)sensor_node=this.Sensors[c],null!=sensor_node&&null!=sensor_node.dragging&&(a?sensor_node.dragging.enable():sensor_node.dragging.disable());c=this.getCurrentLayer("Users",this.mMapLayerId);if(this.mMap.hasLayer(c))for(c=0;c<this.Users.length;c++)user_node=this.Users[c],null!=
user_node&&null!=user_node.dragging&&(a?user_node.dragging.enable():user_node.dragging.disable())};Indoor2DMap.prototype.create_maparea_from_geoJSON=function(a,c,b){L.geoJson(b,{pointToLayer:function(a,b){},style:function(a){return a.properties.style},onEachFeature:function(a,b){var c='<label id="maparea_popup_'+a.properties.areaid+'">\u5340\u57df:'+a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;</label>",c=(new L.popup({minWidth:"16",closeButton:!0,closeOnClick:!0,maxWidth:"190"})).setContent(c);
b.bindPopup(c)}}).eachLayer(function(b){b.index=c;b.orig_this=a;b.on("click",a.mapAreaOnClick);a.MapAreas[c]=b;a.layer_areas.addLayer(b)})};Indoor2DMap.prototype.load_allmaparea=function(a){a.layer_areas.eachLayer(function(b){a.layer_areas.removeLayer(b)});var c=[];"function"===typeof get_maplayerarea&&get_maplayerarea(this.mMapLayerId,function(b){$.each(b,function(a,b){var e=JSON.parse(b);c[a]=e});b=0;for(var e in c){var d=c[e];"6"!==d.properties.areatype&&(a.create_maparea_from_geoJSON(a,b,d),b++)}for(e in c)d=
c[e],"6"===d.properties.areatype&&(a.create_maparea_from_geoJSON(a,b,d),b++)})};Indoor2DMap.prototype.load_maparea=function(){this.load_allmaparea(this)};Indoor2DMap.prototype.create_map_success=function(a,c,b){a.layer_areas.removeLayer(a.MapAreas[b]);a.create_map_area(a,c.geojson,b)};Indoor2DMap.prototype.create_map_action=function(a){a.on("draw:created",function(c){c=c.layer;c.options.fillColor=c.options.color;c.options.fillOpacity=c.options.opacity;c.options.color=a.orig_this.areaborder_color;
c.options.opacity=a.orig_this.areaborder_opacity;c.index=Object.keys(a.orig_this.MapAreas).length;c.orig_this=a.orig_this;c.on("click",a.orig_this.mapAreaOnClick);a.orig_this.layer_areas.addLayer(c);var b=c.toGeoJSON();b.properties.style={};b.properties.style.color=c.options.color;b.properties.style.opacity=c.options.opacity;b.properties.style.weight=c.options.weight;for(var e=b.properties.style,d="#",g=0;6>g;g++)d+="0123456789ABCDEF"[Math.floor(16*Math.random())];e.fillColor=d;b.properties.style.fillOpacity=
c.options.fillOpacity;b.properties.areaid="area"+getRandomInt(1E3,9999);b.properties.areaname="Area "+Object.keys(a.orig_this.MapAreas).length;a.orig_this.MapAreas[c.index]=c;e=JSON.stringify(b);create_maplayerarea(a.orig_this,a.orig_this.mMapLayerId,e,b.properties.areaid,b.properties.areaname,0,c.index,a.orig_this.create_map_success)});a.on("draw:edited",function(c){c.layers.eachLayer(function(b){b=b.toGeoJSON();var c=b.properties.areaid,d=JSON.stringify(b);update_maplayerarea_shape(a.orig_this.mMapLayerId,
c,d,b.properties.areaname)})});a.on("draw:deletestart",function(c){a.orig_this.mEdit_delete_mode=!0});a.on("draw:deletestop",function(c){a.orig_this.mEdit_delete_mode=!1});a.on("draw:deleted",function(c){c.layers.eachLayer(function(b){b=b.toGeoJSON().properties.areaid;a.orig_this.delete_map_area(a.orig_this,b)});a.orig_this.mEdit_delete_mode=!1});a.on("moveend",function(){})};Indoor2DMap.prototype.delete_map_area=function(a,c){delete_maplayerarea(a.mMapLayerId,c)};Indoor2DMap.prototype.create_map_area=
function(a,c,b){return L.geoJson(JSON.parse(c),{pointToLayer:function(a,b){},style:function(a){return a.properties.style},onEachFeature:function(a,b){b.bindPopup(a.properties.areaname+"&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;")}}).eachLayer(function(c){c.index=b;c.orig_this=a;c.on("click",a.mapAreaOnClick);a.MapAreas[b]=c;a.layer_areas.addLayer(c)})};Indoor2DMap.prototype.areacolorOnInput=function(){var a=$("#areacolor_input").val();if("#"!=a.charAt(0))console.log("areacolorOnInput() not valid color!");
else if(9!=a.length)console.log("areacolorOnInput() not valid color string length! need 9, get "+a.length);else{var c=a.substring(0,7),a="0x"+a.substring(7,9),a=parseInt(a),a=parseFloat(a)/255;$("#areaname_color").minicolors("value",c);$("#areaname_color").minicolors("opacity",a)}};Indoor2DMap.prototype.toggle_map_area_editor=function(a,c){this.mEdit_maparea_index=c;$("#areaname_input").val(a.properties.areaname);$("#area_type_show").html(convert_area_type_name(a.properties.areatype));$("#area_type_show").attr("data-id",
a.properties.areatype);$("#areaname_color").minicolors("value",a.properties.style.fillColor);$("#areaname_color").minicolors("opacity",a.properties.style.fillOpacity);var b=parseInt(255*a.properties.style.fillOpacity).toString(16);$("#areacolor_input").val(a.properties.style.fillColor+b);document.getElementById("areacolor_input").addEventListener("input",this.areacolorOnInput);$("#areaname_edit").css("display","block")};Indoor2DMap.prototype.areaname_save=function(a){var c=$("#areaname_color").minicolors("value"),
b=$("#areaname_color").minicolors("opacity"),e=$("#areaname_input").val(),d=$("#area_type_show").attr("data-id"),g=a.MapAreas[a.mEdit_maparea_index];g.setStyle({color:a.areaborder_color,opacity:a.areaborder_opacity,fillColor:c,fillOpacity:b});g.bindPopup(e+"&nbsp;&nbsp;&nbsp;&nbsp;<br>");$("#areaname_edit").css("display","none");g=g.toGeoJSON();g.properties.areaname=e;g.properties.areatype=d;g.properties.style.color=a.areaborder_color;g.properties.style.opacity=a.areaborder_opacity;g.properties.style.fillColor=
c;g.properties.style.fillOpacity=b;c=g.properties.areaid;b=JSON.stringify(g);update_maplayerarea(a.mMapLayerId,c,b,e,d)};Indoor2DMap.prototype.push_to_drawlist=function(a,c,b,e,d,g,h,f,k){for(var l=!1,p=0;p<this.TagDrawList.length;p++){var m=this.TagDrawList[p];m.nodeid===c&&(0==m.preposX&&0==m.preposY&&0==m.preposZ?(m.totalposX=parseInt(e),m.totalposY=parseInt(d),m.totalposZ=parseInt(g),m.count=1):(m.totalposX+=parseInt(e),m.totalposY+=parseInt(d),m.totalposZ+=parseInt(g),m.count++),m.buildingid=
h,m.floor=f,m.date=k,m.hide=!1,l=!0)}0==l&&(l={},l.nodeid=c,l.macaddress=a,l.nodename=b,l.date=k,this.reset_draw_node(l,e,d,g,h,f),this.TagDrawList.push(l))};Indoor2DMap.prototype.hide_2d_drawlist=function(a){for(var c=0;c<this.TagDrawList.length;c++){var b=this.TagDrawList[c];if(b.nodeid===a){b.hide=!0;break}}};Indoor2DMap.prototype.hide_2d_drawGPSlist=function(a){for(var c=0;c<this.TagGPSDrawList.length;c++){var b=this.TagGPSDrawList[c];if(b.nodeid===a){b.hide=!0;break}}};Indoor2DMap.prototype.reset_node=
function(a,c,b,e,d,g){for(var h=0;h<this.TagDrawList.length;h++){var f=this.TagDrawList[h];if(f.nodeid===a){this.reset_draw_node(f,c,b,e,d,g);break}}};Indoor2DMap.prototype.reset_draw_node=function(a,c,b,e,d,g){a.buildingid=d;a.floor=g;a.count=0;a.totalposX=0;a.totalposY=0;a.totalposZ=0;a.preAveragePosX=parseInt(c);a.preAveragePosY=parseInt(b);a.preAveragePosZ=parseInt(e);a.preposX=parseInt(c);a.preposY=parseInt(b);a.preposZ=parseInt(e);a.curposX=parseInt(c);a.curposY=parseInt(b);a.curposZ=parseInt(e);
a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_X=parseInt(c);a.move_no_block_old_X=parseInt(c);a.move_moving_X=parseInt(c);a.move_moving_old_X=parseInt(c);a.move_no_block_Y=parseInt(b);a.move_no_block_old_Y=parseInt(b);a.move_moving_Y=parseInt(b);a.move_moving_old_Y=parseInt(b);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1;a.hide=!1};Indoor2DMap.prototype.push_to_GPSdrawlist=function(a,c,b,e,d){for(var g=!1,h=0;h<this.TagGPSDrawList.length;h++){var f=this.TagGPSDrawList[h];
f.nodeid===a&&(0==f.preposLng&&0==f.preposLat?(f.totalposLng=parseFloat(c),f.totalposLat=parseFloat(b),f.count=1):(f.totalposLng+=parseFloat(c),f.totalposLat+=parseFloat(b),f.count++),f.hide=!1,g=!0)}0==g&&(g={},g.nodeid=a,this.reset_GPSdraw_node(g,c,b,e,d),this.TagGPSDrawList.push(g))};Indoor2DMap.prototype.reset_GPSdraw_node=function(a,c,b,e,d){a.buildingid=e;a.floor=d;a.count=0;a.totalposLng=0;a.totalposLat=0;a.preAveragePosLng=parseFloat(c);a.preAveragePosLat=parseFloat(b);a.preposLng=parseFloat(c);
a.preposLat=parseFloat(b);a.curposLng=parseFloat(c);a.curposLat=parseFloat(b);a.draw_loop_index=0;a.not_move_count=0;a.move_no_block_Lng=parseFloat(c);a.move_no_block_old_Lng=parseFloat(c);a.move_moving_Lng=parseFloat(c);a.move_moving_old_Lng=parseFloat(c);a.move_no_block_Lat=parseFloat(b);a.move_no_block_old_Lat=parseFloat(b);a.move_moving_Lat=parseFloat(b);a.move_moving_old_Lat=parseFloat(b);a.move_status=1;a.alertcircle=null;a.alertcount=0;a.alertType=-1};Indoor2DMap.prototype.draw_tag_smooth_move=
function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_smooth_move,1E3,a);else{for(var c=0;c<a.TagDrawList.length;c++){var b=a.TagDrawList[c];if(1!=b.hide){var e=b.curposX-b.preposX,d=b.curposY-b.preposY,g=b.curposZ-b.preposZ,f;5<=Math.sqrt(e*e+d*d+g*g)||10<b.not_move_count?(f=b.draw_loop_index+1,e/=a.move_step_size,d/=a.move_step_size,g/=a.move_step_size,f>=a.move_step_size&&(f=a.move_step_size),e=parseInt(e*f),d=parseInt(d*f),g=parseInt(g*f),b.not_move_count=0,10>a.move_loop_count||(f=b.preposX+e,e=
b.preposY+d,g=b.preposZ+g,a.updateMarker(a.Tags,b.macaddress,b.nodeid,b.nodename,f,e,g,b.buildingid,b.floor,b.date,!0,!0))):b.not_move_count++;b.draw_loop_index++;if(b.draw_loop_index>=a.move_step_size){if(0<b.count){f=parseInt(b.totalposX/b.count);g=parseInt(b.totalposY/b.count);e=parseInt(b.totalposZ/b.count);r=1;b.move_moving_X=parseInt(r*(f-b.move_no_block_old_X));b.move_no_block_X=b.move_moving_X+b.move_no_block_old_X;b.move_moving_old_X=b.move_moving_X;b.move_moving_Y=parseInt(r*(g-b.move_no_block_old_Y));
b.move_no_block_Y=b.move_moving_Y+b.move_no_block_old_Y;b.move_moving_old_Y=b.move_moving_Y;b.move_status+=1;if(6<b.move_status||0>b.move_moving_X*b.move_moving_old_X)b.move_status=1;b.move_no_block_old_X=b.move_no_block_X;b.move_no_block_old_Y=b.move_no_block_Y;b.preposX=b.curposX;b.preposY=b.curposY;b.preposZ=b.curposZ;b.curposX=b.move_no_block_X;b.curposY=b.move_no_block_Y;b.curposZ=e;b.preAveragePosX=parseInt(b.totalposX/b.count);b.preAveragePosY=parseInt(b.totalposY/b.count);b.preAveragePosZ=
parseInt(b.totalposZ/b.count);b.totalposX=0;b.totalposY=0;b.totalposZ=0;b.count=0;b.draw_loop_index=0}b.draw_loop_index>2*a.move_step_size&&(b.preposX=b.curposX,b.preposY=b.curposY,b.preposZ=b.curposZ,b.draw_loop_index=0)}}}a.move_loop_count++;1E4<=a.move_loop_count&&(a.move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_smooth_move,a.smoothing_time/a.move_step_size,a)}};Indoor2DMap.prototype.draw_tag_GPS_smooth_move=function(a){if(a.mEdit_mode)setTimeout(a.draw_tag_GPS_smooth_move,1E3,
a);else{for(var c=0;c<a.TagGPSDrawList.length;c++){var b=a.TagGPSDrawList[c];if(1!=b.hide){var d=b.curposLng-b.preposLng,f=b.curposLat-b.preposLat,g;10<b.not_move_count?(g=b.draw_loop_index+1,d/=a.GPS_move_step_size,f/=a.GPS_move_step_size,g>=a.GPS_move_step_size&&(g=a.GPS_move_step_size),d=parseFloat(d*g),f=parseFloat(f*g),b.not_move_count=0,10>a.GPS_move_loop_count||(g=b.preposLng+d,f=b.preposLat+f,a.updateTagGPS(b.nodeid,g,f))):b.not_move_count++;b.draw_loop_index++;if(b.draw_loop_index>=a.GPS_move_step_size){if(0<
b.count){g=parseFloat(b.totalposLng/b.count);f=parseFloat(b.totalposLat/b.count);d=.1;switch(b.move_status){case 1:case 2:d=.1;break;case 3:case 4:case 5:case 6:d=.8}a.GPS_smoothing_time=.1==d?200:.4==d?400:800;b.move_moving_Lng=parseFloat(d*(g-b.move_no_block_old_Lng));b.move_no_block_Lng=b.move_moving_Lng+b.move_no_block_old_Lng;b.move_moving_old_Lng=b.move_moving_Lng;b.move_moving_Lat=parseFloat(d*(f-b.move_no_block_old_Lat));b.move_no_block_Lat=b.move_moving_Lat+b.move_no_block_old_Lat;b.move_moving_old_Lat=
b.move_moving_Lat;b.move_status+=1;if(6<b.move_status||0>b.move_moving_Lng*b.move_moving_old_Lng)b.move_status=1;b.move_no_block_old_Lng=b.move_no_block_Lng;b.move_no_block_old_Lat=b.move_no_block_Lat;b.preposLng=b.curposLng;b.preposLat=b.curposLat;b.curposLng=b.move_no_block_Lng;b.curposLat=b.move_no_block_Lat;b.preAveragePosX=parseFloat(b.totalposLng/b.count);b.preAveragePosY=parseFloat(b.totalposLat/b.count);b.totalposLng=0;b.totalposLat=0;b.count=0;b.draw_loop_index=0}b.draw_loop_index>2*a.GPS_move_step_size&&
(b.preposLng=b.curposLng,b.preposLat=b.curposLat,b.draw_loop_index=0)}}}a.GPS_move_loop_count++;1E4<=a.GPS_move_loop_count&&(a.GPS_move_loop_count=100);a.mEnableUISmoothing&&setTimeout(a.draw_tag_GPS_smooth_move,a.GPS_smoothing_time/a.GPS_move_step_size,a)}};Indoor2DMap.prototype.update_alert_circle=function(a){a.update_tag_alert_circle();a.update_tag_GPS_alert_circle();a.update_locator_alert_circle();setTimeout(a.update_alert_circle,100,a)};Indoor2DMap.prototype.update_tag_alert_circle=function(){for(var a=
0;a<this.TagDrawList.length;a++){var c=this.TagDrawList[a];if(1!=c.hide){var b=c.alertcircle;if(void 0!=b&&null!=b){var d=b.options.opacity,f=d,g=b.options.radius,h=g;.2==d?5<g?h=g-5:f=.3:20<g?f=.2:h=g+5;d=this.getTargetNode(c.nodeid);b.setStyle({radius:h,opacity:f});b.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[c.nodeid]&&(this.AlertIconScaleIndexList[c.nodeid]=0);b=this.AlertIconScaleIndexList[c.nodeid];0==this.NodeAlertFunction[c.nodeid]?d.setIcon(this.AlertIconScaleUpDownList[0]):
d.setIcon(this.AlertIconScaleUpDownList[b]);b++;10<=b&&(b=0);this.AlertIconScaleIndexList[c.nodeid]=b}}}};Indoor2DMap.prototype.update_tag_GPS_alert_circle=function(){for(var a=0;a<this.TagGPSDrawList.length;a++){var c=this.TagGPSDrawList[a];if(1!=c.hide){var b=c.alertcircle;if(void 0!=b&&null!=b){var d=b.options.opacity,f=d,g=b.options.radius,h=g;.2==d?5<g?h=g-5:f=.3:20<g?f=.2:h=g+5;d=this.getTargetNode(c.nodeid);b.setStyle({radius:h,opacity:f});b.setLatLng(d.getLatLng());void 0==this.AlertIconScaleIndexList[c.nodeid]&&
(this.AlertIconScaleIndexList[c.nodeid]=0);b=this.AlertIconScaleIndexList[c.nodeid];d.setIcon(this.AlertIconScaleUpDownList[b]);b++;10<=b&&(b=0);this.AlertIconScaleIndexList[c.nodeid]=b}}}};Indoor2DMap.prototype.update_locator_alert_circle=function(){for(var a=0;a<this.Locators.length;a++){var c=this.Locators[a],b=c.alertcircle;if(void 0!=b&&null!=b){var d=b.options.opacity,f=d,g=b.options.radius,h=g;.2==d?5<g?h=g-5:f=.3:20<g?f=.2:h=g+5;d=this.getTargetLocatorNode(c.nodeid);b.setStyle({radius:h,opacity:f});
b.setLatLng(c.getLatLng());void 0==this.AlertIconScaleIndexList[c.nodeid]&&(this.AlertIconScaleIndexList[c.nodeid]=0);b=this.AlertIconScaleIndexList[c.nodeid];d.setIcon(this.AlertIconScaleUpDownList[b]);b++;10<=b&&(b=0);this.AlertIconScaleIndexList[c.nodeid]=b}}};Indoor2DMap.prototype.convertToLatLng=function(a,c,b){var d=FloatDiv(parseFloat(b),11057400);FloatMul(d,11057400);b=a.mWGS48OriginY+FloatDiv(parseFloat(b),11057400);c=a.mWGS48OriginX+f(b,parseFloat(c));return a.mRotateMap?a.rotateLatLng(b,
c):k(c,b)};Indoor2DMap.prototype.rotateLatLng=function(a,c){var b=new L.latLng(a,c),d=new L.latLng(this.mWGS48OriginY,this.mWGS48OriginX);return rotatePoint(b,this.mMAP_North,d)};this.mMap.on("overlayadd",this.onOverlayAdd);this.mMap.on("overlayremove ",this.onOverlayRemove);this.create_alert_scale_icon();this.mEnableUISmoothing&&(setTimeout(this.draw_tag_smooth_move,2E3,this),setTimeout(this.draw_tag_GPS_smooth_move,2E3,this));setTimeout(this.update_alert_circle,2E3,this)};
$(document).ready(function(){$(".colorpicker").each(function(){$(this).minicolors({changeDelay:200,format:"hex",position:"bottom left",theme:"bootstrap",opacity:$(this).attr("data-opacity"),change:function(d,f){console.log("change() fillColorhex:"+d+", opacity:"+f);var h=parseInt(255*f).toString(16);$("#areacolor_input").val(d+h)},theme:"default"})})});var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,glLiveMap,glAddressList=[],glCurrentTargetAddressIndex=-1;check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,create_map(),CurrentLoadIndex+=1);break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex+=1);break;case 2:PreLoadIndex!=CurrentLoadIndex&&
(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex+=1);break;case 4:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),
PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}function create_map(){glLiveMap=new Indoor2DMap("mapid");glLiveMap.setMapCoeff(0,0,10240,10240,5,1E5,121.51,25.04,0);glLiveMap.setMapImage("/images/empty.png","Indoor 2D Map");glLiveMap.setMapLayerInfo(1);glLiveMap.showGoolgeMap();glLiveMap.showOriginLayer()}
function findadressloactionbtn_click(){var d=document.getElementById("Address").value;glAddressList=[];$.getJSON(gl_target_server+"/php/map.php","findlocation=1&address="+d,function(d){$.each(d,function(d,f){glAddressList.push(f)})}).complete(function(){show_addresses()})}
function show_addresses(){document.getElementById("Address_longitude").innerHTML="\u7d93\u5ea6:";document.getElementById("Address_latitude").innerHTML="\u7def\u5ea6:";glCurrentTargetAddressIndex=-1;glLiveMap.clearAddressTarget();for(var d=document.getElementById("dropdown_addresses");d.hasChildNodes();)d.removeChild(d.firstChild);for(var f=0;f<glAddressList.length;f++){var h=glAddressList[f],k=!1;0==f&&(k=!0,document.getElementById("cur_address").innerHTML=h.address+'<span class="caret"></span>',
document.getElementById("Address_longitude").innerHTML="\u7d93\u5ea6:"+h.location.lng,document.getElementById("Address_latitude").innerHTML="\u7def\u5ea6:"+h.location.lat,glCurrentTargetAddressIndex=f,focus_map(h));h=create_dropdown_address_item(f,h.address,k);d.appendChild(h)}}
function create_dropdown_address_item(d,f,h){var k=document.createElement("li"),l=document.createElement("a");l.setAttribute("class","small");l.setAttribute("tabIndex","-1");l.setAttribute("data-value",d);l.setAttribute("href","javascript:;");l.setAttribute("onclick",'dropdown_address_click("'+d+'");return true;');var q=document.createElement("input");q.setAttribute("type","checkbox");q.setAttribute("id","dropdown_checkbox_address_"+d);q.setAttribute("onclick",'dropdown_checkbox_address_click("'+
d+'");return true;');q.checked=h;l.appendChild(q);l.appendChild(document.createTextNode(" "+f));k.appendChild(l);return k}var glDropdown_checkbox_address_click=!1;function dropdown_checkbox_address_click(d){glDropdown_checkbox_address_click=!0}
function dropdown_address_click(d){var f=glAddressList[d];glCurrentTargetAddressIndex=d;focus_map(f);document.getElementById("cur_address").innerHTML=f.address+'<span class="caret"></span>';document.getElementById("Address_longitude").innerHTML="\u7d93\u5ea6:"+f.location.lng;document.getElementById("Address_latitude").innerHTML="\u7def\u5ea6:"+f.location.lat;glDropdown_checkbox_address_click=!1}
function focus_map(d){glLiveMap.setBounds(d.northeast.lat,d.northeast.lng,d.southwest.lat,d.southwest.lng);glLiveMap.setTargetLocation(d.address,d.location.lat,d.location.lng)}
function createNewFireFightingbtn_click(){if(-1==glCurrentTargetAddressIndex)alert("\u8acb\u8f38\u5165\u6848\u5834\u5730\u5740!");else{var d=glAddressList[glCurrentTargetAddressIndex],f={};f.project_id=project_id;f.createFireFighting=1;f.address=d.address;f.lat=d.location.lat;f.lng=d.location.lng;jQuery.ajax({url:gl_target_server+"/php/firefighting.php",type:"POST",data:f,dataType:"json",success:function(d){void 0!=d.casenumber&&(document.getElementById("create_msg").innerHTML="\u65b0\u589e\u6848\u5834\u7de8\u865f:"+
d.casenumber,alert("\u65b0\u589e\u6848\u5834\u7de8\u865f:"+d.casenumber))},error:function(d,f,l){alert("error = "+l);alert("xhr.responseText = "+d.responseText)}});return!1}}function getRandomInt(d,f){return Math.floor(Math.random()*(f-d+1))+d}function FloatAdd(d,f){var h,k;try{h=d.toString().split(".")[1].length}catch(l){h=0}try{k=f.toString().split(".")[1].length}catch(l){k=0}h=Math.pow(10,Math.max(h,k));return(FloatMul(d,h)+FloatMul(f,h))/h}
function FloatSubtraction(d,f){var h,k,l;try{h=d.toString().split(".")[1].length}catch(q){h=0}try{k=f.toString().split(".")[1].length}catch(q){k=0}l=Math.pow(10,Math.max(h,k));return((d*l-f*l)/l).toFixed(h>=k?h:k)}function FloatMul(d,f){var h=0,k=d.toString(),l=f.toString();try{h+=k.split(".")[1].length}catch(q){}try{h+=l.split(".")[1].length}catch(q){}return Number(k.replace(".",""))*Number(l.replace(".",""))/Math.pow(10,h)}
function FloatDiv(d,f){var h=0,k=0,l,q;try{h=d.toString().split(".")[1].length}catch(v){}try{k=f.toString().split(".")[1].length}catch(v){}l=Number(d.toString().replace(".",""));q=Number(f.toString().replace(".",""));return l/q*Math.pow(10,k-h)}function rotatePoint(d,f,h){f=f*Math.PI/180;return new L.latLng(Math.sin(f)*(d.lng-h.lng)+Math.cos(f)*(d.lat-h.lat)+h.lat,Math.cos(f)*(d.lng-h.lng)-Math.sin(f)*(d.lat-h.lat)+h.lng)}
function open_firefighting_create_page(){window.open("/index.php/vilsfirefightingcreate/"+project_id,"_blank").focus()};
