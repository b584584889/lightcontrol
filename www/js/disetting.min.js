var PreLoadIndex=-1,CurrentLoadIndex=0,LOAD_STATE_END=9999,gl_usersubgroups=[],gl_SubgroupUIBlocks=[];check_loading_status();
function check_loading_status(){switch(CurrentLoadIndex){case 0:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_usersubgroup());break;case 1:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,load_subgroup_ui_info(),CurrentLoadIndex+=1);break;case 2:PreLoadIndex!=
CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex+=1);break;case 3:PreLoadIndex!=CurrentLoadIndex&&(console.log("check_loading_status() PreLoadIndex:"+PreLoadIndex+" != CurrentLoadIndex:"+CurrentLoadIndex),PreLoadIndex=CurrentLoadIndex,CurrentLoadIndex=LOAD_STATE_END)}CurrentLoadIndex!=LOAD_STATE_END?setTimeout(check_loading_status,100):console.log("check_loading_status() Stop.")}
function load_usersubgroup(){gl_usersubgroups=[];$.getJSON(gl_target_server+"/php/vilsnodes.php","loadusersubgroup=1&project_id="+project_id,function(a){$.each(a,function(a,b){b.subgroupid=parseInt(b.subgroupid);gl_usersubgroups.push(b)})}).success(function(){add_subgroup_to_table();add_subgroup_to_dropdown();CurrentLoadIndex+=1}).error(function(){}).complete(function(){})}
function add_subgroup_to_table(){for(var a=document.getElementById("subgroup_list_content");1<=a.rows.length;)a.deleteRow(0);for(var c=0;c<gl_usersubgroups.length;c++)a.appendChild(create_subgroup_item(c+1,gl_usersubgroups[c]))}
function create_subgroup_item(a,c){var b=document.getElementById("subgroup_list_content"),d=document.createElement("tr");b.appendChild(d);b=document.createElement("td");b.textContent=a;b.setAttribute("id","subgroup_row_"+c.subgroupid);d.appendChild(b);b=document.createElement("td");d.appendChild(b);var e=document.createElement("input");e.setAttribute("id","subgroup_row_checkbox_"+c.subgroupid);e.setAttribute("type","checkbox");e.setAttribute("onclick",'click_subgroup("'+c.subgroupid+'");return true;');
b.appendChild(e);b=document.createElement("td");b.setAttribute("id","subgroup_row_name_"+c.subgroupid);d.appendChild(b);e=create_subgroup_label(c.subgroupname);e.setAttribute("onclick",'checkbox_subgroup_click("'+c.subgroupid+'");return true;');b.appendChild(e);return d}
function create_subgroup_label(a){var c=document.createElement("span");c.setAttribute("style","display:inline;padding:.2em .3em .3em;font-size:95%;font-weight:700;line-height:2;position:relative;top:-1px;color:#fff;border-radius:2px;white-space:nowrap;background-color:#00a65a;");c.textContent=a;return c}function click_subgroup(a){update_uiblock_list()}
function checkbox_subgroup_click(a){a=document.getElementById("subgroup_row_checkbox_"+a);void 0==a?console.log("checkbox_subgroup_click() checkbox_ui == undefined"):(a.checked=a.checked?!1:!0,update_uiblock_list())}function subgroup_list_checkbox_click(){for(var a=0;a<gl_usersubgroups.length;a++)document.getElementById("subgroup_row_checkbox_"+gl_usersubgroups[a].subgroupid).checked=document.getElementById("subgroup_list_checkbox").checked;update_uiblock_list()}
function add_subgroup_to_dropdown(){var a=document.getElementById("copy_from_uisetting_dropdown_menu");if(void 0!=a)for(;a.firstChild;)a.removeChild(a.firstChild);for(var c=document.getElementById("copy_to_uisetting_dropdown_menu");c.firstChild;)c.removeChild(c.firstChild);for(var b=0;b<gl_usersubgroups.length;b++){var d=gl_usersubgroups[b];void 0!=a&&a.appendChild(create_subgroup_dropdown_item("from",b+1,1,d));c.appendChild(create_subgroup_dropdown_item("to",b+1,0,d))}}
function create_subgroup_dropdown_item(a,c,b,d){var e=document.createElement("li"),f=document.createElement("a");f.setAttribute("class","small");f.setAttribute("tabIndex","-1");f.setAttribute("data-value",d.subgroupid);f.setAttribute("href","javascript:;");f.setAttribute("onclick",'dropdown_subgroup_click("'+a+'","'+d.subgroupid+'",'+c+");return true;");var g=document.createElement("input");0==b?g.setAttribute("type","checkbox"):(g.setAttribute("type","radio"),g.setAttribute("name","radio_"+a));g.setAttribute("id",
"dropdown_checkbox_subgroup_"+a+"_"+d.subgroupid+"_"+c);g.setAttribute("onclick",'dropdown_checkbox_subgroup_click("'+a+'");return true;');g.checked=!1;f.appendChild(g);f.appendChild(document.createTextNode(" "+d.subgroupname));e.appendChild(f);return e}var glDropdown_checkbox_subgroup_click=!1;
function dropdown_subgroup_click(a,c,b){1==glDropdown_checkbox_subgroup_click?glDropdown_checkbox_subgroup_click=!1:(c=document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+c+"_"+b),void 0==c?console.log("checkbox_subgroup_click() checkbox_ui == undefined"):(c.checked=c.checked?!1:!0,check_copy_button(a)))}function dropdown_checkbox_subgroup_click(a){glDropdown_checkbox_subgroup_click=!0;check_copy_button(a)}
function check_copy_button(a){for(var c=0,b=0;b<gl_usersubgroups.length;b++){var d=document.getElementById("dropdown_checkbox_subgroup_"+a+"_"+gl_usersubgroups[b].subgroupid+"_"+(b+1));if(void 0!=d&&d.checked){c++;break}}b=document.getElementById("copy_"+a+"_uisetting_button");console.log("check_copy_button() copy_"+a+"_uisetting_button");0<c?b.setAttribute("style",""):b.setAttribute("style","visibility:hidden;")}
function copy_from_uisetting_button_click(){for(var a=0,c="",b=0;b<gl_usersubgroups.length;b++){var d=gl_usersubgroups[b],e=document.getElementById("dropdown_checkbox_subgroup_from_"+d.subgroupid+"_"+(b+1));if(void 0!=e&&e.checked){c=d.subgroupname;a=d.subgroupid;break}}for(var e=[],f="",g=0,b=0;b<gl_usersubgroups.length;b++)d=gl_usersubgroups[b],document.getElementById("subgroup_row_checkbox_"+d.subgroupid).checked&&(0<g&&(f+=","),f+=d.subgroupname,e[g]=d.subgroupid,g++);if(confirm("\u78ba\u5b9a\u5c07\u5b50\u96c6\u5408["+
c+"]\u8a2d\u5b9a \u8907\u88fd\u5230\u76ee\u524d\u5b50\u96c6\u5408["+f+"]\u8a2d\u5b9a?")){a=gl_SubgroupUIBlocks[a];for(b=0;b<e.length;b++)gl_SubgroupUIBlocks[e[b]]=a;b=JSON.stringify(a);e=e.toString();glUIBlocks=a;update_subgroupuiblock_record(e,b,!0)}}
function copy_to_uisetting_button_click(){for(var a=[],c="",b=0,d=0;d<gl_usersubgroups.length;d++){var e=gl_usersubgroups[d],f=document.getElementById("dropdown_checkbox_subgroup_to_"+e.subgroupid+"_"+(d+1));void 0!=f&&f.checked&&(0<b&&(c+=","),c+=e.subgroupname,a[b]=e.subgroupid,b++)}if(confirm("\u78ba\u5b9a\u5c07\u76ee\u524d\u8a2d\u5b9a \u8907\u88fd\u5230\u5b50\u96c6\u5408["+c+"]\u8a2d\u5b9a?")){c=JSON.stringify(glUIBlocks);b=a.toString();for(d=0;d<a.length;d++)gl_SubgroupUIBlocks[a[d]]=glUIBlocks;
update_subgroupuiblock_record(b,c,!1)}}
function update_uiblock_list(){glUIBlocks=[];for(var a=0,c=0;c<gl_usersubgroups.length;c++){var b=gl_usersubgroups[c];if(document.getElementById("subgroup_row_checkbox_"+b.subgroupid).checked){b=gl_SubgroupUIBlocks[b.subgroupid];if(void 0!=b)for(var d=0;d<b.length;d++)for(var e=b[d],f=0;f<e.length;f++){var g=e[f];0==check_existed_block(g)&&put_to_existed_block(d,f,g)}a++}}c=document.getElementById("save_uisetting_button");b=document.getElementById("restore_uisetting_button");d=document.getElementById("copy_from_uisetting_dropdown");
e=document.getElementById("copy_to_uisetting_dropdown");0<a?(c.setAttribute("style","display:block;"),b.setAttribute("style","display:block;"),d.setAttribute("style","display:block;"),e.setAttribute("style","display:block;"),0==glUIBlocks.length&&(b=gl_SubgroupUIBlocks[0],void 0!=b&&(glUIBlocks=b))):(c.setAttribute("style","display:none;"),b.setAttribute("style","display:none;"),d.setAttribute("style","display:none;"),e.setAttribute("style","display:none;"));create_blocks()}
function check_existed_block(a){var c=!1;if(0==glUIBlocks.length)return!1;for(var b=0;b<glUIBlocks.length;b++){for(var d=glUIBlocks[b],e=0;e<d.length;e++)if(d[e].id===a.id){c=!0;break}if(1==c)break}return c}
function put_to_existed_block(a,c,b){var d=glUIBlocks[a];if(void 0==d)glUIBlocks[a]=[],glUIBlocks[a][c]=b;else{var e;if(void 0==d)glUIBlocks[a][c]=b;else for(e=c;10>a;a++){d=glUIBlocks[a];if(void 0==d){glUIBlocks[a]=[];glUIBlocks[a][0]=b;break}c=!1;for(var f=e;4>f;f++)if(e=d[f],void 0==e){glUIBlocks[a][f]=[];glUIBlocks[a][f]=b;c=!0;break}e=0;if(1==c)break}}}
function load_subgroup_ui_info(){gl_SubgroupUIBlocks=[];$.getJSON(gl_target_server+"/php/configvils.php","loadsubgroupuiblock=1&project_id="+project_id,function(a){$.each(a,function(a,b){gl_SubgroupUIBlocks[a]=b.uidata})});return!1}
function create_blocks(){for(var a=document.getElementById("main_content");a.firstChild;)a.removeChild(a.firstChild);for(var c=0;c<glUIBlocks.length;c++){var b=glUIBlocks[c],d=create_Sortable_row("row_block_"+(c+1));a.appendChild(d);for(var e=0;e<b.length;e++){var f=create_block(b[e]);d.appendChild(f)}$("#row_block_"+(c+1)).sortable({placeholder:"sort-highlight",connectWith:".connectedSortable",forcePlaceholderSize:!1,start:uiblock_start,receive:uiblock_receive,update:uiblock_update,stop:uiblock_stop,
zIndex:999999}).disableSelection();init()}}function touchHandler(a){var c=a.changedTouches[0],b;switch(a.type){case "touchstart":b="mousedown";break;case "touchmove":b="mousemove";break;case "touchend":b="mouseup";break;default:return}var d=document.createEvent("MouseEvent");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);c.target.dispatchEvent(d);a.preventDefault()}var clickms=100,lastTouchDown=-1;
function init(){document.addEventListener("touchstart",touchHandler,!0);document.addEventListener("touchmove",touchHandler,!0);document.addEventListener("touchend",touchHandler,!0);document.addEventListener("touchcancel",touchHandler,!0)}function create_Sortable_row(a){var c=document.createElement("div");c.setAttribute("class","row connectedSortable");c.setAttribute("id",a);return c}
function create_block(a){var c=document.createElement("div");c.setAttribute("class","col-lg-2 col-md-4 col-sm-6 col-xs-6");c.setAttribute("id",a.id);var b=document.createElement("div");b.setAttribute("class","box box-solid "+a.bgcolor);c.appendChild(b);var d=document.createElement("div");d.setAttribute("class","box-header");b.appendChild(d);var e=document.createElement("label");e.setAttribute("class","overflow-ellipsis");e.setAttribute("style","font-size:2vw;width: 180px;white-space: nowrap;overflow: hidden;");
e.textContent=a.title;d.appendChild(e);e=document.createElement("label");e.setAttribute("class","box-tools pull-right");d.appendChild(e);d=document.createElement("button");d.setAttribute("type","button");d.setAttribute("class","btn btn-sm "+a.btncolor);d.setAttribute("data-widget","remove");d.setAttribute("onclick",'box_close("'+a.id+'");');e.appendChild(d);e=document.createElement("i");e.setAttribute("class","fa fa-times");d.appendChild(e);e=document.createElement("div");e.setAttribute("class","box-body border-radius-none");
b.appendChild(e);d=document.createElement("div");d.setAttribute("class","inner");e.appendChild(d);e=document.createElement("div");e.setAttribute("class","inner");e.setAttribute("style","width: 180px;white-space: nowrap;overflow: hidden;");e.textContent=a.context;d.appendChild(e);a=document.createElement("div");a.setAttribute("class","small-box-footer");a.setAttribute("style","background-color: #f3f3f3e3;");b.appendChild(a);d=document.createElement("div");d.setAttribute("class","row");a.appendChild(d);
b=document.createElement("div");b.setAttribute("class","col-xs-12 text-center");d.appendChild(b);a=document.createElement("label");a.setAttribute("style","font-size: 14px");a.textContent="\u9ede\u64ca\u67e5\u770b";b.appendChild(a);a=document.createElement("i");a.setAttribute("class","fa fa-arrow-circle-right");b.appendChild(a);return c}function uiblock_start(a,c){}function uiblock_update(a,c){}function uiblock_receive(a,c){}
function uiblock_stop(a,c){for(var b=[],d=glUIBlocks.length,e=0;e<d;e++){for(var f=$("#row_block_"+(e+1)).sortable("toArray"),g=[],h=0;h<f.length;h++){var k=getUIdata(f[h]);g.push(k)}b.push(g)}glUIBlocks=null;glUIBlocks=b;create_blocks()}function getUIdata(a){for(var c,b=glUIBlocks.length,d=0;d<b;d++)for(var e=glUIBlocks[d],f=0;f<e.length;f++)if(c=e[f],c.id===a)return c;return null}
function box_close(a){for(var c=[],b=glUIBlocks.length,d=0;d<b;d++){for(var e=glUIBlocks[d],f=[],g=0;g<e.length;g++){var h=e[g];h.id!=a&&f.push(h)}c.push(f)}glUIBlocks=null;glUIBlocks=c;create_blocks()}
function update_subgroupuiblock_record(a,c,b){var d;d="updatesubgroupuiblock=1&project_id="+project_id;jQuery.ajax({url:gl_target_server+"/php/configvils.php",type:"POST",data:d+("&subgroupids="+a)+("&uidata="+c),dataType:"text",success:function(a){alert("\u66f4\u65b0\u6210\u529f!");b&&create_blocks()},error:function(a,b,c){alert("\u7121\u6cd5\u66f4\u65b0!")},complete:function(){}});return!1}
function save_uisetting(){for(var a=JSON.stringify(glUIBlocks),c=[],b=0,d=0;d<gl_usersubgroups.length;d++){var e=gl_usersubgroups[d];document.getElementById("subgroup_row_checkbox_"+e.subgroupid).checked&&(c[b]=e.subgroupid,b++)}update_subgroupuiblock_record(c.toString(),a,!1);load_subgroup_ui_info()}function restore_uisetting(){var a=gl_SubgroupUIBlocks[0];void 0!=a&&(glUIBlocks=a);create_blocks()}
$("#row_1, #row_2").sortable({placeholder:"sort-highlight",connectWith:".connectedSortable",forcePlaceholderSize:!1,start:uiblock_start,receive:uiblock_receive,update:uiblock_update,stop:uiblock_stop,zIndex:999999}).disableSelection();$(".connectedSortable .box-header, .connectedSortable .nav-tabs-custom").css("cursor","move");function open_disetting_page(){window.open("/index.php/vilsdisetting/"+project_id,"_blank").focus()};
